<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar -->
    <meta name="theme-color" content="#0d6efd">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0b4c8f 0%, #02274f 100%) fixed;
            color: #f8f9fa;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            line-height: 1.6;
            padding-top: 60px; /* Space for fixed header */
        }
        /* --- App Header --- */
        #appHeader {
            position: fixed;
            top: 0; left: 0; right: 0; height: 60px;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            color: #fff; display: flex; align-items: center; justify-content: center;
            z-index: 1030; box-shadow: 0 2px 5px rgba(0,0,0,0.2); padding: 0 1rem;
        }
        #appHeader h5 { margin-bottom: 0; font-weight: 600; font-size: 1.1rem; }
        /* --- Offline Indicator --- */
        #offlineIndicator {
            position: fixed; top: 60px; left: 0; right: 0;
            background-color: #ffc107; color: #000; text-align: center;
            padding: 0.3rem 1rem; z-index: 1029; font-size: 0.9rem;
            display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            background: rgba(0, 0, 0, 0.8); border-radius: 15px; padding: 1.5rem;
            margin: 30px auto; max-width: 960px; z-index: 1; display: none;
        }

        /* Page Transitions */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; width: 100%; }

        /* Splash Screen */
        .splash-screen {
            /* display: flex; /* Set by JS */
            flex-direction: column; justify-content: flex-end; align-items: center;
            padding: 1.5rem; padding-bottom: 3rem; height: 100vh; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 1031; /* Above header */
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.8)), url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed;
            text-align: center;
        }
        .splash-screen .button-group-center { width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
        .splash-screen .button-group-center .btn { display: block; width: 100%; margin: 0 auto 1rem auto; color: white; padding-top: 0.9rem; padding-bottom: 0.9rem; }
        .splash-screen .btn-outline-light { color: #fff; border-color: #fff; }
        .splash-screen .btn-outline-light:hover, .splash-screen .btn-outline-light:focus { background-color: rgba(255, 255, 255, 0.15); color: #fff; border-color: #fff; }

        /* Card Sections */
        .card-section { background: rgba(255, 255, 255, 0.98); border-radius: 12px; padding: 2rem 1.75rem; margin: 1.5rem 0; border: none; color: #212529; z-index: 3; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); transition: box-shadow 0.3s ease; }
        .card-section:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15); }
        .card-section h2 { color: #0056b3; margin-bottom: 1.5rem; font-weight: 700; }
        .card-section h5 { color: #0056b3; margin-bottom: 1.2rem; font-weight: 600; }
        .card-section h6 { font-weight: 700; margin-top: 1rem; margin-bottom: 0.75rem; color: #0056b3; }

        /* Buttons (General) */
        .btn { padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 50px; border: none; margin: 0.3rem; transition: transform 0.2s ease-out, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, color 0.2s ease; cursor: pointer; font-weight: 600; vertical-align: middle; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); line-height: 1.5; }
        .btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .btn:active { transform: translateY(0px) scale(1); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .btn:disabled, .btn.disabled { cursor: not-allowed; opacity: 0.65; transform: none; box-shadow: none; }
        .btn i.bi { vertical-align: text-bottom; line-height: 1; margin-right: 0.1em; margin-left: -0.1em; }
        .btn i.ms-1, .btn i.ms-2 { margin-left: 0.5em !important; margin-right: -0.1em !important;}
        .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; color: white; }
        .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; color: white; }
        .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; color: white; }
        .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; color: black;}
        .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; box-shadow: none; } .btn-outline-secondary:hover { background-color: #6c757d; color: white; border-color: #6c757d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; box-shadow: none; } .btn-outline-light:hover { background-color: #f8f9fa; color: #000; border-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-outline-danger { border: 2px solid #dc3545; color: #dc3545; background-color: transparent; box-shadow: none; } .btn-outline-danger:hover { background-color: #dc3545; color: white; border-color: #dc3545; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.875rem; border-radius: 30px; font-weight: 500; margin: 0.15rem; }
        .btn-lg { padding: 0.9rem 1.8rem; font-size: 1.15rem; margin: 0.5rem; }
        .button-group-center { text-align: center; margin-top: 1.5rem; }
        .button-group-center .btn:not(.d-block) { margin-left: 0.5rem; margin-right: 0.5rem; }

        /* Forms */
        .mb-3 { margin-bottom: 1.5rem !important; }
        .form-label { font-weight: 600; color: #495057; margin-bottom: 0.6rem; font-size: 0.95rem; }
        .form-control, .form-select { border-radius: 8px; border: 1px solid #ced4da; padding: 0.6rem 0.8rem; font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; height: auto; }
        .form-select { background-position: right 0.8rem center; }
        .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-control.is-invalid, .form-select.is-invalid { border-color: #dc3545; }
        .form-check-label { color: #212529; padding-left: 0.3rem; font-weight: normal; }
        .form-check-input { margin-top: 0.2em; margin-right: 0.5em; }
        #verifierEndModalSection { display: none; }
        /* Removed .length-input-group styles */

        /* Tables */
        .card-section .table { background: white; color: #212529; margin-top: 1.5rem; border-collapse: separate; border-spacing: 0; width: 100%; table-layout: auto; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6; }
        .table-responsive { margin-bottom: 1.5rem; border: none; border-radius: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: none; }
        .card-section .table thead { background-color: #e9ecef; color: #495057; font-weight: 700; border-bottom: 2px solid #dee2e6; }
        .card-section .table th, .card-section .table td { border: none; border-bottom: 1px solid #e9ecef; vertical-align: middle; padding: 0.9rem 0.85rem; white-space: normal; font-size: 0.95rem; }
        .card-section .table tbody tr:last-child td { border-bottom: 0; }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: #f8f9fa; }
        .card-section .table-hover tbody tr:hover > * { background-color: rgba(0, 123, 255, 0.08); }
        #fishingPage .table { margin-top: 0; margin-bottom: 0; border: none; }
        #fishingPage .table-responsive { margin-bottom: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; }
        #fishingPage th.photo-col { width: 65px; text-align: center; } #fishingPage td.photo-col { text-align: center; }
        #fishingPage th.length-col { width: 90px; text-align: right;} /* Back to original width */ #fishingPage td.length-col { text-align: right;}
        #fishingPage th.verified-col { width: 90px; text-align: center; } #fishingPage td.verified-col { text-align: center; }
        #fishingPage th.delete-col { width: 60px; text-align: center;} #fishingPage td.delete-col { text-align: center;}
        .delete-icon-btn { background: none; border: none; padding: 0.1rem 0.3rem; color: #dc3545; cursor: pointer; font-size: 1.3rem; vertical-align: middle; transition: color 0.2s ease, transform 0.1s ease; }
        .delete-icon-btn:hover { color: #a71d2a; transform: scale(1.1); } .delete-icon-btn:active { transform: scale(1); }
        #tallyPage.card-section tfoot tr { background-color: #f8f9fa; }
        #tallyPage.card-section tfoot td { padding-top: 1rem; padding-bottom: 1rem; border-bottom: none; }
        #tallyPage.card-section .catch-summary-details { margin-bottom: 1.75rem; color: #495057; line-height: 1.7; font-size: 0.95rem; padding: 1rem; background-color: #f0f4f8; border-radius: 8px; border: 1px solid #d6dde4; }

        /* Fish Log Specific */
        .thumbnail-container { display: inline-block; vertical-align: middle; cursor: pointer; width: 45px; height: 45px; text-align: center; line-height: 45px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .thumbnail-container:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .fish-thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; }
        .no-photo-icon { font-size: 1.6rem; color: #adb5bd; vertical-align: middle; }

        /* Modals */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { background: #ffffff; color: #212529; border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { background-color: #f8f9fa; color: #212529; border-bottom: 1px solid #dee2e6; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 1rem 1.5rem; }
        .modal-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; display: flex; justify-content: flex-end; flex-wrap: wrap; padding: 1rem 1.5rem; }
        .modal-footer .btn { margin: 0.25rem; }
        .modal-title { color: #0056b3; font-weight: 700; font-size: 1.2rem; }
        .modal-header .btn-close { filter: none; background-size: 0.8em; opacity: 0.7; transition: opacity 0.2s ease; }
        .modal-header .btn-close:hover { opacity: 1; }
        .modal-body { background-color: #ffffff; color: #212529; padding: 1.5rem 1.75rem; line-height: 1.7; }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body, #confirmPhotoModal .modal-body { color: #212529 !important; }

        /* Saved Scorecards Modal */
        #savedScorecardsList.card-section { background: transparent; border: none; box-shadow: none; padding: 0; margin: 0; }
        #savedScorecardsModal .modal-body { padding: 1rem 1.25rem; }
        #savedScorecardsModal .scorecard-entry { border: 1px solid #dee2e6; border-radius: 10px; margin-bottom: 1rem; background-color: #ffffff; overflow: hidden; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: box-shadow 0.2s ease; }
        #savedScorecardsModal .scorecard-entry:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12); }
        #savedScorecardsModal .scorecard-item { cursor: pointer; padding: 1rem 1.25rem; border-bottom: 1px solid #e9ecef; color: #212529; transition: background-color 0.2s; display: flex; align-items: center; gap: 0.75rem; }
        #savedScorecardsModal .scorecard-item:hover { background-color: #f8f9fa; }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible { background-color: #eef5ff; border-bottom: 1px solid #cdddff; }
        #savedScorecardsModal .scorecard-item i.bi { transition: transform 0.2s ease-in-out; color: #6c757d; font-size: 1.1rem; flex-shrink: 0; }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: #6c757d !important; font-size: 0.85rem; }
        #savedScorecardsModal .scorecard-item strong { font-weight: 600; }
        #savedScorecardsModal .scorecard-item > div { flex-grow: 1; }
        #savedScorecardsModal .scorecard-item .badge { font-size: 0.75rem; padding: 0.3em 0.6em; vertical-align: middle; }
        #savedScorecardsModal .scorecard-details { display: none; padding: 1.25rem 1.5rem; background-color: #ffffff; border-top: 1px solid #e9ecef; margin-top: 0; border-radius: 0 0 10px 10px; color: #212529; line-height: 1.7; }
        #savedScorecardsModal .scorecard-details.loading { text-align: center; padding: 2rem; }
        #savedScorecardsModal .scorecard-details h6 { font-weight: 700; margin-top: 1.2rem; margin-bottom: 0.8rem; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 0.4rem; font-size: 1.1rem; }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 0.6rem; color: #212529; font-size: 0.95rem; }
        #savedScorecardsModal .scorecard-details hr { margin-top: 1.2rem; margin-bottom: 1.2rem; border-top: 1px solid #dee2e6; }
        .fish-list-item { padding: 0.5rem 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .fish-list-item:last-child { border-bottom: none; }
        .fish-list-item .badge { font-weight: normal; }
        .fish-list-item small.text-muted { font-size: 0.8rem; margin-left: auto; }
        .session-photos { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px; }
        .session-photo-thumbnail { width: 70px; height: 70px; object-fit: cover; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .session-photo-thumbnail:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .placeholder-photos { color: #6c757d; font-style: italic; font-size: 0.9rem; }
        #savedScorecardsModal .scorecard-details .species-length-summary p { margin-bottom: 0.4rem; padding-left: 0.5rem; font-size: 0.9rem; }
        #savedScorecardsModal .scorecard-details .species-length-summary h6 { margin-top: 0.5rem; margin-bottom: 0.6rem; font-size: 1rem; color: #495057; border-bottom: none; padding-bottom: 0; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block { background-color: #e7f1ff; padding: 1rem 1.25rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #b8d6fb; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block h6 { margin-top: 0; margin-bottom: 1rem; border-bottom: none; color: #0056b3; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block .summary-highlight { padding: 0.2em 0.5em; border-radius: 4px; font-weight: 600; display: inline-block; background-color: #ddeaff; }
        #savedScorecardsModal .scorecard-details .btn-actions-group { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e9ecef; text-align: right; }
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-left: 5px; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry { border: 2px solid #007bff; box-shadow: 0 0 12px rgba(0, 123, 255, 0.3); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item { border-bottom-color: rgba(0, 123, 255, 0.3); background-color: #e7f1ff; font-weight: 600; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge { background-color: #007bff !important; color: white !important; }
        #olderScorecardsToggleContainer { padding-top: 1rem; text-align: center; }
        #olderScorecardsToggleContainer .btn { margin: 0.5rem; }
        #scorecardSearchInput { margin-bottom: 1rem; }

        /* Notes Modal */
        #notesModal .modal-body textarea { resize: vertical; min-height: 120px; font-size: 1rem; }

        /* Camera Modal */
        #cameraModal .modal-dialog { max-width: 100%; margin: 0; height: 100%; }
        #cameraModal .modal-content { height: 100%; border-radius: 0; background-color: #000; }
        #cameraModal .modal-header { border-bottom: 0; background-color: rgba(0,0,0,0.6); position: absolute; top: 0; left: 0; right: 0; z-index: 10; padding: 0.8rem 1rem; }
        #cameraModal .modal-title { color: #fff; font-size: 1.1rem; }
        #cameraModal .btn-close { filter: brightness(0) invert(1); opacity: 0.8; }
        #cameraModal .modal-body { padding: 0; display: flex; justify-content: center; align-items: center; height: 100%; }
        #cameraVideo { display: block; width: 100%; height: 100%; object-fit: cover; }
        #cameraCanvas { display: none; }
        #cameraControls { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0,0,0,0.6); padding: 25px 20px; text-align: center; z-index: 10; }
        #takePhotoButton { border-radius: 50%; width: 75px; height: 75px; padding: 0; background-color: #fff; border: 6px solid rgba(255,255,255,0.5); transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; box-shadow: 0 0 15px rgba(255,255,255,0.3); display: inline-block; font-size: 1rem; font-weight: normal; line-height: initial; margin: 0; color: transparent; }
        #takePhotoButton:hover { background-color: #f0f0f0; border-color: rgba(255,255,255,0.8); transform: scale(1.05); }
        #takePhotoButton:active { transform: scale(0.95); }
        #takePhotoButton:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc; border-color: #aaa; } /* Disabled style */


        /* Image Viewer Modal */
        #imageViewerModal .modal-dialog { max-width: 95%; margin: 1.75rem auto; }
        #imageViewerModal .modal-content { background-color: #f8f9fa; }
        #imageViewerModal .modal-body { text-align: center; padding: 1rem; }
        #fullImageView { max-width: 100%; max-height: 75vh; display: block; margin: 0 auto 1.5rem auto; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }
        #imageViewerModal .modal-footer { justify-content: space-between; }
        #imageViewerModal .btn { min-width: 100px; }

        /* Toast Container */
        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1100; }

        /* Responsive Adjustments */
        @media (max-width: 767px) {
            body { padding-top: 56px; } #appHeader { height: 56px; } #offlineIndicator { top: 56px; }
            .card-section { padding: 1.5rem 1rem; }
            .modal-body { padding: 1.25rem 1rem; }
            .modal-footer { padding: 0.75rem 1rem; }
            .modal-footer .btn:not(.btn-sm) { width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 0.5rem; }
            .modal-footer .btn:not(.btn-sm):last-child { margin-bottom: 0; }
            #fishingPage .row .btn#addFishBtn { width: 100%; margin-top: 0.5rem; }
        }
        @media (max-width: 575px) {
             html { font-size: 15px; }
             .container { margin: 15px auto; padding: 1rem; }
             .card-section { padding: 1.25rem 0.8rem; }
             .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem; }
             .btn-lg { padding: 0.8rem 1.6rem; font-size: 1.05rem; }
             .splash-screen { padding: 2rem 1rem; }
             #fishingPage .row > div { padding-left: 5px; padding-right: 5px; }
             .fish-list-item { flex-wrap: wrap; }
             .fish-list-item small.text-muted { margin-left: 0; width: 100%; text-align: left; font-size: 0.75rem; padding-left: calc(1em + 0.5rem + 10px); }
             /* Removed length input group responsive rules */
        }

    </style>
</head>
<body>
    <!-- App Header -->
    <div id="appHeader">
        <h5 id="appTitle">Sea Catch Scorer</h5>
    </div>
    <!-- Offline Indicator -->
    <div id="offlineIndicator">
         <i class="bi bi-wifi-off me-1"></i> You are currently offline. Functionality may be limited.
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <!-- Toasts will be added here by JS -->
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div class="mb-3">
                 <label for="zoneInput" class="form-label">Zone</label>
                 <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select>
            </div>
            <div class="mb-3">
                <label for="pegInput" class="form-label">Peg</label>
                <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> </select>
            </div>
            <div class="button-group-center"> <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button> </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
            <div class="row g-2 align-items-start">
                <div class="col-md-6 col-lg-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select"> <option value="" selected disabled>Loading species...</option> </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                     <label for="lengthInput" class="form-label">Length (cm)</label>
                     <!-- Removed input-group wrapper and +/- buttons -->
                     <input type="number" id="lengthInput" class="form-control" placeholder="Length" step="1" min="1" inputmode="numeric">
                </div>
                <div id="initialsInputGroup" class="col-sm-6 col-md-3 col-lg-2 mb-3" style="display: none;">
                    <label for="initialsInput" class="form-label">Verifier Initials</label>
                    <input type="text" id="initialsInput" class="form-control" placeholder="Initials" maxlength="3" style="text-transform:uppercase">
                </div>
                <div class="col-md-12 col-lg-3 mb-3 text-lg-end text-center align-self-end">
                     <button class="btn btn-primary w-100 w-lg-auto" id="addFishBtn"> <i class="bi bi-plus-circle me-1"></i> Add Fish </button>
                </div>
            </div>
            <div class="text-center mb-4 mt-2">
                 <button class="btn btn-secondary btn-sm" id="backFromFishingBtn"> <i class="bi bi-arrow-left-circle me-1"></i> Back to Registration </button>
             </div>
            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead> <tr> <th class="photo-col">Photo</th> <th class="species-col">Species</th> <th class="length-col">Length</th> <th id="verifiedByHeader" class="verified-col" style="display:none;">Verified</th> <th class="delete-col">Del</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>
            <div class="button-group-center mt-4"> <button class="btn btn-success btn-lg" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button> </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details"> <strong>Angler:</strong> <span id="summaryAngler"></span><br> <strong>Date:</strong> <span id="summaryDate"></span><br> <strong>Venue:</strong> <span id="summaryVenue"></span><br> <strong>Zone:</strong> <span id="summaryZone"></span><br> <strong>Peg:</strong> <span id="summaryPeg"></span><br> <span id="summaryVerifier"></span> </div>
            <div class="table-responsive"> <table class="table"> <thead> <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr> </thead> <tbody id="tallyTable"></tbody>
                <tfoot>
                    <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                    <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Points Total</strong></td> <td><strong id="tallyPointsTotal">0</strong></td> </tr>
                </tfoot>
            </table> </div>
            <div class="button-group-center"> <button class="btn btn-secondary" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back to Log</button> </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen page">
        <div class="button-group-center">
            <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
            <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals (HTML unchanged) -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> An unsaved session was found. Would you like to restore it? <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p> <p><strong>Date:</strong> <span id="restoreDate"></span></p> <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p> </div> <div class="modal-footer button-group-center d-block"> <button type="button" class="btn btn-success btn-lg mb-2 w-100" id="restoreSessionBtn">Restore Session</button> <button type="button" class="btn btn-danger w-100" id="startNewSessionBtn">Start New Session</button> </div> </div> </div> </div>
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="mb-3"> <input type="search" id="scorecardSearchInput" class="form-control" placeholder="Search by Angler or Venue..."> </div> <div id="savedScorecardsList" class="card-section"> <div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div> </div> <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p>Are you sure you want to end your session? This will save the scorecard.</p> <div id="verifierEndModalSection" class="mt-3" style="display: none;"> <hr> <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label> <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required> <small class="text-muted d-block mt-1">Required for competition scorecards.</small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button> <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button> </div> </div> </div> </div>
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="notesModalLabel">Session Notes</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" id="notesModalScorecardKey"> <div class="mb-3"> <label for="notesTextarea" class="form-label">Enter your notes below:</label> <textarea class="form-control" id="notesTextarea" rows="6"></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" onclick="saveNoteFromModal()">Save Notes</button> </div> </div> </div> </div>
    <div class="modal fade" id="mlsInfoModal" tabindex="-1" aria-labelledby="mlsInfoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="mlsInfoModalLabel"><i class="bi bi-info-circle-fill text-primary me-2"></i>Important MLS Information</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div> <div class="modal-body"> <p>Please ensure you are recording your catches in accordance with the minimum landing sizes (MLS) and any other fishing regulations that apply to your specific location or event.</p> <p><em>This app does not enforce MLS rules automatically.</em></p> </div> <div class="modal-footer"> <button type="button" class="btn btn-primary" id="mlsAgreeBtn" data-bs-dismiss="modal">OK, Understood</button> </div> </div> </div> </div>
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true"> <div class="modal-dialog modal-fullscreen"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cameraModalLabel">Take Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelCameraButtonHeader"></button> </div> <div class="modal-body"> <video id="cameraVideo" playsinline autoplay muted></video> <canvas id="cameraCanvas"></canvas> </div> <div id="cameraControls"> <button type="button" id="takePhotoButton" aria-label="Take Photo"></button> </div> </div> </div> </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="imageViewerModalLabel">Fish Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <img id="fullImageView" src="#" alt="Full fish photo"> </div> <div class="modal-footer"> <button type="button" class="btn btn-info" id="shareImageBtn"><i class="bi bi-share-fill me-1"></i> Share</button> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="confirmPhotoModal" tabindex="-1" aria-labelledby="confirmPhotoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-sm modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="confirmPhotoModalLabel">Add Photo?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body text-center"> Add a photo for this fish now? </div> <div class="modal-footer justify-content-center"> <button type="button" class="btn btn-success mx-2" id="confirmPhotoYesBtn">Yes</button> <button type="button" class="btn btn-secondary mx-2" id="confirmPhotoNoBtn">No</button> </div> </div> </div> </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Application JS -->
    <script>
        // --- Global Variables ---
        const fishCategories = { /* ... Categories ... */
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
            "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
            "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
            "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
            "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
        };
        let fishData = []; let currentAngler = null; let currentDate = null; let currentVenue = null;
        let currentZone = null; let currentPeg = null; let currentPage = 'splashScreen'; let isAppActive = false;
        let historyHijacked = false; let notesModalInstance = null; let cameraModalInstance = null;
        let imageViewerModalInstance = null; let confirmPhotoModalInstance = null; let db = null;
        let currentStream = null; let currentFishIdForPhoto = null; let currentImageBlobForViewer = null;
        let currentImageIdForViewer = null; let isDropdownPopulated = false; let pendingFishData = null;
        let isOffline = !navigator.onLine; let scorecardSearchDebounceTimer = null; let allScorecardsCache = [];

        // --- Constants ---
        const DB_NAME = 'SeaCatchDB'; const DB_VERSION = 1; const IMAGE_STORE_NAME = 'fishImages';
        const POINTS_PER_SPECIES = 10; const SEARCH_DEBOUNCE_MS = 300;

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function formatDateForInput(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function showPage(pageId) {
            console.log(`Show page requested: ${pageId}`);
            const appTitleElement = document.getElementById('appTitle');
            const headerElement = document.getElementById('appHeader');
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            const target = document.getElementById(pageId);

            if (target) {
                const displayStyle = pageId === 'splashScreen' ? 'flex' : 'block';
                target.style.display = displayStyle;
                currentPage = pageId;

                // Update Header Title & Visibility
                if (headerElement) headerElement.style.display = (pageId === 'splashScreen') ? 'none' : 'flex';
                if (appTitleElement) {
                    switch(pageId) {
                        case 'splashScreen': break; // No title needed when header hidden
                        case 'registrationPage': appTitleElement.textContent = 'Session Setup'; break;
                        case 'fishingPage': appTitleElement.textContent = 'Record Catch'; break;
                        case 'tallyPage': appTitleElement.textContent = 'Catch Summary'; break;
                        default: appTitleElement.textContent = 'Sea Catch Scorer';
                    }
                }

                const container = document.querySelector('.container');
                if(container) { container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; }

                // Adjust body padding based on header visibility
                document.body.style.paddingTop = (pageId === 'splashScreen') ? '0' : '60px';

                if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); }
                if (pageId !== 'splashScreen') { saveTempSession(); }

            } else {
                console.error(`ERROR: Page element not found: ${pageId}. Defaulting to splash.`);
                const splash = document.getElementById('splashScreen');
                if(splash) splash.style.display = 'flex';
                if(headerElement) headerElement.style.display = 'none'; // Hide header on fallback
                document.body.style.paddingTop = '0'; // Remove padding on fallback
                const container = document.querySelector('.container');
                if(container) container.style.display = 'none';
                currentPage = 'splashScreen';
            }
        }
        function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) ); }
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        // --- IndexedDB --- (Assumed functional - no changes)
        function initDb() { return new Promise((resolve, reject) => { if (db) { resolve(db); return; } console.log("Initializing IndexedDB..."); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("IndexedDB error: " + event.target.error); }; request.onsuccess = (event) => { db = event.target.result; console.log("IndexedDB initialized successfully."); resolve(db); }; request.onupgradeneeded = (event) => { console.log("Upgrading IndexedDB..."); db = event.target.result; if (!db.objectStoreNames.contains(IMAGE_STORE_NAME)) { console.log(`Creating object store: ${IMAGE_STORE_NAME}`); db.createObjectStore(IMAGE_STORE_NAME, { keyPath: 'id' }); } }; }); }
        function saveImageToDb(imageId, blob) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for saving image: " + dbErr); return; } } if (!blob || !imageId) { reject("Missing imageId or blob data."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); const imageData = { id: imageId, blob: blob }; console.log(`Attempting to save image with ID: ${imageId}`); const request = store.put(imageData); request.onsuccess = () => { console.log(`Image ${imageId} saved to IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error saving image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Save image transaction completed."); }; transaction.onerror = (event) => { console.error("Save image transaction error:", event.target.error); reject("Save image transaction failed."); }; }); }
        function getImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for getting image: " + dbErr); return; } } if (!imageId) { reject("Missing imageId."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readonly'); const store = transaction.objectStore(IMAGE_STORE_NAME); const request = store.get(imageId); request.onsuccess = (event) => { if (event.target.result) { console.log(`Image ${imageId} retrieved from IndexedDB.`); resolve(event.target.result.blob); } else { console.log(`Image ${imageId} not found in IndexedDB.`); resolve(null); } }; request.onerror = (event) => { console.error(`Error retrieving image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }
        function deleteImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for deleting image: " + dbErr); return; } } if (!imageId) { resolve(); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); console.log(`Attempting to delete image with ID: ${imageId}`); const request = store.delete(imageId); request.onsuccess = () => { console.log(`Image ${imageId} deleted from IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error deleting image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Delete image transaction completed."); }; transaction.onerror = (event) => { console.error("Delete image transaction error:", event.target.error); reject("Delete image transaction failed."); }; }); }


        // --- History/Nav --- (Assumed functional - no changes)
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { try { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } catch (e) { console.error("Error pushing history state:", e); historyHijacked = false; } } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } }
        function handleBackButton(event) { if (isAppActive && historyHijacked) { console.log("Browser back button intercepted by app mode."); try { history.pushState({ appActive: true }, '', location.href); if (confirm("You have an active session. Do you want to exit and discard changes? Press 'Cancel' to stay in the app.")) { deactivateAppMode(); history.back(); } } catch (e) { console.error("Error handling back button:", e); } } else { console.log("Browser back button allowed."); } }
        function handleBeforeUnload(event) { if (isAppActive && fishData.length > 0) { const msg = 'You have an unsaved fishing session. Are you sure you want to leave?'; console.log("beforeunload prompt triggered."); event.preventDefault(); event.returnValue = msg; return msg; } else { console.log("beforeunload allowed."); } }

        // --- Session Management ---
        function saveTempSession() { if (!isAppActive && currentPage !== 'splashScreen') return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); console.log("Temp session saved for page:", currentPage); } catch (e) { console.error("Save temp session error:", e); if(e.name === 'QuotaExceededError'){ showToast("Could not save progress: Storage full.", "danger"); }} }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temporary session cleared."); } catch (e) { console.error("Clear temp session error:", e); } }
        function checkRestoreSession() {
            console.log("Checking for restore session...");
            let data; let tempSessionRaw = null;
            try {
                tempSessionRaw = localStorage.getItem('temp_session');
                if (!tempSessionRaw) {
                    console.log("No temp session found.");
                    // Don't navigate here, just let the default splash show
                    return;
                }
                data = JSON.parse(tempSessionRaw);
                if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid temp session format.");
                if (!data.currentAngler && !data.currentDate && !data.currentVenue && data.fishData.length === 0) {
                    console.log("Temp session found but empty, clearing.");
                    clearTempSession();
                    return;
                }
            } catch (e) {
                console.error("Error reading temp session:", e);
                clearTempSession();
                return; // Let default splash show
            }
            // If valid, non-empty session found, show modal OVER the splash
            console.log("Found restorable session content, showing modal.");
            document.getElementById('restoreAngler').textContent=data.currentAngler||'N/A';
            document.getElementById('restoreDate').textContent=data.currentDate?formatDate(data.currentDate):'N/A';
            document.getElementById('restoreFishCount').textContent=data.fishData.length;
            showModal('restoreSessionModal');
        }
        function restoreSession() { /* ... Unchanged ... */ console.log("Restore session initiated."); let temp; try { const sS=localStorage.getItem('temp_session'); if(!sS)throw new Error("No temp session data found."); temp=JSON.parse(sS); if(!temp||!Array.isArray(temp.fishData))throw new Error("Invalid temp session data format."); } catch(e){ console.error("Error restoring session data:",e); showToast("Failed to restore session data. Starting fresh.", "danger"); startNewSession(); return; } fishData=temp.fishData||[]; currentAngler=temp.currentAngler||null; currentDate=temp.currentDate||null; currentVenue=temp.currentVenue||null; currentZone=temp.currentZone||null; currentPeg=temp.currentPeg||null; const page=temp.currentPage||'registrationPage'; isAppActive=temp.isAppActive||false; historyHijacked=temp.historyHijacked||false; const restoredIsCompetition = temp.isCompetition === true; console.log("Restoring state:",{currentAngler, currentDate, currentVenue, currentZone, currentPeg, page, isAppActive, historyHijacked, isCompetition: restoredIsCompetition}); try{ if(currentAngler)document.getElementById('anglerName').value=currentAngler; if(currentDate)document.getElementById('competitionDate').value=currentDate; if(currentVenue)document.getElementById('venueInput').value=currentVenue; document.getElementById('isCompetition').checked=restoredIsCompetition; toggleCompetitionFields(false); if(currentZone)document.getElementById('zoneInput').value=currentZone; if(currentPeg)document.getElementById('pegInput').value=currentPeg; } catch(e) { console.error("Error restoring registration fields:",e); } populateSpeciesDropdown(); if(page==='fishingPage'){ updateFishLog(); } else if(page==='tallyPage'){ populateTallySummaryFields(); populateTallyTable(); } hideModal('restoreSessionModal'); showPage(page); if(isAppActive) { activateAppMode(); console.log("App mode re-activated after restore."); } showToast("Session restored successfully.", "success"); }
        function startNewSession() { /* ... Unchanged ... */ console.log("Start New Session confirmed."); clearTempSession(); resetApp(); hideModal('restoreSessionModal'); startApp(); }

        // --- UI Interaction ---
        function populateSpeciesDropdown() { /* ... Unchanged ... */ }
        function toggleCustomSpeciesInput() { /* ... Unchanged ... */ }
        function toggleCompetitionFields(updateLog = true) { /* ... Unchanged ... */ }
        function setTodaysDate() { /* ... Unchanged ... */ }
        function startApp() { console.log("Start Fishing button clicked -> Registration"); setTodaysDate(); populateSpeciesDropdown(); showPage('registrationPage'); }
        function startRecording() { /* ... Unchanged ... */ }
        // REMOVED handleLengthButtonClick
        function attemptAddFish() { addFish(); }
        function addFish() { /* ... Unchanged - validation logic remains ... */ }
        function handleConfirmPhoto(shouldTakePhoto) { /* ... Unchanged ... */ }
        async function updateFishLog() { /* ... Unchanged ... */ }
        async function loadThumbnail(fishId, imageId) { /* ... Unchanged ... */ }
        async function deleteFish(idx) { /* ... Unchanged ... */ }
        function backFromFishing() { /* ... Unchanged ... */ }

        // --- Camera Functions ---
        async function openCamera(fishId) {
            console.log("Opening camera for fish ID:", fishId);
            currentFishIdForPhoto = fishId;
            const video = document.getElementById('cameraVideo');
            if (!video || !cameraModalInstance) { console.error("Camera video element or modal instance missing!"); showToast("Error: Could not initialize camera view.", "danger"); return; }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showToast("Camera access is not supported by this browser.", "danger"); return; }

            // Stop existing stream before starting new one
            stopCameraStream(); // Ensure any previous stream is stopped

            try {
                const constraints = { video: { facingMode: "environment" } }; // Prefer rear camera
                console.log("Requesting camera stream:", constraints);
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                await video.play();
                cameraModalInstance.show();
                console.log("Rear camera stream started.");
            } catch (err) {
                console.error("Error accessing rear camera:", err);
                if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") { showToast("Camera permission denied.", "warning"); }
                else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError" || err.name === "OverconstrainedError") {
                    console.log("Trying front camera...");
                    try {
                        const frontConstraints = { video: { facingMode: "user" } };
                        currentStream = await navigator.mediaDevices.getUserMedia(frontConstraints);
                        video.srcObject = currentStream;
                        await video.play();
                        cameraModalInstance.show();
                        console.log("Front camera stream started.");
                    } catch (fallbackErr) { console.error("Error accessing front camera:", fallbackErr); showToast(`Could not access any camera. Error: ${fallbackErr.name}`, "danger"); }
                } else { showToast(`Camera error: ${err.name}`, "danger"); }
            }
        }

        function stopCameraStream() {
            if (currentStream) {
                console.log("Stopping camera stream tracks.");
                currentStream.getTracks().forEach(track => track.stop());
            }
            currentStream = null;
            const video = document.getElementById('cameraVideo');
            if (video) video.srcObject = null; // Clear video source
            console.log("Camera stream stopped.");
        }

        async function takeSnapshot() {
            console.log("Attempting to take snapshot...");
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const takePhotoButton = document.getElementById('takePhotoButton');

            if (!video || !canvas || !currentFishIdForPhoto) { console.error("Snapshot failed: Missing video, canvas, or fish ID."); stopCameraStream(); hideModal('cameraModal'); return; }
            if (video.readyState < video.HAVE_METADATA) { console.error("Snapshot failed: Video not ready (readyState=" + video.readyState + ")."); showToast("Camera not ready yet, try again.", "warning"); return; }
            if (takePhotoButton) takePhotoButton.disabled = true; // Disable button

            const MAX_WIDTH = 1280; const MAX_HEIGHT = 1280;
            let width = video.videoWidth; let height = video.videoHeight;

            if (width <= 0 || height <= 0) { console.error(`Snapshot failed: Invalid video dimensions ${width}x${height}.`); showToast("Error reading camera dimensions.", "danger"); stopCameraStream(); hideModal('cameraModal'); if (takePhotoButton) takePhotoButton.disabled = false; return; }

            // --- Calculate Resized Dimensions ---
            if (width > height) { if (width > MAX_WIDTH) { height = Math.round(height * MAX_WIDTH / width); width = MAX_WIDTH; } }
            else { if (height > MAX_HEIGHT) { width = Math.round(width * MAX_HEIGHT / height); height = MAX_HEIGHT; } }
            canvas.width = width; canvas.height = height;

            const context = canvas.getContext('2d');
            console.log(`Drawing image to canvas. Original: ${video.videoWidth}x${video.videoHeight}, Resized: ${width}x${height}`);
            try {
                context.drawImage(video, 0, 0, width, height); // Draw resized image
                console.log("Canvas drawImage successful.");
            } catch (drawError) {
                console.error("Error drawing video to canvas:", drawError);
                showToast("Failed to capture image.", "danger");
                stopCameraStream(); hideModal('cameraModal'); if (takePhotoButton) takePhotoButton.disabled = false;
                return;
            }

            stopCameraStream(); // Stop stream *after* drawing

            canvas.toBlob(async (blob) => {
                if (blob) {
                    const imageId = `img_${currentFishIdForPhoto}_${Date.now()}`;
                    console.log(`Generated Blob (approx ${Math.round(blob.size / 1024)} KB). Saving ID: ${imageId}`);
                    try {
                        const fishIndex = fishData.findIndex(f => f.id === currentFishIdForPhoto);
                        let oldImageId = null;
                        if (fishIndex !== -1) { oldImageId = fishData[fishIndex].imageId; }

                        await saveImageToDb(imageId, blob); // Save the new image

                        if (fishIndex !== -1) {
                            fishData[fishIndex].imageId = imageId; // Update fish data
                            console.log("Updated fishData with new imageId:", fishData[fishIndex]);
                            saveTempSession();
                            updateFishLog(); // Update UI
                        } else {
                            console.error("Could not find fish ID", currentFishIdForPhoto, "to update imageId.");
                        }

                        if (oldImageId && oldImageId !== imageId) { // Delete old image if replaced
                            console.log("Deleting old image:", oldImageId);
                            await deleteImageFromDb(oldImageId);
                        }
                        showToast("Photo saved successfully.", "success");
                    } catch (error) {
                        console.error("Error saving image/deleting old one:", error);
                        showToast("Failed to save photo storage.", "danger");
                    }
                } else {
                    console.error("Canvas toBlob failed to generate blob.");
                    showToast("Failed to process photo data.", "danger");
                }
                hideModal('cameraModal');
                if (takePhotoButton) takePhotoButton.disabled = false; // Re-enable button
                currentFishIdForPhoto = null;
            }, 'image/jpeg', 0.85); // Use quality 0.85
        }

        // --- End Session Modal ---
        function showEndSessionModal() { /* ... Unchanged ... */ }
        function confirmEndSession() { /* ... Unchanged ... */ }

        // --- Tally Page ---
        function populateTallySummaryFields() { /* ... Unchanged ... */ }
        function populateTallyTable() { /* ... Unchanged ... */ }
        function backFromTally() { /* ... Unchanged ... */ }

        // --- Saved Scorecards ---
        function showScorecardsModal() { /* ... Unchanged ... */ }
        async function loadAllScorecardsToCache() { /* ... Unchanged ... */ }
        function filterAndDisplayScorecards() { /* ... Unchanged ... */ }
        function displayRemainingScorecards(filteredScorecards, startIndex) { /* ... Unchanged ... */ }
        const debouncedFilterAndDisplay = debounce(filterAndDisplayScorecards, SEARCH_DEBOUNCE_MS);
        function createScorecardElement (key, data, isLatest) { /* ... Unchanged ... */ }
        async function toggleScorecardDetails(key, headerElement){ /* ... Unchanged ... */ }
        async function loadSessionPhotos(scorecardKey, fishList) { /* ... Unchanged ... */ }
        async function deleteScorecard(key, event){ /* ... Unchanged ... */ }
        function emailScorecard(key, event) { /* ... Unchanged ... */ }

        // --- Notes Modal ---
        function openNotesModal(key, event) { /* ... Unchanged ... */ }
        function saveNoteFromModal() { /* ... Unchanged ... */ }
        function viewNote(key, event) { /* ... Unchanged ... */ }

        // --- Delete Older ---
        function confirmDeleteOlderScorecards() { /* ... Unchanged ... */ }
        async function deleteOlderScorecards() { /* ... Unchanged ... */ }

        // --- Image Viewer/Sharing ---
        async function showFullscreenImage(imageId) { /* ... Unchanged ... */ }
        async function shareImage() { /* ... Unchanged ... */ }

        // --- Modals & Toasts ---
        function hideModal(modalId) { /* ... Unchanged ... */ }
        function showModal(modalId) { /* ... Unchanged ... */ }
        function showToast(message, type = 'info') { /* ... Unchanged ... */ }

        // --- Online/Offline ---
        function updateOnlineStatus() { /* ... Unchanged ... */ }

        // --- App Reset ---
        function resetApp() { /* ... Unchanged ... */ }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM loaded. Initializing App...");
            try {
                 await initDb();
                 console.log("DB initialized.");

                 // Service Worker
                 if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered:', reg.scope)).catch(err => console.error('SW Error:', err)); }); } else { console.log('Service workers not supported.'); }

                 // Network Status
                 window.addEventListener('online', updateOnlineStatus);
                 window.addEventListener('offline', updateOnlineStatus);
                 updateOnlineStatus(); // Initial check

                 // History/Unload
                 window.addEventListener('popstate', handleBackButton);
                 window.addEventListener('beforeunload', handleBeforeUnload);

                 // Cache Refs
                 const refs = {
                     // ... (add specific refs if needed, most listeners use getElementById now)
                     takePhotoButton: document.getElementById('takePhotoButton'),
                     scorecardSearchInput: document.getElementById('scorecardSearchInput'),
                 };

                 // Init Modals
                 try { /* ... Modal Init ... */ const modalIds = ['notesModal', 'cameraModal', 'imageViewerModal', 'confirmPhotoModal', 'restoreSessionModal', 'savedScorecardsModal', 'endSessionModal', 'mlsInfoModal']; modalIds.forEach(id => { const el = document.getElementById(id); if (el) { const instance = bootstrap.Modal.getOrCreateInstance(el); if (id === 'notesModal') notesModalInstance = instance; if (id === 'cameraModal') { cameraModalInstance = instance; el.addEventListener('hidden.bs.modal', stopCameraStream); } if (id === 'imageViewerModal') imageViewerModalInstance = instance; if (id === 'confirmPhotoModal') confirmPhotoModalInstance = instance; } else { console.warn(`WARN: Modal element #${id} not found!`); } }); console.log("Modals initialized."); }
                 catch (modalInitError) { console.error("ERROR initializing modals:", modalInitError); }

                 // Add Event Listeners (using getElementById directly for clarity)
                 const addClickListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('click', handler); else console.warn(`Listener not added: Element #${id} not found for ${handler.name}`); };
                 const addInputListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('input', handler); else console.warn(`Listener not added: Element #${id} not found for ${handler.name}`); };
                 const addChangeListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('change', handler); else console.warn(`Listener not added: Element #${id} not found for ${handler.name}`); };
                 const addKeydownListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('keydown', handler); else console.warn(`Listener not added: Element #${id} not found for ${handler.name}`); };

                 addClickListener('continueBtn', startApp);
                 addClickListener('viewScorecardsBtn', showScorecardsModal);
                 addClickListener('startRecordingBtn', startRecording);
                 addChangeListener('isCompetition', () => { toggleCompetitionFields(); saveTempSession(); });
                 addChangeListener('speciesInput', toggleCustomSpeciesInput);
                 addClickListener('addFishBtn', attemptAddFish);
                 addClickListener('backFromFishingBtn', backFromFishing);
                 addClickListener('endSessionBtn', showEndSessionModal);
                 addClickListener('confirmEndBtn', confirmEndSession);
                 addClickListener('backFromTallyBtn', backFromTally);
                 addClickListener('startNewSessionBtn', () => { if (confirm("Discard unsaved session and start new?")) { startNewSession(); } });
                 addClickListener('restoreSessionBtn', restoreSession);
                 addInputListener('anglerName', () => { currentAngler = document.getElementById('anglerName').value.trim(); saveTempSession(); });
                 addChangeListener('competitionDate', () => { currentDate = document.getElementById('competitionDate').value; saveTempSession(); });
                 addInputListener('venueInput', () => { currentVenue = document.getElementById('venueInput').value.trim(); saveTempSession(); });
                 addChangeListener('zoneInput', () => { currentZone = document.getElementById('isCompetition')?.checked ? document.getElementById('zoneInput').value : null; saveTempSession(); });
                 addChangeListener('pegInput', () => { currentPeg = document.getElementById('isCompetition')?.checked ? document.getElementById('pegInput').value : null; saveTempSession(); });

                 // Enter key on length/initials to add fish
                 const handleEnterKey = (event) => { if (event.key === 'Enter') { event.preventDefault(); attemptAddFish(); } };
                 addKeydownListener('lengthInput', handleEnterKey);
                 addKeydownListener('initialsInput', handleEnterKey);

                 // Scorecard Search
                 addInputListener('scorecardSearchInput', debouncedFilterAndDisplay);

                 // Modal Buttons
                 addClickListener('takePhotoButton', takeSnapshot);
                 addClickListener('cancelCameraButtonHeader', stopCameraStream);
                 addClickListener('confirmPhotoYesBtn', () => handleConfirmPhoto(true));
                 addClickListener('confirmPhotoNoBtn', () => handleConfirmPhoto(false));

                 console.log("Event listeners attached.");

                 // Start App Flow
                 setTodaysDate();
                 showPage('splashScreen'); // Always show splash first
                 checkRestoreSession(); // Then check if restore modal needs to overlay it

                 console.log("App initialization sequence complete.");
            } catch (error) {
                 console.error("FATAL ERROR during initialization:", error);
                 document.body.innerHTML = `<div class="alert alert-danger m-5" role="alert"><strong>App Init Failed!</strong><br>${error.message}<br>See console.</div>`;
            }
        });
    </script>

</body>
</html>
