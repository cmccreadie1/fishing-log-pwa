<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar -->
    <meta name="theme-color" content="#007bff">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- Add other icon sizes if you have them -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed;
            color: #fff; /* Default text color (mostly for splash) */
            min-height: 100vh;
        }
        .container { /* Wrapper for main content cards */
            background: rgba(0, 0, 0, 0.7); /* Dark, semi-transparent wrapper */
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            z-index: 1;
            display: none; /* Hide initially, show based on page */
        }
        .page { display: none; } /* Hide pages by default */

        /* --- Splash Screen --- */
        .splash-screen {
            display: flex; /* Initially shown via JS */
            flex-direction: column; justify-content: flex-end; align-items: center;
            padding: 40px; height: 100vh; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 2;
        }

        /* --- Main Content Card Style (Registration, Fishing, Tally) --- */
        .card-section {
            background: rgba(255, 255, 255, 0.92); /* Slightly more opaque white */
            border-radius: 15px; padding: 25px; margin: 20px 0; /* Increased padding */
            border: 1px solid #dee2e6; /* Lighter border */
            color: #212529; /* Dark text for content */
            z-index: 3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card-section h2 { color: #0056b3; } /* Dark blue headings */
        .card-section h5 { color: #0056b3; }

        /* --- Buttons --- */
        .btn { padding: 12px 24px; font-size: 1.1rem; border-radius: 25px; border: none; margin: 10px; transition: transform 0.2s, background-color 0.2s, border-color 0.2s; cursor: pointer; font-weight: 600; }
        .btn:disabled { cursor: not-allowed; opacity: 0.65; }
        .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; transform: scale(1.05); }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; transform: scale(1.05); }
        .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; transform: scale(1.05); }
        .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; transform: scale(1.05); }
        .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; transform: scale(1.05); color: black;}
        .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; } .btn-outline-secondary:hover { background-color: #6c757d; color: white; }
        .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; } .btn-outline-light:hover { background-color: #f8f9fa; color: #000; }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; border-radius: 20px; font-weight: normal; }
        .btn-lg { padding: 14px 28px; font-size: 1.25rem; }


        /* --- Forms --- */
        .form-label { font-weight: 600; color: #495057; }
        .form-control, .form-select { border-radius: 8px; margin-bottom: 15px; border: 1px solid #ced4da; }
        .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-label { color: #212529; }
        /* Style for Verifier Field in Modal */
        #verifierEndModalSection { display: none; } /* Hide by default */

        /* --- Tables --- */
        .card-section .table { background: white; border-radius: 8px; color: #212529; border: 1px solid #dee2e6; margin-top: 15px; }
        .card-section .table thead { background-color: #f8f9fa; }
        .card-section .table th, .card-section .table td { border-color: #dee2e6; vertical-align: middle; }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(0, 0, 0, 0.03); }
        .card-section .table-bordered { border: 1px solid #dee2e6; }
        .card-section .table-hover tbody tr:hover > * { background-color: rgba(0, 0, 0, 0.06); }

        /* --- Unified Modal Style --- */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; opacity: 0.5; }
        .modal-content { background: #f8f9fa; color: #212529; border: 1px solid #dee2e6; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-header { background-color: #e9ecef; color: #212529; border-bottom: 1px solid #dee2e6; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .modal-footer { background-color: #e9ecef; border-top: 1px solid #dee2e6; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; display: flex; justify-content: flex-end; flex-wrap: wrap; }
        .modal-title { color: #0056b3; font-weight: 700; }
        .modal-header .btn-close { filter: none; background-size: 0.75em; }
        .modal-body { background-color: #ffffff; color: #212529; padding: 20px; }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body { color: #212529 !important; }

        /* --- Saved Scorecards Modal --- */
        #savedScorecardsList.card-section { background: transparent; border: none; padding: 0; margin: 0; }
        #savedScorecardsModal .scorecard-entry { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 15px; background-color: #ffffff; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        #savedScorecardsModal .scorecard-item { cursor: pointer; padding: 12px 15px; border-bottom: 1px solid #dee2e6; color: #212529; transition: background-color 0.2s; }
        #savedScorecardsModal .scorecard-item:hover { background-color: #f8f9fa; }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible { border-bottom: 1px solid #dee2e6; }
        #savedScorecardsModal .scorecard-item i.bi { transition: transform 0.2s ease-in-out; color: #6c757d; }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: #6c757d !important; }
        #savedScorecardsModal .scorecard-details { display: none; padding: 15px; background-color: #ffffff; border-top: none; margin-top: 0; border-radius: 0 0 8px 8px; color: #212529; }
        #savedScorecardsModal .scorecard-details h6 { font-weight: 700; margin-top: 10px; margin-bottom: 8px; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 4px; }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 8px; color: #212529; }
        #savedScorecardsModal .scorecard-details hr { margin-top: 15px; margin-bottom: 15px; border-top: 1px solid #dee2e6; background-color: transparent; height: 1px; opacity: 1; }
        #savedScorecardsModal .scorecard-details .table { margin-bottom: 15px; background-color: #ffffff; color: #212529; border: 1px solid #dee2e6; }
        #savedScorecardsModal .scorecard-details .table thead { background-color: #f8f9fa; color: #495057; }
        #savedScorecardsModal .scorecard-details .table th, #savedScorecardsModal .scorecard-details .table td { border-color: #dee2e6; border-bottom-width: 1px; vertical-align: middle;}
        #savedScorecardsModal .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(0, 0, 0, 0.03); }
        #savedScorecardsModal .scorecard-details .btn-actions-group { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;}
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-right: 5px; }
        #savedScorecardsModal .scorecard-details .btn-danger { color: white !important; }
        #savedScorecardsModal .scorecard-details .btn-info { color: black !important; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry { border: 2px solid #007bff; box-shadow: 0 0 8px rgba(0, 123, 255, 0.3); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item { border-bottom: 1px solid rgba(0, 123, 255, 0.3); background-color: #e7f1ff; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge { background-color: #007bff !important; color: white !important; font-weight: 600; }
        #olderScorecardsToggleContainer { padding-top: 10px; text-align: center;}
        #olderScorecardsToggleContainer .btn { margin: 5px; } /* Add spacing between View Older and Delete Older */


        /* --- Notes Modal --- */
        #notesModal .modal-body textarea { resize: vertical; min-height: 100px; }

        #tallyPage.card-section .table { margin-top: 20px; }
        #tallyPage.card-section .catch-summary-details { margin-bottom: 20px; color: #495057; }
        #tallyPage.card-section tfoot td, #tallyPage.card-section tfoot strong { color: #212529; }
        .table-responsive { margin-bottom: 1rem; }

    </style>
</head>
<body>
    <!-- Container only needed for card sections, not splash -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div class="mb-3">
                 <label for="zoneInput" class="form-label">Zone</label>
                 <select id="zoneInput" class="form-select" disabled>
                    <option value="" selected>Select a zone</option>
                    <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option>
                    <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="pegInput" class="form-label">Peg</label>
                <select id="pegInput" class="form-select" disabled>
                    <option value="" selected>Select a peg</option>
                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option>
                    <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option>
                    <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option>
                    <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option>
                    <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option>
                 </select>
            </div>
            <div class="text-center">
                <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button>
            </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select">
                         <option value="" selected disabled>Select a species</option>
                         <option value="Other">Other (specify)</option>
                    </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-md-4 mb-3">
                     <label for="lengthInput" class="form-label">Length (cm)</label>
                     <input type="number" id="lengthInput" class="form-control" placeholder="Enter length" step="1" min="1">
                </div>
                <div id="initialsInputGroup" class="col-md-4 mb-3" style="display: none;">  <!-- HIDDEN INITIALLY -->
                     <label for="initialsInput" class="form-label">Verifier Initials</label>
                     <input type="text" id="initialsInput" class="form-control" placeholder="Enter Initials (e.g., AB)" maxlength="3" style="text-transform:uppercase">
                </div>
            </div>
            <div class="text-center mb-3">
                <button class="btn btn-primary" id="addFishBtn"><i class="bi bi-plus-circle me-1"></i> Add Fish</button>
                <button class="btn btn-secondary" id="backFromFishingBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button>
            </div>

            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead> <tr> <th>Species</th> <th>Length (cm)</th> <th id="verifiedByHeader" style="display:none;">Verified By</th> <th class="text-end">Action</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>

            <!-- Verifier section removed -->

            <div class="text-center mt-3">
                <button class="btn btn-success" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button>
            </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details">
                 <strong>Angler:</strong> <span id="summaryAngler"></span><br>
                 <strong>Date:</strong> <span id="summaryDate"></span><br>
                 <strong>Venue:</strong> <span id="summaryVenue"></span><br>
                 <strong>Zone:</strong> <span id="summaryZone"></span><br>
                 <strong>Peg:</strong> <span id="summaryPeg"></span><br>
                 <span id="summaryVerifier"></span>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr>
                    </thead>
                    <tbody id="tallyTable"></tbody>
                    <tfoot>
                        <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                        <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                        <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                    </tfoot>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-secondary mb-3" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button>
            </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen (Outside .container) -->
    <div id="splashScreen" class="splash-screen page">
        <div class="text-center">
             <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
             <br>
             <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Restore Session Modal -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true">
         <div class="modal-dialog">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                 <div class="modal-body">
                     An unsaved session was found. Would you like to restore it?
                     <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p>
                     <p><strong>Date:</strong> <span id="restoreDate"></span></p>
                     <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p>
                 </div>

                 <div class="modal-footer d-block text-center">
                     <button type="button" class="btn btn-success btn-lg mb-2" id="restoreSessionBtn">Restore Session</button>
                     <br>
                     <button type="button" class="btn btn-danger" id="startNewSessionBtn">Start New Session</button>
                 </div>
             </div>
         </div>
     </div>

    <!-- Saved Scorecards Modal -->
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                <div class="modal-body">
                    <div id="savedScorecardsList" class="card-section">
                       <p class="placeholder-glow"><span class="placeholder col-12"></span></p> <!-- Placeholder while loading -->
                    </div>
                    <!-- DIV TO HOLD THE "VIEW OLDER" / "DELETE OLDER" BUTTONS -->
                    <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div>
                </div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- End Session Confirmation Modal (UPDATED with Verifier Input) -->
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to end your session? This will save the scorecard.</p>

                    <div id="verifierEndModalSection" class="mt-3" style="display: none;">
                        <hr>
                        <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required>
                        <small class="text-muted">Required for competition scorecards.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Verifier Modal Removed -->

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notesModalLabel">Session Notes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="notesModalScorecardKey">
            <div class="mb-3">
              <label for="notesTextarea" class="form-label">Enter your notes below:</label>
              <textarea class="form-control" id="notesTextarea" rows="5"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveNoteFromModal()">Save Notes</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Application JS -->
    <script>
        // --- Global Variables ---
        const fishCategories = {
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
            "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss, "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ], // Removed Smoothhound
            "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
            "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ], // Added Smoothhound
            "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
        };
        let fishData = [];
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentPage = 'splashScreen';
        let isAppActive = false;
        let historyHijacked = false;
        let notesModalInstance = null;
        // No Verifier Modal Instance needed

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function showPage(pageId) { console.log("Show page:", pageId); document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); const target = document.getElementById(pageId); if (target) { target.style.display = pageId === 'splashScreen' ? 'flex' : 'block'; currentPage = pageId; const container = document.querySelector('.container'); if(container) container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); } else if (pageId === 'splashScreen' && isAppActive) { deactivateAppMode(); } if (pageId !== 'splashScreen') { saveTempSession(); } } else { console.error("Page missing:", pageId, ". Defaulting splash."); const splash = document.getElementById('splashScreen'), container = document.querySelector('.container'); if(splash) splash.style.display = 'flex'; if(container) container.style.display = 'none'; currentPage = 'splashScreen'; deactivateAppMode(); } }

        // --- History/Navigation Control ---
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } }
        function handleBackButton(event) { if (isAppActive) { console.log("popstate intercepted."); history.pushState({ appActive: true }, '', location.href); } else { console.log("popstate allowed."); } }
        function handleBeforeUnload(event) { if (isAppActive) { console.log("beforeunload prompt."); event.preventDefault(); event.returnValue = ''; return ''; } else { console.log("beforeunload allowed."); } }

        // --- Session Management ---
        function saveTempSession() { if (!currentAngler && !currentDate && !currentVenue && fishData.length === 0 && currentPage === 'registrationPage') return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); } catch (e) { console.error("Save temp err:", e); } }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temp cleared."); } catch (e) { console.error("Clear temp err:", e); } }
        function checkRestoreSession() { let data; try { const temp = localStorage.getItem('temp_session'); if (!temp) { showPage('splashScreen'); return; } data = JSON.parse(temp); if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid format."); } catch (e) { console.error("Read temp err:", e); clearTempSession(); showPage('splashScreen'); return; } if (data.currentAngler || data.currentDate || data.currentVenue || data.fishData.length > 0) { console.log("Found session, show modal."); document.getElementById('restoreAngler').textContent=data.currentAngler||'N/A'; document.getElementById('restoreDate').textContent=data.currentDate?formatDate(data.currentDate):'N/A'; document.getElementById('restoreFishCount').textContent=data.fishData.length; const modalEl=document.getElementById('restoreSessionModal'); if(modalEl){let mI=bootstrap.Modal.getInstance(modalEl);if(!mI)mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false}); mI.show();}else{console.error("Restore modal missing.");clearTempSession();showPage('splashScreen');} } else { clearTempSession(); showPage('splashScreen'); } }
        function restoreSession() { console.log("Restore clicked."); let temp; try { const sS=localStorage.getItem('temp_session'); if(!sS)throw new Error("No data."); temp=JSON.parse(sS); if(!temp||!Array.isArray(temp.fishData))throw new Error("Invalid format."); } catch(e){console.error("Restore err:",e);alert("Failed restore.");startNewSession();return;} fishData=temp.fishData||[]; currentAngler=temp.currentAngler||null; currentDate=temp.currentDate||null; currentVenue=temp.currentVenue||null; currentZone=temp.currentZone||null; currentPeg=temp.currentPeg||null; const page=temp.currentPage||'registrationPage'; isAppActive=temp.isAppActive||false; historyHijacked=temp.historyHijacked||false; const restoredIsCompetition = temp.isCompetition === true; // Get competition status from saved session
        console.log("Restoring to:",page,"App active:",isAppActive, "Is Competition:", restoredIsCompetition);
        try{
            if(currentAngler)document.getElementById('anglerName').value=currentAngler;
            if(currentDate)document.getElementById('competitionDate').value=currentDate;
            if(currentVenue)document.getElementById('venueInput').value=currentVenue;
            document.getElementById('isCompetition').checked=restoredIsCompetition; // Set checkbox based on restored status
            toggleCompetitionFields(); // Update fields based on restored competition status
            if(currentZone)document.getElementById('zoneInput').value=currentZone;
            if(currentPeg)document.getElementById('pegInput').value=currentPeg;
        }catch(e){console.error("Restore reg fields err:",e);}
        if(page==='fishingPage'||page==='tallyPage'){populateSpeciesDropdown(); if(page==='fishingPage'){updateFishLog();}else if(page==='tallyPage'){populateTallySummaryFields();populateTallyTable();}} hideModal('restoreSessionModal'); showPage(page); if(isAppActive && !historyHijacked){history.pushState({appActive:true},'',location.href); historyHijacked=true; console.log("Pushed history after restore.");} console.log("Session restored."); }


        function startNewSession() {
            // Confirmation logic moved to the event listener
            console.log("Start New Session confirmed after prompt.");
            clearTempSession(); resetApp(); hideModal('restoreSessionModal'); showPage('splashScreen');
        }

        // --- UI Interaction ---
        function populateSpeciesDropdown() { const input=document.getElementById('speciesInput'); if(!input) {console.error("Species dropdown missing!"); return;} const cats=Object.keys(fishCategories).sort(); input.innerHTML='<option value="" selected disabled>Select species</option><option value="Other">Other</option>'; cats.forEach(cat=>{const group=document.createElement('optgroup'); group.label=cat; const species=[...fishCategories[cat]].sort(); species.forEach(s=>{const opt=document.createElement('option'); opt.value=s; opt.textContent=s; group.appendChild(opt);}); input.appendChild(group);}); console.log("Species dropdown populated."); }
        function toggleCustomSpeciesInput() { const sel=document.getElementById('speciesInput'), custom=document.getElementById('customSpeciesInput'); if(!sel||!custom)return; custom.style.display=sel.value==='Other'?'block':'none'; if(sel.value!=='Other')custom.value=''; }
        function toggleCompetitionFields() {
            try{
                const check=document.getElementById('isCompetition').checked;
                const zone=document.getElementById('zoneInput');
                const peg=document.getElementById('pegInput');
                const initialsGroup = document.getElementById('initialsInputGroup'); // Get the initials input group
                const initialsInput = document.getElementById('initialsInput'); // Get the initials input field
                const verifiedByHeader = document.getElementById('verifiedByHeader'); // Get the "Verified By" header

                zone.disabled=!check; peg.disabled=!check;
                initialsGroup.style.display = check ? 'block' : 'none'; // Show/hide initials input
                verifiedByHeader.style.display = check ? 'table-cell' : 'none'; // Show/hide "Verified By" column header

                if(!check){
                    zone.value='';peg.value='';currentZone=null;currentPeg=null;
                    if (initialsInput) initialsInput.value = ''; // Clear initials input if competition is unchecked
                }
                updateFishLog(); // Re-render fish log to show/hide "Verified By" column
            }catch(e){console.error("Toggle comp fields err:",e);}
        }

        function startApp() { console.log("Start Fishing."); populateSpeciesDropdown(); showPage('registrationPage'); }
        function startRecording() { console.log("Record Catch."); const nameEl=document.getElementById('anglerName'), dateEl=document.getElementById('competitionDate'), venueEl=document.getElementById('venueInput'), checkEl=document.getElementById('isCompetition'), zoneEl=document.getElementById('zoneInput'), pegEl=document.getElementById('pegInput'); if(!nameEl||!dateEl||!venueEl||!checkEl||!zoneEl||!pegEl){alert("Form elements missing.");return;} const name=nameEl.value.trim(), date=dateEl.value, venue=venueEl.value.trim(), isComp=checkEl.checked, zone=zoneEl.value, peg=pegEl.value; if(!name||!date||!venue){alert("Name, Date, Venue required.");return;} if(isComp&&(!zone||!peg)){alert("Zone & Peg required for competition.");return;} if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){alert("Valid date required.");return;} currentAngler=name; currentDate=date; currentVenue=venue; currentZone=isComp?zone:null; currentPeg=isComp?peg:null; const isActuallyCompetition = !!(currentZone && currentPeg); console.log("Start recording data:",{currentAngler,currentDate,currentVenue,currentZone,currentPeg,isCompetition:isActuallyCompetition}); saveTempSession(); updateFishLog(); showPage('fishingPage'); }
        function addFish() {
            console.log("Add Fish.");
            const spEl=document.getElementById('speciesInput');
            const custEl=document.getElementById('customSpeciesInput');
            const lenEl=document.getElementById('lengthInput');
            const initialsEl = document.getElementById('initialsInput');
            const isCompetition = document.getElementById('isCompetition').checked; // Check competition status

            if(!spEl||!custEl||!lenEl){alert("Add fish elements missing.");return;}
            let species=spEl.value;
            const lenVal=lenEl.value.trim();
            let length;
            let initials = null; // Initialize initials to null for non-competition

            if(!lenVal){alert("Length required.");return;}
            length=Math.round(parseFloat(lenVal));
            if(isNaN(length)||length<=0||length>500){alert("Valid length (1-500cm) required.");return;}
            if(species==='Other'){species=custEl.value.trim();if(!species){alert("Custom species name required.");return;}if(!/^[a-zA-Z\s'-]+$/.test(species)){alert("Invalid species chars.");return;}}else if(!species){alert("Select species.");return;}

            if (isCompetition && initialsEl) { // Only get initials if it's a competition and input exists
                initials = initialsEl.value.trim().toUpperCase();
            }

            fishData.push({species, length, initials: initials || null}); // Store initials, null if not competition or empty
            console.log("Added:",{species,length, initials});
            updateFishLog(); spEl.value='';custEl.value='';lenEl.value=''; if(initialsEl) initialsEl.value=''; toggleCustomSpeciesInput();saveTempSession();
        }


        function updateFishLog() {
            const log=document.getElementById('fishLog');
            const isCompetition = document.getElementById('isCompetition').checked; // Check competition status
            const verifiedByHeader = document.getElementById('verifiedByHeader'); // Get the "Verified By" header

            if(!log) return;

            verifiedByHeader.style.display = isCompetition ? 'table-cell' : 'none'; // Show/hide header

            log.innerHTML = fishData.map((f,i)=> {
                let verifiedByCell = '';
                if (isCompetition) {
                    verifiedByCell = `<td>${f.initials || '-'}</td>`; // Display initials if competition, or '-' if null/empty
                }
                return `<tr><td>${f.species||'?'}</td><td>${f.length||'?'}</td>${verifiedByCell}<td class="text-end"><button class="btn btn-danger btn-sm" onclick="deleteFish(${i})"><i class="bi bi-trash"></i></button></td></tr>`;
            }).join('');
        }


        function deleteFish(idx){
            if(idx>=0&&idx<fishData.length){
                const{species,length, initials}=fishData[idx];
                const isCompetition = document.getElementById('isCompetition').checked;
                let confirmMessage = `Delete ${species||'?'} (${length||'?'}cm)?`;
                if (isCompetition && initials) {
                    confirmMessage = `Delete ${species||'?'} (${length||'?'}cm) verified by ${initials}?`;
                }
                if(confirm(confirmMessage)){
                    console.log("Deleting:",idx);
                    fishData.splice(idx,1);
                    updateFishLog();
                    saveTempSession();
                }
            }else{console.error("Invalid delete idx:",idx);}
        }
        function backFromFishing() { console.log("Back from Fishing."); showPage('registrationPage'); }

        // *** UPDATED: Shows the single confirmation modal, adjusts visibility of verifier inside ***
        function showEndSessionModal() {
            console.log("End Session button clicked.");
            const modalEl = document.getElementById('endSessionModal');
            const verifierSection = document.getElementById('verifierEndModalSection');
            const verifierInput = document.getElementById('verifierEndModalInput');

            if (!modalEl || !verifierSection || !verifierInput) {
                console.error("End session modal or its verifier elements missing!");
                alert("Error preparing end session dialog.");
                return;
            }

            // Check competition status and show/hide verifier section within the modal
            const isCompetition = !!(currentZone && currentPeg);
            if (isCompetition) {
                console.log("Setting up modal for Competition save.");
                verifierSection.style.display = 'block';
                verifierInput.value = ''; // Clear previous input
            } else {
                console.log("Setting up modal for Non-Competition save.");
                verifierSection.style.display = 'none';
                verifierInput.value = ''; // Clear just in case
            }

            // Show the single modal
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl, {backdrop: 'static', keyboard: false});
            modalInstance.show();
        }

        // *** UPDATED: Handles single confirm button, includes conditional verifier check ***
        function confirmEndSession() {
            console.log("Confirm End button clicked.");

            // 1. Basic Data Validation (Globals)
            if (!currentAngler || !currentDate || !currentVenue) {
                alert("Cannot save session: Missing Angler Name, Date, or Venue information.");
                hideModal('endSessionModal'); // Hide modal before navigating
                showPage('registrationPage');
                return;
            }

            const isCompetition = !!(currentZone && currentPeg);
            let verifierName = null;

            // 2. Competition Verifier Validation (If applicable)
            if (isCompetition) {
                 const verifierInput = document.getElementById('verifierEndModalInput');
                 if (!verifierInput) {
                     console.error("Verifier input missing inside modal during save!");
                     alert("Error: Verifier field is missing. Cannot save competition scorecard.");
                     return; // Stop saving
                 }
                 verifierName = verifierInput.value.trim();
                 if (!verifierName) {
                     alert("Competition Scorecard: Please enter the verifier's name in the modal.");
                     verifierInput.focus(); // Keep focus in modal
                     return; // Stop saving, keep modal open
                 }
            }

            // 3. Hide modal *before* attempting save
            hideModal('endSessionModal');

            // 4. Prepare and Save Data
            console.log("Validation passed. Proceeding to save data with verifier:", verifierName);
            const sessionData = {
                currentAngler, currentDate, currentVenue, currentZone, currentPeg,
                verifier: verifierName, // Will be null if not competition or invalid
                notes: null, // Initialize notes field
                fishData: fishData || [],
                isCompetition: isCompetition // Save competition status with the scorecard
            };
            const id = `scorecard_${Date.now()}`;
            try {
                localStorage.setItem(id, JSON.stringify(sessionData));
                console.log("Saved:", id, sessionData);
                alert("Scorecard saved successfully!");
                clearTempSession();
                resetApp(); // This includes deactivateAppMode()
                showPage('splashScreen');
            } catch(e) {
                console.error("Save err:", e);
                alert("Save failed. Local storage might be full or disabled.");
                showPage('fishingPage'); // Stay on fishing page on failure
            }
        }
        // Removed confirmEndSessionWithVerifier and saveScorecardData functions

        // --- Tally Page ---
        function populateTallySummaryFields() { try{document.getElementById('summaryAngler').textContent=currentAngler||'?'; document.getElementById('summaryDate').textContent=currentDate?formatDate(currentDate):'?'; document.getElementById('summaryVenue').textContent=currentVenue||'?'; document.getElementById('summaryZone').textContent=currentZone||'?'; document.getElementById('summaryPeg').textContent=currentPeg||'?'; document.getElementById('summaryVerifier').innerHTML = '';}catch(e){} }
        function populateTallyTable() { const table=document.getElementById('tallyTable'); if (!table)return; const sum={}; let tL=0, lF=null; fishData.forEach(f=>{const sK=f.species||"?";const l=f.length||0; sum[sK]=sum[sK]||{c:0,tL:0,l:[]}; sum[sK].c++;sum[sK].tL+=l;sum[sK].l.push(l); tL+=l; if(!lF||l>(lF.length||0))lF=f;}); Object.values(sum).forEach(d=>d.l.sort((a,b)=>a-b)); const sorted=Object.entries(sum).sort(([a],[b])=>a.localeCompare(b)); table.innerHTML=sorted.map(([s,d])=>`<tr><td>${s}</td><td>${d.c}</td><td>(${d.l.join(', ')})</td><td>${d.tL}</td></tr>`).join('')||'<tr><td colspan="4" class="text-center">No fish.</td></tr>'; document.getElementById('tallyTotalLength').textContent=`${tL} cm`; document.getElementById('tallySpeciesCount').textContent=Object.keys(sum).length; document.getElementById('longestFishSpecies').textContent=lF?(lF.species||'?'):'N/A'; document.getElementById('longestFishLength').textContent=lF?`${lF.length||'?'} cm`:'0 cm';}
        function backFromTally() { console.log("Back from Tally."); showPage('fishingPage'); }

        // --- Saved Scorecards ---
        function showScorecardsModal() { console.log("View Scorecards."); const modalEl=document.getElementById('savedScorecardsModal'), listEl=document.getElementById('savedScorecardsList'); if(modalEl&&listEl){listEl.innerHTML='<div class="text-center p-3"><div class="spinner-border text-primary"><span class="visually-hidden">Load...</span></div></div>'; let mI=bootstrap.Modal.getInstance(modalEl);if(!mI)mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false});mI.show();setTimeout(loadScorecards,50);}else{console.error("Scorecard modal/list missing.");alert("Err show modal.");}}

        function loadScorecards() {
            console.log("Loading scorecards...");
            const savedScorecardsList = document.getElementById('savedScorecardsList');
            const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer');
             if (!savedScorecardsList) { console.error("CRITICAL: savedScorecardsList element not found!"); const mb = document.getElementById('savedScorecardsModal')?.querySelector('.modal-body'); if(mb) mb.innerHTML = '<p class="text-danger">Error: List container missing.</p>'; return; }
             if (!olderScorecardsToggleContainer) { console.error("CRITICAL: olderScorecardsToggleContainer element not found!"); }

            savedScorecardsList.innerHTML = ''; if(olderScorecardsToggleContainer) olderScorecardsToggleContainer.innerHTML = '';
            const scorecards = []; let loadError = false;

            try { for (let i=0; i<localStorage.length; i++){ const key=localStorage.key(i); if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ try { const data=JSON.parse(dS); if(data?.currentAngler && data.currentDate && data.currentVenue){ const tS=parseInt(key.split('_')[1],10); if(!isNaN(tS)){scorecards.push({key,data,timestamp:tS});}} else {console.warn("Skip invalid card:",key);}} catch(e){console.error("Parse err:",key,e);}}}}}
            catch (e) { console.error("LS err:",e); savedScorecardsList.innerHTML='<p class="text-danger p-3">Load failed.</p>'; loadError=true; }
            if(loadError) return;

            scorecards.sort((a,b)=>b.timestamp-a.timestamp);
            if (scorecards.length===0){ savedScorecardsList.innerHTML='<p class="text-center p-3">No saved scorecards.</p>'; return; }
            console.log(`Total scorecards found: ${scorecards.length}`);

            const displayLimit = 4;
            const createScorecardElement = (key, data, isLatest) => {
                 try {
                     const w = document.createElement('div');
                     w.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`;
                     let tL = 0, fC = 0, sp = new Set(), lF = null;
                     const fish = data.fishData || [];
                     fish.forEach(f => { const l = f.length || 0; fC++; tL += l; if (f.species) sp.add(f.species); if (!lF || l > (lF.length || 0)) lF = f; });
                     const spC = sp.size;
                     const lFS = lF ? `${lF.species || '?'}(${lF.length || '?'}cm)` : 'N/A';
                     const eK = key.replace(/'/g, "\\'");

                     const viewNoteButtonHtml = (data.notes && data.notes.trim() !== '')
                        ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${eK}', event)"><i class="bi bi-eye me-1"></i>View Note</button>`
                        : '';

                     let catchTableHTML = '<p>No fish.</p>';
                     if (fish.length > 0) {
                         const verifiedHeader = data.isCompetition ? '<th>Verified</th>' : ''; // Conditional header
                         const fishRows = fish.map((f, i) => {
                             const verifiedCell = data.isCompetition ? `<td>${f.initials || '-'}</td>` : ''; // Conditional cell
                             return `<tr><td>${i + 1}</td><td>${f.species || '?'}</td><td>${f.length || '?'}</td>${verifiedCell}</tr>`;
                         }).join('');
                         catchTableHTML = `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>#</th><th>Species</th><th>Len(cm)</th>${verifiedHeader}</tr></thead><tbody>${fishRows}</tbody></table></div>`;
                     }


                     w.innerHTML = `<div class="scorecard-item" onclick="toggleScorecardDetails('${eK}',this)"><i class="bi bi-chevron-right me-2"></i><strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')} <span class="text-muted ms-2">(${fC} fish, ${tL}cm)</span> ${isLatest ? '<span class="badge ms-2">Latest</span>' : ''}</div>
                        <div class="scorecard-details" id="details_${key}">
                            <h6>Session Details</h6>
                            <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p>
                            <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p>
                            <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p>
                            ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''}
                            ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''}
                            ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''}
                            <hr>
                            <h6>Catch (${fC})</h6>
                            ${catchTableHTML}
                            ${fish.length > 0 ? `<hr><h6>Summary</h6><p><strong>Total Len:</strong> ${tL}cm</p><p><strong>Species:</strong> ${spC}</p><p><strong>Longest:</strong> ${lFS}</p>` : ''}

                            <div class="btn-actions-group">
                                ${viewNoteButtonHtml}
                                <button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${eK}', event)"><i class="bi bi-pencil me-1"></i>Add/Edit Note</button>
                                <button class="btn btn-info btn-sm" onclick="emailScorecard('${eK}', event)"><i class="bi bi-envelope me-1"></i>Email</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${eK}', event)"><i class="bi bi-trash me-1"></i>Delete</button>
                            </div>
                        </div>`;
                     return w;
                 } catch (elementError) {
                     console.error(`Err create el for ${key}:`, elementError);
                     const errDiv = document.createElement('div');
                     errDiv.className = 'alert alert-warning p-2 my-2';
                     errDiv.textContent = `Err display card ${key.slice(-4)}`;
                     return errDiv;
                 }
             }; // End of createScorecardElement


            try { console.log(`Slicing initial (0 to ${displayLimit})`); const initial = scorecards.slice(0, displayLimit); console.log(`Displaying ${initial.length} initial.`); initial.forEach(({ key, data }, index) => { const el = createScorecardElement(key, data, index === 0); if (el) savedScorecardsList.appendChild(el); }); }
            catch(e) { console.error("Err initial loop:", e); savedScorecardsList.innerHTML += '<p class="text-danger p-3">Err display initial.</p>'; }

            console.log(`Check need Older button: ${scorecards.length} > ${displayLimit}?`);
            if (scorecards.length > displayLimit) {
                 console.log("Condition MET: Creating 'Older' buttons."); // Plural
                 if (!olderScorecardsToggleContainer) { console.error("Cannot create 'Older' buttons - container missing!"); return; }
                 const olderCount = scorecards.length - displayLimit;

                 // Create View Older Button
                 const showOlderBtn = document.createElement('button');
                 showOlderBtn.id = 'showOlderBtn';
                 showOlderBtn.className = 'btn btn-outline-secondary'; // Use className
                 showOlderBtn.textContent = `View ${olderCount} Older Scorecard${olderCount > 1 ? 's' : ''}`;
                 showOlderBtn.onclick = function() { console.log("'Older' clicked."); try { const older = scorecards.slice(displayLimit); console.log(`Appending ${older.length} older.`); older.forEach(({ key, data }) => { const el = createScorecardElement(key, data, false); if (el) savedScorecardsList.appendChild(el); }); olderScorecardsToggleContainer.innerHTML = ''; console.log("Older appended, buttons removed."); } catch(e) { console.error("Err create/append older:", e); olderScorecardsToggleContainer.innerHTML = '<p class="text-danger">Err display older.</p>'; } };
                 olderScorecardsToggleContainer.appendChild(showOlderBtn);
                 console.log("'View Older' button added.");

                 // Create Delete Older Button
                 const deleteOlderBtn = document.createElement('button');
                 deleteOlderBtn.id = 'deleteOlderBtn';
                 deleteOlderBtn.className = 'btn btn-danger'; // Use className, red button
                 deleteOlderBtn.textContent = 'Delete Older Scorecards';
                 deleteOlderBtn.onclick = confirmDeleteOlderScorecards; // Assign new confirmation function
                 olderScorecardsToggleContainer.appendChild(deleteOlderBtn);
                 console.log("'Delete Older' button added.");

            } else {
                 console.log("Condition NOT MET: No 'Older' buttons needed.");
            }
        } // End of loadScorecards


        function toggleScorecardDetails(key, element){console.log("Toggle:",key); const d=document.getElementById(`details_${key}`), i=element.querySelector('i.bi'); if(d){const v=d.style.display==='block'; d.style.display=v?'none':'block'; if(i){i.classList.toggle('bi-chevron-right',v);i.classList.toggle('bi-chevron-down',!v);} element.classList.toggle('details-visible',!v);}else{console.error("Details missing:",key);}}
        function deleteScorecard(key, event){event.stopPropagation(); console.log("Delete:",key); let sN=`card ${key.slice(-6)}`; try{const d=JSON.parse(localStorage.getItem(key)||'{}'); sN=`card for ${d.currentAngler||'?'} on ${formatDate(d.currentDate||'')}`;}catch(e){} if(confirm(`Delete ${sN}? Cannot undo.`)){try{localStorage.removeItem(key);console.log("Deleted:",key);loadScorecards();}catch(e){console.error("Delete err:",e);alert("Failed delete.");}}else{console.log("Delete cancel.");}}

        function emailScorecard(key, event) {
            event.stopPropagation(); console.log("Emailing:", key);
            alert("This will open your default email app. Notes are NOT included.");

            let data; try { const dS = localStorage.getItem(key); if (!dS) throw new Error("Not found."); data = JSON.parse(dS); if (!data?.currentAngler || !data.currentDate || !data.currentVenue || !Array.isArray(data.fishData)) throw new Error("Invalid data."); } catch (error) { console.error("Email data err:", error); alert(`Error getting data: ${error.message}`); return; }
            let body = "Sea Catch Scorecard\r\n=====================\r\n\r\n";
            body += "Session Details:\r\n"; body += `Angler: ${data.currentAngler||'?'}\r\n`; body += `Date: ${formatDate(data.currentDate||'')}\r\n`; body += `Venue: ${data.currentVenue||'?'}\r\n`; if(data.currentZone)body+=`Zone: ${data.currentZone}\r\n`; if(data.currentPeg)body+=`Peg: ${data.currentPeg}\r\n`; if(data.verifier)body+=`Verified By: ${data.verifier}\r\n`; body += "\r\n";
            body += "Catch List:\r\n"; if(data.fishData?.length>0){data.fishData.forEach((f,i)=>{body+=`${i+1}. ${f.species||'?'} - ${f.length||'?'} cm`; if(data.isCompetition) { body += ` - Verified by: ${f.initials || '-'}`;} body += `\r\n`;});}else{body+="No fish.\r\n";} body+="\r\n";
            let tL=0,fC=0,sp=new Set(),lF=null; const fish=data.fishData||[]; fish.forEach(f=>{const l=f.length||0;fC++;tL+=l;if(f.species)sp.add(f.species);if(!lF||l>(lF.length||0))lF=f;}); const spC=sp.size; const lFS=lF?`${lF.species||'?'}(${lF.length||'?'}cm)`:'N/A';
            body += "Summary:\r\n"; body += `Total Fish: ${fC}\r\n`; body += `Total Length: ${tL} cm\r\n`; body += `Unique Species: ${spC}\r\n`; body += `Longest Fish: ${lFS}\r\n\r\n=====================\r\n`;
            const subject = `Fishing Scorecard: ${data.currentVenue||'?'} - ${formatDate(data.currentDate||'')}`;
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            if(mailtoUrl.length>1800){console.warn(`Mailto long (${mailtoUrl.length})`); alert("Warning: Scorecard long.");}
            console.log("Mailto len:", mailtoUrl.length); try{window.open(mailtoUrl,'_self');}catch(e){console.error("Mailto err:",e);alert("Could not open email client.");}
        }

        // --- Notes Modal Functions ---
        function openNotesModal(key, event) { if(event) event.stopPropagation(); console.log('Opening notes modal for key:', key); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { console.error('Notes modal elements/instance missing!'); alert('Error opening notes editor.'); return; } try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; notesTextarea.value=data.notes||''; } catch(e){ console.error('Error loading notes for modal:',e); notesTextarea.value=''; } notesModalKeyInput.value = key; notesModalInstance.show(); }
        function saveNoteFromModal() { console.log('Save notes modal clicked.'); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { alert('Error saving notes.'); return; } const key = notesModalKeyInput.value; const newNotes = notesTextarea.value; if (!key) { alert('Error: Scorecard key missing.'); return; } try { const dS = localStorage.getItem(key); if (!dS) throw new Error('Scorecard data not found.'); let data = JSON.parse(dS); data.notes = newNotes; localStorage.setItem(key, JSON.stringify(data)); console.log('Notes saved via modal for key:', key); notesModalInstance.hide(); setTimeout(loadScorecards, 150); } catch (e) { console.error('Error saving notes from modal:', e); alert(`Failed to save notes: ${e.message}`); } }
        function viewNote(key, event) { event.stopPropagation(); console.log('Viewing notes for key:', key); try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; const notes=data.notes||''; alert(`Notes for scorecard:\n--------------------\n${notes || '(No notes saved)'}`); } catch (e) { console.error('Error retrieving notes:', e); alert('Could not retrieve notes.'); } }
        // --- End Notes Functions ---

        // --- Delete Older Scorecards Functions ---
        function confirmDeleteOlderScorecards() {
            const displayLimit = 4; // Keep consistent
            const scorecards = [];
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('scorecard_')) scorecards.push(key);
                }
            } catch (e) { alert('Error reading scorecards for deletion count.'); return; }

            scorecards.sort((a, b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1])); // Sort by timestamp desc

            if (scorecards.length > displayLimit) {
                 const olderCount = scorecards.length - displayLimit;
                 if (confirm(`Are you sure you want to delete the oldest ${olderCount} scorecard${olderCount > 1 ? 's' : ''}? This cannot be undone.`)) {
                     deleteOlderScorecards();
                 } else {
                     console.log("Delete older scorecards cancelled.");
                 }
            } else {
                 alert("No older scorecards found to delete (less than 5 total).");
            }
        }

        function deleteOlderScorecards() {
            console.log("Deleting older scorecards...");
            const displayLimit = 4;
            const scorecards = [];
             let errorOccurred = false;
            try {
                // Fetch all scorecard keys
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('scorecard_')) {
                        const timestamp = parseInt(key.split('_')[1], 10);
                        if (!isNaN(timestamp)) {
                             scorecards.push({ key, timestamp });
                        }
                    }
                }
                // Sort by timestamp, newest first
                scorecards.sort((a, b) => b.timestamp - a.timestamp);

                // Identify keys to delete (skip the first 'displayLimit')
                const keysToDelete = scorecards.slice(displayLimit).map(item => item.key);

                if (keysToDelete.length > 0) {
                    console.log(`Attempting to delete ${keysToDelete.length} older scorecards:`, keysToDelete);
                    keysToDelete.forEach(key => {
                         try {
                             localStorage.removeItem(key);
                             console.log(`Deleted: ${key}`);
                         } catch (removeError) {
                              console.error(`Error removing key ${key}:`, removeError);
                              errorOccurred = true; // Mark that an error happened
                         }
                    });

                    if (errorOccurred) {
                         alert("Some older scorecards may not have been deleted due to an error. Please check the list.");
                    } else {
                         alert(`${keysToDelete.length} older scorecard${keysToDelete.length > 1 ? 's' : ''} deleted successfully.`);
                    }
                } else {
                    console.log("No older scorecards found to delete after re-check.");
                    // No need to alert if nothing to delete
                }

            } catch (e) {
                console.error("Error during the delete older process:", e);
                alert("An error occurred while trying to delete older scorecards.");
                errorOccurred = true;
            } finally {
                 // Always reload the list to reflect changes or errors
                 loadScorecards();
            }
        }
        // --- End Delete Older Scorecards ---


        // --- General Modal Hiding/Showing ---
        function hideModal(modalId) { const mE=document.getElementById(modalId); if(mE){const m=bootstrap.Modal.getInstance(mE); if(m){m.hide();}else{mE.classList.remove('show');mE.style.display='none';const b=document.querySelector('.modal-backdrop');if(b)b.remove();document.body.classList.remove('modal-open');document.body.style.overflow='';document.body.style.paddingRight='';}}}
        function showModal(modalId) { const modalElement = document.getElementById(modalId); if(modalElement) { const instance = bootstrap.Modal.getOrCreateInstance(modalElement, {backdrop: 'static', keyboard: false}); instance.show(); } else { console.error(`Modal element #${modalId} not found!`); } }

        // --- Application Reset ---
        function resetApp() {
            console.log("Resetting app.");
            fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null; currentPage='splashScreen';
            deactivateAppMode();
            try {
               document.getElementById('anglerName').value=''; document.getElementById('competitionDate').value=''; document.getElementById('venueInput').value=''; document.getElementById('isCompetition').checked=false; toggleCompetitionFields(); document.getElementById('zoneInput').value=''; document.getElementById('pegInput').value=''; document.getElementById('speciesInput').value=''; document.getElementById('customSpeciesInput').value=''; document.getElementById('customSpeciesInput').style.display='none'; document.getElementById('lengthInput').value=''; document.getElementById('initialsInput').value=''; document.getElementById('fishLog').innerHTML='';
               // Clear and hide verifier input inside modal
               const vI = document.getElementById('verifierEndModalInput'); if(vI) vI.value='';
               const vS = document.getElementById('verifierEndModalSection'); if(vS) vS.style.display='none';
               populateTallySummaryFields(); document.getElementById('tallyTable').innerHTML=''; document.getElementById('tallyTotalLength').textContent='0 cm'; document.getElementById('tallySpeciesCount').textContent='0'; document.getElementById('longestFishSpecies').textContent='N/A'; document.getElementById('longestFishLength').textContent='0 cm';
            } catch(e) { console.error("Error resetting forms:", e); }
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded.");
            try {
                 // --- Service Worker Registration ---
                 if ('serviceWorker' in navigator) {
                     window.addEventListener('load', () => {
                         navigator.serviceWorker.register('/Sea-Catch-Scorer/sw.js') // <<< EDIT THIS PATH!!!
                             .then(reg => console.log('SW registered scope: ', reg.scope))
                             .catch(err => console.error('SW registration failed: ', err));
                     });
                 } else { console.log('Service workers not supported.'); }
                 // --- End Service Worker Registration ---

                 window.addEventListener('popstate', handleBackButton); window.addEventListener('beforeunload', handleBeforeUnload); console.log("Nav listeners attached.");
                 const refs = { continueBtn: document.getElementById('continueBtn'), viewScorecardsBtn: document.getElementById('viewScorecardsBtn'), startRecordingBtn: document.getElementById('startRecordingBtn'), isCompetitionCheck: document.getElementById('isCompetition'), speciesSelect: document.getElementById('speciesInput'), addFishBtn: document.getElementById('addFishBtn'), backFromFishingBtn: document.getElementById('backFromFishingBtn'), endSessionBtn: document.getElementById('endSessionBtn'), confirmEndBtn: document.getElementById('confirmEndBtn'), backFromTallyBtn: document.getElementById('backFromTallyBtn'), closeModalBtn: document.getElementById('closeModalBtn'), restoreSessionBtn: document.getElementById('restoreSessionBtn'), startNewSessionBtn: document.getElementById('startNewSessionBtn'), anglerNameInput: document.getElementById('anglerName'), competitionDateInput: document.getElementById('competitionDate'), venueInput: document.getElementById('venueInput'), zoneSelect: document.getElementById('zoneInput'), pegSelect: document.getElementById('pegInput'), initialsInput: document.getElementById('initialsInput'), initialsInputGroup: document.getElementById('initialsInputGroup'), verifiedByHeader: document.getElementById('verifiedByHeader') };
                 // Add listeners checking if ref exists
                 if (refs.continueBtn) refs.continueBtn.addEventListener('click', startApp);
                 if (refs.viewScorecardsBtn) refs.viewScorecardsBtn.addEventListener('click', showScorecardsModal);
                 if (refs.startRecordingBtn) refs.startRecordingBtn.addEventListener('click', startRecording);
                 if (refs.isCompetitionCheck) refs.isCompetitionCheck.addEventListener('change', () => { toggleCompetitionFields(); saveTempSession(); });
                 if (refs.speciesSelect) refs.speciesSelect.addEventListener('change', toggleCustomSpeciesInput);
                 if (refs.addFishBtn) refs.addFishBtn.addEventListener('click', addFish);
                 if (refs.backFromFishingBtn) refs.backFromFishingBtn.addEventListener('click', backFromFishing);
                 if (refs.endSessionBtn) refs.endSessionBtn.addEventListener('click', showEndSessionModal); // Reverted listener target
                 if (refs.confirmEndBtn) refs.confirmEndBtn.addEventListener('click', confirmEndSession); // Reverted listener target
                 // Removed verifier modal button listener
                 if (refs.backFromTallyBtn) refs.backFromTallyBtn.addEventListener('click', backFromTally);
                 // *** UPDATED listener for Start New Session Button ***
                 if (refs.startNewSessionBtn) {
                      refs.startNewSessionBtn.addEventListener('click', function() {
                            if (confirm("Starting a new session will discard the currently unsaved session data. Are you sure?")) {
                                console.log("User confirmed discarding session.");
                                startNewSession(); // Proceed only if user clicks OK
                            } else {
                                console.log("User cancelled discarding session.");
                            }
                      });
                 } else {
                      console.error("Missing: startNewSessionBtn");
                 }
                 if (refs.restoreSessionBtn) refs.restoreSessionBtn.addEventListener('click', restoreSession);
                 // Input listeners
                 if (refs.anglerNameInput) refs.anglerNameInput.addEventListener('input', () => { currentAngler = refs.anglerNameInput.value.trim(); saveTempSession(); });
                 if (refs.competitionDateInput) refs.competitionDateInput.addEventListener('change', () => { currentDate = refs.competitionDateInput.value; saveTempSession(); });
                 if (refs.venueInput) refs.venueInput.addEventListener('input', () => { currentVenue = refs.venueInput.value.trim(); saveTempSession(); });
                 if (refs.zoneSelect) refs.zoneSelect.addEventListener('change', () => { currentZone = refs.isCompetitionCheck?.checked ? refs.zoneSelect.value : null; saveTempSession(); });
                 if (refs.pegSelect) refs.pegSelect.addEventListener('change', () => { currentPeg = refs.isCompetitionCheck?.checked ? refs.pegSelect.value : null; saveTempSession(); });
                 if (refs.initialsInput) refs.initialsInput.addEventListener('input', () => { saveTempSession(); });


                 // Initialize the notes modal instance
                 const notesModalElement = document.getElementById('notesModal');
                 if (notesModalElement) { notesModalInstance = new bootstrap.Modal(notesModalElement); }
                 else { console.error("Notes Modal element (#notesModal) not found in HTML!"); }
                 // No verifier modal instance to initialize

                 checkRestoreSession();
             } catch (error) { console.error("Fatal init error:", error); document.body.innerHTML = `<div class="alert alert-danger m-5">App Error: ${error.message}. Please refresh.</div>`; }
        });
    </script>

</body>
</html>
