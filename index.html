<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar -->
    <meta name="theme-color" content="#0d6efd">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0b4c8f 0%, #02274f 100%) fixed;
            color: #f8f9fa;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            line-height: 1.6;
            padding-top: 60px; /* Space for fixed header */
        }
        /* --- App Header --- */
        #appHeader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1030; /* Below modals */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 0 1rem;
        }
        #appHeader h5 {
            margin-bottom: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        /* --- Offline Indicator --- */
        #offlineIndicator {
            position: fixed;
            top: 60px; /* Below header */
            left: 0;
            right: 0;
            background-color: #ffc107; /* Warning color */
            color: #000;
            text-align: center;
            padding: 0.3rem 1rem;
            z-index: 1029; /* Below header, above content */
            font-size: 0.9rem;
            display: none; /* Hidden by default */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 30px auto;
            max-width: 960px;
            z-index: 1;
            display: none; /* Initially hidden */
        }

        /* Page Transitions */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; width: 100%; }

        /* Splash Screen */
        .splash-screen {
            flex-direction: column; justify-content: flex-end; align-items: center;
            padding: 1.5rem; padding-bottom: 3rem; height: 100vh; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 1031; /* Above header */
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.8)), url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed;
            text-align: center;
        }
        .splash-screen .button-group-center { width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
        .splash-screen .button-group-center .btn { display: block; width: 100%; margin: 0 auto 1rem auto; color: white; padding-top: 0.9rem; padding-bottom: 0.9rem; }
        .splash-screen .btn-outline-light { color: #fff; border-color: #fff; }
        .splash-screen .btn-outline-light:hover, .splash-screen .btn-outline-light:focus { background-color: rgba(255, 255, 255, 0.15); color: #fff; border-color: #fff; }

        /* Card Sections */
        .card-section { background: rgba(255, 255, 255, 0.98); border-radius: 12px; padding: 2rem 1.75rem; margin: 1.5rem 0; border: none; color: #212529; z-index: 3; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); transition: box-shadow 0.3s ease; }
        .card-section:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15); }
        .card-section h2 { color: #0056b3; margin-bottom: 1.5rem; font-weight: 700; }
        .card-section h5 { color: #0056b3; margin-bottom: 1.2rem; font-weight: 600; }
        .card-section h6 { font-weight: 700; margin-top: 1rem; margin-bottom: 0.75rem; color: #0056b3; }

        /* Buttons (General) */
        .btn { padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 50px; border: none; margin: 0.3rem; transition: transform 0.2s ease-out, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, color 0.2s ease; cursor: pointer; font-weight: 600; vertical-align: middle; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); line-height: 1.5; }
        .btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .btn:active { transform: translateY(0px) scale(1); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .btn:disabled, .btn.disabled { cursor: not-allowed; opacity: 0.65; transform: none; box-shadow: none; }
        .btn i.bi { vertical-align: text-bottom; line-height: 1; margin-right: 0.1em; margin-left: -0.1em; }
        .btn i.ms-1, .btn i.ms-2 { margin-left: 0.5em !important; margin-right: -0.1em !important;}
        .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; color: white; }
        .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; color: white; }
        .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; color: white; }
        .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; color: black;}
        .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; box-shadow: none; } .btn-outline-secondary:hover { background-color: #6c757d; color: white; border-color: #6c757d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; box-shadow: none; } .btn-outline-light:hover { background-color: #f8f9fa; color: #000; border-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-outline-danger { border: 2px solid #dc3545; color: #dc3545; background-color: transparent; box-shadow: none; } .btn-outline-danger:hover { background-color: #dc3545; color: white; border-color: #dc3545; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.875rem; border-radius: 30px; font-weight: 500; margin: 0.15rem; }
        .btn-lg { padding: 0.9rem 1.8rem; font-size: 1.15rem; margin: 0.5rem; }
        .button-group-center { text-align: center; margin-top: 1.5rem; }
        .button-group-center .btn:not(.d-block) { margin-left: 0.5rem; margin-right: 0.5rem; }

        /* Forms */
        .mb-3 { margin-bottom: 1.5rem !important; }
        .form-label { font-weight: 600; color: #495057; margin-bottom: 0.6rem; font-size: 0.95rem; }
        .form-control, .form-select { border-radius: 8px; border: 1px solid #ced4da; padding: 0.6rem 0.8rem; font-size: 1rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; height: auto; }
        .form-select { background-position: right 0.8rem center; }
        .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-control.is-invalid, .form-select.is-invalid { border-color: #dc3545; }
        .form-check-label { color: #212529; padding-left: 0.3rem; font-weight: normal; }
        .form-check-input { margin-top: 0.2em; margin-right: 0.5em; }
        #verifierEndModalSection { display: none; }
        /* Length Input Group */
        .length-input-group { display: flex; align-items: center; }
        .length-input-group input { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .length-input-group .btn {
            padding: 0.6rem 0.6rem; /* Smaller padding for +/- */
            font-size: 1rem;
            line-height: 1; /* Ensure icon fits */
            border-radius: 0;
            border-left: none;
            z-index: 5; /* Ensure buttons are clickable */
        }
        .length-input-group .btn:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* Tables */
        .card-section .table { background: white; color: #212529; margin-top: 1.5rem; border-collapse: separate; border-spacing: 0; width: 100%; table-layout: auto; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6; }
        .table-responsive { margin-bottom: 1.5rem; border: none; border-radius: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: none; }
        .card-section .table thead { background-color: #e9ecef; color: #495057; font-weight: 700; border-bottom: 2px solid #dee2e6; }
        .card-section .table th, .card-section .table td { border: none; border-bottom: 1px solid #e9ecef; vertical-align: middle; padding: 0.9rem 0.85rem; white-space: normal; font-size: 0.95rem; }
        .card-section .table tbody tr:last-child td { border-bottom: 0; }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: #f8f9fa; }
        .card-section .table-hover tbody tr:hover > * { background-color: rgba(0, 123, 255, 0.08); }
        #fishingPage .table { margin-top: 0; margin-bottom: 0; border: none; }
        #fishingPage .table-responsive { margin-bottom: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; }
        #fishingPage th.photo-col { width: 65px; text-align: center; } #fishingPage td.photo-col { text-align: center; }
        #fishingPage th.length-col { width: 150px; text-align: right;} /* Wider for buttons */
        #fishingPage td.length-col { text-align: right;}
        #fishingPage th.verified-col { width: 90px; text-align: center; } #fishingPage td.verified-col { text-align: center; }
        #fishingPage th.delete-col { width: 60px; text-align: center;} #fishingPage td.delete-col { text-align: center;}
        .delete-icon-btn { background: none; border: none; padding: 0.1rem 0.3rem; color: #dc3545; cursor: pointer; font-size: 1.3rem; vertical-align: middle; transition: color 0.2s ease, transform 0.1s ease; }
        .delete-icon-btn:hover { color: #a71d2a; transform: scale(1.1); } .delete-icon-btn:active { transform: scale(1); }
        #tallyPage.card-section tfoot tr { background-color: #f8f9fa; }
        #tallyPage.card-section tfoot td { padding-top: 1rem; padding-bottom: 1rem; border-bottom: none; }
        #tallyPage.card-section .catch-summary-details { margin-bottom: 1.75rem; color: #495057; line-height: 1.7; font-size: 0.95rem; padding: 1rem; background-color: #f0f4f8; border-radius: 8px; border: 1px solid #d6dde4; }

        /* Fish Log Specific */
        .thumbnail-container { display: inline-block; vertical-align: middle; cursor: pointer; width: 45px; height: 45px; text-align: center; line-height: 45px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .thumbnail-container:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .fish-thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; }
        .no-photo-icon { font-size: 1.6rem; color: #adb5bd; vertical-align: middle; }

        /* Modals */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { background: #ffffff; color: #212529; border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { background-color: #f8f9fa; color: #212529; border-bottom: 1px solid #dee2e6; border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 1rem 1.5rem; }
        .modal-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; display: flex; justify-content: flex-end; flex-wrap: wrap; padding: 1rem 1.5rem; }
        .modal-footer .btn { margin: 0.25rem; }
        .modal-title { color: #0056b3; font-weight: 700; font-size: 1.2rem; }
        .modal-header .btn-close { filter: none; background-size: 0.8em; opacity: 0.7; transition: opacity 0.2s ease; }
        .modal-header .btn-close:hover { opacity: 1; }
        .modal-body { background-color: #ffffff; color: #212529; padding: 1.5rem 1.75rem; line-height: 1.7; }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body, #confirmPhotoModal .modal-body { color: #212529 !important; }

        /* Saved Scorecards Modal */
        #savedScorecardsList.card-section { background: transparent; border: none; box-shadow: none; padding: 0; margin: 0; }
        #savedScorecardsModal .modal-body { padding: 1rem 1.25rem; }
        #savedScorecardsModal .scorecard-entry { border: 1px solid #dee2e6; border-radius: 10px; margin-bottom: 1rem; background-color: #ffffff; overflow: hidden; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: box-shadow 0.2s ease; }
        #savedScorecardsModal .scorecard-entry:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12); }
        #savedScorecardsModal .scorecard-item { cursor: pointer; padding: 1rem 1.25rem; border-bottom: 1px solid #e9ecef; color: #212529; transition: background-color 0.2s; display: flex; align-items: center; gap: 0.75rem; }
        #savedScorecardsModal .scorecard-item:hover { background-color: #f8f9fa; }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible { background-color: #eef5ff; border-bottom: 1px solid #cdddff; }
        #savedScorecardsModal .scorecard-item i.bi { transition: transform 0.2s ease-in-out; color: #6c757d; font-size: 1.1rem; flex-shrink: 0; }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: #6c757d !important; font-size: 0.85rem; }
        #savedScorecardsModal .scorecard-item strong { font-weight: 600; }
        #savedScorecardsModal .scorecard-item > div { flex-grow: 1; }
        #savedScorecardsModal .scorecard-item .badge { font-size: 0.75rem; padding: 0.3em 0.6em; vertical-align: middle; }
        #savedScorecardsModal .scorecard-details { display: none; /* Shown by JS */ padding: 1.25rem 1.5rem; background-color: #ffffff; border-top: 1px solid #e9ecef; margin-top: 0; border-radius: 0 0 10px 10px; color: #212529; line-height: 1.7; }
        #savedScorecardsModal .scorecard-details.loading { text-align: center; padding: 2rem; } /* Style for loading state */
        #savedScorecardsModal .scorecard-details h6 { font-weight: 700; margin-top: 1.2rem; margin-bottom: 0.8rem; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 0.4rem; font-size: 1.1rem; }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 0.6rem; color: #212529; font-size: 0.95rem; }
        #savedScorecardsModal .scorecard-details hr { margin-top: 1.2rem; margin-bottom: 1.2rem; border-top: 1px solid #dee2e6; }
        .fish-list-item { padding: 0.5rem 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .fish-list-item:last-child { border-bottom: none; }
        .fish-list-item .badge { font-weight: normal; }
        .fish-list-item small.text-muted { font-size: 0.8rem; margin-left: auto; }
        .session-photos { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px; }
        .session-photo-thumbnail { width: 70px; height: 70px; object-fit: cover; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .session-photo-thumbnail:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .placeholder-photos { color: #6c757d; font-style: italic; font-size: 0.9rem; }
        #savedScorecardsModal .scorecard-details .species-length-summary p { margin-bottom: 0.4rem; padding-left: 0.5rem; font-size: 0.9rem; }
        #savedScorecardsModal .scorecard-details .species-length-summary h6 { margin-top: 0.5rem; margin-bottom: 0.6rem; font-size: 1rem; color: #495057; border-bottom: none; padding-bottom: 0; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block { background-color: #e7f1ff; padding: 1rem 1.25rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #b8d6fb; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block h6 { margin-top: 0; margin-bottom: 1rem; border-bottom: none; color: #0056b3; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block .summary-highlight { padding: 0.2em 0.5em; border-radius: 4px; font-weight: 600; display: inline-block; background-color: #ddeaff; }
        #savedScorecardsModal .scorecard-details .btn-actions-group { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e9ecef; text-align: right; }
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-left: 5px; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry { border: 2px solid #007bff; box-shadow: 0 0 12px rgba(0, 123, 255, 0.3); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item { border-bottom-color: rgba(0, 123, 255, 0.3); background-color: #e7f1ff; font-weight: 600; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge { background-color: #007bff !important; color: white !important; }
        #olderScorecardsToggleContainer { padding-top: 1rem; text-align: center; }
        #olderScorecardsToggleContainer .btn { margin: 0.5rem; }
        /* Search input */
        #scorecardSearchInput { margin-bottom: 1rem; }

        /* Notes Modal */
        #notesModal .modal-body textarea { resize: vertical; min-height: 120px; font-size: 1rem; }

        /* Camera Modal */
        #cameraModal .modal-dialog { max-width: 100%; margin: 0; height: 100%; }
        #cameraModal .modal-content { height: 100%; border-radius: 0; background-color: #000; }
        #cameraModal .modal-header { border-bottom: 0; background-color: rgba(0,0,0,0.6); position: absolute; top: 0; left: 0; right: 0; z-index: 10; padding: 0.8rem 1rem; }
        #cameraModal .modal-title { color: #fff; font-size: 1.1rem; }
        #cameraModal .btn-close { filter: brightness(0) invert(1); opacity: 0.8; }
        #cameraModal .modal-body { padding: 0; display: flex; justify-content: center; align-items: center; height: 100%; }
        #cameraVideo { display: block; width: 100%; height: 100%; object-fit: cover; }
        #cameraCanvas { display: none; }
        #cameraControls { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0,0,0,0.6); padding: 25px 20px; text-align: center; z-index: 10; }
        #takePhotoButton { border-radius: 50%; width: 75px; height: 75px; padding: 0; background-color: #fff; border: 6px solid rgba(255,255,255,0.5); transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; box-shadow: 0 0 15px rgba(255,255,255,0.3); display: inline-block; font-size: 1rem; font-weight: normal; line-height: initial; margin: 0; color: transparent; }
        #takePhotoButton:hover { background-color: #f0f0f0; border-color: rgba(255,255,255,0.8); transform: scale(1.05); }
        #takePhotoButton:active { transform: scale(0.95); }

        /* Image Viewer Modal */
        #imageViewerModal .modal-dialog { max-width: 95%; margin: 1.75rem auto; }
        #imageViewerModal .modal-content { background-color: #f8f9fa; }
        #imageViewerModal .modal-body { text-align: center; padding: 1rem; }
        #fullImageView { max-width: 100%; max-height: 75vh; display: block; margin: 0 auto 1.5rem auto; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }
        #imageViewerModal .modal-footer { justify-content: space-between; }
        #imageViewerModal .btn { min-width: 100px; }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1100; /* Above most elements */
        }

        /* Responsive Adjustments */
        @media (max-width: 767px) {
            body { padding-top: 56px; } /* Adjust for smaller header if needed */
            #appHeader { height: 56px; }
            #offlineIndicator { top: 56px; }
            .card-section { padding: 1.5rem 1rem; }
            .modal-body { padding: 1.25rem 1rem; }
            .modal-footer { padding: 0.75rem 1rem; }
            .modal-footer .btn:not(.btn-sm) { width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 0.5rem; } /* Stack normal footer buttons */
            .modal-footer .btn:not(.btn-sm):last-child { margin-bottom: 0; }
            #fishingPage .row .btn#addFishBtn { width: 100%; margin-top: 0.5rem; }
        }
        @media (max-width: 575px) {
             html { font-size: 15px; }
             .container { margin: 15px auto; padding: 1rem; }
             .card-section { padding: 1.25rem 0.8rem; }
             .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem; }
             .btn-lg { padding: 0.8rem 1.6rem; font-size: 1.05rem; }
             .splash-screen { padding: 2rem 1rem; }
             #fishingPage .row > div { padding-left: 5px; padding-right: 5px; }
             .fish-list-item { flex-wrap: wrap; }
             .fish-list-item small.text-muted { margin-left: 0; width: 100%; text-align: left; font-size: 0.75rem; padding-left: calc(1em + 0.5rem + 10px); }
             .length-input-group { flex-wrap: wrap; } /* Allow wrapping on smallest screens */
             .length-input-group input { width: calc(100% - 80px); border-radius: 8px 0 0 8px !important; } /* Adjust input width */
             .length-input-group .btn { width: 40px; border-radius: 0 !important; } /* Fixed width buttons */
             .length-input-group .btn:last-child { border-radius: 0 8px 8px 0 !important; }
        }

    </style>
</head>
<body>
    <!-- App Header -->
    <div id="appHeader">
        <h5 id="appTitle">Sea Catch Scorer</h5>
    </div>
    <!-- Offline Indicator -->
    <div id="offlineIndicator">
         <i class="bi bi-wifi-off me-1"></i> You are currently offline. Functionality may be limited.
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <!-- Toasts will be added here by JS -->
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <!-- Content unchanged -->
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div class="mb-3">
                 <label for="zoneInput" class="form-label">Zone</label>
                 <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select>
            </div>
            <div class="mb-3">
                <label for="pegInput" class="form-label">Peg</label>
                <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> </select>
            </div>
            <div class="button-group-center"> <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button> </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
            <div class="row g-2 align-items-start"> <!-- align-items-start needed for label alignment -->
                <div class="col-md-6 col-lg-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select"> <option value="" selected disabled>Loading species...</option> </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3 mb-3"> <!-- Adjusted width -->
                     <label for="lengthInput" class="form-label">Length (cm)</label>
                     <div class="input-group length-input-group"> <!-- Added wrapper -->
                        <input type="number" id="lengthInput" class="form-control" placeholder="Length" step="1" min="1" inputmode="numeric">
                        <button class="btn btn-outline-secondary" type="button" id="lengthDecrementBtn" title="Decrease length"><i class="bi bi-dash"></i></button>
                        <button class="btn btn-outline-secondary" type="button" id="lengthIncrementBtn" title="Increase length"><i class="bi bi-plus"></i></button>
                    </div>
                </div>
                <div id="initialsInputGroup" class="col-sm-6 col-md-3 col-lg-2 mb-3" style="display: none;">
                    <label for="initialsInput" class="form-label">Verifier Initials</label>
                    <input type="text" id="initialsInput" class="form-control" placeholder="Initials" maxlength="3" style="text-transform:uppercase">
                </div>
                <div class="col-md-12 col-lg-3 mb-3 text-lg-end text-center align-self-end"> <!-- align-self-end to push button down -->
                     <button class="btn btn-primary w-100 w-lg-auto" id="addFishBtn"> <i class="bi bi-plus-circle me-1"></i> Add Fish </button>
                </div>
            </div>
            <!-- Back Button -->
            <div class="text-center mb-4 mt-2">
                 <button class="btn btn-secondary btn-sm" id="backFromFishingBtn"> <i class="bi bi-arrow-left-circle me-1"></i> Back to Registration </button>
             </div>

            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead> <tr> <th class="photo-col">Photo</th> <th class="species-col">Species</th> <th class="length-col">Length</th> <th id="verifiedByHeader" class="verified-col" style="display:none;">Verified</th> <th class="delete-col">Del</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>
             <!-- End Session Button Below Table -->
            <div class="button-group-center mt-4"> <button class="btn btn-success btn-lg" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button> </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <!-- Content unchanged -->
            <h2>Catch Summary</h2>
            <div class="catch-summary-details"> <strong>Angler:</strong> <span id="summaryAngler"></span><br> <strong>Date:</strong> <span id="summaryDate"></span><br> <strong>Venue:</strong> <span id="summaryVenue"></span><br> <strong>Zone:</strong> <span id="summaryZone"></span><br> <strong>Peg:</strong> <span id="summaryPeg"></span><br> <span id="summaryVerifier"></span> </div>
            <div class="table-responsive"> <table class="table"> <thead> <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr> </thead> <tbody id="tallyTable"></tbody>
                <tfoot>
                    <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                    <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Points Total</strong></td> <td><strong id="tallyPointsTotal">0</strong></td> </tr>
                </tfoot>
            </table> </div>
            <div class="button-group-center"> <button class="btn btn-secondary" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back to Log</button> </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen page">
        <div class="button-group-center">
            <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
            <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> An unsaved session was found. Would you like to restore it? <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p> <p><strong>Date:</strong> <span id="restoreDate"></span></p> <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p> </div> <div class="modal-footer button-group-center d-block"> <button type="button" class="btn btn-success btn-lg mb-2 w-100" id="restoreSessionBtn">Restore Session</button> <button type="button" class="btn btn-danger w-100" id="startNewSessionBtn">Start New Session</button> </div> </div> </div> </div>
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-scrollable"> <!-- Wider modal --> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body">
        <!-- Search Input -->
        <div class="mb-3">
            <input type="search" id="scorecardSearchInput" class="form-control" placeholder="Search by Angler or Venue...">
        </div>
        <div id="savedScorecardsList" class="card-section"> <div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div> </div>
        <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <!-- Other Modals (structure unchanged) -->
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p>Are you sure you want to end your session? This will save the scorecard.</p> <div id="verifierEndModalSection" class="mt-3" style="display: none;"> <hr> <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label> <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required> <small class="text-muted d-block mt-1">Required for competition scorecards.</small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button> <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button> </div> </div> </div> </div>
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="notesModalLabel">Session Notes</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" id="notesModalScorecardKey"> <div class="mb-3"> <label for="notesTextarea" class="form-label">Enter your notes below:</label> <textarea class="form-control" id="notesTextarea" rows="6"></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" onclick="saveNoteFromModal()">Save Notes</button> </div> </div> </div> </div>
    <div class="modal fade" id="mlsInfoModal" tabindex="-1" aria-labelledby="mlsInfoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="mlsInfoModalLabel"><i class="bi bi-info-circle-fill text-primary me-2"></i>Important MLS Information</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div> <div class="modal-body"> <p>Please ensure you are recording your catches in accordance with the minimum landing sizes (MLS) and any other fishing regulations that apply to your specific location or event.</p> <p><em>This app does not enforce MLS rules automatically.</em></p> </div> <div class="modal-footer"> <button type="button" class="btn btn-primary" id="mlsAgreeBtn" data-bs-dismiss="modal">OK, Understood</button> </div> </div> </div> </div>
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true"> <div class="modal-dialog modal-fullscreen"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cameraModalLabel">Take Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelCameraButtonHeader"></button> </div> <div class="modal-body"> <video id="cameraVideo" playsinline autoplay muted></video> <canvas id="cameraCanvas"></canvas> </div> <div id="cameraControls"> <button type="button" id="takePhotoButton" aria-label="Take Photo"></button> </div> </div> </div> </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="imageViewerModalLabel">Fish Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <img id="fullImageView" src="#" alt="Full fish photo"> </div> <div class="modal-footer"> <button type="button" class="btn btn-info" id="shareImageBtn"><i class="bi bi-share-fill me-1"></i> Share</button> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="confirmPhotoModal" tabindex="-1" aria-labelledby="confirmPhotoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-sm modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="confirmPhotoModalLabel">Add Photo?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body text-center"> Add a photo for this fish now? </div> <div class="modal-footer justify-content-center"> <button type="button" class="btn btn-success mx-2" id="confirmPhotoYesBtn">Yes</button> <button type="button" class="btn btn-secondary mx-2" id="confirmPhotoNoBtn">No</button> </div> </div> </div> </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Application JS -->
    <script>
        // --- Global Variables ---
        const fishCategories = { /* ... Categories ... */
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
            "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
            "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
            "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
            "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
        };
        let fishData = []; // Holds fish {id, species, length, initials, imageId} for current session
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentPage = 'splashScreen';
        let isAppActive = false; // Is a recording session active?
        let historyHijacked = false; // Has back button behavior been modified?
        let notesModalInstance = null;
        let cameraModalInstance = null;
        let imageViewerModalInstance = null;
        let confirmPhotoModalInstance = null;
        let db = null; // IndexedDB database instance
        let currentStream = null; // Active camera stream
        let currentFishIdForPhoto = null; // Which fish is getting a photo now?
        let currentImageBlobForViewer = null; // Blob for image viewer/sharing
        let currentImageIdForViewer = null; // ID for image viewer/sharing
        let isDropdownPopulated = false;
        let pendingFishData = null; // Temp holder between addFish and confirmPhoto
        let isOffline = !navigator.onLine; // Initial offline state
        let scorecardSearchDebounceTimer = null; // Timer for search input debounce
        let allScorecardsCache = []; // Cache for scorecard search/filter

        // --- Constants ---
        const DB_NAME = 'SeaCatchDB';
        const DB_VERSION = 1;
        const IMAGE_STORE_NAME = 'fishImages';
        const POINTS_PER_SPECIES = 10;
        const SEARCH_DEBOUNCE_MS = 300; // Delay for scorecard search

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function formatDateForInput(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function showPage(pageId) {
            console.log(`Show page requested: ${pageId}`);
            const appTitleElement = document.getElementById('appTitle');
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            const target = document.getElementById(pageId);

            if (target) {
                const displayStyle = pageId === 'splashScreen' ? 'flex' : 'block';
                target.style.display = displayStyle;
                currentPage = pageId;

                // Update Header Title
                if (appTitleElement) {
                    switch(pageId) {
                        case 'splashScreen': appTitleElement.textContent = 'Sea Catch Scorer'; break;
                        case 'registrationPage': appTitleElement.textContent = 'Session Setup'; break;
                        case 'fishingPage': appTitleElement.textContent = 'Record Catch'; break;
                        case 'tallyPage': appTitleElement.textContent = 'Catch Summary'; break;
                        default: appTitleElement.textContent = 'Sea Catch Scorer';
                    }
                }

                const container = document.querySelector('.container');
                if(container) { container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; }

                if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); }
                // Don't deactivate just for showing splash anymore
                // else if (pageId === 'splashScreen' && isAppActive) { deactivateAppMode(); }

                if (pageId !== 'splashScreen') { saveTempSession(); }
                else { document.body.style.paddingTop = '0'; } // Remove padding for splash

                if (pageId !== 'splashScreen') { document.body.style.paddingTop = '60px'; } // Restore padding

            } else {
                console.error(`ERROR: Page element not found: ${pageId}. Defaulting to splash.`);
                const splash = document.getElementById('splashScreen');
                if(splash) splash.style.display = 'flex';
                if (appTitleElement) appTitleElement.textContent = 'Sea Catch Scorer';
                document.body.style.paddingTop = '0'; // Remove padding for splash
                const container = document.querySelector('.container');
                if(container) container.style.display = 'none';
                currentPage = 'splashScreen';
            }
        }
        function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) ); }
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        // --- IndexedDB Functions ---
        // (Unchanged - assumed functional)
        function initDb() { return new Promise((resolve, reject) => { if (db) { resolve(db); return; } console.log("Initializing IndexedDB..."); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("IndexedDB error: " + event.target.error); }; request.onsuccess = (event) => { db = event.target.result; console.log("IndexedDB initialized successfully."); resolve(db); }; request.onupgradeneeded = (event) => { console.log("Upgrading IndexedDB..."); db = event.target.result; if (!db.objectStoreNames.contains(IMAGE_STORE_NAME)) { console.log(`Creating object store: ${IMAGE_STORE_NAME}`); db.createObjectStore(IMAGE_STORE_NAME, { keyPath: 'id' }); } }; }); }
        function saveImageToDb(imageId, blob) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for saving image: " + dbErr); return; } } if (!blob || !imageId) { reject("Missing imageId or blob data."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); const imageData = { id: imageId, blob: blob }; console.log(`Attempting to save image with ID: ${imageId}`); const request = store.put(imageData); request.onsuccess = () => { console.log(`Image ${imageId} saved to IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error saving image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Save image transaction completed."); }; transaction.onerror = (event) => { console.error("Save image transaction error:", event.target.error); reject("Save image transaction failed."); }; }); }
        function getImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for getting image: " + dbErr); return; } } if (!imageId) { reject("Missing imageId."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readonly'); const store = transaction.objectStore(IMAGE_STORE_NAME); const request = store.get(imageId); request.onsuccess = (event) => { if (event.target.result) { console.log(`Image ${imageId} retrieved from IndexedDB.`); resolve(event.target.result.blob); } else { console.log(`Image ${imageId} not found in IndexedDB.`); resolve(null); } }; request.onerror = (event) => { console.error(`Error retrieving image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }
        function deleteImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for deleting image: " + dbErr); return; } } if (!imageId) { resolve(); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); console.log(`Attempting to delete image with ID: ${imageId}`); const request = store.delete(imageId); request.onsuccess = () => { console.log(`Image ${imageId} deleted from IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error deleting image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Delete image transaction completed."); }; transaction.onerror = (event) => { console.error("Delete image transaction error:", event.target.error); reject("Delete image transaction failed."); }; }); }

        // --- History/Navigation Control ---
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { try { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } catch (e) { console.error("Error pushing history state:", e); historyHijacked = false; } } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } } // Consider if back button should offer to save
        function handleBackButton(event) { if (isAppActive && historyHijacked) { console.log("Browser back button intercepted by app mode."); try { history.pushState({ appActive: true }, '', location.href); // Prevent back // Optional: Show confirm dialog or navigate within app
                 if (confirm("You have an active session. Do you want to exit and discard changes? Press 'Cancel' to stay in the app.")) { deactivateAppMode(); history.back(); // Allow exit if confirmed
                 } } catch (e) { console.error("Error handling back button:", e); } } else { console.log("Browser back button allowed."); } }
        function handleBeforeUnload(event) { if (isAppActive && fishData.length > 0) { const msg = 'You have an unsaved fishing session. Are you sure you want to leave?'; console.log("beforeunload prompt triggered."); event.preventDefault(); event.returnValue = msg; return msg; } else { console.log("beforeunload allowed."); } }

        // --- Session Management ---
        function saveTempSession() { if (!isAppActive && currentPage !== 'splashScreen') return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); console.log("Temp session saved for page:", currentPage); } catch (e) { console.error("Save temp session error:", e); if(e.name === 'QuotaExceededError'){ showToast("Could not save progress: Storage full.", "danger"); }} }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temporary session cleared."); } catch (e) { console.error("Clear temp session error:", e); } }
        function checkRestoreSession() { console.log("Checking for restore session..."); let data; let tempSessionRaw = null; try { tempSessionRaw = localStorage.getItem('temp_session'); if (!tempSessionRaw) { console.log("No temp session found."); setTodaysDate(); startApp(); // Go directly to registration if no session
                 return; } data = JSON.parse(tempSessionRaw); if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid temp session format."); // Check if session has meaningful data
            if (!data.currentAngler && !data.currentDate && !data.currentVenue && data.fishData.length === 0) { console.log("Temp session found but empty, clearing and starting new."); clearTempSession(); setTodaysDate(); startApp(); return; } } catch (e) { console.error("Error reading temp session:", e); clearTempSession(); setTodaysDate(); showPage('splashScreen'); // Fallback to splash on error
             return; } // If we reach here, session is valid and has data, show restore modal
             console.log("Found restorable session content, showing modal."); document.getElementById('restoreAngler').textContent=data.currentAngler||'N/A'; document.getElementById('restoreDate').textContent=data.currentDate?formatDate(data.currentDate):'N/A'; document.getElementById('restoreFishCount').textContent=data.fishData.length; showModal('restoreSessionModal'); }
        function restoreSession() { console.log("Restore session initiated."); let temp; try { const sS=localStorage.getItem('temp_session'); if(!sS)throw new Error("No temp session data found."); temp=JSON.parse(sS); if(!temp||!Array.isArray(temp.fishData))throw new Error("Invalid temp session data format."); } catch(e){ console.error("Error restoring session data:",e); showToast("Failed to restore session data. Starting fresh.", "danger"); startNewSession(); return; } fishData=temp.fishData||[]; currentAngler=temp.currentAngler||null; currentDate=temp.currentDate||null; currentVenue=temp.currentVenue||null; currentZone=temp.currentZone||null; currentPeg=temp.currentPeg||null; const page=temp.currentPage||'registrationPage'; isAppActive=temp.isAppActive||false; // Restore active state
            historyHijacked=temp.historyHijacked||false; const restoredIsCompetition = temp.isCompetition === true; console.log("Restoring state:",{currentAngler, currentDate, currentVenue, currentZone, currentPeg, page, isAppActive, historyHijacked, isCompetition: restoredIsCompetition}); try{ if(currentAngler)document.getElementById('anglerName').value=currentAngler; if(currentDate)document.getElementById('competitionDate').value=currentDate; if(currentVenue)document.getElementById('venueInput').value=currentVenue; document.getElementById('isCompetition').checked=restoredIsCompetition; toggleCompetitionFields(false); if(currentZone)document.getElementById('zoneInput').value=currentZone; if(currentPeg)document.getElementById('pegInput').value=currentPeg; } catch(e) { console.error("Error restoring registration fields:",e); } populateSpeciesDropdown(); if(page==='fishingPage'){ updateFishLog(); } else if(page==='tallyPage'){ populateTallySummaryFields(); populateTallyTable(); } hideModal('restoreSessionModal'); showPage(page); // Restore to correct page
             // Re-activate app mode if it was active
             if(isAppActive) { activateAppMode(); console.log("App mode re-activated after restore."); } showToast("Session restored successfully.", "success"); }
        function startNewSession() { console.log("Start New Session confirmed."); clearTempSession(); resetApp(); hideModal('restoreSessionModal'); startApp(); // Go to registration page directly
        }

        // --- UI Interaction ---
        function populateSpeciesDropdown() { if (isDropdownPopulated) return; console.log("Populating species dropdown..."); const input = document.getElementById('speciesInput'); if (!input) { console.error("Species dropdown (#speciesInput) missing!"); return; } try { const cats = Object.keys(fishCategories).sort(); input.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; if (Object.keys(fishCategories).length === 0) { console.warn("fishCategories object is empty!"); input.innerHTML = '<option value="" selected disabled>Error: No species loaded</option>'; return; } cats.forEach(cat => { const group = document.createElement('optgroup'); group.label = cat; const species = Array.isArray(fishCategories[cat]) ? [...fishCategories[cat]].sort() : []; if (species.length === 0) { console.warn(`No species array found for category: ${cat}`); } species.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; group.appendChild(opt); }); input.appendChild(group); }); isDropdownPopulated = true; console.log("Species dropdown populated."); } catch (error) { console.error("Error populating species dropdown:", error); input.innerHTML = '<option value="" selected disabled>Error loading species</option>'; } }
        function toggleCustomSpeciesInput() { const sel=document.getElementById('speciesInput'), custom=document.getElementById('customSpeciesInput'), lenInput = document.getElementById('lengthInput'); if(!sel||!custom||!lenInput)return; const showCustom = sel.value === 'Other'; custom.style.display = showCustom ? 'block' : 'none'; if(showCustom) { custom.focus(); } else { custom.value = ''; lenInput.focus(); /* Focus length after selecting normal species */ } }
        function toggleCompetitionFields(updateLog = true) { try{ const isChecked = document.getElementById('isCompetition').checked; const zone=document.getElementById('zoneInput'); const peg=document.getElementById('pegInput'); const initialsGroup = document.getElementById('initialsInputGroup'); const verifiedByHeader = document.getElementById('verifiedByHeader'); if (zone) zone.disabled=!isChecked; if (peg) peg.disabled=!isChecked; if (initialsGroup) initialsGroup.style.display = isChecked ? 'block' : 'none'; if (verifiedByHeader) verifiedByHeader.style.display = isChecked ? 'table-cell' : 'none'; if (!isChecked) { if (zone) zone.value = ''; if (peg) peg.value = ''; const initialsInput = document.getElementById('initialsInput'); if (initialsInput) initialsInput.value = ''; fishData.forEach(fish => fish.initials = null); currentZone = null; currentPeg = null; } if (updateLog) { updateFishLog(); } } catch(e){console.error("Toggle competition fields error:",e);} }
        function setTodaysDate() { try { const dateInput = document.getElementById('competitionDate'); if (dateInput && !dateInput.value) { const today = new Date(); const formattedDate = formatDateForInput(today); dateInput.value = formattedDate; console.log("Set date input to today:", formattedDate); } } catch (e) { console.error("Error setting today's date:", e); } }
        function startApp() { console.log("Starting App -> Registration Page"); setTodaysDate(); populateSpeciesDropdown(); showPage('registrationPage'); }
        function startRecording() { console.log("Start Recording button clicked."); const nameEl=document.getElementById('anglerName'), dateEl=document.getElementById('competitionDate'), venueEl=document.getElementById('venueInput'), checkEl=document.getElementById('isCompetition'), zoneEl=document.getElementById('zoneInput'), pegEl=document.getElementById('pegInput'); let isValid = true; let errorMsg = ""; if(!nameEl || !dateEl || !venueEl || !checkEl || !zoneEl || !pegEl){ showToast("Form elements missing.", "danger"); return; } [nameEl, dateEl, venueEl, zoneEl, pegEl].forEach(el => el?.classList.remove('is-invalid')); const name=nameEl.value.trim(); const date=dateEl.value; const venue=venueEl.value.trim(); const isComp=checkEl.checked; const zone=zoneEl.value; const peg=pegEl.value; if(!name){ errorMsg += "Angler Name is required.\n"; isValid = false; nameEl.classList.add('is-invalid'); } if(!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)){ errorMsg += "A valid Date is required.\n"; isValid = false; dateEl.classList.add('is-invalid'); } if(!venue){ errorMsg += "Venue is required.\n"; isValid = false; venueEl.classList.add('is-invalid'); } if(isComp){ if(!zone){ errorMsg += "Zone is required for competition.\n"; isValid = false; zoneEl.classList.add('is-invalid'); } if(!peg){ errorMsg += "Peg is required for competition.\n"; isValid = false; pegEl.classList.add('is-invalid'); } } if (!isValid) { showToast("Please fix errors in the form.", "warning"); alert("Please fix the following errors:\n" + errorMsg); return; } currentAngler=name; currentDate=date; currentVenue=venue; currentZone=isComp?zone:null; currentPeg=isComp?peg:null; const isActuallyCompetition = !!(currentZone && currentPeg); console.log("Starting recording session:",{currentAngler,currentDate,currentVenue,currentZone,currentPeg,isCompetition:isActuallyCompetition}); populateSpeciesDropdown(); activateAppMode(); saveTempSession(); updateFishLog(); showPage('fishingPage'); if (isActuallyCompetition) { showModal('mlsInfoModal'); } }
        function handleLengthButtonClick(increment) { const lenInput = document.getElementById('lengthInput'); if (!lenInput) return; let currentVal = parseInt(lenInput.value, 10) || 0; if (increment) { currentVal++; } else { currentVal = Math.max(1, currentVal - 1); // Ensure minimum is 1
             } lenInput.value = currentVal; }
        function attemptAddFish() { // Triggered by button or enter key
            addFish();
        }
        function addFish() {
            console.log("Add Fish attempt...");
            const spEl=document.getElementById('speciesInput'), custEl=document.getElementById('customSpeciesInput'), lenEl=document.getElementById('lengthInput'), initialsEl = document.getElementById('initialsInput');
            const isCompetition = document.getElementById('isCompetition').checked;
            let isValid = true; let errorMsg = "";
            [spEl, custEl, lenEl, initialsEl].forEach(el => el?.classList.remove('is-invalid'));
            if(!spEl || !custEl || !lenEl){ showToast("Add fish form elements missing.", "danger"); return; }
            let species = spEl.value; const lenVal = lenEl.value.trim(); let length; let initials = null;
            if(!lenVal || isNaN(parseFloat(lenVal)) || parseFloat(lenVal) <= 0 || parseFloat(lenVal) > 500){ errorMsg += "Valid length (1-500cm) required.\n"; isValid = false; lenEl.classList.add('is-invalid'); } else { length = Math.round(parseFloat(lenVal)); }
            if(species === 'Other'){ species = custEl.value.trim(); if(!species){ errorMsg += "Custom species name required.\n"; isValid = false; custEl.classList.add('is-invalid'); } else if(!/^[a-zA-Z0-9\s'-]+$/.test(species)){ errorMsg += "Invalid chars in custom species name.\n"; isValid = false; custEl.classList.add('is-invalid'); } } else if(!species){ errorMsg += "Please select a species.\n"; isValid = false; spEl.classList.add('is-invalid'); }
            if (isCompetition && initialsEl) { initials = initialsEl.value.trim().toUpperCase(); if (!initials) { errorMsg += "Verifier initials required.\n"; isValid = false; initialsEl.classList.add('is-invalid'); } else if (initials.length < 2) { errorMsg += "Enter at least 2 initials.\n"; isValid = false; initialsEl.classList.add('is-invalid'); } }
            if (!isValid) { showToast("Please fix errors before adding fish.", "warning"); alert("Please fix the following errors:\n" + errorMsg); return; }
            const fishId = generateUUID();
            pendingFishData = { id: fishId, species, length, initials: initials || null, imageId: null };
            console.log("Fish data validated, showing photo prompt:", pendingFishData);
            if (confirmPhotoModalInstance) { confirmPhotoModalInstance.show(); } else { console.error("Confirm photo modal instance missing!"); handleConfirmPhoto(false); }
        }
        function handleConfirmPhoto(shouldTakePhoto) { hideModal('confirmPhotoModal'); console.log(`Photo confirmation: ${shouldTakePhoto}`); if (!pendingFishData) { console.error("Cannot confirm photo, pendingFishData is null!"); return; } fishData.push(pendingFishData); const addedFishId = pendingFishData.id; console.log("Added fish to main data:", pendingFishData); pendingFishData = null; try { document.getElementById('speciesInput').value = ''; document.getElementById('customSpeciesInput').value = ''; document.getElementById('customSpeciesInput').style.display = 'none'; document.getElementById('lengthInput').value = ''; const initialsInput = document.getElementById('initialsInput'); if(initialsInput) initialsInput.value = ''; ['speciesInput', 'customSpeciesInput', 'lengthInput', 'initialsInput'].forEach(id => document.getElementById(id)?.classList.remove('is-invalid')); document.getElementById('speciesInput').focus(); /* Focus species for next */ } catch(e) { console.error("Error resetting form fields after add:", e); } updateFishLog(); saveTempSession(); if (shouldTakePhoto) { openCamera(addedFishId); } }
        async function updateFishLog() { const logBody = document.getElementById('fishLog'); const isCompetition = document.getElementById('isCompetition').checked; const verifiedByHeader = document.getElementById('verifiedByHeader'); if (!logBody) { console.error("Fish log body missing!"); return; } if (verifiedByHeader) verifiedByHeader.style.display = isCompetition ? 'table-cell' : 'none'; logBody.innerHTML = ''; const colCount = 3 + (isCompetition ? 1 : 0) + 1; if (fishData.length === 0) { const row = logBody.insertRow(); const cell = row.insertCell(); cell.colSpan = colCount; cell.className = 'text-center text-muted p-4'; cell.textContent = 'No fish added yet.'; return; } for (let i = fishData.length - 1; i >= 0; i--) { const f = fishData[i]; const row = logBody.insertRow(); const photoCell = row.insertCell(); photoCell.className = 'photo-col'; const thumbContainer = document.createElement('span'); thumbContainer.className = 'thumbnail-container'; thumbContainer.id = `thumb-container-${f.id}`; thumbContainer.innerHTML = '<i class="bi bi-camera no-photo-icon"></i>'; thumbContainer.title = f.imageId ? "Click to view photo" : "Click to add photo"; thumbContainer.onclick = () => { const currentFish = fishData.find(fish => fish.id === f.id); if (currentFish?.imageId) { showFullscreenImage(currentFish.imageId); } else { openCamera(f.id); } }; photoCell.appendChild(thumbContainer); row.insertCell().textContent = f.species || '?'; const lenCell = row.insertCell(); lenCell.className = 'length-col'; lenCell.textContent = f.length ? `${f.length} cm` : '?'; if (isCompetition) { const initialsCell = row.insertCell(); initialsCell.className = 'verified-col'; initialsCell.textContent = f.initials || '-'; } const deleteCell = row.insertCell(); deleteCell.className = 'delete-col'; const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-icon-btn'; deleteBtn.title = 'Delete this fish'; deleteBtn.setAttribute('aria-label', `Delete ${f.species || 'fish'} (${f.length || '?'}cm)`); deleteBtn.innerHTML = '<i class="bi bi-x-circle-fill" aria-hidden="true"></i>'; deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); const currentIndex = fishData.findIndex(fish => fish.id === f.id); if (currentIndex !== -1) { deleteFish(currentIndex); } else { console.error("Could not find fish to delete by ID:", f.id); showToast("Error: Could not delete fish.", "danger"); } }); deleteCell.appendChild(deleteBtn); if (f.imageId) { loadThumbnail(f.id, f.imageId); } } }
        async function loadThumbnail(fishId, imageId) { /* ... Unchanged ... */ }
        async function deleteFish(idx) { /* ... Unchanged ... */ }
        function backFromFishing() { console.log("Back from Fishing requested."); stopCameraStream(); showPage('registrationPage'); }

        // --- Camera Functions ---
        async function openCamera(fishId) { /* ... Unchanged ... */ }
        function stopCameraStream() { /* ... Unchanged ... */ }
        async function takeSnapshot() { /* ... Unchanged ... */ }

        // --- End Session Modal ---
        function showEndSessionModal() { console.log("End Session button clicked."); if (fishData.length === 0) { if (!confirm("You haven't logged any fish. Save empty session?")) { return; } } const modalEl = document.getElementById('endSessionModal'); const verifierSection = document.getElementById('verifierEndModalSection'); const verifierInput = document.getElementById('verifierEndModalInput'); if (!modalEl || !verifierSection || !verifierInput) { console.error("End session modal elements missing!"); showToast("Error preparing end session dialog.", "danger"); return; } const isCompetition = !!(currentZone && currentPeg); verifierSection.style.display = isCompetition ? 'block' : 'none'; verifierInput.value = ''; verifierInput.classList.remove('is-invalid'); bootstrap.Modal.getOrCreateInstance(modalEl).show(); }
        function confirmEndSession() { console.log("Confirm End Session button clicked."); if (!currentAngler || !currentDate || !currentVenue) { showToast("Missing Angler, Date, or Venue.", "danger"); hideModal('endSessionModal'); showPage('registrationPage'); return; } const isCompetition = !!(currentZone && currentPeg); let verifierName = null; const verifierInput = document.getElementById('verifierEndModalInput'); if (isCompetition) { if (!verifierInput) { console.error("Verifier input element missing!"); showToast("Verifier input missing.", "danger"); return; } verifierName = verifierInput.value.trim(); if (!verifierName) { showToast("Verifier name required for competition.", "warning"); verifierInput.classList.add('is-invalid'); verifierInput.focus(); return; } verifierInput.classList.remove('is-invalid'); } hideModal('endSessionModal'); console.log("Saving final scorecard with verifier:", verifierName); const sessionData = { currentAngler, currentDate, currentVenue, currentZone: currentZone || null, currentPeg: currentPeg || null, verifier: verifierName, notes: null, fishData: fishData || [], isCompetition: isCompetition }; const id = `scorecard_${Date.now()}`; try { localStorage.setItem(id, JSON.stringify(sessionData)); console.log("Saved final scorecard:", id); showToast("Scorecard saved successfully!", "success"); clearTempSession(); resetApp(); showPage('splashScreen'); } catch(e) { console.error("Failed to save final scorecard:", e); showToast("Save failed: Storage full or disabled?", "danger"); if(e.name === 'QuotaExceededError') { alert("Local storage is full. Please delete older scorecards.");} showPage('fishingPage'); } }

        // --- Tally Page ---
        function populateTallySummaryFields() { /* ... Unchanged ... */ }
        function populateTallyTable() { /* ... Unchanged ... */ }
        function backFromTally() { console.log("Back from Tally requested."); showPage('fishingPage'); }

        // --- Saved Scorecards ---
        function showScorecardsModal() { console.log("View Saved Scorecards clicked."); const modalEl=document.getElementById('savedScorecardsModal'), listEl=document.getElementById('savedScorecardsList'); if(modalEl&&listEl){ listEl.innerHTML='<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; try { bootstrap.Modal.getOrCreateInstance(modalEl).show(); // Load all scorecards into cache first for filtering
                 loadAllScorecardsToCache().then(() => { filterAndDisplayScorecards(); // Initial display
                 }); } catch (modalError) { console.error("Error showing scorecards modal:", modalError); showToast("Error opening scorecards.", "danger"); } } else { console.error("Scorecard modal/list element missing."); showToast("Cannot display scorecards.", "danger"); } }
        async function loadAllScorecardsToCache() { console.log("Loading all scorecards to cache..."); allScorecardsCache = []; try { const keys = Object.keys(localStorage); for (const key of keys) { if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ try { const data=JSON.parse(dS); if(data && data.currentDate && data.currentVenue){ const tS=parseInt(key.split('_')[1],10); if(!isNaN(tS)){ allScorecardsCache.push({key,data,timestamp:tS}); } else { console.warn("Skipping scorecard with invalid key:", key); } } else { console.warn("Skipping incomplete scorecard:",key); } } catch(e){ console.error("Error parsing scorecard JSON:",key,e); } } } } } catch (e) { console.error("Error reading scorecards from localStorage:",e); showToast("Error loading scorecards.", "danger"); } allScorecardsCache.sort((a,b)=>b.timestamp-a.timestamp); // Sort newest first
             console.log(`Cached ${allScorecardsCache.length} scorecards.`); }
        function filterAndDisplayScorecards() { const savedScorecardsList = document.getElementById('savedScorecardsList'); const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer'); const searchInput = document.getElementById('scorecardSearchInput'); if (!savedScorecardsList || !olderScorecardsToggleContainer || !searchInput) { console.error("Scorecard list/toggle/search elements missing!"); return; } const searchTerm = searchInput.value.trim().toLowerCase(); savedScorecardsList.innerHTML = ''; // Clear previous list
             olderScorecardsToggleContainer.innerHTML = ''; // Clear old buttons
             const filteredScorecards = searchTerm ? allScorecardsCache.filter(sc => (sc.data.currentAngler?.toLowerCase().includes(searchTerm) || sc.data.currentVenue?.toLowerCase().includes(searchTerm))) : [...allScorecardsCache]; // Filter or use all
             if (filteredScorecards.length === 0) { savedScorecardsList.innerHTML = `<p class="text-center text-muted p-4">${searchTerm ? 'No matching scorecards found.' : 'No saved scorecards found.'}</p>`; return; } const displayLimit = 5; let displayedCount = 0; for (let i = 0; i < filteredScorecards.length; i++) { if (i < displayLimit) { const { key, data } = filteredScorecards[i]; const el = createScorecardElement(key, data, i === 0 && !searchTerm); // Only mark latest if not searching
                 if (el) { savedScorecardsList.appendChild(el); displayedCount++; } } else { break; // Stop after initial limit
                 } } if (filteredScorecards.length > displayLimit) { const olderCount = filteredScorecards.length - displayLimit; const showOlderBtn = document.createElement('button'); showOlderBtn.id = 'showOlderBtn'; showOlderBtn.className = 'btn btn-outline-secondary'; showOlderBtn.innerHTML = `<i class="bi bi-chevron-double-down me-1"></i> View ${olderCount} More`; showOlderBtn.onclick = () => displayRemainingScorecards(filteredScorecards, displayLimit); olderScorecardsToggleContainer.appendChild(showOlderBtn); // Only show 'View More' when filtered, not 'Delete Older' for simplicity
             } }
        function displayRemainingScorecards(filteredScorecards, startIndex) { const savedScorecardsList = document.getElementById('savedScorecardsList'); const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer'); if (!savedScorecardsList || !olderScorecardsToggleContainer) return; olderScorecardsToggleContainer.innerHTML = ''; // Remove 'View More' button
             for (let i = startIndex; i < filteredScorecards.length; i++) { const { key, data } = filteredScorecards[i]; const el = createScorecardElement(key, data, false); // Not latest
                 if (el) savedScorecardsList.appendChild(el); } }
        const debouncedFilterAndDisplay = debounce(filterAndDisplayScorecards, SEARCH_DEBOUNCE_MS);
        // --- createScorecardElement (Modified for Lazy Loading) ---
        function createScorecardElement (key, data, isLatest) { try { const wrapperDiv = document.createElement('div'); wrapperDiv.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`; wrapperDiv.id = `entry-${key}`; // Store full data with the element for lazy loading
             wrapperDiv.dataset.scorecardData = JSON.stringify(data); // Calculate minimal summary for header
             const fishCount = data.fishData?.length || 0; let initialPoints = 0; let initialTotalLength = 0; if (fishCount > 0) { const speciesSet = new Set(); data.fishData.forEach(f => { initialTotalLength += (f.length || 0); speciesSet.add(f.species || '?'); }); initialPoints = initialTotalLength + (speciesSet.size * POINTS_PER_SPECIES); } const escapedKey = key.replace(/'/g, "\\'"); wrapperDiv.innerHTML = `
                <div class="scorecard-item" onclick="toggleScorecardDetails('${escapedKey}', this)">
                    <i class="bi bi-chevron-right"></i>
                    <div>
                        <strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')}
                        <small class="text-muted d-block">
                            ${fishCount} fish • ${initialTotalLength}cm • ${initialPoints} pts • Angler: ${data.currentAngler || '?'}
                        </small>
                    </div>
                    ${isLatest ? '<span class="badge bg-primary ms-auto align-self-center">Latest</span>' : ''}
                </div>
                <div class="scorecard-details" id="details_${key}" style="display: none;">
                    <!-- Details will be loaded here on expand -->
                     <div class="text-center p-3 loading">
                         <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                         <span class="ms-2 text-muted small">Loading details...</span>
                     </div>
                </div>`; return wrapperDiv; } catch (elementError) { console.error(`Error creating scorecard element for ${key}:`, elementError); /* ... error div ... */ } }
        async function toggleScorecardDetails(key, headerElement){ console.log("Toggle details for:",key); const detailsDiv=document.getElementById(`details_${key}`), icon=headerElement.querySelector('i.bi'); const wrapperDiv = document.getElementById(`entry-${key}`); if(!detailsDiv || !icon || !wrapperDiv) { console.error("Missing elements for scorecard toggle:", key); return; } const isVisible = detailsDiv.style.display === 'block'; // Toggle visibility first
             detailsDiv.style.display = isVisible ? 'none' : 'block'; icon.classList.toggle('bi-chevron-right', isVisible); icon.classList.toggle('bi-chevron-down', !isVisible); headerElement.classList.toggle('details-visible', !isVisible); // Load content only if expanding for the first time
             const needsLoading = !isVisible && !detailsDiv.dataset.detailsLoaded; if (needsLoading) { console.log(`Loading details for ${key}...`); detailsDiv.dataset.detailsLoaded = 'true'; // Mark as loading/loaded
                 detailsDiv.innerHTML = `<div class="text-center p-3 loading"><div class="spinner-border spinner-border-sm text-secondary" role="status"></div><span class="ms-2 text-muted small">Loading details...</span></div>`; try { const dataString = wrapperDiv.dataset.scorecardData; if (!dataString) throw new Error("Scorecard data not found in dataset."); const data = JSON.parse(dataString); // Now generate the full detail HTML (Similar logic as before, but happens here)
                     // --- Calculate Full Summaries ---
                     let overallTotalLength = 0, fishCount = 0, speciesSet = new Set(), longestFish = null, speciesTotals = {}; const fishList = data.fishData || []; fishList.forEach(f => { const length = f.length || 0; const speciesName = f.species || '?'; fishCount++; overallTotalLength += length; speciesSet.add(speciesName); if (!longestFish || length > (longestFish.length || 0)) longestFish = f; speciesTotals[speciesName] = (speciesTotals[speciesName] || 0) + length; }); const speciesCount = speciesSet.size; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); const longestFishString = longestFish ? `${longestFish.species || '?'}(${longestFish.length || '?'}cm)` : 'N/A'; const escapedKey = key.replace(/'/g, "\\'"); const hasNotes = data.notes && data.notes.trim() !== ''; const viewNoteButtonHtml = hasNotes ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${escapedKey}', event)"><i class="bi bi-eye me-1"></i>View Note</button>` : ''; const addEditNoteButtonHtml = `<button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${escapedKey}', event)"><i class="bi bi-pencil me-1"></i>${hasNotes ? 'Edit Note' : 'Add Note'}</button>`; let fishListHtml = `<p class="ms-2 text-muted fst-italic">No fish recorded.</p>`; if (fishList.length > 0) { fishListHtml = fishList.map((f, i) => { let verifiedText = ''; if (data.isCompetition && f.initials) verifiedText = ` <small class="text-muted fst-italic">(Verified: ${f.initials})</small>`; return `<p class="fish-list-item"><span class="badge bg-secondary me-2">${i + 1}</span><span>${f.species || '?'} - <strong>${f.length || '?'}cm</strong></span>${verifiedText}</p>`; }).join(''); } let speciesSummaryHtml = ''; if (Object.keys(speciesTotals).length > 0) { const sortedSpecies = Object.entries(speciesTotals).sort((a, b) => a[0].localeCompare(b[0])); speciesSummaryHtml += '<div class="species-length-summary"><h6>Species Length Totals:</h6>'; sortedSpecies.forEach(([speciesName, totalLength]) => { speciesSummaryHtml += `<p><strong>${speciesName}:</strong> ${totalLength}cm</p>`; }); speciesSummaryHtml += '</div><hr>'; } const photosPlaceholderId = `sessionPhotos-${key}`; const photosHtml = `<hr><h6>Session Photos</h6><div class="session-photos" id="${photosPlaceholderId}"><p class="text-muted placeholder-photos fst-italic">(Checking for photos...)</p></div>`; // --- Inject HTML ---
                     detailsDiv.innerHTML = `
                        <h6>Session Details</h6>
                        <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p>
                        <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p>
                        <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p>
                        ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''}
                        ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''}
                        ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''}
                        <hr>
                        <h6>Catch List (${fishCount})</h6>
                        ${fishListHtml}
                        ${fishList.length > 0 ? `
                            <hr>
                            <div class="scorecard-summary-block">
                                <h6>Session Summary</h6>
                                ${speciesSummaryHtml}
                                <p><strong>Overall Total Length:</strong> <span class="summary-highlight">${overallTotalLength}cm</span></p>
                                <p><strong>Total Species Caught:</strong> ${speciesCount}</p>
                                <p><strong>Longest Fish Recorded:</strong> ${longestFishString}</p>
                                <p><strong>Points Total:</strong> <span class="summary-highlight">${points}</span></p>
                            </div>
                        ` : ''}
                        ${photosHtml}
                        <div class="btn-actions-group">
                            ${viewNoteButtonHtml}
                            ${addEditNoteButtonHtml}
                            <button class="btn btn-info btn-sm" onclick="emailScorecard('${escapedKey}', event)"><i class="bi bi-envelope me-1"></i>Email</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${escapedKey}', event)"><i class="bi bi-trash me-1"></i>Delete</button>
                        </div>`; // --- Load Photos Async ---
                     await loadSessionPhotos(key, fishList); // Wait for photos to load now
                     console.log(`Details loaded for ${key}`); } catch (err) { console.error(`Error loading details for ${key}:`, err); detailsDiv.innerHTML = '<p class="text-danger p-3">Error loading scorecard details.</p>'; // Show error in details section
                 } } // Scroll into view if opening
             if (!isVisible) { setTimeout(() => { detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50); } }
        async function loadSessionPhotos(scorecardKey, fishList) { /* ... Unchanged ... */ }
        async function deleteScorecard(key, event){ /* ... Unchanged ... */ }
        function emailScorecard(key, event) { /* ... Unchanged ... */ }

        // --- Notes Modal Functions ---
        function openNotesModal(key, event) { /* ... Unchanged ... */ }
        function saveNoteFromModal() { /* ... Modified to use toast ... */ console.log('Save notes modal button clicked.'); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { showToast('Error saving notes.', "danger"); return; } const key = notesModalKeyInput.value; const newNotes = notesTextarea.value; if (!key) { showToast('Scorecard key missing.', "danger"); return; } try { const dS = localStorage.getItem(key); if (!dS) throw new Error('Scorecard data not found.'); let data = JSON.parse(dS); data.notes = newNotes; localStorage.setItem(key, JSON.stringify(data)); console.log('Notes saved via modal for key:', key); notesModalInstance.hide(); // Update button text and data in cache/element
             const scorecardEntry = document.getElementById(`entry-${key}`); if (scorecardEntry) { scorecardEntry.dataset.scorecardData = JSON.stringify(data); // Update stored data
                 const addEditButton = scorecardEntry.querySelector('.btn-actions-group button[onclick^="openNotesModal"]'); const viewButtonContainer = scorecardEntry.querySelector('.btn-actions-group'); let existingViewButton = scorecardEntry.querySelector('.btn-actions-group button[onclick^="viewNote"]'); const hasNotesNow = newNotes && newNotes.trim() !== ''; if (addEditButton) { addEditButton.innerHTML = `<i class="bi bi-pencil me-1"></i>${hasNotesNow ? 'Edit Note' : 'Add Note'}`; } if (viewButtonContainer) { if (hasNotesNow && !existingViewButton) { const viewBtn = document.createElement('button'); viewBtn.className = 'btn btn-secondary btn-sm'; viewBtn.onclick = (event) => viewNote(key, event); viewBtn.innerHTML = '<i class="bi bi-eye me-1"></i>View Note'; viewButtonContainer.insertBefore(viewBtn, addEditButton); } else if (!hasNotesNow && existingViewButton) { existingViewButton.remove(); } } } showToast("Notes saved successfully.", "success"); } catch (e) { console.error('Error saving notes from modal:', e); showToast(`Failed to save notes: ${e.message}`, "danger"); if(e.name === 'QuotaExceededError') { showToast("Storage full. Could not save.", "danger"); }} }
        function viewNote(key, event) { /* ... Unchanged ... */ }

        // --- Delete Older Scorecards Functions ---
        function confirmDeleteOlderScorecards() { /* ... Logic unchanged ... */ }
        async function deleteOlderScorecards() { /* ... Modified to use toast & update cache ... */ console.log("Starting deletion of older scorecards..."); const displayLimit = 5; let scorecards = []; try { const keys = Object.keys(localStorage); for (const key of keys) { if (key?.startsWith('scorecard_')) { const timestamp = parseInt(key.split('_')[1], 10); if (!isNaN(timestamp)) { scorecards.push({ key, timestamp }); } } } scorecards.sort((a, b) => b.timestamp - a.timestamp); const keysToDelete = scorecards.slice(displayLimit).map(item => item.key); if (keysToDelete.length > 0) { console.log(`Attempting to delete ${keysToDelete.length} older scorecards:`, keysToDelete); let allImageIdsToDelete = []; let errorOccurred = false; for (const key of keysToDelete) { try { const data = JSON.parse(localStorage.getItem(key) || '{}'); allImageIdsToDelete.push(...(data.fishData || []).map(f => f.imageId).filter(id => !!id)); } catch (e) { console.warn("Error parsing scorecard for image IDs during delete:", key); } } allImageIdsToDelete = [...new Set(allImageIdsToDelete)]; if (allImageIdsToDelete.length > 0) { console.log("Deleting older images from DB:", allImageIdsToDelete); const deleteImgPromises = allImageIdsToDelete.map(id => deleteImageFromDb(id)); const results = await Promise.allSettled(deleteImgPromises); results.forEach((result, index) => { if (result.status === 'rejected') { console.error(`Failed to delete image ${allImageIdsToDelete[index]}:`, result.reason); errorOccurred = true; }}); console.log("Older image deletion finished."); } for (const key of keysToDelete) { try { localStorage.removeItem(key); console.log(`Deleted metadata: ${key}`); } catch (removeError) { console.error(`Error removing metadata key ${key}:`, removeError); errorOccurred = true; } } if (errorOccurred) { showToast("Some older items may not have been deleted.", "warning"); } else { showToast(`${keysToDelete.length} older scorecard${keysToDelete.length > 1 ? 's' : ''} deleted.`, "success"); } // Refresh cache and display
                 await loadAllScorecardsToCache(); filterAndDisplayScorecards(); } else { console.log("No older scorecards found to delete."); showToast("No older scorecards to delete.", "info"); } } catch (e) { console.error("Error during delete older scorecards process:", e); showToast("Error deleting older scorecards.", "danger"); } }

        // --- Image Viewer and Sharing ---
        async function showFullscreenImage(imageId) { /* ... Unchanged ... */ }
        async function shareImage() { /* ... Unchanged ... */ }

        // --- General Modal Hiding/Showing ---
        function hideModal(modalId) { try { const mE=document.getElementById(modalId); if(mE){const m=bootstrap.Modal.getInstance(mE); if(m){m.hide();} else { mE.classList.remove('show'); mE.style.display='none'; const b=document.querySelector('.modal-backdrop.show'); if(b) b.remove(); document.body.classList.remove('modal-open'); document.body.style.overflow=''; document.body.style.paddingRight=''; }} } catch(e) { console.error(`Error hiding modal ${modalId}:`, e); } }
        function showModal(modalId) { try { const modalElement = document.getElementById(modalId); if(modalElement) { bootstrap.Modal.getOrCreateInstance(modalElement).show(); } else { console.error(`Modal element #${modalId} not found!`); } } catch (e) { console.error(`Error showing modal ${modalId}:`, e); } }

        // --- Toast Notification Function ---
        function showToast(message, type = 'info') { // type = primary, secondary, success, danger, warning, info, light, dark
             const toastContainer = document.querySelector('.toast-container');
             if (!toastContainer) { console.error("Toast container not found!"); alert(message); return; } // Fallback

             const toastId = 'toast-' + Date.now();
             const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
                  <div class="d-flex">
                    <div class="toast-body">
                      ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                </div>`;

             toastContainer.insertAdjacentHTML('beforeend', toastHtml);
             const toastElement = document.getElementById(toastId);
             const toastInstance = new bootstrap.Toast(toastElement);

             toastElement.addEventListener('hidden.bs.toast', () => {
                 toastElement.remove(); // Clean up DOM after hide
             });

             toastInstance.show();
         }

        // --- Offline/Online Status Handling ---
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!indicator) return;
            isOffline = !navigator.onLine;
            indicator.style.display = isOffline ? 'block' : 'none';
            console.log(`Network status changed. Offline: ${isOffline}`);
            if (!isOffline) {
                // Optional: Trigger any queued sync actions here
            }
        }

        // --- Application Reset ---
        function resetApp() { /* ... Unchanged ... */ console.log("Resetting application state and UI..."); fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null; currentPage='splashScreen'; stopCameraStream(); deactivateAppMode(); isDropdownPopulated = false; pendingFishData = null; try { const regFormIds = ['anglerName', 'competitionDate', 'venueInput', 'zoneInput', 'pegInput']; regFormIds.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; el.classList.remove('is-invalid'); } }); const isCompCheck = document.getElementById('isCompetition'); if(isCompCheck) isCompCheck.checked = false; setTodaysDate(); toggleCompetitionFields(false); const fishFormIds = ['speciesInput', 'customSpeciesInput', 'lengthInput', 'initialsInput']; fishFormIds.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; el.classList.remove('is-invalid'); } }); const customSpeciesInput = document.getElementById('customSpeciesInput'); if (customSpeciesInput) customSpeciesInput.style.display = 'none'; const speciesInput = document.getElementById('speciesInput'); if (speciesInput) { speciesInput.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; isDropdownPopulated = false; } const fishLog = document.getElementById('fishLog'); if (fishLog) fishLog.innerHTML=''; const tallyTable = document.getElementById('tallyTable'); if (tallyTable) tallyTable.innerHTML=''; const vI = document.getElementById('verifierEndModalInput'); if(vI) { vI.value=''; vI.classList.remove('is-invalid'); } const vS = document.getElementById('verifierEndModalSection'); if(vS) vS.style.display='none'; populateTallySummaryFields(); populateTallyTable(); console.log("Application reset complete."); } catch(e) { console.error("Error occurred during application reset:", e); showToast("Error resetting application.", "danger"); } }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM fully loaded. Initializing App...");
            try {
                 await initDb();
                 console.log("IndexedDB initialized.");

                 // Service Worker
                 if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered:', reg.scope)).catch(err => console.error('SW Error:', err)); }); } else { console.log('Service workers not supported.'); }

                 // Online/Offline Listeners
                 window.addEventListener('online', updateOnlineStatus);
                 window.addEventListener('offline', updateOnlineStatus);
                 updateOnlineStatus(); // Initial check

                 // History/Unload Listeners
                 window.addEventListener('popstate', handleBackButton);
                 window.addEventListener('beforeunload', handleBeforeUnload);
                 console.log("Navigation listeners attached.");

                 // Element Refs (Example)
                 const refs = {
                     continueBtn: document.getElementById('continueBtn'),
                     viewScorecardsBtn: document.getElementById('viewScorecardsBtn'),
                     lengthDecrementBtn: document.getElementById('lengthDecrementBtn'),
                     lengthIncrementBtn: document.getElementById('lengthIncrementBtn'),
                     lengthInput: document.getElementById('lengthInput'),
                     initialsInput: document.getElementById('initialsInput'),
                     addFishBtn: document.getElementById('addFishBtn'),
                     scorecardSearchInput: document.getElementById('scorecardSearchInput'),
                     // Add others if frequently used and need listeners
                 };
                 console.log("Element references cached.");

                 // Init Modals
                 try { /* ... Modal Init Code ... */ const modalIds = ['notesModal', 'cameraModal', 'imageViewerModal', 'confirmPhotoModal', 'restoreSessionModal', 'savedScorecardsModal', 'endSessionModal', 'mlsInfoModal']; modalIds.forEach(id => { const el = document.getElementById(id); if (el) { const instance = bootstrap.Modal.getOrCreateInstance(el); if (id === 'notesModal') notesModalInstance = instance; if (id === 'cameraModal') { cameraModalInstance = instance; el.addEventListener('hidden.bs.modal', stopCameraStream); } if (id === 'imageViewerModal') imageViewerModalInstance = instance; if (id === 'confirmPhotoModal') confirmPhotoModalInstance = instance; } else { console.warn(`WARN: Modal element #${id} not found!`); } }); console.log("Bootstrap modals initialized."); }
                 catch (modalInitError) { console.error("ERROR initializing modals:", modalInitError); }

                 // Attach Event Listeners
                 const addClickListener = (ref, handler) => { if (ref) ref.addEventListener('click', handler); else console.warn(`Listener not added: Null ref for ${handler.name}`); };
                 const addInputListener = (ref, handler) => { if (ref) ref.addEventListener('input', handler); else console.warn(`Listener not added: Null ref for ${handler.name}`); };
                 const addChangeListener = (ref, handler) => { if (ref) ref.addEventListener('change', handler); else console.warn(`Listener not added: Null ref for ${handler.name}`); };

                 addClickListener(refs.continueBtn, startApp);
                 addClickListener(refs.viewScorecardsBtn, showScorecardsModal);
                 addClickListener(document.getElementById('startRecordingBtn'), startRecording); // Direct getElementById example
                 addChangeListener(document.getElementById('isCompetition'), () => { toggleCompetitionFields(); saveTempSession(); });
                 addChangeListener(document.getElementById('speciesInput'), toggleCustomSpeciesInput);
                 addClickListener(refs.addFishBtn, attemptAddFish); // Use wrapper
                 addClickListener(document.getElementById('backFromFishingBtn'), backFromFishing);
                 addClickListener(document.getElementById('endSessionBtn'), showEndSessionModal);
                 addClickListener(document.getElementById('confirmEndBtn'), confirmEndSession);
                 addClickListener(document.getElementById('backFromTallyBtn'), backFromTally);
                 addClickListener(document.getElementById('startNewSessionBtn'), () => { if (confirm("Discard unsaved session and start new?")) { startNewSession(); } });
                 addClickListener(document.getElementById('restoreSessionBtn'), restoreSession);

                 // Input listeners for saving temp session
                 addInputListener(document.getElementById('anglerName'), () => { currentAngler = document.getElementById('anglerName').value.trim(); saveTempSession(); });
                 addChangeListener(document.getElementById('competitionDate'), () => { currentDate = document.getElementById('competitionDate').value; saveTempSession(); });
                 addInputListener(document.getElementById('venueInput'), () => { currentVenue = document.getElementById('venueInput').value.trim(); saveTempSession(); });
                 addChangeListener(document.getElementById('zoneInput'), () => { currentZone = document.getElementById('isCompetition')?.checked ? document.getElementById('zoneInput').value : null; saveTempSession(); });
                 addChangeListener(document.getElementById('pegInput'), () => { currentPeg = document.getElementById('isCompetition')?.checked ? document.getElementById('pegInput').value : null; saveTempSession(); });

                 // Length +/- buttons
                 addClickListener(refs.lengthDecrementBtn, () => handleLengthButtonClick(false));
                 addClickListener(refs.lengthIncrementBtn, () => handleLengthButtonClick(true));

                 // Enter key on length/initials to add fish
                 const handleEnterKey = (event) => { if (event.key === 'Enter') { event.preventDefault(); attemptAddFish(); } };
                 if (refs.lengthInput) refs.lengthInput.addEventListener('keydown', handleEnterKey);
                 if (refs.initialsInput) refs.initialsInput.addEventListener('keydown', handleEnterKey);

                 // Scorecard Search Listener
                 if (refs.scorecardSearchInput) {
                     refs.scorecardSearchInput.addEventListener('input', debouncedFilterAndDisplay);
                 }

                 // Modal Buttons
                 addClickListener(document.getElementById('takePhotoButton'), takeSnapshot);
                 addClickListener(document.getElementById('cancelCameraButtonHeader'), stopCameraStream);
                 addClickListener(document.getElementById('confirmPhotoYesBtn'), () => handleConfirmPhoto(true));
                 addClickListener(document.getElementById('confirmPhotoNoBtn'), () => handleConfirmPhoto(false));
                 // Note save is inline onclick

                 console.log("Event listeners attached.");

                 // Start App Flow
                 setTodaysDate();
                 checkRestoreSession(); // This function now decides whether to show splash or startApp

                 console.log("App initialization sequence complete.");
            } catch (error) {
                 console.error("FATAL ERROR during initialization:", error);
                 document.body.innerHTML = `<div class="alert alert-danger m-5" role="alert"><strong>App Init Failed!</strong><br>${error.message}<br>See console.</div>`;
            }
        });
    </script>

</body>
</html>
