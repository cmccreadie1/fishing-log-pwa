<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar (Will be dynamically updated by JS for dark mode) -->
    <meta name="theme-color" id="themeColorMeta" content="#007bff">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --body-bg: url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg');
            --body-color: #fff;
            --container-bg: rgba(0, 0, 0, 0.75);
            --card-section-bg: rgba(255, 255, 255, 0.95);
            --card-section-color: #212529;
            --card-border-color: #dee2e6;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            --heading-color: #0056b3;
            --label-color: #495057;
            --input-bg: #fff;
            --input-color: #212529;
            --input-border: #ced4da;
            --input-focus-border: #86b7fe;
            --input-focus-shadow: rgba(13, 110, 253, 0.25);
            --table-bg: #fff;
            --table-color: #212529;
            --table-border: #dee2e6;
            --table-header-bg: #e9ecef;
            --table-header-color: #495057;
            --table-striped-bg: #eef5ff;
            --table-hover-bg: rgba(0, 123, 255, 0.1);
            --modal-content-bg: #f8f9fa;
            --modal-content-color: #212529;
            --modal-header-bg: #e9ecef;
            --modal-header-color: #212529;
            --modal-footer-bg: #e9ecef;
            --modal-body-bg: #ffffff;
            --modal-body-color: #212529;
            --btn-primary-bg: #007bff;
            --btn-primary-hover-bg: #0056b3;
            --btn-primary-color: white;
            --btn-secondary-bg: #6c757d;
            --btn-secondary-hover-bg: #5a6268;
            --btn-secondary-color: white;
            --btn-success-bg: #198754;
            --btn-success-hover-bg: #157347;
            --btn-success-color: white;
            --btn-danger-bg: #dc3545;
            --btn-danger-hover-bg: #c82333;
            --btn-danger-color: white;
            --btn-info-bg: #0dcaf0;
            --btn-info-hover-bg: #31d2f2;
            --btn-info-color: black;
            --link-color: #0d6efd;
            --link-hover-color: #0a58ca;
            --splash-text-color: #fff;
            --splash-button-outline: #f8f9fa;
            --splash-button-outline-hover-bg: #f8f9fa;
            --splash-button-outline-hover-color: #000;
            --header-bg: rgba(0, 0, 0, 0.6);
            --header-text-color: #fff;
            --theme-switch-bg: #ccc;
            --theme-switch-slider: #fff;
            --theme-switch-checked-bg: #007bff; /* Use primary color */
        }

        body.dark-mode {
            --body-bg: url('https://i.postimg.cc/NMgY51c2/seacatchscorecard-dark.jpg'); /* Consider a darker background image */
            --body-color: #dee2e6;
            --container-bg: rgba(10, 10, 10, 0.85); /* Darker, slightly less transparent */
            --card-section-bg: rgba(33, 37, 41, 0.95); /* Bootstrap's dark color */
            --card-section-color: #dee2e6;
            --card-border-color: #495057;
            --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            --heading-color: #80bfff; /* Lighter blue for headings */
            --label-color: #adb5bd;
            --input-bg: #2c3034; /* Slightly lighter than card bg */
            --input-color: #dee2e6;
            --input-border: #495057;
            --input-focus-border: #80bfff;
            --input-focus-shadow: rgba(128, 191, 255, 0.25);
            --table-bg: #2c3034;
            --table-color: #dee2e6;
            --table-border: #495057;
            --table-header-bg: #343a40;
            --table-header-color: #adb5bd;
            --table-striped-bg: #343a40; /* Same as header for subtle striping */
            --table-hover-bg: rgba(128, 191, 255, 0.1);
            --modal-content-bg: #2b3035;
            --modal-content-color: #dee2e6;
            --modal-header-bg: #343a40;
            --modal-header-color: #dee2e6;
            --modal-footer-bg: #343a40;
            --modal-body-bg: #212529;
            --modal-body-color: #dee2e6;
            --btn-primary-bg: #0d6efd;
            --btn-primary-hover-bg: #0b5ed7;
            --btn-secondary-bg: #6c757d;
            --btn-secondary-hover-bg: #5c636a;
            --btn-success-bg: #198754;
            --btn-success-hover-bg: #157347;
            --btn-danger-bg: #dc3545;
            --btn-danger-hover-bg: #bb2d3b;
            --btn-info-bg: #0dcaf0;
            --btn-info-hover-bg: #31d2f2;
            --btn-info-color: black;
            --link-color: #80bfff;
            --link-hover-color: #a8d1ff;
            --splash-text-color: #dee2e6;
            --splash-button-outline: #6c757d;
            --splash-button-outline-hover-bg: #6c757d;
            --splash-button-outline-hover-color: #fff;
            --header-bg: rgba(10, 10, 10, 0.7);
            --header-text-color: #dee2e6;
            --theme-switch-bg: #495057;
            --theme-switch-slider: #dee2e6;
            --theme-switch-checked-bg: #0d6efd; /* Use primary color */
        }

        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--body-bg) no-repeat center/cover fixed;
            color: var(--body-color);
            min-height: 100vh;
            overscroll-behavior-y: contain;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .app-header {
            padding: 10px 20px;
            background: var(--header-bg);
            color: var(--header-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1030; /* Above container, below modals */
            transition: background-color 0.3s ease, color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .app-header h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch-wrapper i { font-size: 1.2rem; color: var(--header-text-color); }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; margin: 0 8px; }
        .theme-switch input { display: none; }
        .slider { background-color: var(--theme-switch-bg); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: var(--theme-switch-slider); bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--theme-switch-checked-bg); }
        input:checked + .slider:before { transform: translateX(26px); }

        .container {
            background: var(--container-bg);
            border-radius: 15px;
            padding: 25px;
            margin: 20px auto;
            max-width: 960px;
            z-index: 1;
            display: none; /* Initially hidden */
            transition: background-color 0.3s ease;
        }
        .page { display: none; } /* Pages hidden by default */

        /* --- Splash Screen --- */
        .splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
            color: var(--splash-text-color);
            text-align: center;
        }
         .splash-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* --- Main Content Card Style --- */
        .card-section {
            background: var(--card-section-bg);
            color: var(--card-section-color);
            border-radius: 15px;
            padding: 30px 25px;
            margin: 20px 0;
            border: 1px solid var(--card-border-color);
            box-shadow: var(--card-shadow);
            z-index: 3;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .card-section h2 {
            color: var(--heading-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--card-border-color);
            font-weight: 700; /* Make headings bolder */
        }
        .card-section h5 {
            color: var(--heading-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
         .card-section h6 {
            font-weight: 600;
            color: var(--heading-color); /* Use heading color for h6 too */
        }


        /* --- Buttons --- */
        .btn { padding: 12px 24px; font-size: 1.05rem; border-radius: 25px; border: none; margin: 5px; transition: transform 0.2s, background-color 0.2s, border-color 0.2s, box-shadow 0.2s; cursor: pointer; font-weight: 600; vertical-align: middle; }
        .btn:focus-visible { outline: 2px solid var(--input-focus-border); outline-offset: 2px; box-shadow: 0 0 0 0.25rem var(--input-focus-shadow); }
        .btn:disabled { cursor: not-allowed; opacity: 0.65; transform: none !important; } /* Prevent hover effect when disabled */
        .btn .spinner-border { margin-left: 8px; vertical-align: -0.125em; width: 1em; height: 1em; }

        .btn-primary { background-color: var(--btn-primary-bg); color: var(--btn-primary-color); } .btn-primary:not(:disabled):hover { background-color: var(--btn-primary-hover-bg); transform: scale(1.03); }
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-color); } .btn-secondary:not(:disabled):hover { background-color: var(--btn-secondary-hover-bg); transform: scale(1.03); }
        .btn-success { background-color: var(--btn-success-bg); color: var(--btn-success-color); } .btn-success:not(:disabled):hover { background-color: var(--btn-success-hover-bg); transform: scale(1.03); }
        .btn-danger { background-color: var(--btn-danger-bg); color: var(--btn-danger-color); } .btn-danger:not(:disabled):hover { background-color: var(--btn-danger-hover-bg); transform: scale(1.03); }
        .btn-info { background-color: var(--btn-info-bg); color: var(--btn-info-color); } .btn-info:not(:disabled):hover { background-color: var(--btn-info-hover-bg); transform: scale(1.03); color: var(--btn-info-color); }
        .btn-outline-secondary { border: 2px solid var(--btn-secondary-bg); color: var(--btn-secondary-bg); background-color: transparent; } .btn-outline-secondary:not(:disabled):hover { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-color); }
        .btn-outline-light { border: 2px solid var(--splash-button-outline); color: var(--splash-button-outline); background-color: transparent; } .btn-outline-light:not(:disabled):hover { background-color: var(--splash-button-outline-hover-bg); color: var(--splash-button-outline-hover-color); }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; border-radius: 20px; font-weight: normal; margin: 2px; }
        .btn-lg { padding: 14px 28px; font-size: 1.2rem; margin: 10px; }
        .button-group-center { text-align: center; margin-top: 25px; }
        .button-group-center .btn { margin-left: 8px; margin-right: 8px; }

        /* --- Forms --- */
        .mb-3 { margin-bottom: 1.5rem !important; }
        .form-label { font-weight: 600; color: var(--label-color); margin-bottom: 0.6rem; }
        .form-label .required-indicator { color: var(--btn-danger-bg); font-weight: bold; margin-left: 4px; display: none; /* Hidden by default, shown by JS */ }
        body.dark-mode .form-label .required-indicator { color: #ff7b7b; }
        .form-control, .form-select { border-radius: 8px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--input-color); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .form-control:focus, .form-select:focus { border-color: var(--input-focus-border); box-shadow: 0 0 0 0.25rem var(--input-focus-shadow); background-color: var(--input-bg); color: var(--input-color); }
        .form-check-label { color: var(--card-section-color); cursor: pointer; } /* Make label clickable */
        body.dark-mode .form-check-input:checked { background-color: var(--btn-primary-bg); border-color: var(--btn-primary-bg); }
        .form-check-input { cursor: pointer; }
        #verifierEndModalSection { display: none; }
        .competition-group {
            padding: 15px;
            border: 1px dashed var(--input-border);
            border-radius: 8px;
            margin-top: 15px;
            background-color: rgba(128, 128, 128, 0.05);
            transition: border-color 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
            opacity: 0.6; /* Dimmed when competition unchecked */
        }
        body.dark-mode .competition-group { background-color: rgba(255, 255, 255, 0.03); }


        /* --- Tables --- */
        .card-section .table { background: var(--table-bg); color: var(--table-color); margin-top: 15px; border-collapse: separate; border-spacing: 0; width: 100%; table-layout: auto; transition: background-color 0.3s ease, color 0.3s ease; }
        .table-responsive { margin-bottom: 1rem; border: 1px solid var(--table-border); border-radius: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: border-color 0.3s ease; }
        .card-section .table thead { background-color: var(--table-header-bg); color: var(--table-header-color); font-weight: 600; border-bottom: 2px solid var(--table-border); transition: background-color 0.3s ease, color 0.3s ease; }
        .card-section .table th, .card-section .table td { border-color: var(--table-border); vertical-align: middle; padding: 0.9rem 0.75rem; border-bottom: 1px solid var(--table-border); border-right: 1px solid var(--table-border); white-space: normal; transition: border-color 0.3s ease; }
        .card-section .table th:first-child, .card-section .table td:first-child { border-left: 0; padding-left: 1rem; }
        .card-section .table th:last-child, .card-section .table td:last-child { border-right: 0; padding-right: 1rem; }
        .card-section .table tbody tr:last-child td { border-bottom: 0; }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: var(--table-striped-bg); }
        .card-section .table-hover tbody tr:hover > * { background-color: var(--table-hover-bg); }
        .card-section .table-bordered th, .card-section .table-bordered td { border: 1px solid var(--table-border); }

        /* --- Specific Table Styles --- */
        #fishingPage .table { margin-top: 20px; margin-bottom: 0; } /* Give more space above */
        #fishingPage th.photo-col { width: 70px; text-align: center; }
        #fishingPage td.photo-col { text-align: center; }
        #fishingPage th.species-col {}
        #fishingPage th.length-col { width: 110px; text-align: right;} /* Slightly wider */
        #fishingPage td.length-col { text-align: right;}
        #fishingPage th.verified-col { width: 95px; text-align: center; }
        #fishingPage td.verified-col { text-align: center; }
        #fishingPage th.delete-col { width: 65px; text-align: center;}
        #fishingPage td.delete-col { text-align: center;}
        .delete-icon-btn { background: none; border: none; padding: 0 0.3rem; color: var(--btn-danger-bg); cursor: pointer; font-size: 1.3rem; vertical-align: middle; line-height: 1; transition: color 0.2s ease, transform 0.2s ease;}
        .delete-icon-btn:hover { color: var(--btn-danger-hover-bg); transform: scale(1.15); }
        .delete-icon-btn:focus-visible { outline: 2px solid var(--input-focus-border); outline-offset: 1px; border-radius: 50%; }

        #tallyPage.card-section .table { margin-top: 20px; table-layout: auto; }
        #tallyPage.card-section tfoot td, #tallyPage.card-section tfoot strong { color: var(--card-section-color); font-weight: 600; }
        #tallyPage.card-section .catch-summary-details { margin-bottom: 25px; color: var(--label-color); line-height: 1.7; }
        #tallyPage.card-section .catch-summary-details dl { margin-bottom: 0; }
        #tallyPage.card-section .catch-summary-details dt { font-weight: 600; color: var(--card-section-color); }
        #tallyPage.card-section .catch-summary-details dd { margin-left: 0; margin-bottom: 0.5rem; } /* Adjusted margin for row layout */

        /* --- Fish Log Specific --- */
        .thumbnail-container { display: inline-block; vertical-align: middle; cursor: pointer; width: 45px; height: 45px; text-align: center; line-height: 45px; border: 1px solid var(--table-border); border-radius: 4px; background-color: var(--input-bg); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .thumbnail-container:hover { transform: scale(1.05); box-shadow: 0 0 5px var(--input-focus-shadow); }
        .fish-thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; }
        .no-photo-icon { font-size: 1.8rem; color: var(--label-color); vertical-align: middle; line-height: 45px; } /* Ensure icon is vertically centered */
        .thumbnail-container:focus-visible { outline: 2px solid var(--input-focus-border); outline-offset: 1px; box-shadow: 0 0 0 0.2rem var(--input-focus-shadow); }


        /* --- Unified Modal Style --- */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; opacity: 0.6; }
        .modal-content { background: var(--modal-content-bg); color: var(--modal-content-color); border: 1px solid var(--card-border-color); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .modal-header { background-color: var(--modal-header-bg); color: var(--modal-header-color); border-bottom: 1px solid var(--card-border-color); border-top-left-radius: 15px; border-top-right-radius: 15px; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .modal-footer { background-color: var(--modal-footer-bg); border-top: 1px solid var(--card-border-color); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; display: flex; justify-content: flex-end; flex-wrap: wrap; padding: 0.75rem 1rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .modal-title { color: var(--heading-color); font-weight: 700; }
        .modal-header .btn-close { filter: none; background-size: 0.8em; } /* Reset BS5 filter */
        body.dark-mode .modal-header .btn-close { filter: brightness(0) invert(1); }
        .modal-body { background-color: var(--modal-body-bg); color: var(--modal-body-color); padding: 20px; transition: background-color 0.3s ease, color 0.3s ease; }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body, #mlsInfoModal .modal-body { color: var(--modal-body-color) !important; }

        /* --- Saved Scorecards Modal --- */
        #savedScorecardsList.card-section { background: transparent; border: none; padding: 0; margin: 0; box-shadow: none;}
        #savedScorecardsModal .scorecard-entry { border: 1px solid var(--card-border-color); border-radius: 8px; margin-bottom: 15px; background-color: var(--modal-body-bg); overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: background-color 0.3s ease, border-color 0.3s ease; }
        body.dark-mode #savedScorecardsModal .scorecard-entry { background-color: var(--table-bg); }
        #savedScorecardsModal .scorecard-item { cursor: pointer; padding: 12px 15px; border-bottom: 1px solid var(--card-border-color); color: var(--modal-body-color); transition: background-color 0.2s, border-color 0.3s ease; }
        #savedScorecardsModal .scorecard-item:hover { background-color: var(--table-hover-bg); }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible { border-bottom: 1px solid var(--card-border-color); background-color: var(--table-striped-bg); }
        #savedScorecardsModal .scorecard-item i.bi { transition: transform 0.2s ease-in-out; color: var(--label-color); }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: var(--label-color) !important; }
        #savedScorecardsModal .scorecard-details { display: none; padding: 15px; background-color: var(--modal-body-bg); border-top: none; margin-top: 0; border-radius: 0 0 8px 8px; color: var(--modal-body-color); transition: background-color 0.3s ease, color 0.3s ease; }
        #savedScorecardsModal .scorecard-details h6 { font-weight: 700; margin-top: 10px; margin-bottom: 8px; color: var(--heading-color); border-bottom: 1px solid var(--table-header-bg); padding-bottom: 4px; transition: border-color 0.3s ease; }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 8px; color: var(--modal-body-color); }
        #savedScorecardsModal .scorecard-details hr { margin-top: 15px; margin-bottom: 15px; border-top: 1px solid var(--card-border-color); background-color: transparent; height: 1px; opacity: 1; transition: border-color 0.3s ease;}
        .fish-list-item { padding: 0.3rem 0; border-bottom: 1px dashed var(--input-border); font-size: 0.95rem; transition: border-color 0.3s ease;}
        .fish-list-item:last-child { border-bottom: none; }
        .session-photos { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .session-photo-thumbnail { width: 70px; height: 70px; object-fit: cover; border: 1px solid var(--input-border); border-radius: 4px; cursor: pointer; transition: transform 0.2s, border-color 0.3s ease; background-color: var(--input-bg); }
        .session-photo-thumbnail:hover { transform: scale(1.05); }
        .placeholder-photos { color: var(--label-color); font-style: italic; }

        #savedScorecardsModal .scorecard-details .species-length-summary p { margin-bottom: 0.3rem; padding-left: 10px; }
        #savedScorecardsModal .scorecard-details .species-length-summary h6 { margin-top: 0.5rem; margin-bottom: 0.5rem; font-size: 0.95rem; color: var(--label-color); border-bottom: none; padding-bottom: 0; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block { background-color: var(--table-striped-bg); padding: 10px 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--table-border); transition: background-color 0.3s ease, border-color 0.3s ease; }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block h6 { margin-top: 0; margin-bottom: 0.75rem; border-bottom: none; color: var(--heading-color); }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block .summary-highlight { font-weight: 600; }

        #savedScorecardsModal .scorecard-details .btn-actions-group { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--modal-header-bg); transition: border-color 0.3s ease;}
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-right: 5px; }
        #savedScorecardsModal .scorecard-details .btn-danger { color: var(--btn-danger-color) !important; }
        body.dark-mode #savedScorecardsModal .scorecard-details .btn-danger { color: white !important; }
        #savedScorecardsModal .scorecard-details .btn-info { color: var(--btn-info-color) !important; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry { border: 2px solid var(--btn-primary-bg); box-shadow: 0 0 8px var(--input-focus-shadow); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item { border-bottom: 1px solid var(--btn-primary-bg); background-color: var(--table-hover-bg); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge { background-color: var(--btn-primary-bg) !important; color: white !important; font-weight: 600; }
        #olderScorecardsToggleContainer { padding-top: 10px; text-align: center;}
        #olderScorecardsToggleContainer .btn { margin: 5px; }

        /* --- Notes Modal --- */
        #notesModal .modal-body textarea { resize: vertical; min-height: 100px; background-color: var(--input-bg); color: var(--input-color); border: 1px solid var(--input-border); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;}
        #notesModal .modal-body textarea:focus { border-color: var(--input-focus-border); box-shadow: 0 0 0 0.25rem var(--input-focus-shadow); }

        /* --- Camera Modal Styles --- */
        #cameraModal .modal-dialog { max-width: 100%; margin: 0; height: 100%; }
        #cameraModal .modal-content { height: 100%; border-radius: 0; background-color: #000; }
        #cameraModal .modal-header { border-bottom: 0; background-color: rgba(0,0,0,0.5); position: absolute; top: 0; left: 0; right: 0; z-index: 10; }
        #cameraModal .modal-title { color: #fff; }
        #cameraModal .btn-close { filter: brightness(0) invert(1); }
        #cameraModal .modal-body { padding: 0; display: flex; justify-content: center; align-items: center; height: 100%; }
        #cameraVideo { display: block; width: 100%; height: 100%; object-fit: cover; }
        #cameraCanvas { display: none; }
        #cameraControls { position: absolute; bottom: 0; left: 0; right: 0; background-color: rgba(0,0,0,0.5); padding: 20px; text-align: center; z-index: 10; }
        #takePhotoButton { border-radius: 50%; width: 70px; height: 70px; padding: 0; background-color: #fff; border: 5px solid #ccc; }
        #takePhotoButton:hover { background-color: #eee; }
        #takePhotoButton:focus-visible { outline: 3px solid #0dcaf0; outline-offset: 3px;}

        /* --- Image Viewer Modal Styles --- */
        #imageViewerModal .modal-dialog { max-width: 95%; margin: 1.75rem auto; }
        #imageViewerModal .modal-content { background-color: var(--modal-content-bg); }
        #imageViewerModal .modal-body { text-align: center; padding: 1rem; background-color: var(--modal-body-bg); }
        #fullImageView { max-width: 100%; max-height: 80vh; display: block; margin: 0 auto 1rem auto; border: 1px solid var(--card-border-color); border-radius: 8px; transition: border-color 0.3s ease; }
        #imageViewerModal .modal-footer { justify-content: space-between; }

        /* --- Toast Styles --- */
        .toast-container { z-index: 1100; }
        .toast { transition: background-color 0.3s ease, color 0.3s ease; }
        body.dark-mode .toast { background-color: #343a40; color: #dee2e6; }
        body.dark-mode .toast-header { background-color: #495057; color: #dee2e6; }
        body.dark-mode .toast .btn-close { filter: brightness(0) invert(1); }

    </style>
</head>
<body>

    <!-- Simple Header for Title and Theme Toggle -->
    <header class="app-header">
        <h1>Sea Catch Scorer</h1>
        <div class="theme-switch-wrapper">
            <i class="bi bi-brightness-high-fill" id="lightIcon"></i>
            <label class="theme-switch" for="themeSwitch">
                <input type="checkbox" id="themeSwitch">
                <span class="slider round"></span>
            </label>
             <i class="bi bi-moon-stars-fill" id="darkIcon"></i>
        </div>
    </header>

    <!-- Container -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3">
                <label for="anglerName" class="form-label">Angler Name</label>
                <input type="text" id="anglerName" class="form-control" placeholder="Enter your name">
            </div>
            <div class="mb-3">
                <label for="competitionDate" class="form-label">Date</label>
                <input type="date" id="competitionDate" class="form-control">
            </div>
            <div class="mb-3">
                <label for="venueInput" class="form-label">Venue</label>
                <input type="text" id="venueInput" class="form-control" placeholder="Enter venue">
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="isCompetition">
                <label class="form-check-label" for="isCompetition">Competition Mode</label>
            </div>
            <!-- Grouping for Competition Fields -->
            <div class="competition-group" id="competitionFields">
                <div class="mb-3">
                     <label for="zoneInput" class="form-label">Zone <span class="required-indicator" aria-hidden="true">*</span><span class="visually-hidden"> (required for competition)</span></label>
                     <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select>
                </div>
                <div class="mb-3">
                    <label for="pegInput" class="form-label">Peg <span class="required-indicator" aria-hidden="true">*</span><span class="visually-hidden"> (required for competition)</span></label>
                    <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> </select>
                </div>
            </div>
            <div class="button-group-center">
                <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button>
            </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select"> <option value="" selected disabled>Loading species...</option> </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="lengthInput" class="form-label">Length (cm)</label>
                    <input type="number" id="lengthInput" class="form-control" placeholder="Enter length" step="1" min="1">
                </div>
                <div id="initialsInputGroup" class="col-md-4 mb-3" style="display: none;">
                     <label for="initialsInput" class="form-label">Verifier Initials</label>
                     <input type="text" id="initialsInput" class="form-control" placeholder="e.g., AB" maxlength="3" style="text-transform:uppercase">
                </div>
            </div>
            <div class="button-group-center mb-4">
                 <button class="btn btn-primary" id="addFishBtn"> <i class="bi bi-plus-circle me-1"></i> Add Fish </button>
                 <button class="btn btn-secondary" id="backFromFishingBtn"> <i class="bi bi-arrow-left-circle me-1"></i> Back </button>
             </div>
            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th class="photo-col">Photo</th>
                            <th class="species-col">Species</th>
                            <th class="length-col">Length (cm)</th>
                            <th id="verifiedByHeader" class="verified-col" style="display:none;">Verified</th>
                            <th class="delete-col">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>
             <!-- End Session Button Below Table -->
            <div class="button-group-center mt-4">
                <button class="btn btn-success" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button>
            </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details mb-4">
                 <dl class="row gy-2"> {/* gy-2 for vertical gap */}
                    <dt class="col-sm-4">Angler:</dt><dd class="col-sm-8" id="summaryAngler"></dd>
                    <dt class="col-sm-4">Date:</dt><dd class="col-sm-8" id="summaryDate"></dd>
                    <dt class="col-sm-4">Venue:</dt><dd class="col-sm-8" id="summaryVenue"></dd>
                    <dt class="col-sm-4" id="summaryZoneLabel" style="display: none;">Zone:</dt><dd class="col-sm-8" id="summaryZone" style="display: none;"></dd>
                    <dt class="col-sm-4" id="summaryPegLabel" style="display: none;">Peg:</dt><dd class="col-sm-8" id="summaryPeg" style="display: none;"></dd>
                    <dt class="col-sm-4" id="summaryVerifierLabel" style="display: none;">Verifier:</dt><dd class="col-sm-8" id="summaryVerifier" style="display: none;"></dd>
                 </dl>
            </div>
            <div class="table-responsive">
                 <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Species</th>
                            <th>Total Caught</th>
                            <th>Lengths (cm)</th>
                            <th>Total Length (cm)</th>
                        </tr>
                    </thead>
                    <tbody id="tallyTable"></tbody>
                    <tfoot>
                        <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                        <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                        <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                        <tr> <td colspan="3" class="text-end"><strong>Points Total</strong></td> <td><strong id="tallyPointsTotal">0</strong></td> </tr>
                    </tfoot>
                </table>
            </div>
            <div class="button-group-center">
                <button class="btn btn-secondary" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button>
            </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen page">
        <h1 class="splash-title">Sea Catch Scorer</h1>
        <div class="button-group-center">
            <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
            <br>
            <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> An unsaved session was found. Would you like to restore it? <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p> <p><strong>Date:</strong> <span id="restoreDate"></span></p> <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p> </div> <div class="modal-footer button-group-center d-block"> <button type="button" class="btn btn-success btn-lg mb-2" id="restoreSessionBtn">Restore Session</button> <br> <button type="button" class="btn btn-danger" id="startNewSessionBtn">Start New Session</button> </div> </div> </div> </div>
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div id="savedScorecardsList" class="card-section"> <p class="placeholder-glow"><span class="placeholder col-12"></span></p> </div> <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p>Are you sure you want to end your session? This will save the scorecard.</p> <div id="verifierEndModalSection" class="mt-3" style="display: none;"> <hr> <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label> <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required> <small class="text-muted">Required for competition scorecards.</small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button> <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button> </div> </div> </div> </div>
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="notesModalLabel">Session Notes</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" id="notesModalScorecardKey"> <div class="mb-3"> <label for="notesTextarea" class="form-label">Enter your notes below:</label> <textarea class="form-control" id="notesTextarea" rows="5"></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" id="saveNotesBtn">Save Notes</button> </div> </div> </div> </div>
    <div class="modal fade" id="mlsInfoModal" tabindex="-1" aria-labelledby="mlsInfoModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="mlsInfoModalLabel">Important MLS Information</h5> </div> <div class="modal-body"> <p>Please ensure you are recording your catches in accordance with the minimum landing sizes (MLS) and any other fishing regulations that apply to your specific location or event.</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-primary" id="mlsAgreeBtn">OK</button> </div> </div> </div> </div>
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true"> <div class="modal-dialog modal-fullscreen"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cameraModalLabel">Take Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelCameraButtonHeader"></button> </div> <div class="modal-body"> <video id="cameraVideo" playsinline autoplay muted></video> <canvas id="cameraCanvas"></canvas> </div> <div id="cameraControls"> <button type="button" class="btn btn-light" id="takePhotoButton" aria-label="Take Photo"></button> </div> </div> </div> </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="imageViewerModalLabel">Fish Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <img id="fullImageView" src="#" alt="Full fish photo"> </div> <div class="modal-footer"> <button type="button" class="btn btn-info" id="shareImageBtn" disabled><i class="bi bi-share-fill me-1"></i> Share</button> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <!-- Toasts will be added here by JS -->
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Application JS -->
    <script>
        // --- Global Variables ---
        const fishCategories = { // Same as before
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
             "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
             "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
             "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
             "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
         };
        let fishData = [];
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentPage = 'splashScreen';
        let isAppActive = false;
        let historyHijacked = false;
        let notesModalInstance = null;
        let cameraModalInstance = null;
        let imageViewerModalInstance = null;
        let db = null;
        let currentStream = null;
        let currentFishIdForPhoto = null; // Fish ID when camera is opened
        let currentImageBlobForViewer = null;
        let currentImageIdForViewer = null;
        let isDropdownPopulated = false;

        // --- Constants ---
        const DB_NAME = 'SeaCatchDB';
        const DB_VERSION = 1;
        const IMAGE_STORE_NAME = 'fishImages';
        const POINTS_PER_SPECIES = 10;
        const THEME_KEY = 'appTheme'; // localStorage key for theme
        const DISPLAY_SCORECARD_LIMIT = 4; // How many scorecards to show initially

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function formatDateForInput(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function showPage(pageId) { console.log("Show page:", pageId); document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); const target = document.getElementById(pageId); if (target) { target.style.display = pageId === 'splashScreen' ? 'flex' : 'block'; currentPage = pageId; const container = document.querySelector('.container'); if(container) container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); } else if (pageId === 'splashScreen' && isAppActive) { deactivateAppMode(); } if (pageId !== 'splashScreen') { saveTempSession(); } } else { console.error("Page missing:", pageId, ". Defaulting splash."); const splash = document.getElementById('splashScreen'), container = document.querySelector('.container'); if(splash) splash.style.display = 'flex'; if(container) container.style.display = 'none'; currentPage = 'splashScreen'; deactivateAppMode(); } }
        function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) ); }

        function toggleButtonSpinner(buttonElement, showSpinner) {
            if (!buttonElement) return;
            const spinnerHtml = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            if (showSpinner) {
                buttonElement.disabled = true;
                if (!buttonElement.querySelector('.spinner-border')) {
                    // Store original content if not already stored
                    if (!buttonElement.dataset.originalContent) {
                        buttonElement.dataset.originalContent = buttonElement.innerHTML;
                    }
                    buttonElement.innerHTML = buttonElement.dataset.originalContent + ' ' + spinnerHtml;
                 }
            } else {
                buttonElement.disabled = false;
                // Restore original content
                if (buttonElement.dataset.originalContent) {
                    buttonElement.innerHTML = buttonElement.dataset.originalContent;
                    // Clean up dataset attribute
                    delete buttonElement.dataset.originalContent;
                } else {
                    // Fallback if original content wasn't stored (e.g. manual call)
                    const spinner = buttonElement.querySelector('.spinner-border');
                    if (spinner) spinner.remove();
                }
            }
        }

        function showToast(message, type = 'info', delay = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                console.error("Toast container not found!");
                alert(message); // Fallback to alert
                return;
            }

            const toastId = `toast-${Date.now()}`;
            const bgClass = {
                success: 'bg-success', danger: 'bg-danger',
                warning: 'bg-warning text-dark', // Dark text for warning bg
                info: 'bg-info text-dark', // Dark text for info bg
            }[type] || 'bg-secondary';

            const iconClass = {
                success: 'bi-check-circle-fill', danger: 'bi-x-octagon-fill',
                warning: 'bi-exclamation-triangle-fill', info: 'bi-info-circle-fill',
            }[type] || 'bi-bell-fill';

            const textClass = (type === 'warning' || type === 'info') ? '' : 'text-white'; // Use default text color for warning/info

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center ${textClass} ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}">
                  <div class="d-flex">
                    <div class="toast-body">
                      <i class="bi ${iconClass} me-2"></i> ${message}
                    </div>
                    <button type="button" class="btn-close me-2 m-auto ${textClass ? 'btn-close-white' : ''}" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                </div>`;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toastInstance = new bootstrap.Toast(toastElement); // Delay is set via data-bs-delay

            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });

            toastInstance.show();
        }

        // --- IndexedDB Functions ---
        function initDb() { return new Promise((resolve, reject) => { if (db) { resolve(db); return; } console.log("Initializing IndexedDB..."); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("IndexedDB error: " + event.target.error); }; request.onsuccess = (event) => { db = event.target.result; console.log("IndexedDB initialized successfully."); resolve(db); }; request.onupgradeneeded = (event) => { console.log("Upgrading IndexedDB..."); db = event.target.result; if (!db.objectStoreNames.contains(IMAGE_STORE_NAME)) { console.log(`Creating object store: ${IMAGE_STORE_NAME}`); db.createObjectStore(IMAGE_STORE_NAME, { keyPath: 'id' }); } }; }); }
        function saveImageToDb(imageId, blob) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch (dbErr) { reject(dbErr); return; } } if (!blob || !imageId) { reject("Missing imageId or blob data."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); const imageData = { id: imageId, blob: blob }; console.log(`Attempting to save image with ID: ${imageId}`); const request = store.put(imageData); request.onsuccess = () => { console.log(`Image ${imageId} saved to IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error saving image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }
        function getImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch (dbErr) { reject(dbErr); return; } } if (!imageId) { reject("Missing imageId."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readonly'); const store = transaction.objectStore(IMAGE_STORE_NAME); const request = store.get(imageId); request.onsuccess = (event) => { if (event.target.result) { console.log(`Image ${imageId} retrieved from IndexedDB.`); resolve(event.target.result.blob); } else { console.log(`Image ${imageId} not found in IndexedDB.`); resolve(null); } }; request.onerror = (event) => { console.error(`Error retrieving image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }
        function deleteImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch (dbErr) { reject(dbErr); return; } } if (!imageId) { resolve(); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); console.log(`Attempting to delete image with ID: ${imageId}`); const request = store.delete(imageId); request.onsuccess = () => { console.log(`Image ${imageId} deleted from IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error deleting image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }


        // --- History/Navigation Control ---
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } }
        function handleBackButton(event) { if (isAppActive) { console.log("popstate intercepted."); history.pushState({ appActive: true }, '', location.href); /* Add logic here if needed, e.g., show confirmation modal */ } else { console.log("popstate allowed."); } }
        function handleBeforeUnload(event) { if (isAppActive) { console.log("beforeunload prompt."); event.preventDefault(); event.returnValue = ''; return ''; } else { console.log("beforeunload allowed."); } }

        // --- Session Management ---
        function saveTempSession() { if (!isAppActive) return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); } catch (e) { console.error("Save temp err:", e); if(e.name === 'QuotaExceededError'){ showToast("Warning: Could not save session progress, local storage might be full.", "warning");}} }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temp cleared."); } catch (e) { console.error("Clear temp err:", e); } }
        function checkRestoreSession() { let data; try { const temp = localStorage.getItem('temp_session'); if (!temp) { setTodaysDate(); showPage('splashScreen'); return; } data = JSON.parse(temp); if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid format."); } catch (e) { console.error("Read temp err:", e); clearTempSession(); setTodaysDate(); showPage('splashScreen'); return; } if (data.currentAngler || data.currentDate || data.currentVenue || data.fishData.length > 0) { console.log("Found session, show modal."); document.getElementById('restoreAngler').textContent=data.currentAngler||'N/A'; document.getElementById('restoreDate').textContent=data.currentDate?formatDate(data.currentDate):'N/A'; document.getElementById('restoreFishCount').textContent=data.fishData.length; const modalEl=document.getElementById('restoreSessionModal'); if(modalEl){let mI=bootstrap.Modal.getInstance(modalEl);if(!mI)mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false}); mI.show();}else{console.error("Restore modal missing.");clearTempSession();setTodaysDate();showPage('splashScreen');} } else { clearTempSession(); setTodaysDate(); showPage('splashScreen'); } }
        function restoreSession() { console.log("Restore clicked."); let temp; try { const sS=localStorage.getItem('temp_session'); if(!sS)throw new Error("No data."); temp=JSON.parse(sS); if(!temp||!Array.isArray(temp.fishData))throw new Error("Invalid format."); } catch(e){console.error("Restore err:",e);showToast("Failed to restore session data.", "danger");startNewSession();return;} fishData=temp.fishData||[]; currentAngler=temp.currentAngler||null; currentDate=temp.currentDate||null; currentVenue=temp.currentVenue||null; currentZone=temp.currentZone||null; currentPeg=temp.currentPeg||null; const page=temp.currentPage||'registrationPage'; isAppActive=temp.isAppActive||false; historyHijacked=temp.historyHijacked||false; const restoredIsCompetition = temp.isCompetition === true; console.log("Restoring to:",page,"App active:",isAppActive, "Is Competition:", restoredIsCompetition); try{ if(currentAngler)document.getElementById('anglerName').value=currentAngler; if(currentDate)document.getElementById('competitionDate').value=currentDate; if(currentVenue)document.getElementById('venueInput').value=currentVenue; document.getElementById('isCompetition').checked=restoredIsCompetition; toggleCompetitionFields(false); // Update UI without log update
                 if(currentZone)document.getElementById('zoneInput').value=currentZone; if(currentPeg)document.getElementById('pegInput').value=currentPeg; }catch(e){console.error("Restore reg fields err:",e);} if(page==='fishingPage'||page==='tallyPage'){populateSpeciesDropdown(); if(page==='fishingPage'){updateFishLog();}else if(page==='tallyPage'){populateTallySummaryFields();populateTallyTable();}} hideModal('restoreSessionModal'); showPage(page); if(isAppActive && !historyHijacked){history.pushState({appActive:true},'',location.href); historyHijacked=true; console.log("Pushed history after restore.");} console.log("Session restored."); showToast("Session restored successfully.", "success"); }
        function startNewSession() { console.log("Start New Session confirmed after prompt."); clearTempSession(); resetApp(); hideModal('restoreSessionModal'); showPage('splashScreen'); showToast("New session started.", "info"); }


        // --- UI Interaction ---
        function populateSpeciesDropdown() { if (isDropdownPopulated) { return; } console.log("Populating species dropdown..."); const input = document.getElementById('speciesInput'); if (!input) { console.error("Species dropdown (#speciesInput) missing!"); return; } try { const cats = Object.keys(fishCategories).sort(); input.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; if (Object.keys(fishCategories).length === 0) { console.warn("fishCategories object is empty!"); input.innerHTML = '<option value="" selected disabled>Error: No species loaded</option>'; return; } cats.forEach(cat => { const group = document.createElement('optgroup'); group.label = cat; const species = Array.isArray(fishCategories[cat]) ? [...fishCategories[cat]].sort() : []; if (species.length === 0) { console.warn(`No species array found for category: ${cat}`); } species.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; group.appendChild(opt); }); input.appendChild(group); }); isDropdownPopulated = true; console.log("Species dropdown populated successfully."); } catch (error) { console.error("Error during species dropdown population:", error); input.innerHTML = '<option value="" selected disabled>Error loading species</option>'; } }
        function toggleCustomSpeciesInput() { const sel=document.getElementById('speciesInput'), custom=document.getElementById('customSpeciesInput'); if(!sel||!custom)return; custom.style.display=sel.value==='Other'?'block':'none'; if(sel.value!=='Other')custom.value=''; }

        function toggleCompetitionFields(updateLog = true) {
             try{
                const isChecked = document.getElementById('isCompetition').checked;
                const zoneSelect = document.getElementById('zoneInput');
                const pegSelect = document.getElementById('pegInput');
                const initialsGroup = document.getElementById('initialsInputGroup');
                const verifiedByHeader = document.getElementById('verifiedByHeader');
                const competitionFieldsDiv = document.getElementById('competitionFields');
                const requiredIndicators = competitionFieldsDiv?.querySelectorAll('.required-indicator'); // Check if div exists

                if (!zoneSelect || !pegSelect || !initialsGroup || !competitionFieldsDiv || !requiredIndicators) {
                    console.error("Competition field elements missing for toggle.");
                    return;
                }

                zoneSelect.disabled = !isChecked;
                pegSelect.disabled = !isChecked;
                initialsGroup.style.display = isChecked ? 'block' : 'none';
                if (verifiedByHeader) verifiedByHeader.style.display = isChecked ? 'table-cell' : 'none';

                 requiredIndicators.forEach(span => {
                     span.style.display = isChecked ? 'inline' : 'none';
                 });

                 competitionFieldsDiv.style.opacity = isChecked ? '1' : '0.6';
                 competitionFieldsDiv.style.borderColor = isChecked ? 'var(--input-focus-border)' : 'var(--input-border)';
                 competitionFieldsDiv.style.backgroundColor = isChecked ? 'rgba(128, 128, 128, 0.1)' : 'rgba(128, 128, 128, 0.05)';
                 if (document.body.classList.contains('dark-mode')) {
                    competitionFieldsDiv.style.backgroundColor = isChecked ? 'rgba(255, 255, 255, 0.06)' : 'rgba(255, 255, 255, 0.03)';
                 }


                if (updateLog) { updateFishLog(); }
            }catch(e){console.error("Toggle comp fields err:",e);}
        }

        function setTodaysDate() { try { const dateInput = document.getElementById('competitionDate'); if (dateInput && !dateInput.value) { const today = new Date(); const formattedDate = formatDateForInput(today); dateInput.value = formattedDate; currentDate = formattedDate; console.log("Set date input to today:", formattedDate); } } catch (e) { console.error("Error setting today's date:", e); } }
        function startApp() { console.log("Start Fishing triggered."); setTodaysDate(); populateSpeciesDropdown(); showPage('registrationPage'); toggleCompetitionFields(false); /* Ensure fields match checkbox state */ }
        function startRecording() { console.log("Record Catch triggered."); const nameEl=document.getElementById('anglerName'), dateEl=document.getElementById('competitionDate'), venueEl=document.getElementById('venueInput'), checkEl=document.getElementById('isCompetition'), zoneEl=document.getElementById('zoneInput'), pegEl=document.getElementById('pegInput'); if(!nameEl||!dateEl||!venueEl||!checkEl||!zoneEl||!pegEl){showToast("Form elements missing.", "danger");return;} const name=nameEl.value.trim(), date=dateEl.value, venue=venueEl.value.trim(), isComp=checkEl.checked, zone=zoneEl.value, peg=pegEl.value; if(!name||!date||!venue){showToast("Angler Name, Date, and Venue are required.", "warning"); return;} if(isComp&&(!zone||!peg)){showToast("Zone & Peg required for competition mode.", "warning"); return;} if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){showToast("Please enter a valid date.", "warning"); return;} currentAngler=name; currentDate=date; currentVenue=venue; currentZone=isComp?zone:null; currentPeg=isComp?peg:null; const isActuallyCompetition = !!(currentZone && currentPeg); console.log("Start recording data:",{currentAngler,currentDate,currentVenue,currentZone,currentPeg,isCompetition:isActuallyCompetition}); populateSpeciesDropdown(); saveTempSession(); updateFishLog(); showPage('fishingPage'); if (isActuallyCompetition) { showModal('mlsInfoModal'); } }

        function addFish() {
            console.log("Add Fish button clicked. Validating...");
            const spEl = document.getElementById('speciesInput');
            const custEl = document.getElementById('customSpeciesInput');
            const lenEl = document.getElementById('lengthInput');
            const initialsEl = document.getElementById('initialsInput');
            const isCompetition = document.getElementById('isCompetition').checked;

            if (!spEl || !custEl || !lenEl) { showToast("Form elements missing.", "danger"); return; }

            let species = spEl.value;
            const lenVal = lenEl.value.trim();
            let length;
            let initials = null;

            if (!lenVal) { showToast("Length is required.", "warning"); lenEl.focus(); return; }
            length = Math.round(parseFloat(lenVal));
            if (isNaN(length) || length <= 0 || length > 500) { showToast("Please enter a valid length between 1 and 500 cm.", "warning"); lenEl.focus(); return; }

            if (species === 'Other') {
                species = custEl.value.trim();
                if (!species) { showToast("Custom species name is required when 'Other' is selected.", "warning"); custEl.focus(); return; }
                if (!/^[a-zA-Z\s'-]+$/.test(species)) { showToast("Species name contains invalid characters.", "warning"); custEl.focus(); return; }
            } else if (!species) {
                showToast("Please select a species.", "warning"); spEl.focus(); return;
            }

            if (isCompetition && initialsEl) {
                 initials = initialsEl.value.trim().toUpperCase();
            }

            const fishId = generateUUID();
            const newFishData = { id: fishId, species, length, initials: initials || null, imageId: null };

            fishData.push(newFishData);
            console.log("Added fish to main data:", newFishData);

            try {
                spEl.value = '';
                custEl.value = '';
                custEl.style.display = 'none';
                lenEl.value = '';
                if (initialsEl) initialsEl.value = '';
                spEl.focus(); // Focus back on species for next entry
            } catch (e) {
                console.error("Error resetting form fields after add:", e);
            }

            updateFishLog();
            saveTempSession();
            showToast(`${species} (${length}cm) added to log.`, "success");

            // Scroll the new fish into view
            const newRow = document.getElementById(`fishrow-${fishId}`);
            if (newRow) {
                newRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 newRow.classList.add('table-info');
                 setTimeout(() => newRow.classList.remove('table-info'), 1500);
            }
        }

        async function updateFishLog() {
            const logBody = document.getElementById('fishLog');
            const isCompetition = document.getElementById('isCompetition').checked;
            const verifiedByHeader = document.getElementById('verifiedByHeader');

            if (!logBody) { console.error("Fish log body (#fishLog) not found!"); return; }
            if (verifiedByHeader) { verifiedByHeader.style.display = isCompetition ? 'table-cell' : 'none'; }

            logBody.innerHTML = '';
            const colCount = 3 + (isCompetition ? 1 : 0) + 1;

            if (fishData.length === 0) {
                 const row = logBody.insertRow();
                 const cell = row.insertCell();
                 cell.colSpan = colCount;
                 cell.className = 'text-center text-muted p-3';
                 cell.textContent = 'No fish added yet.'; return;
            }

            const fragment = document.createDocumentFragment();

            // Iterate in reverse to show newest first (optional)
            // for (let i = fishData.length - 1; i >= 0; i--) {
            // const f = fishData[i];
            for (const [i, f] of fishData.entries()) { // Normal order
                 const row = document.createElement('tr'); // Use createElement for fragment compatibility
                 row.id = `fishrow-${f.id}`;

                 const photoCell = row.insertCell(); photoCell.className = 'photo-col';
                 const thumbContainer = document.createElement('span');
                 thumbContainer.className = 'thumbnail-container';
                 thumbContainer.id = `thumb-container-${f.id}`;
                 thumbContainer.tabIndex = 0;

                 // Default: Camera Icon, clickable to add photo
                 thumbContainer.innerHTML = '<i class="bi bi-camera no-photo-icon"></i>';
                 thumbContainer.setAttribute('role', 'button');
                 thumbContainer.setAttribute('aria-label', `Add photo for ${f.species || 'fish'} (${f.length || '?'}cm)`);
                 thumbContainer.onclick = (e) => { e.stopPropagation(); openCamera(f.id); };
                 thumbContainer.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCamera(f.id); }};
                 thumbContainer.title = 'Click to add photo';

                 photoCell.appendChild(thumbContainer);

                 row.insertCell().textContent = f.species || '?';

                 const lenCell = row.insertCell(); lenCell.className = 'length-col';
                 lenCell.textContent = f.length ? `${f.length} cm` : '?';

                 if (isCompetition) {
                      const initialsCell = row.insertCell(); initialsCell.className = 'verified-col';
                      initialsCell.textContent = f.initials || '-';
                 }

                 const deleteCell = row.insertCell(); deleteCell.className = 'delete-col';
                 const deleteBtn = document.createElement('button'); deleteBtn.type = 'button';
                 deleteBtn.className = 'delete-icon-btn';
                 deleteBtn.title = 'Delete this fish';
                 deleteBtn.setAttribute('aria-label', `Delete ${f.species || 'fish'} (${f.length || '?'}cm)`);
                 deleteBtn.innerHTML = '<i class="bi bi-x-circle-fill" aria-hidden="true"></i>';
                 // Pass index 'i' to delete function
                 deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteFish(i); });
                 deleteCell.appendChild(deleteBtn);

                 fragment.appendChild(row); // Add row to fragment

                 // If an image ID exists, load the thumbnail (this will update the container's content and handlers)
                 if (f.imageId) {
                      // Use setTimeout to ensure the element is in the fragment before loading
                      setTimeout(() => loadThumbnail(f.id, f.imageId), 0);
                 }
            }
            logBody.appendChild(fragment);
        }

        async function loadThumbnail(fishId, imageId) {
             const container = document.getElementById(`thumb-container-${fishId}`);
             if (!container || !imageId) return;

             container.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>';
             container.onclick = null;
             container.onkeydown = null;
             container.removeAttribute('aria-label');
             container.removeAttribute('role');
             container.title = 'Loading image...';

             try {
                 const blob = await getImageFromDb(imageId);
                 if (blob) {
                      const url = URL.createObjectURL(blob);
                      container.innerHTML = `<img src="${url}" alt="Fish thumbnail" class="fish-thumbnail">`;
                      container.onclick = (e) => { e.stopPropagation(); console.log(`Thumbnail clicked, showing image: ${imageId}`); showFullscreenImage(imageId); };
                      container.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showFullscreenImage(imageId); }};
                      container.setAttribute('role', 'button');
                      const fishName = container.closest('tr')?.cells[1]?.textContent || 'fish';
                      container.setAttribute('aria-label', `View photo for ${fishName}`);
                      container.title = 'Click to view full size';
                 } else {
                      container.innerHTML = `<i class="bi bi-image-alt no-photo-icon" title="Image missing"></i>`;
                      container.title = 'Image data not found';
                 }
             } catch (error) {
                 console.error(`Error loading thumbnail for ${imageId}:`, error);
                 container.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger no-photo-icon" title="Error loading image"></i>`;
                 container.title = 'Error loading image';
             }
         }

        async function deleteFish(idx) {
             if (idx >= 0 && idx < fishData.length) {
                 const fishToDelete = fishData[idx];
                 const { id, species, length, imageId } = fishToDelete;
                 let confirmMessage = `Delete ${species || '?'} (${length || '?'}cm)?`;
                 if (imageId) { confirmMessage += " The associated photo will also be deleted."; }

                 if (confirm(confirmMessage)) {
                     console.log("Deleting fish index:", idx, "ID:", id, "ImageID:", imageId);
                     try {
                         if (imageId) {
                             await deleteImageFromDb(imageId);
                         }
                         fishData.splice(idx, 1);
                         // Find the row and remove it directly for smoother UI update
                         const rowToRemove = document.getElementById(`fishrow-${id}`);
                         if (rowToRemove) {
                             rowToRemove.remove();
                         } else {
                             // Fallback to full log update if row not found
                             updateFishLog();
                         }
                         saveTempSession();
                         showToast("Fish record deleted.", "info");
                         // Check if log is now empty
                         if (fishData.length === 0) {
                             updateFishLog(); // Call again to show the "No fish" message
                         }
                     } catch (error) {
                         console.error("Error during fish/image deletion:", error);
                         showToast("An error occurred while deleting the fish or its photo.", "danger");
                         updateFishLog(); // Refresh log on error
                     }
                 } else {
                     console.log("Delete cancelled.");
                 }
             } else {
                 console.error("Invalid delete idx:", idx);
                 showToast("Error: Could not delete fish record (invalid index).", "danger");
             }
        }
        function backFromFishing() { console.log("Back from Fishing."); stopCameraStream(); showPage('registrationPage'); }


        // --- Camera Functions ---
        async function openCamera(fishId) {
            console.log("Opening camera for fish ID:", fishId);
            if (!fishId) { console.error("Cannot open camera without a fish ID."); return; }

            currentFishIdForPhoto = fishId;
            const video = document.getElementById('cameraVideo');
            if (!video || !cameraModalInstance) { console.error("Camera video or modal instance missing!"); showToast("Camera UI elements not found.", "danger"); return; }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showToast("Camera access is not supported by your browser.", "warning"); return; }

            try {
                const constraints = { video: { facingMode: "environment" } };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                await video.play();
                cameraModalInstance.show();
                console.log("Camera stream started (rear).");
            } catch (err) {
                console.warn("Error accessing rear camera:", err);
                if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError" || err.name === "OverconstrainedError" || err.name === "ConstraintNotSatisfiedError") {
                     console.log("Trying front camera...");
                    try {
                        const frontConstraints = { video: { facingMode: "user" } };
                        currentStream = await navigator.mediaDevices.getUserMedia(frontConstraints);
                        video.srcObject = currentStream;
                        await video.play();
                        cameraModalInstance.show();
                        console.log("Camera stream started (front).");
                    } catch (fallbackErr) {
                        console.error("Error accessing front camera:", fallbackErr);
                        stopCameraStream();
                        showToast(`Could not access any camera. Error: ${fallbackErr.name || fallbackErr.message}`, "danger");
                        currentFishIdForPhoto = null;
                    }
                } else if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                    showToast("Camera permission denied. Please allow camera access in your browser settings.", "warning");
                    currentFishIdForPhoto = null;
                } else {
                    showToast(`Could not access camera. Error: ${err.name || err.message}`, "danger");
                    currentFishIdForPhoto = null;
                }
            }
        }
        function stopCameraStream() { if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); console.log("Camera stream stopped."); currentStream = null; const video = document.getElementById('cameraVideo'); if (video) video.srcObject = null; } }
        async function takeSnapshot(event) {
             const takePhotoButton = event.target;
             console.log("Taking snapshot...");
             toggleButtonSpinner(takePhotoButton, true);

             const video = document.getElementById('cameraVideo');
             const canvas = document.getElementById('cameraCanvas');

             if (!video || !canvas || !currentFishIdForPhoto) {
                 console.error("Missing video, canvas, or fish ID for snapshot.");
                 showToast("Error taking photo: missing components.", "danger");
                 stopCameraStream();
                 hideModal('cameraModal');
                 toggleButtonSpinner(takePhotoButton, false);
                 return;
             }

             const context = canvas.getContext('2d');
             canvas.width = video.videoWidth;
             canvas.height = video.videoHeight;
             // Optional: Mirror front camera image
             // if (currentStream?.getVideoTracks()[0]?.getSettings()?.facingMode === 'user') {
             //     context.translate(canvas.width, 0);
             //     context.scale(-1, 1);
             // }
             context.drawImage(video, 0, 0, canvas.width, canvas.height);
             stopCameraStream(); // Stop stream now

             canvas.toBlob(async (blob) => {
                 if (blob) {
                     const imageId = `img_${currentFishIdForPhoto}_${Date.now()}`;
                     console.log(`Generated Blob. Saving with ID: ${imageId}`);
                     try {
                         await saveImageToDb(imageId, blob);
                         const fishIndex = fishData.findIndex(f => f.id === currentFishIdForPhoto);
                         if (fishIndex !== -1) {
                             fishData[fishIndex].imageId = imageId;
                             console.log("Updated fishData with imageId:", fishData[fishIndex]);
                             saveTempSession();
                             // Don't call updateFishLog here, call loadThumbnail directly
                             loadThumbnail(currentFishIdForPhoto, imageId);
                             showToast("Photo saved successfully.", "success");
                         } else {
                             console.error("Could not find fish with ID", currentFishIdForPhoto, "after taking photo.");
                             showToast("Error associating photo with fish record.", "danger");
                         }
                     } catch (error) {
                         console.error("Error saving image blob to DB:", error);
                         showToast("Failed to save the photo.", "danger");
                     }
                 } else {
                     console.error("Canvas toBlob failed.");
                     showToast("Failed to capture photo data.", "danger");
                 }
                 hideModal('cameraModal');
                 toggleButtonSpinner(takePhotoButton, false);
                 currentFishIdForPhoto = null;
             }, 'image/jpeg', 0.9);
         }


        // --- End Session Modal ---
        function showEndSessionModal() { console.log("End Session button clicked."); const modalEl = document.getElementById('endSessionModal'); const verifierSection = document.getElementById('verifierEndModalSection'); const verifierInput = document.getElementById('verifierEndModalInput'); if (!modalEl || !verifierSection || !verifierInput) { console.error("End session modal elements missing!"); showToast("Error preparing end session dialog.", "danger"); return; } const isCompetition = !!(currentZone && currentPeg); verifierSection.style.display = isCompetition ? 'block' : 'none'; verifierInput.required = isCompetition; // Set required attribute dynamically
             verifierInput.value = ''; bootstrap.Modal.getOrCreateInstance(modalEl, {backdrop: 'static', keyboard: false}).show(); }

        function confirmEndSession(event) {
             const confirmButton = event.target.matches('button') ? event.target : event.target.closest('button');
             console.log("Confirm End button clicked.");
             toggleButtonSpinner(confirmButton, true);

             if (!currentAngler || !currentDate || !currentVenue) {
                 showToast("Cannot save session: Missing Angler Name, Date, or Venue.", "warning");
                 hideModal('endSessionModal');
                 toggleButtonSpinner(confirmButton, false);
                 return;
             }

             const isCompetition = !!(currentZone && currentPeg);
             let verifierName = null;
             const verifierInput = document.getElementById('verifierEndModalInput'); // Define here for broader scope

             if (isCompetition) {
                 if (!verifierInput) {
                     console.error("Verifier input missing!");
                     showToast("Error: Verifier input field not found.", "danger");
                     toggleButtonSpinner(confirmButton, false);
                     return;
                 }
                 verifierName = verifierInput.value.trim();
                 if (!verifierName) {
                     showToast("Competition Scorecard: Please enter the verifier's name.", "warning");
                     verifierInput.focus();
                     toggleButtonSpinner(confirmButton, false);
                     return;
                 }
             }

             hideModal('endSessionModal');
             console.log("Validation passed. Saving data with verifier:", verifierName);
             const sessionData = {
                 currentAngler, currentDate, currentVenue, currentZone, currentPeg,
                 verifier: verifierName, notes: null,
                 fishData: fishData || [], isCompetition: isCompetition
             };
             const id = `scorecard_${Date.now()}`;

             try {
                 localStorage.setItem(id, JSON.stringify(sessionData));
                 console.log("Saved scorecard metadata:", id);
                 showToast("Scorecard saved successfully!", "success");
                 clearTempSession();
                 resetApp();
                 showPage('splashScreen');
             } catch (e) {
                 console.error("Save scorecard metadata err:", e);
                 let errorMsg = "Save failed. Could not save scorecard.";
                 if (e.name === 'QuotaExceededError') {
                     errorMsg = "Save failed. Local storage is full. Please delete older scorecards.";
                 }
                 showToast(errorMsg, "danger");
             } finally {
                 // Ensure spinner is always removed
                 toggleButtonSpinner(confirmButton, false);
             }
         }


        // --- Tally Page ---
        function populateTallySummaryFields() {
             try {
                 document.getElementById('summaryAngler').textContent = currentAngler || '?';
                 document.getElementById('summaryDate').textContent = currentDate ? formatDate(currentDate) : '?';
                 document.getElementById('summaryVenue').textContent = currentVenue || '?';

                 const isCompetition = !!(currentZone && currentPeg);
                 const zoneLabel = document.getElementById('summaryZoneLabel');
                 const zoneValue = document.getElementById('summaryZone');
                 const pegLabel = document.getElementById('summaryPegLabel');
                 const pegValue = document.getElementById('summaryPeg');
                 // Verifier info isn't stored during session, only on save
                 const verifierLabel = document.getElementById('summaryVerifierLabel');
                 const verifierValue = document.getElementById('summaryVerifier');

                 if (isCompetition) {
                     zoneValue.textContent = currentZone || '?';
                     pegValue.textContent = currentPeg || '?';
                     zoneLabel.style.display = ''; zoneValue.style.display = '';
                     pegLabel.style.display = ''; pegValue.style.display = '';
                 } else {
                     zoneLabel.style.display = 'none'; zoneValue.style.display = 'none';
                     pegLabel.style.display = 'none'; pegValue.style.display = 'none';
                 }
                 verifierLabel.style.display = 'none'; verifierValue.style.display = 'none';


             } catch (e) {
                 console.error("Error populating tally summary fields:", e);
             }
         }
        function populateTallyTable() { const tableBody = document.getElementById('tallyTable'); if (!tableBody) return; const speciesSummary = {}; let overallTotalLength = 0; let longestFish = null; fishData.forEach(fish => { const speciesKey = fish.species || "?"; const length = fish.length || 0; speciesSummary[speciesKey] = speciesSummary[speciesKey] || { count: 0, totalLength: 0, lengths: [] }; speciesSummary[speciesKey].count++; speciesSummary[speciesKey].totalLength += length; speciesSummary[speciesKey].lengths.push(length); overallTotalLength += length; if (!longestFish || length > (longestFish.length || 0)) { longestFish = fish; } }); Object.values(speciesSummary).forEach(details => details.lengths.sort((a, b) => a - b)); const sortedSpeciesEntries = Object.entries(speciesSummary).sort(([a], [b]) => a.localeCompare(b)); tableBody.innerHTML = sortedSpeciesEntries.map(([species, details]) => `<tr> <td>${species}</td> <td>${details.count}</td> <td>(${details.lengths.join(', ')})</td> <td>${details.totalLength}</td> </tr>` ).join('') || '<tr><td colspan="4" class="text-center">No fish recorded.</td></tr>'; const speciesCount = Object.keys(speciesSummary).length; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); document.getElementById('tallyTotalLength').textContent = `${overallTotalLength} cm`; document.getElementById('tallySpeciesCount').textContent = speciesCount; document.getElementById('longestFishSpecies').textContent = longestFish ? (longestFish.species || '?') : 'N/A'; document.getElementById('longestFishLength').textContent = longestFish ? `${longestFish.length || '?'} cm` : '0 cm'; document.getElementById('tallyPointsTotal').textContent = points; }
        function backFromTally() { console.log("Back from Tally."); showPage('fishingPage'); }


        // --- Saved Scorecards ---
        function showScorecardsModal() { console.log("View Scorecards."); const modalEl=document.getElementById('savedScorecardsModal'), listEl=document.getElementById('savedScorecardsList'); if(modalEl&&listEl){listEl.innerHTML='<div class="text-center p-3"><div class="spinner-border text-primary"><span class="visually-hidden">Loading...</span></div></div>'; let mI=bootstrap.Modal.getInstance(modalEl);if(!mI)mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false});mI.show();setTimeout(loadScorecards,50);}else{console.error("Scorecard modal/list missing.");showToast("Error showing scorecards modal.", "danger");}}
        async function loadScorecards() { console.log("Loading scorecards..."); const savedScorecardsList = document.getElementById('savedScorecardsList'); const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer'); if (!savedScorecardsList || !olderScorecardsToggleContainer) { console.error("CRITICAL: Modal list or toggle container missing!"); return; } savedScorecardsList.innerHTML = ''; olderScorecardsToggleContainer.innerHTML = ''; const scorecards = []; let loadError = false; try { for (let i=0; i<localStorage.length; i++){ const key=localStorage.key(i); if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ try { const data=JSON.parse(dS); if(data?.currentAngler && data.currentDate && data.currentVenue){ const tS=parseInt(key.split('_')[1],10); if(!isNaN(tS)){scorecards.push({key,data,timestamp:tS});}} else {console.warn("Skip invalid card:",key);}} catch(e){console.error("Parse err:",key,e);}}}}} catch (e) { console.error("LS err:",e); savedScorecardsList.innerHTML='<p class="text-danger p-3 text-center">Failed to load scorecards from storage.</p>'; loadError=true; showToast("Error reading scorecards from storage.", "danger"); } if(loadError) return; scorecards.sort((a,b)=>b.timestamp-a.timestamp); if (scorecards.length===0){ savedScorecardsList.innerHTML='<p class="text-center text-muted p-3">No saved scorecards found.</p>'; return; } console.log(`Total scorecards found: ${scorecards.length}`); const displayLimit = DISPLAY_SCORECARD_LIMIT; try { const initial = scorecards.slice(0, displayLimit); initial.forEach(({ key, data }, index) => { const el = createScorecardElement(key, data, index === 0); if (el) savedScorecardsList.appendChild(el); }); } catch(e) { console.error("Err initial loop:", e); savedScorecardsList.innerHTML += '<p class="text-danger p-3 text-center">Error displaying initial scorecards.</p>'; } if (scorecards.length > displayLimit) { const olderCount = scorecards.length - displayLimit; const showOlderBtn = document.createElement('button'); showOlderBtn.id = 'showOlderBtn'; showOlderBtn.className = 'btn btn-outline-secondary'; showOlderBtn.innerHTML = `<i class="bi bi-chevron-double-down me-1"></i> View ${olderCount} Older`; showOlderBtn.onclick = function(event) { const btn = event.target.closest('button'); console.log("'Older' clicked."); toggleButtonSpinner(btn, true); setTimeout(() => { // Allow UI to update spinner try { const older = scorecards.slice(displayLimit); older.forEach(({ key, data }) => { const el = createScorecardElement(key, data, false); if (el) savedScorecardsList.appendChild(el); }); olderScorecardsToggleContainer.innerHTML = ''; // Remove buttons after showing } catch(e) { console.error("Err create/append older:", e); olderScorecardsToggleContainer.innerHTML = '<p class="text-danger">Error displaying older scorecards.</p>'; } finally { // Spinner removed automatically by toggleButtonSpinner } }, 50); // Short delay }; olderScorecardsToggleContainer.appendChild(showOlderBtn); const deleteOlderBtn = document.createElement('button'); deleteOlderBtn.id = 'deleteOlderBtn'; deleteOlderBtn.className = 'btn btn-outline-danger'; // Use outline danger deleteOlderBtn.innerHTML = `<i class="bi bi-trash me-1"></i> Delete ${olderCount} Older`; deleteOlderBtn.onclick = confirmDeleteOlderScorecards; olderScorecardsToggleContainer.appendChild(deleteOlderBtn); } }
        function createScorecardElement (key, data, isLatest) { try { const wrapperDiv = document.createElement('div'); wrapperDiv.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`; wrapperDiv.id = `entry-${key}`; let overallTotalLength = 0, fishCount = 0, speciesSet = new Set(), longestFish = null, speciesTotals = {}; const fishList = data.fishData || []; fishList.forEach(f => { const length = f.length || 0; const speciesName = f.species || '?'; fishCount++; overallTotalLength += length; speciesSet.add(speciesName); if (!longestFish || length > (longestFish.length || 0)) longestFish = f; speciesTotals[speciesName] = (speciesTotals[speciesName] || 0) + length; }); const speciesCount = speciesSet.size; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); const longestFishString = longestFish ? `${longestFish.species || '?'}(${longestFish.length || '?'}cm)` : 'N/A'; const escapedKey = key.replace(/'/g, "\\'"); const viewNoteButtonHtml = (data.notes && data.notes.trim() !== '') ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${escapedKey}', event)"><i class="bi bi-eye me-1"></i>View Note</button>` : ''; let fishListHtml = '<p class="ms-2 text-muted">No fish recorded.</p>'; if (fishList.length > 0) { fishListHtml = fishList.map((f, i) => { let verifiedText = ''; if (data.isCompetition && f.initials) verifiedText = ` <small class="text-muted">(Verified: ${f.initials})</small>`; return `<p class="fish-list-item">${i + 1}. ${f.species || '?'} - ${f.length || '?'}cm${verifiedText}</p>`; }).join(''); } let speciesSummaryHtml = ''; if (Object.keys(speciesTotals).length > 0) { const sortedSpecies = Object.entries(speciesTotals).sort((a, b) => a[0].localeCompare(b[0])); speciesSummaryHtml += '<div class="species-length-summary">'; speciesSummaryHtml += '<h6>Species Length Totals:</h6>'; sortedSpecies.forEach(([speciesName, totalLength]) => { speciesSummaryHtml += `<p><strong>${speciesName}:</strong> ${totalLength}cm</p>`; }); speciesSummaryHtml += '</div><hr>'; } const photosPlaceholderId = `sessionPhotos-${key}`; const photosHtml = `<hr><h6>Session Photos</h6><div class="session-photos" id="${photosPlaceholderId}"><p class="text-muted placeholder-photos">(No photos)</p></div>`; wrapperDiv.innerHTML = ` <div class="scorecard-item" onclick="toggleScorecardDetails('${escapedKey}',this)"> <i class="bi bi-chevron-right me-2"></i><strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')} <span class="text-muted ms-2">(${fishCount} fish, ${overallTotalLength}cm, ${points} pts)</span> ${isLatest ? '<span class="badge bg-primary ms-2">Latest</span>' : ''} </div> <div class="scorecard-details" id="details_${key}"> <h6>Session Details</h6> <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p> <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p> <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p> ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''} ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''} ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''} <hr> <h6>Catch (${fishCount})</h6> ${fishListHtml} ${fishList.length > 0 ? ` <hr> <div class="scorecard-summary-block"> <h6>Summary</h6> ${speciesSummaryHtml} <p><strong class="summary-highlight">Overall Total Length:</strong> ${overallTotalLength}cm</p> <p><strong>Total Species:</strong> ${speciesCount}</p> <p><strong>Longest Fish:</strong> ${longestFishString}</p> <p><strong class="summary-highlight">Points Total:</strong> ${points}</p> </div> ` : ''} ${photosHtml} <div class="btn-actions-group"> ${viewNoteButtonHtml} <button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${escapedKey}', event)"><i class="bi bi-pencil me-1"></i>Add/Edit Note</button> <button class="btn btn-info btn-sm" onclick="emailScorecard('${escapedKey}', event)"><i class="bi bi-envelope me-1"></i>Email</button> <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${escapedKey}', event, this)"><i class="bi bi-trash me-1"></i>Delete</button> </div> </div>`; setTimeout(() => loadSessionPhotos(key, fishList), 0); return wrapperDiv; } catch (elementError) { console.error(`Err create el for ${key}:`, elementError); const errDiv = document.createElement('div'); errDiv.className = 'alert alert-warning p-2 my-2'; errDiv.textContent = `Error displaying card ${key.slice(-4)}`; return errDiv; } }
        async function loadSessionPhotos(scorecardKey, fishList) { const photosContainerId = `sessionPhotos-${scorecardKey}`; const photosContainer = document.getElementById(photosContainerId); if (!photosContainer) { console.error(`Photos container not found: ${photosContainerId}`); return; } const fishWithPhotos = fishList.filter(f => !!f.imageId); if (fishWithPhotos.length === 0) { photosContainer.innerHTML = '<p class="text-muted placeholder-photos">(No photos saved for this session)</p>'; return; } console.log(`Loading ${fishWithPhotos.length} photos for scorecard ${scorecardKey}`); photosContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading photos...</span></div>'; let imagesAdded = 0; const imagePromises = fishWithPhotos.map(async (fish) => { try { const blob = await getImageFromDb(fish.imageId); if (blob) { const url = URL.createObjectURL(blob); const img = document.createElement('img'); img.src = url; img.alt = `Photo for ${fish.species || 'fish'}`; img.className = 'session-photo-thumbnail'; img.onclick = () => showFullscreenImage(fish.imageId); img.onload = () => URL.revokeObjectURL(url); // Revoke URL when image is loaded return img; } else { console.warn(`Blob not found in DB for imageId: ${fish.imageId}`); return null; } } catch (error) { console.error(`Error loading photo ${fish.imageId} for scorecard ${scorecardKey}:`, error); return null; } }); const imageElements = await Promise.all(imagePromises); photosContainer.innerHTML = ''; imageElements.forEach(img => { if (img) { photosContainer.appendChild(img); imagesAdded++; } }); if (imagesAdded === 0 && fishWithPhotos.length > 0) { photosContainer.innerHTML = '<p class="text-danger placeholder-photos">(Error loading session photos)</p>'; } else if (imagesAdded === 0) { photosContainer.innerHTML = '<p class="text-muted placeholder-photos">(No photos found)</p>'; } console.log(`Finished loading photos for scorecard ${scorecardKey}. Added ${imagesAdded} images.`); }
        function toggleScorecardDetails(key, element){ console.log("Toggle:",key); const d=document.getElementById(`details_${key}`), i=element.querySelector('i.bi'); if(d){const v=d.style.display==='block'; d.style.display=v?'none':'block'; if(i){i.classList.toggle('bi-chevron-right',v);i.classList.toggle('bi-chevron-down',!v);} element.classList.toggle('details-visible',!v);}else{console.error("Details missing:",key);}}

        async function deleteScorecard(key, event, buttonElement){
            event.stopPropagation(); // Prevent details toggle
            console.log("Delete scorecard key:", key);
            toggleButtonSpinner(buttonElement, true);

            let data;
            try { data = JSON.parse(localStorage.getItem(key) || '{}'); } catch (e) { data = {}; }

            const fishList = data.fishData || [];
            const imageIdsToDelete = fishList.map(f => f.imageId).filter(id => !!id);
            let scorecardName = `scorecard from ${formatDate(data.currentDate || '')}`;
            try { scorecardName = `scorecard for ${data.currentAngler || '?'} on ${formatDate(data.currentDate || '')}`; } catch (e) {}

            if (confirm(`Delete ${scorecardName}? This will also delete ${imageIdsToDelete.length} associated photo(s). This action cannot be undone.`)) {
                try {
                    if (imageIdsToDelete.length > 0) {
                        console.log("Deleting images from DB:", imageIdsToDelete);
                        const deletePromises = imageIdsToDelete.map(id => deleteImageFromDb(id));
                        await Promise.allSettled(deletePromises); // Wait for all deletions to attempt
                        console.log("Image deletion from DB attempted.");
                    }
                    localStorage.removeItem(key);
                    console.log("Deleted scorecard metadata from localStorage:", key);
                    // Remove the element from the UI directly
                    const entryElement = document.getElementById(`entry-${key}`);
                    if (entryElement) {
                        entryElement.remove();
                    } else {
                        loadScorecards(); // Fallback to full reload if element not found
                    }
                     showToast("Scorecard deleted successfully.", "success");
                     // Check if list is now empty or only has older placeholders
                     const remainingEntries = document.querySelectorAll('#savedScorecardsList .scorecard-entry');
                     if (remainingEntries.length === 0) {
                         loadScorecards(); // Reload to show "No scorecards" message
                     }

                } catch (e) {
                    console.error("Delete scorecard/images error:", e);
                    showToast("Failed to delete scorecard or some associated images.", "danger");
                    loadScorecards(); // Reload on error
                } finally {
                     // Spinner removed automatically
                }
            } else {
                console.log("Delete cancelled.");
                toggleButtonSpinner(buttonElement, false); // Remove spinner if cancelled
            }
        }

        function emailScorecard(key, event) { /* Unchanged except alert */ event.stopPropagation(); console.log("Emailing:", key); showToast("Preparing email... Photos and Notes are NOT included.", "info", 2000); let data; try { const dS = localStorage.getItem(key); if (!dS) throw new Error("Not found."); data = JSON.parse(dS); if (!data?.currentAngler || !data.currentDate || !data.currentVenue || !Array.isArray(data.fishData)) throw new Error("Invalid data."); } catch (error) { console.error("Email data err:", error); showToast(`Error getting data for email: ${error.message}`, "danger"); return; } let body = "Sea Catch Scorecard\r\n=====================\r\n\r\n"; body += "Session Details:\r\n"; body += `Angler: ${data.currentAngler||'?'}\r\n`; body += `Date: ${formatDate(data.currentDate||'')}\r\n`; body += `Venue: ${data.currentVenue||'?'}\r\n`; if(data.currentZone)body+=`Zone: ${data.currentZone}\r\n`; if(data.currentPeg)body+=`Peg: ${data.currentPeg}\r\n`; if(data.verifier)body+=`Verified By: ${data.verifier}\r\n`; body += "\r\n"; body += "Catch List:\r\n"; if(data.fishData?.length>0){data.fishData.forEach((f,i)=>{body+=`${i+1}. ${f.species||'?'} - ${f.length||'?'} cm`; if(data.isCompetition && f.initials) { body += ` - Verified by: ${f.initials || '-'}`;} body += `\r\n`;});}else{body+="No fish.\r\n";} body+="\r\n"; let overallTotalLength=0, fishCount=0, speciesSet=new Set(), longestFish=null, speciesTotals={}; const fishList=data.fishData||[]; fishList.forEach(f=>{ const l=f.length||0; const sN=f.species||'?'; fishCount++; overallTotalLength+=l; speciesSet.add(sN); if(!longestFish||l>(longestFish.length||0)) longestFish=f; speciesTotals[sN]=(speciesTotals[sN]||0)+l; }); const speciesCount=speciesSet.size; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); const longestFishString=longestFish?`${longestFish.species||'?'}(${longestFish.length||'?'}cm)`:'N/A'; body += "Summary:\r\n"; if(Object.keys(speciesTotals).length > 0) { body += "Species Length Totals:\r\n"; Object.entries(speciesTotals).sort((a,b) => a[0].localeCompare(b[0])).forEach(([name, len]) => { body += ` - ${name}: ${len}cm\r\n`; }); body += "\r\n"; } body += `Overall Total Fish: ${fishCount}\r\n`; body += `Overall Total Length: ${overallTotalLength} cm\r\n`; body += `Unique Species: ${speciesCount}\r\n`; body += `Longest Fish: ${longestFishString}\r\n`; body += `Points Total: ${points}\r\n`; body += "\r\n=====================\r\n"; const subject = `Fishing Scorecard: ${data.currentVenue||'?'} - ${formatDate(data.currentDate||'')}`; const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; if(mailtoUrl.length>1800){console.warn(`Mailto long (${mailtoUrl.length})`); showToast("Warning: Scorecard data is very long, email may be truncated.", "warning");} console.log("Mailto len:", mailtoUrl.length); try{window.open(mailtoUrl,'_self');}catch(e){console.error("Mailto err:",e);showToast("Could not open email client.", "danger");} }

        // --- Notes Modal Functions ---
        function openNotesModal(key, event) { if(event) event.stopPropagation(); console.log('Opening notes modal for key:', key); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { console.error('Notes modal elements/instance missing!'); showToast('Error opening notes editor.', 'danger'); return; } try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; notesTextarea.value=data.notes||''; } catch(e){ console.error('Error loading notes for modal:',e); notesTextarea.value=''; showToast('Error loading existing notes.', 'warning'); } notesModalKeyInput.value = key; notesModalInstance.show(); }
        function saveNoteFromModal(event) {
             const saveButton = event.target.matches('button') ? event.target : event.target.closest('button');
             console.log('Save notes modal clicked.');
             toggleButtonSpinner(saveButton, true);

             const notesTextarea = document.getElementById('notesTextarea');
             const notesModalKeyInput = document.getElementById('notesModalScorecardKey');

             if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) {
                 showToast('Error saving notes: components missing.', 'danger');
                 toggleButtonSpinner(saveButton, false);
                 return;
             }
             const key = notesModalKeyInput.value;
             const newNotes = notesTextarea.value;
             if (!key) {
                 showToast('Error: Scorecard key missing.', 'danger');
                 toggleButtonSpinner(saveButton, false);
                 return;
             }

             try {
                 const dS = localStorage.getItem(key);
                 if (!dS) throw new Error('Scorecard data not found.');
                 let data = JSON.parse(dS);
                 data.notes = newNotes;
                 localStorage.setItem(key, JSON.stringify(data));
                 console.log('Notes saved via modal for key:', key);
                 notesModalInstance.hide();
                 showToast("Notes saved successfully.", "success");
                 // Update the button visibility in the scorecard list without full reload
                 const viewNoteBtn = document.querySelector(`#entry-${key} .btn-secondary[onclick^="viewNote"]`);
                 const addEditNoteBtn = document.querySelector(`#entry-${key} .btn-outline-secondary[onclick^="openNotesModal"]`);
                 if (newNotes.trim() !== '' && !viewNoteBtn && addEditNoteBtn) {
                     // Add the 'View Note' button if it doesn't exist
                     const newViewBtn = document.createElement('button');
                     newViewBtn.className = "btn btn-secondary btn-sm";
                     newViewBtn.innerHTML = '<i class="bi bi-eye me-1"></i>View Note';
                     newViewBtn.onclick = (e) => viewNote(key, e);
                     addEditNoteBtn.parentNode.insertBefore(newViewBtn, addEditNoteBtn);
                 } else if (newNotes.trim() === '' && viewNoteBtn) {
                     // Remove the 'View Note' button if notes are empty
                     viewNoteBtn.remove();
                 }
                 // setTimeout(loadScorecards, 150); // Optionally reload full list
             } catch (e) {
                 console.error('Error saving notes from modal:', e);
                 let errorMsg = `Failed to save notes: ${e.message}`;
                 if (e.name === 'QuotaExceededError') {
                    errorMsg = "Local storage is full. Could not save notes.";
                 }
                 showToast(errorMsg, 'danger');
             } finally {
                toggleButtonSpinner(saveButton, false);
             }
         }
        function viewNote(key, event) { event.stopPropagation(); console.log('Viewing notes for key:', key); try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; const notes=data.notes||''; alert(`Notes for scorecard:\n--------------------\n${notes || '(No notes saved)'}`); } catch (e) { console.error('Error retrieving notes:', e); showToast('Could not retrieve notes.', 'danger'); } }

        // --- Delete Older Scorecards Functions ---
        function confirmDeleteOlderScorecards(event) {
             const deleteButton = event.target.closest('button');
             toggleButtonSpinner(deleteButton, true); // Show spinner immediately

             const displayLimit = DISPLAY_SCORECARD_LIMIT;
             const scorecards = [];
             try {
                 for (let i = 0; i < localStorage.length; i++) {
                     const key = localStorage.key(i);
                     if (key?.startsWith('scorecard_')) {
                         const timestamp = parseInt(key.split('_')[1], 10);
                         if (!isNaN(timestamp)) {
                              scorecards.push({ key, timestamp });
                         }
                     }
                 }
             } catch (e) {
                 showToast('Error reading scorecards for deletion count.', 'danger');
                 toggleButtonSpinner(deleteButton, false);
                 return;
             }

             scorecards.sort((a, b) => b.timestamp - a.timestamp); // Sort descending

             if (scorecards.length > displayLimit) {
                 const olderItems = scorecards.slice(displayLimit);
                 const olderKeys = olderItems.map(item => item.key);
                 const olderCount = olderKeys.length;
                 let imageCount = 0;
                 olderKeys.forEach(key => {
                     try {
                         const data = JSON.parse(localStorage.getItem(key) || '{}');
                         imageCount += (data.fishData || []).filter(f => !!f.imageId).length;
                     } catch (e) {}
                 });

                 // Use setTimeout to allow spinner to render before confirm dialog
                 setTimeout(() => {
                     if (confirm(`Are you sure you want to delete the oldest ${olderCount} scorecard${olderCount > 1 ? 's' : ''} (including approx. ${imageCount} photos)? This cannot be undone.`)) {
                         deleteOlderScorecards(olderKeys, deleteButton); // Pass keys and button
                     } else {
                         console.log("Delete older scorecards cancelled.");
                         toggleButtonSpinner(deleteButton, false); // Remove spinner if cancelled
                     }
                 }, 50); // Small delay

             } else {
                 showToast("No older scorecards found to delete (less than " + (displayLimit + 1) + " total).", "info");
                 toggleButtonSpinner(deleteButton, false); // Remove spinner if none to delete
             }
         }
        async function deleteOlderScorecards(keysToDelete, buttonElement) {
             console.log("Deleting older scorecards...");
             let errorOccurred = false;
             try {
                 if (keysToDelete.length > 0) {
                     console.log(`Attempting to delete ${keysToDelete.length} older scorecards:`, keysToDelete);
                     let allImageIdsToDelete = [];
                     keysToDelete.forEach(key => {
                         try {
                             const data = JSON.parse(localStorage.getItem(key) || '{}');
                             allImageIdsToDelete.push(...(data.fishData || []).map(f => f.imageId).filter(id => !!id));
                         } catch (e) { console.warn("Error parsing scorecard for image IDs during delete:", key); }});
                     allImageIdsToDelete = [...new Set(allImageIdsToDelete)];

                     if (allImageIdsToDelete.length > 0) {
                         console.log("Deleting older images from DB:", allImageIdsToDelete);
                         const deleteImgPromises = allImageIdsToDelete.map(id => deleteImageFromDb(id));
                         const results = await Promise.allSettled(deleteImgPromises);
                         results.forEach((result, index) => {
                             if (result.status === 'rejected') {
                                 console.error(`Failed to delete image ${allImageIdsToDelete[index]}:`, result.reason);
                                 errorOccurred = true; // Mark error but continue
                             }});
                         console.log("Older image deletion from DB attempted.");
                     }

                     keysToDelete.forEach(key => {
                         try {
                             localStorage.removeItem(key);
                             console.log(`Deleted metadata: ${key}`);
                             // Remove element from UI
                             const entryElement = document.getElementById(`entry-${key}`);
                             if (entryElement) entryElement.remove();
                         } catch (removeError) {
                             console.error(`Error removing metadata key ${key}:`, removeError);
                             errorOccurred = true;
                         }
                     });

                     if (errorOccurred) {
                         showToast("Some older scorecards or their photos may not have been deleted due to an error.", "warning");
                     } else {
                         showToast(`${keysToDelete.length} older scorecard${keysToDelete.length > 1 ? 's' : ''} and associated photos deleted successfully.`, "success");
                     }
                     // Remove the delete buttons container
                     const toggleContainer = document.getElementById('olderScorecardsToggleContainer');
                     if(toggleContainer) toggleContainer.innerHTML = '';

                 } else {
                     console.log("No older scorecards found to delete after re-check.");
                 }
             } catch (e) {
                 console.error("Error during the delete older process:", e);
                 showToast("An error occurred while trying to delete older scorecards.", "danger");
                 errorOccurred = true;
             } finally {
                 toggleButtonSpinner(buttonElement, false); // Always remove spinner
                 // Optionally reload the list fully if errors occurred or state is uncertain
                 // if (errorOccurred) loadScorecards();
                 const remainingEntries = document.querySelectorAll('#savedScorecardsList .scorecard-entry');
                 if (remainingEntries.length === 0) {
                     loadScorecards(); // Reload to show "No scorecards" message
                 }
             }
         }

        // --- Image Viewer and Sharing ---
        async function showFullscreenImage(imageId) { console.log("Showing fullscreen image:", imageId); if (!imageId || !imageViewerModalInstance) return; const imageView = document.getElementById('fullImageView'); const shareBtn = document.getElementById('shareImageBtn'); if (!imageView || !shareBtn) { console.error("Image viewer elements missing"); return; } imageView.src = '#'; // Clear previous image imageView.alt = "Loading full image..."; toggleButtonSpinner(shareBtn, true); // Disable share btn while loading currentImageBlobForViewer = null; currentImageIdForViewer = null; try { const blob = await getImageFromDb(imageId); if (blob) { const url = URL.createObjectURL(blob); imageView.src = url; imageView.alt = "Full fish photo"; currentImageBlobForViewer = blob; currentImageIdForViewer = imageId; const canShare = navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], "image.jpg", { type: blob.type })] }); shareBtn.disabled = !canShare; shareBtn.title = canShare ? "Share Image" : "Sharing not supported by browser"; imageViewerModalInstance.show(); const modalElement = document.getElementById('imageViewerModal'); modalElement.addEventListener('hidden.bs.modal', () => { console.log("Revoking object URL for fullscreen image:", url); URL.revokeObjectURL(url); imageView.src = '#'; imageView.alt = "Image viewer closed"; currentImageBlobForViewer = null; currentImageIdForViewer = null; toggleButtonSpinner(shareBtn, false); // Ensure disabled on close shareBtn.disabled = true; }, { once: true }); } else { showToast("Image data not found.", "warning"); } } catch (error) { console.error("Error loading image for viewer:", error); showToast("Could not load image.", "danger"); } finally { toggleButtonSpinner(shareBtn, false); // Re-enable share button only if load succeeded } }
        async function shareImage(event) {
             const shareButton = event.target.closest('button');
             console.log("Share button clicked.");
             toggleButtonSpinner(shareButton, true);

             if (!currentImageBlobForViewer || !currentImageIdForViewer) {
                 showToast("Image data not available for sharing.", "warning");
                 toggleButtonSpinner(shareButton, false);
                 return;
             }
             if (!navigator.share) {
                 showToast("Web Share API not supported on this browser.", "warning");
                 toggleButtonSpinner(shareButton, false);
                 return;
             }

             const fileName = `fish_photo_${currentImageIdForViewer}.jpg`;
             const file = new File([currentImageBlobForViewer], fileName, { type: currentImageBlobForViewer.type });
             const shareData = {
                 files: [file],
                 title: 'Sea Catch Photo',
                 text: 'Check out this fish I caught using the Sea Catch Scorer app!'
             };

             if (navigator.canShare && navigator.canShare(shareData)) {
                 console.log("Attempting to share file:", fileName);
                 try {
                     await navigator.share(shareData);
                     console.log("Image shared successfully.");
                     showToast("Image shared!", "success");
                 } catch (error) {
                     console.error("Error sharing image:", error);
                     if (error.name !== 'AbortError') {
                         showToast(`Sharing failed: ${error.message}`, "danger");
                     } else {
                         console.log("Sharing cancelled by user.");
                         showToast("Sharing cancelled.", "info");
                     }
                 } finally {
                      toggleButtonSpinner(shareButton, false);
                 }
             } else {
                 console.warn("Sharing this file type might not be supported.");
                 showToast("Your browser may not support sharing this file.", "warning");
                 toggleButtonSpinner(shareButton, false);
             }
         }


        // --- General Modal Hiding/Showing ---
        function hideModal(modalId) { const mE=document.getElementById(modalId); if(mE){const m=bootstrap.Modal.getInstance(mE); if(m){m.hide();}else{/* Fallback for modals not properly initialized */ mE.classList.remove('show');mE.style.display='none';const b=document.querySelector('.modal-backdrop');if(b)b.remove();document.body.classList.remove('modal-open');document.body.style.overflow='';document.body.style.paddingRight='';}}}
        function showModal(modalId) { const modalElement = document.getElementById(modalId); if(modalElement) { try { const instance = bootstrap.Modal.getOrCreateInstance(modalElement, {backdrop: 'static', keyboard: false}); instance.show(); } catch (e) { console.error(`Error showing modal ${modalId}:`, e); } } else { console.error(`Modal element #${modalId} not found!`); } }

        // --- Theme Switching ---
        function applyTheme(theme) {
            const themeMeta = document.getElementById('themeColorMeta');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeSwitch').checked = true;
                if(themeMeta) themeMeta.content = '#0a0a0a'; // Dark theme color
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeSwitch').checked = false;
                 if(themeMeta) themeMeta.content = '#007bff'; // Light theme color (original)
            }
            // Update competition group background based on theme and checked state
            toggleCompetitionFields(false);
        }
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(currentTheme);
            try {
                 localStorage.setItem(THEME_KEY, currentTheme);
                 console.log(`Theme saved: ${currentTheme}`);
            } catch (e) {
                console.error("Could not save theme preference:", e);
                 showToast("Could not save theme preference.", "warning");
            }
        }
        function loadTheme() {
             let savedTheme = 'light'; // Default to light
             try {
                 savedTheme = localStorage.getItem(THEME_KEY) || 'light';
             } catch (e) {
                 console.error("Could not load theme preference:", e);
             }
            applyTheme(savedTheme);
             console.log(`Theme loaded: ${savedTheme}`);
        }


        // --- Application Reset ---
        function resetApp() {
            console.log("Resetting app.");
            fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null;
            currentPage='splashScreen'; stopCameraStream(); deactivateAppMode();
            isDropdownPopulated = false;
            try {
                document.getElementById('anglerName').value='';
                setTodaysDate(); // Resets date to today if empty
                document.getElementById('venueInput').value='';
                document.getElementById('isCompetition').checked=false;
                toggleCompetitionFields(false); // Reset UI state
                document.getElementById('zoneInput').value='';
                document.getElementById('pegInput').value='';
                const speciesInput = document.getElementById('speciesInput');
                if (speciesInput) { speciesInput.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; }
                const customSpeciesInput = document.getElementById('customSpeciesInput');
                if (customSpeciesInput) { customSpeciesInput.value = ''; customSpeciesInput.style.display = 'none'; }
                document.getElementById('lengthInput').value='';
                const initialsInput = document.getElementById('initialsInput'); if(initialsInput) initialsInput.value = '';
                document.getElementById('fishLog').innerHTML='';
                const vI = document.getElementById('verifierEndModalInput'); if(vI) vI.value='';
                const vS = document.getElementById('verifierEndModalSection'); if(vS) vS.style.display='none';
                // Reset Tally Page Footer
                populateTallySummaryFields(); // Clear summary fields
                document.getElementById('tallyTable').innerHTML='';
                document.getElementById('tallyTotalLength').textContent='0 cm';
                document.getElementById('tallySpeciesCount').textContent='0';
                document.getElementById('longestFishSpecies').textContent='N/A';
                document.getElementById('longestFishLength').textContent='0 cm';
                document.getElementById('tallyPointsTotal').textContent='0';
            } catch(e) { console.error("Error resetting forms:", e); }
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM loaded. Initializing...");
            loadTheme(); // Apply theme ASAP

            try {
                 await initDb();
                 if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/Sea-Catch-Scorer/sw.js').then(reg => console.log('SW registered scope: ', reg.scope)).catch(err => console.error('SW registration failed: ', err)); }); } else { console.log('Service workers not supported.'); }

                 window.addEventListener('popstate', handleBackButton);
                 window.addEventListener('beforeunload', handleBeforeUnload);
                 console.log("Nav listeners attached.");

                 // Cache frequently accessed elements
                 const refs = {
                     themeSwitch: document.getElementById('themeSwitch'),
                     continueBtn: document.getElementById('continueBtn'),
                     viewScorecardsBtn: document.getElementById('viewScorecardsBtn'),
                     startRecordingBtn: document.getElementById('startRecordingBtn'),
                     isCompetitionCheck: document.getElementById('isCompetition'),
                     speciesSelect: document.getElementById('speciesInput'),
                     addFishBtn: document.getElementById('addFishBtn'),
                     backFromFishingBtn: document.getElementById('backFromFishingBtn'),
                     endSessionBtn: document.getElementById('endSessionBtn'),
                     confirmEndBtn: document.getElementById('confirmEndBtn'),
                     saveNotesBtn: document.getElementById('saveNotesBtn'),
                     backFromTallyBtn: document.getElementById('backFromTallyBtn'),
                     restoreSessionBtn: document.getElementById('restoreSessionBtn'),
                     startNewSessionBtn: document.getElementById('startNewSessionBtn'),
                     anglerNameInput: document.getElementById('anglerName'),
                     competitionDateInput: document.getElementById('competitionDate'),
                     venueInput: document.getElementById('venueInput'),
                     zoneSelect: document.getElementById('zoneInput'),
                     pegSelect: document.getElementById('pegInput'),
                     initialsInput: document.getElementById('initialsInput'),
                     mlsAgreeBtn: document.getElementById('mlsAgreeBtn'),
                     takePhotoButton: document.getElementById('takePhotoButton'),
                     cancelCameraButtonHeader: document.getElementById('cancelCameraButtonHeader'),
                     shareImageBtn: document.getElementById('shareImageBtn')
                 };

                 // Init Modals
                 const notesModalElement = document.getElementById('notesModal'); if (notesModalElement) { notesModalInstance = new bootstrap.Modal(notesModalElement); } else { console.error("#notesModal not found!"); }
                 const cameraModalElement = document.getElementById('cameraModal'); if (cameraModalElement) { cameraModalInstance = new bootstrap.Modal(cameraModalElement); cameraModalElement.addEventListener('hidden.bs.modal', stopCameraStream); } else { console.error("#cameraModal not found!"); }
                 const imageViewerModalElement = document.getElementById('imageViewerModal'); if (imageViewerModalElement) { imageViewerModalInstance = new bootstrap.Modal(imageViewerModalElement); } else { console.error("#imageViewerModal not found!"); }

                 // Add Listeners
                 if (refs.themeSwitch) refs.themeSwitch.addEventListener('change', toggleTheme);
                 if (refs.continueBtn) refs.continueBtn.addEventListener('click', startApp);
                 if (refs.viewScorecardsBtn) refs.viewScorecardsBtn.addEventListener('click', showScorecardsModal);
                 if (refs.startRecordingBtn) refs.startRecordingBtn.addEventListener('click', startRecording);
                 if (refs.isCompetitionCheck) refs.isCompetitionCheck.addEventListener('change', () => { toggleCompetitionFields(); saveTempSession(); });
                 if (refs.speciesSelect) refs.speciesSelect.addEventListener('change', toggleCustomSpeciesInput);
                 if (refs.addFishBtn) refs.addFishBtn.addEventListener('click', addFish);
                 if (refs.backFromFishingBtn) refs.backFromFishingBtn.addEventListener('click', backFromFishing);
                 if (refs.endSessionBtn) refs.endSessionBtn.addEventListener('click', showEndSessionModal);
                 if (refs.confirmEndBtn) refs.confirmEndBtn.addEventListener('click', confirmEndSession);
                 if (refs.saveNotesBtn) refs.saveNotesBtn.addEventListener('click', saveNoteFromModal);
                 if (refs.backFromTallyBtn) refs.backFromTallyBtn.addEventListener('click', backFromTally);
                 if (refs.startNewSessionBtn) { refs.startNewSessionBtn.addEventListener('click', () => { if (confirm("Starting a new session will discard the currently unsaved session data. Are you sure?")) { startNewSession(); } }); }
                 if (refs.restoreSessionBtn) refs.restoreSessionBtn.addEventListener('click', restoreSession);

                 // Input Listeners for temp save
                 const saveOnChange = () => saveTempSession();
                 if (refs.anglerNameInput) refs.anglerNameInput.addEventListener('input', () => { currentAngler = refs.anglerNameInput.value.trim(); saveOnChange(); });
                 if (refs.competitionDateInput) refs.competitionDateInput.addEventListener('change', () => { currentDate = refs.competitionDateInput.value; saveOnChange(); });
                 if (refs.venueInput) refs.venueInput.addEventListener('input', () => { currentVenue = refs.venueInput.value.trim(); saveOnChange(); });
                 if (refs.zoneSelect) refs.zoneSelect.addEventListener('change', () => { currentZone = refs.isCompetitionCheck?.checked ? refs.zoneSelect.value : null; saveOnChange(); });
                 if (refs.pegSelect) refs.pegSelect.addEventListener('change', () => { currentPeg = refs.isCompetitionCheck?.checked ? refs.pegSelect.value : null; saveOnChange(); });
                 if (refs.initialsInput) refs.initialsInput.addEventListener('input', saveOnChange);

                 // Modal Buttons
                 if (refs.mlsAgreeBtn) { refs.mlsAgreeBtn.addEventListener('click', () => hideModal('mlsInfoModal')); }
                 if (refs.takePhotoButton) refs.takePhotoButton.addEventListener('click', takeSnapshot);
                 if (refs.cancelCameraButtonHeader) refs.cancelCameraButtonHeader.addEventListener('click', () => { stopCameraStream(); hideModal('cameraModal'); }); // Ensure modal hides
                 if (refs.shareImageBtn) refs.shareImageBtn.addEventListener('click', shareImage);

                 setTodaysDate();
                 checkRestoreSession(); // Check after setting date

                 console.log("Initialization complete.");
            } catch (error) {
                 console.error("Fatal initialization error:", error);
                 document.body.innerHTML = `<div class="app-header"><h1>Sea Catch Scorer</h1></div><div class="alert alert-danger m-5"><strong>Application Error:</strong> ${error.message}.<br>Please check browser permissions (camera, storage), ensure you are not in private browsing mode, and try refreshing the page. If the problem persists, check the developer console for more details.</div>`;
                 // Try to apply theme even on error
                 loadTheme();
            }
        });
    </script>

</body>
</html>
```
