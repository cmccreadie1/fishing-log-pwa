<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles largely unchanged - collapsed for brevity */
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center center fixed; background-size: cover; color: #fff; min-height: 100vh; overscroll-behavior-y: contain; }
        .container { background: rgba(0, 0, 0, 0.85); border-radius: 15px; padding: 25px; margin: 20px auto; max-width: 960px; z-index: 1; display: none; /* Managed by JS */ }
        .page { display: none; } .splash-screen.page { display: flex; }
        /* --- Splash Screen --- */
        .splash-screen { flex-direction: column; justify-content: flex-end; align-items: center; padding: 40px 20px; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2; text-align: center; }
        .splash-screen .button-group-center { background-color: rgba(0, 0, 0, 0.6); padding: 25px 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); max-width: 90%; width: 500px; }
        .splash-screen .btn { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        /* --- Main Content Card Style --- */
        .card-section { background: #f8f9fa; border-radius: 15px; padding: 30px 25px; margin: 20px 0; border: 1px solid #dee2e6; color: #212529; z-index: 3; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .card-section h2 { color: #0056b3; margin-bottom: 1.2rem; } .card-section h5 { color: #0056b3; margin-bottom: 1rem; }
        /* --- Buttons --- */
        .btn { padding: 12px 24px; font-size: 1.1rem; border-radius: 25px; border: none; margin: 5px; transition: transform 0.2s, background-color 0.2s, border-color 0.2s; cursor: pointer; font-weight: 600; vertical-align: middle; } .btn:disabled { cursor: not-allowed; opacity: 0.65; }
        /* ... other button styles ... */
        .button-group-center { text-align: center; margin-top: 20px; } .button-group-center .btn { margin-left: 8px; margin-right: 8px; margin-bottom: 10px; }
        /* --- Forms --- */
        .mb-3 { margin-bottom: 1.3rem !important; } .form-label { font-weight: 600; color: #495057; margin-bottom: 0.5rem; } .form-control, .form-select { border-radius: 8px; border: 1px solid #ced4da; } .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); } .form-check-label { color: #212529; }
        #verifierEndModalSection { display: none; } #customSpeciesInput { display: none; }
        /* --- Tables --- */
        /* ... table styles ... */
        /* --- Fish Log Specific --- */
        .thumbnail-container { display: inline-block; vertical-align: middle; cursor: pointer; width: 40px; height: 40px; text-align: center; line-height: 40px; border: 1px solid #eee; border-radius: 4px; background-color: #f8f9fa; overflow: hidden; } .thumbnail-container:hover { background-color: #e9ecef; }
        .fish-thumbnail { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; }
        .no-photo-icon { font-size: 1.5rem; color: #adb5bd; vertical-align: middle; }
        /* --- Unified Modal Style --- */
        /* ... modal styles ... */
        /* --- Other Modals Styles omitted for brevity --- */
        /* --- Camera Modal Styles --- */
        /* ... */
        /* --- Visibility Style --- */ .hidden-by-default { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="registrationPage" class="card-section page">
             <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div id="competitionDetails" style="display: none;">
                 <div class="mb-3"> <label for="teamNameInput" class="form-label">Team Name</label> <input type="text" id="teamNameInput" class="form-control" placeholder="Enter team name (if applicable)"> </div>
                 <div class="mb-3"> <label for="zoneInput" class="form-label">Zone</label> <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select> </div>
                 <div class="mb-3"> <label for="pegInput" class="form-label">Peg</label> <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> </select> </div>
            </div>
            <div class="button-group-center"> <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button> </div>
        </div>

        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
            <div class="row">
                <div class="col-md-4 mb-3"> <label for="speciesInput" class="form-label">Species</label> <select id="speciesInput" class="form-select"> <option value="" selected disabled>Select species...</option> </select> <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species"> </div>
                <div class="col-md-4 mb-3"> <label for="lengthInput" class="form-label">Length (cm)</label> <input type="number" id="lengthInput" class="form-control" placeholder="Enter length" step="1" min="1"> </div>
                <div id="initialsInputGroup" class="col-md-4 mb-3" style="display: none;"> <label for="initialsInput" class="form-label">Verifier Initials</label> <input type="text" id="initialsInput" class="form-control" placeholder="Enter Initials (e.g., AB)" maxlength="3" style="text-transform:uppercase"> </div>
            </div>
            <div class="button-group-center mb-4"> <button class="btn btn-primary" id="addFishBtn"> <i class="bi bi-plus-circle me-1"></i> Add Fish </button> <button class="btn btn-secondary" id="backFromFishingBtn"> <i class="bi bi-arrow-left-circle me-1"></i> Back </button> </div>
            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead> <tr> <th class="photo-col">Photo</th> <th class="species-col">Species</th> <th class="length-col">Length</th> <th id="verifiedByHeader" class="verified-col">Verified</th> <th class="delete-col">Del</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
                 <p id="emptyLogMessage" class="text-center text-muted mt-3" style="display: none;">No fish recorded yet.</p>
            </div>
            <div class="button-group-center mt-4"> <button class="btn btn-success" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button> </div>
        </div>

         <div id="tallyPage" class="card-section page">
             <h2>Catch Summary</h2>
             <div class="catch-summary-details"> <strong>Angler:</strong> <span id="summaryAngler"></span><br> <strong>Date:</strong> <span id="summaryDate"></span><br> <strong>Venue:</strong> <span id="summaryVenue"></span><br> <strong>Team:</strong> <span id="summaryTeam"></span><br> <strong>Zone:</strong> <span id="summaryZone"></span><br> <strong>Peg:</strong> <span id="summaryPeg"></span><br> <span id="summaryVerifier"></span> </div>
             <div class="table-responsive"> <table class="table table-bordered"> <thead> <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr> </thead> <tbody id="tallyTable"></tbody> <tfoot> <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr> <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr> <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr> <tr> <td colspan="3" class="text-end"><strong>Points Total</strong></td> <td><strong id="tallyPointsTotal">0</strong></td> </tr> </tfoot> </table> </div>
             <div class="button-group-center"> <button class="btn btn-secondary" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button> </div>
         </div>
    </div> <div id="splashScreen" class="splash-screen page">
         <div class="button-group-center"> <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button> <br> <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button> </div>
    </div>

    <div class="modal fade" id="restoreSessionModal" tabindex="-1"></div>
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1"></div> <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p>Are you sure you want to end your session? This will save the scorecard.</p> <div id="verifierEndModalSection" class="mt-3" style="display: none;"> <hr> <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label> <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required> <small class="text-muted">Required for competition scorecards.</small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button> <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button> </div> </div> </div> </div>
    <div class="modal fade" id="notesModal" tabindex="-1"></div>
    <div class="modal fade" id="mlsInfoModal" tabindex="-1"></div>
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true"> <div class="modal-dialog modal-fullscreen"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cameraModalLabel">Take Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelCameraButtonHeader"></button> </div> <div class="modal-body"> <video id="cameraVideo" playsinline autoplay muted></video> <canvas id="cameraCanvas"></canvas> </div> <div id="cameraControls"> <button type="button" class="btn btn-light" id="takePhotoButton" aria-label="Take Photo"></button> </div> </div> </div> </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="imageViewerModalLabel">View Image</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <img id="fullImageView" src="" alt="Full Size Image"> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wrap all code in DOMContentLoaded and add a try...catch for initial errors
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired. Initializing script..."); // Log script start
            try {

                // --- Global Variables ---
                let currentFishLog = [];
                let isCompetitionSession = false;
                let currentPhotoIndex = -1;
                let cameraStream = null;

                // --- Element References ---
                const splashScreen = document.getElementById('splashScreen'); const mainContainer = document.querySelector('.container'); const registrationPage = document.getElementById('registrationPage'); const fishingPage = document.getElementById('fishingPage'); const tallyPage = document.getElementById('tallyPage'); const allPages = document.querySelectorAll('.page');
                const continueBtn = document.getElementById('continueBtn'); const viewScorecardsBtn = document.getElementById('viewScorecardsBtn');
                const competitionCheckbox = document.getElementById('isCompetition'); const competitionDetailsDiv = document.getElementById('competitionDetails'); const zoneInput = document.getElementById('zoneInput'); const pegInput = document.getElementById('pegInput'); const teamNameInput = document.getElementById('teamNameInput'); const startRecordingBtn = document.getElementById('startRecordingBtn'); const anglerNameInput = document.getElementById('anglerName'); const competitionDateInput = document.getElementById('competitionDate'); const venueInput = document.getElementById('venueInput');
                const speciesInput = document.getElementById('speciesInput'); const customSpeciesInput = document.getElementById('customSpeciesInput'); const lengthInput = document.getElementById('lengthInput'); const initialsInputGroup = document.getElementById('initialsInputGroup'); const initialsInput = document.getElementById('initialsInput'); const verifiedByHeader = document.getElementById('verifiedByHeader'); const fishLogTableBody = document.getElementById('fishLog'); const emptyLogMessage = document.getElementById('emptyLogMessage'); const addFishBtn = document.getElementById('addFishBtn'); const backFromFishingBtn = document.getElementById('backFromFishingBtn'); const endSessionBtn = document.getElementById('endSessionBtn');
                const backFromTallyBtn = document.getElementById('backFromTallyBtn');
                const savedScorecardsModalEl = document.getElementById('savedScorecardsModal'); const endSessionModalEl = document.getElementById('endSessionModal'); const verifierEndModalSection = document.getElementById('verifierEndModalSection'); const confirmEndBtn = document.getElementById('confirmEndBtn'); const cameraModalEl = document.getElementById('cameraModal'); const cameraVideo = document.getElementById('cameraVideo'); const cameraCanvas = document.getElementById('cameraCanvas'); const takePhotoButton = document.getElementById('takePhotoButton'); const cancelCameraButtonHeader = document.getElementById('cancelCameraButtonHeader'); const imageViewerModalEl = document.getElementById('imageViewerModal'); const fullImageView = document.getElementById('fullImageView');

                // Check if Bootstrap's Modal component is loaded
                if (typeof bootstrap === 'undefined' || typeof bootstrap.Modal === 'undefined') {
                    console.error("Bootstrap Modal component not found! Check if bootstrap.bundle.min.js is loaded correctly.");
                    alert("Error: UI components might not work correctly. Bootstrap JS missing.");
                    // Optionally disable buttons that depend on modals
                } else {
                     console.log("Bootstrap Modal component seems available.");
                }


                // --- Bootstrap Modal Instances ---
                // Initialize modals only if Bootstrap seems available
                let savedScorecardsModal = null;
                if (savedScorecardsModalEl && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                    savedScorecardsModal = new bootstrap.Modal(savedScorecardsModalEl);
                    console.log("Saved Scorecards Modal Instance: Created");
                } else {
                    console.error("Saved Scorecards Modal element not found or Bootstrap Modal component missing.");
                }

                let endSessionModal = null;
                if (endSessionModalEl && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                     endSessionModal = new bootstrap.Modal(endSessionModalEl);
                     console.log("End Session Modal Instance: Created");
                } else {
                     console.error("End Session Modal element not found or Bootstrap Modal component missing.");
                }

                let cameraModal = null;
                if (cameraModalEl && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                    cameraModal = new bootstrap.Modal(cameraModalEl);
                    console.log("Camera Modal Instance: Created");
                } else {
                     console.error("Camera Modal element not found or Bootstrap Modal component missing.");
                }

                let imageViewerModal = null;
                 if (imageViewerModalEl && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                    imageViewerModal = new bootstrap.Modal(imageViewerModalEl);
                    console.log("Image Viewer Modal Instance: Created");
                } else {
                     console.error("Image Viewer Modal element not found or Bootstrap Modal component missing.");
                }


                // --- Helper Functions ---
                function showPage(pageIdToShow) { /* ... (unchanged) ... */ if (pageIdToShow === 'splashScreen') { if(mainContainer) mainContainer.style.display = 'none'; } else { if(mainContainer) mainContainer.style.display = 'block'; } allPages.forEach(page => { page.style.display = (page.id === pageIdToShow) ? (page.id === 'splashScreen' ? 'flex' : 'block') : 'none'; }); if (pageIdToShow !== 'splashScreen' && mainContainer) { window.scrollTo(0, 0); } console.log(`Mapsd to: ${pageIdToShow}`); }
                function resetFishInputFields() { /* ... (unchanged) ... */ if(speciesInput) speciesInput.value = ""; if(customSpeciesInput) { customSpeciesInput.value = ""; customSpeciesInput.style.display = 'none'; } if(lengthInput) lengthInput.value = ""; if(initialsInput) initialsInput.value = ""; if(speciesInput) speciesInput.focus(); }
                function renderFishLog() { /* ... (Unchanged) ... */ if (!fishLogTableBody) return; fishLogTableBody.innerHTML = ''; emptyLogMessage.style.display = currentFishLog.length === 0 ? 'block' : 'none'; currentFishLog.forEach((fish, index) => { const row = fishLogTableBody.insertRow(); row.setAttribute('data-index', index); const photoCell = row.insertCell(); photoCell.classList.add('photo-col'); const thumbContainer = document.createElement('div'); thumbContainer.classList.add('thumbnail-container'); thumbContainer.setAttribute('data-index', index); if (fish.photo) { const img = document.createElement('img'); img.src = fish.photo; img.alt = `Photo of ${fish.species}`; img.classList.add('fish-thumbnail'); thumbContainer.appendChild(img); thumbContainer.setAttribute('data-has-photo', 'true'); } else { thumbContainer.innerHTML = `<i class="bi bi-camera no-photo-icon"></i>`; thumbContainer.setAttribute('data-has-photo', 'false'); } photoCell.appendChild(thumbContainer); const speciesCell = row.insertCell(); speciesCell.classList.add('species-col'); speciesCell.textContent = fish.species; const lengthCell = row.insertCell(); lengthCell.classList.add('length-col'); lengthCell.textContent = `${fish.length} cm`; const verifiedCell = row.insertCell(); verifiedCell.classList.add('verified-col'); if (isCompetitionSession) { verifiedCell.style.display = 'table-cell'; verifiedCell.textContent = fish.verifiedBy || '---'; } else { verifiedCell.style.display = 'none'; } const deleteCell = row.insertCell(); deleteCell.classList.add('delete-col'); const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-fish-btn'); deleteBtn.setAttribute('data-index', index); deleteBtn.setAttribute('aria-label', `Delete ${fish.species} entry`); deleteBtn.innerHTML = '<i class="bi bi-trash-fill"></i>'; deleteCell.appendChild(deleteBtn); }); }

                // --- Load Species Function (Using "Round Fish") ---
                function loadSpecies() {
                    const categorizedSpecies = {
                        "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
                        "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
                        "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
                        "Rays": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
                        "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)", "Corkwing Wrasse", "Goldsinny Wrasse", "Rock Cook Wrasse" ]
                    };

                    const placeholderOption = speciesInput.options[0];
                    speciesInput.innerHTML = '';
                    speciesInput.appendChild(placeholderOption);
                    placeholderOption.selected = true;

                    for (const category in categorizedSpecies) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = category; // Use the key directly (e.g., "Round Fish")
                        categorizedSpecies[category].sort();
                        categorizedSpecies[category].forEach(fishName => {
                            const option = document.createElement('option');
                            option.value = fishName; option.textContent = fishName;
                            optgroup.appendChild(option);
                        });
                        speciesInput.appendChild(optgroup);
                    }
                    const otherOption = document.createElement('option'); otherOption.value = 'Other'; otherOption.textContent = 'Other (Specify)'; speciesInput.appendChild(otherOption);
                    console.log("Categorized species list loaded using 'Round Fish'.");
                }

                // --- Camera Functions ---
                // (startCamera, stopCamera, takePhoto unchanged - keep logging)
                function startCamera() { console.log("Attempting to start camera..."); if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Camera API (getUserMedia) is not supported by your browser."); console.error("getUserMedia not supported."); return; } if (!cameraModal || !cameraVideo) { console.error("Camera modal elements not found."); return; } navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }) .then(stream => { console.log("Camera stream obtained."); cameraStream = stream; cameraVideo.srcObject = stream; cameraVideo.play().catch(playErr => { console.error("Video play failed:", playErr); if(cameraModal) cameraModal.show(); }); if(cameraModal) cameraModal.show(); }) .catch(err => { console.error("Error accessing camera:", err); let message = `Could not access camera: ${err.name}.`; if (err.name === "NotAllowedError") { message += "\nPlease grant camera permission in your browser settings."; } else if (err.name === "NotFoundError") { message += "\nNo suitable camera found."; } else if (err.name === "NotReadableError") { message += "\nCamera might be in use by another application or hardware error."; } else if (window.location.protocol !== 'https:') { message += "\nCamera access often requires a secure (HTTPS) connection."; } message += "\nCheck browser console (F12) for more details."; alert(message); stopCamera(); }); }
                function stopCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); console.log("Camera stopped"); } cameraStream = null; }
                function takePhoto() { console.log("Take Photo button clicked."); if (!cameraCanvas || !cameraVideo || !cameraVideo.srcObject || currentPhotoIndex < 0) { console.error("Cannot take photo: Missing elements, stream, or index.", { canvas: !!cameraCanvas, video: !!cameraVideo, stream: !!(cameraVideo && cameraVideo.srcObject), index: currentPhotoIndex }); return; } const context = cameraCanvas.getContext('2d'); if(cameraVideo.videoWidth === 0 || cameraVideo.videoHeight === 0) { console.error("Video dimensions not available yet."); alert("Could not capture photo, video not ready."); return; } cameraCanvas.width = cameraVideo.videoWidth; cameraCanvas.height = cameraVideo.videoHeight; console.log(`Canvas dimensions set: ${cameraCanvas.width}x${cameraCanvas.height}`); context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height); console.log("Image drawn to canvas."); const dataURL = cameraCanvas.toDataURL('image/jpeg', 0.9); console.log("Data URL created (length):", dataURL.length); if (currentPhotoIndex >= 0 && currentPhotoIndex < currentFishLog.length) { currentFishLog[currentPhotoIndex].photo = dataURL; console.log(`Photo data URL stored for fish index ${currentPhotoIndex}`); } else { console.error("Invalid currentPhotoIndex when storing photo:", currentPhotoIndex); } stopCamera(); if(cameraModal) cameraModal.hide(); renderFishLog(); currentPhotoIndex = -1; }

                // --- Initial Page Setup & Auto-Date ---
                showPage('splashScreen');
                if(customSpeciesInput) customSpeciesInput.style.display = 'none';
                if(emptyLogMessage) emptyLogMessage.style.display = 'block';
                // Set today's date
                if(competitionDateInput) {
                    try {
                        // Use current date (will use the provided date: 2025-04-27)
                        competitionDateInput.value = '2025-04-27';
                        // Alt: for actual today's date:
                        // const today = new Date();
                        // const yyyy = today.getFullYear();
                        // const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                        // const dd = String(today.getDate()).padStart(2, '0');
                        // competitionDateInput.value = `${yyyy}-${mm}-${dd}`;
                        console.log("Date set to:", competitionDateInput.value);
                    } catch (dateError) {
                        console.error("Error setting date input:", dateError);
                    }
                }


                // --- Event Listeners ---

                // Competition Checkbox
                if (competitionCheckbox) { competitionCheckbox.addEventListener('change', function() { const isChecked = this.checked; competitionDetailsDiv.style.display = isChecked ? 'block' : 'none'; zoneInput.disabled = !isChecked; pegInput.disabled = !isChecked; teamNameInput.disabled = !isChecked; if (!isChecked) { zoneInput.value = ''; pegInput.value = ''; teamNameInput.value = ''; } }); const initialCheck = competitionCheckbox.checked; competitionDetailsDiv.style.display = initialCheck ? 'block' : 'none'; zoneInput.disabled = !initialCheck; pegInput.disabled = !initialCheck; teamNameInput.disabled = !initialCheck; }
                // Splash -> Registration
                if (continueBtn) { continueBtn.addEventListener('click', () => { showPage('registrationPage'); }); }
                // Splash -> View Scorecards Modal (DEBUG Logging Added)
                if (viewScorecardsBtn) { // Check only button initially
                    viewScorecardsBtn.addEventListener('click', () => {
                        console.log("DEBUG: View Scorecards button clicked.");
                        if (savedScorecardsModal) { // Check if instance exists *inside* listener
                            console.log("DEBUG: savedScorecardsModal instance exists. Attempting show()...");
                            // TODO: Load saved scorecards data here before showing
                            try {
                                savedScorecardsModal.show();
                                console.log("DEBUG: savedScorecardsModal.show() called.");
                            } catch (error) {
                                console.error("DEBUG: Error calling savedScorecardsModal.show():", error);
                                alert("Error opening saved scorecards. Please check console.");
                            }
                        } else {
                            console.error("DEBUG: savedScorecardsModal instance is null or undefined. Cannot show modal.");
                            alert("Error: Saved scorecards component failed to initialize.");
                        }
                    });
                 } else { console.error("View Scorecards button element not found!"); }

                // Registration -> Fishing Page
                if (startRecordingBtn) { startRecordingBtn.addEventListener('click', () => { isCompetitionSession = competitionCheckbox.checked; if(initialsInputGroup) initialsInputGroup.style.display = isCompetitionSession ? 'block' : 'none'; if(verifiedByHeader) verifiedByHeader.style.display = isCompetitionSession ? 'table-cell' : 'none'; currentFishLog = []; renderFishLog(); loadSpecies(); showPage('fishingPage'); }); }
                // Species Dropdown -> Custom Input / Length Input (Focus Change)
                if (speciesInput) { speciesInput.addEventListener('change', () => { const selectedValue = speciesInput.value; if (selectedValue === 'Other') { if(customSpeciesInput) { customSpeciesInput.style.display = 'block'; customSpeciesInput.focus(); } } else { if(customSpeciesInput) { customSpeciesInput.style.display = 'none'; customSpeciesInput.value = ''; } if (selectedValue && lengthInput) { console.log("Moving focus to length input"); lengthInput.focus(); } } }); }
                // Zone Dropdown -> Peg Dropdown (Focus Change)
                if (zoneInput && pegInput) { zoneInput.addEventListener('change', () => { if (zoneInput.value && !zoneInput.disabled && !pegInput.disabled) { console.log("Moving focus to peg input"); pegInput.focus(); } }); }
                 // Add Fish Button
                if (addFishBtn) { addFishBtn.addEventListener('click', () => { /* ... (Validation & Data creation unchanged) ... */ let speciesValue = speciesInput.value; const customSpeciesValue = customSpeciesInput.value.trim(); const lengthValue = lengthInput.value.trim(); const initialsValue = initialsInput.value.trim().toUpperCase(); if (speciesValue === 'Other') { if (!customSpeciesValue) { alert("Please enter the custom species name."); customSpeciesInput.focus(); return; } speciesValue = customSpeciesValue; } else if (!speciesValue) { alert("Please select a species."); speciesInput.focus(); return; } if (!lengthValue || isNaN(lengthValue) || parseFloat(lengthValue) <= 0) { alert("Please enter a valid length (positive number)."); lengthInput.focus(); return; } if (isCompetitionSession && !initialsValue) { alert("Please enter verifier initials for competition catches."); initialsInput.focus(); return; } const fishData = { species: speciesValue, length: parseFloat(lengthValue), verifiedBy: isCompetitionSession ? initialsValue : null, photo: null }; currentFishLog.push(fishData); console.log("Fish added:", fishData); renderFishLog(); resetFishInputFields(); }); }
                 // Fish Log Table Body Listener (Photo & Delete)
                if (fishLogTableBody) { fishLogTableBody.addEventListener('click', (event) => { /* ... (Unchanged) ... */ const target = event.target; const thumbnailContainer = target.closest('.thumbnail-container'); const deleteButton = target.closest('.delete-fish-btn'); if (deleteButton) { const indexToDelete = parseInt(deleteButton.getAttribute('data-index'), 10); if (!isNaN(indexToDelete) && indexToDelete >= 0 && indexToDelete < currentFishLog.length) { currentFishLog.splice(indexToDelete, 1); renderFishLog(); } return; } if (thumbnailContainer) { const index = parseInt(thumbnailContainer.getAttribute('data-index'), 10); const hasPhoto = thumbnailContainer.getAttribute('data-has-photo') === 'true'; if (!isNaN(index) && index >= 0 && index < currentFishLog.length) { if (hasPhoto && imageViewerModal && fullImageView) { console.log(`Viewing photo for index ${index}`); fullImageView.src = currentFishLog[index].photo; imageViewerModal.show(); } else { console.log(`Attempting photo capture for index ${index}`); currentPhotoIndex = index; startCamera(); } } } }); }
                // Camera Modal: Take Photo Button
                if (takePhotoButton) { takePhotoButton.addEventListener('click', takePhoto); }
                // Camera Modal: Cancel/Close Buttons (Stop Stream)
                if (cancelCameraButtonHeader) { cancelCameraButtonHeader.addEventListener('click', () => { if(cameraModal) cameraModal.hide(); }); }
                if(cameraModalEl) { cameraModalEl.addEventListener('hidden.bs.modal', () => { console.log("Camera modal hidden event triggered."); stopCamera(); if(currentPhotoIndex !== -1 && !currentFishLog[currentPhotoIndex]?.photo) { console.log("Resetting photo index as modal closed without confirmed capture."); currentPhotoIndex = -1; } }); }
                // Fishing Page: Back Button -> Registration
                if (backFromFishingBtn) { backFromFishingBtn.addEventListener('click', () => { showPage('registrationPage'); }); }
                // Fishing Page: End Session Button -> Modal
                if (endSessionBtn && endSessionModal && verifierEndModalSection) { endSessionBtn.addEventListener('click', () => { console.log("End Session button clicked, attempting to show modal."); verifierEndModalSection.style.display = isCompetitionSession ? 'block' : 'none'; endSessionModal.show(); }); } else { console.error("Elements for 'End Session' button action missing!", {endSessionBtn, endSessionModal, verifierEndModalSection}); }
                // End Session Modal: Confirm Button -> Splash Screen
                if (confirmEndBtn && endSessionModal) { confirmEndBtn.addEventListener('click', () => { console.log("Confirm End Session button clicked."); const verifierInput = document.getElementById('verifierEndModalInput'); if(isCompetitionSession && !verifierInput?.value?.trim()) { alert("Please enter the verifier's name for competition scorecards."); return; } console.log("Placeholder: Saving session data...", {log: currentFishLog, verifier: verifierInput?.value }); /* TODO: Add actual save logic */ endSessionModal.hide(); showPage('splashScreen'); }); } else { console.error("'Confirm End Session' button or its modal instance missing!"); }
                // Tally Page: Back Button -> Fishing
                if (backFromTallyBtn) { backFromTallyBtn.addEventListener('click', () => { showPage('fishingPage'); }); }

                console.log("Script initialization finished."); // Log end of setup

            } catch (error) {
                console.error("A critical error occurred during script initialization:", error);
                alert("A critical error occurred. Please check the console (F12) for details.");
            }
        }); // End of DOMContentLoaded
    </script>

</body>
</html>
