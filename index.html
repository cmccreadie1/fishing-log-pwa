<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar -->
    <meta name="theme-color" content="#0d6efd">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0b4c8f 0%, #02274f 100%) fixed;
            color: #f8f9fa;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            line-height: 1.6;
        }
        .container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 30px auto;
            max-width: 960px;
            z-index: 1;
            display: none; /* Initially hidden */
        }

        /* --- Page Transitions --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page {
            display: none; /* Controlled by JS */
            animation: fadeIn 0.3s ease-in-out;
        }

        /* --- Splash Screen --- */
        .splash-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 2.5rem 1.5rem;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.8)), url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed;
            text-align: center; /* Ensure button group center works */
        }
        .splash-screen .button-group-center .btn {
             margin-bottom: 1rem; /* Space between buttons */
             color: white; /* Ensure text is white */
        }
        /* Explicit styling for outline button on splash */
        .splash-screen .btn-outline-light {
            color: #fff;
            border-color: #fff;
        }
        .splash-screen .btn-outline-light:hover,
        .splash-screen .btn-outline-light:focus {
            background-color: rgba(255, 255, 255, 0.15); /* Subtle background on hover/focus */
            color: #fff;
            border-color: #fff;
        }


        /* --- Main Content Card Style --- */
        .card-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            padding: 2rem 1.75rem;
            margin: 1.5rem 0;
            border: none;
            color: #212529;
            z-index: 3;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }
        .card-section:hover {
             box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .card-section h2 {
            color: #0056b3;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        .card-section h5 {
            color: #0056b3;
            margin-bottom: 1.2rem;
            font-weight: 600;
        }
        .card-section h6 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            color: #0056b3;
        }


        /* --- Buttons --- */
        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 50px; /* Pill shape */
            border: none;
            margin: 0.3rem;
            transition: transform 0.2s ease-out, background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            cursor: pointer;
            font-weight: 600;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }
        .btn:hover {
            transform: translateY(-2px) scale(1.02); /* Slightly less scale */
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn:active {
             transform: translateY(0px) scale(1); /* Adjusted active state */
             box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled, .btn.disabled {
            cursor: not-allowed;
            opacity: 0.65;
            transform: none;
            box-shadow: none;
        }
        .btn i.bi { /* Ensure icons align nicely */
             vertical-align: text-bottom;
             line-height: 1;
             margin-right: 0.1em; /* Small space before text */
             margin-left: -0.1em; /* Pull icon slightly closer if first */
        }
        .btn i.ms-1, .btn i.ms-2 { margin-left: 0.5em !important; margin-right: -0.1em !important;} /* Adjust BS margin helpers if needed */

        /* Specific Button Colors */
        .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; color: white; }
        .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; color: white; }
        .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; color: white; }
        .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; color: black;}

        /* Outline buttons */
        .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; box-shadow: none; }
        .btn-outline-secondary:hover { background-color: #6c757d; color: white; border-color: #6c757d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; box-shadow: none; }
        .btn-outline-light:hover { background-color: #f8f9fa; color: #000; border-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        /* Outline Danger specific hover */
        .btn-outline-danger { border: 2px solid #dc3545; color: #dc3545; background-color: transparent; box-shadow: none; }
        .btn-outline-danger:hover { background-color: #dc3545; color: white; border-color: #dc3545; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        /* Sizes */
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.875rem; border-radius: 30px; font-weight: 500; margin: 0.15rem; }
        .btn-lg { padding: 0.9rem 1.8rem; font-size: 1.15rem; margin: 0.5rem; }
        /* Centered group */
        .button-group-center { text-align: center; margin-top: 1.5rem; }
        .button-group-center .btn { margin-left: 0.5rem; margin-right: 0.5rem; } /* Horizontal spacing for inline buttons */


        /* --- Forms --- */
        .mb-3 { margin-bottom: 1.5rem !important; }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.6rem;
            font-size: 0.95rem;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.6rem 0.8rem;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            height: auto; /* Ensure height is determined by padding/font */
        }
        .form-select {
            background-position: right 0.8rem center; /* Adjust arrow position */
        }
        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .form-check-label {
            color: #212529;
            padding-left: 0.3rem;
            font-weight: normal;
        }
        .form-check-input {
             margin-top: 0.2em;
             margin-right: 0.5em; /* Add space between checkbox and label */
        }
        #verifierEndModalSection { display: none; }


        /* --- Tables --- */
        .card-section .table {
            background: white;
            color: #212529;
            margin-top: 1.5rem;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            table-layout: auto;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        .table-responsive {
            margin-bottom: 1.5rem;
            border: none;
            border-radius: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: none;
        }
        .card-section .table thead {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 700;
            border-bottom: 2px solid #dee2e6;
        }
        .card-section .table th, .card-section .table td {
            border: none;
            border-bottom: 1px solid #e9ecef; /* Lighter internal border */
            vertical-align: middle;
            padding: 0.9rem 0.85rem;
            white-space: normal;
            font-size: 0.95rem;
        }
        .card-section .table tbody tr:last-child td {
             border-bottom: 0;
        }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #f8f9fa;
        }
        .card-section .table-hover tbody tr:hover > * {
            background-color: rgba(0, 123, 255, 0.08);
        }
        /* Tweak bordered if specifically used */
        .card-section .table-bordered { border: 1px solid #dee2e6; }
        .card-section .table-bordered th, .card-section .table-bordered td { border: 1px solid #dee2e6; }

        /* --- Specific Table Styles --- */
        #fishingPage .table { margin-top: 0; margin-bottom: 0; border: none; }
        #fishingPage .table-responsive { margin-bottom: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; }
        #fishingPage th.photo-col { width: 65px; text-align: center; }
        #fishingPage td.photo-col { text-align: center; }
        #fishingPage th.species-col {}
        #fishingPage th.length-col { width: 90px; text-align: right;}
        #fishingPage td.length-col { text-align: right;}
        #fishingPage th.verified-col { width: 90px; text-align: center; }
        #fishingPage td.verified-col { text-align: center; }
        #fishingPage th.delete-col { width: 60px; text-align: center;}
        #fishingPage td.delete-col { text-align: center;}
        .delete-icon-btn {
            background: none; border: none; padding: 0.1rem 0.3rem; color: #dc3545;
            cursor: pointer; font-size: 1.3rem; vertical-align: middle;
            transition: color 0.2s ease, transform 0.1s ease;
        }
        .delete-icon-btn:hover { color: #a71d2a; transform: scale(1.1); }
        .delete-icon-btn:active { transform: scale(1); }

        #tallyPage.card-section .table { margin-top: 1.5rem; table-layout: auto; }
        #tallyPage.card-section tfoot td, #tallyPage.card-section tfoot strong {
            color: #212529; font-weight: 600; font-size: 1rem;
        }
         #tallyPage.card-section tfoot tr { background-color: #f8f9fa; }
         #tallyPage.card-section tfoot td { padding-top: 1rem; padding-bottom: 1rem; border-bottom: none; }
         #tallyPage.card-section .catch-summary-details {
            margin-bottom: 1.75rem; color: #495057; line-height: 1.7; font-size: 0.95rem;
            padding: 1rem; background-color: #f0f4f8; /* Slightly different background */
            border-radius: 8px; border: 1px solid #d6dde4;
        }

        /* --- Fish Log Specific --- */
        .thumbnail-container {
            display: inline-block; vertical-align: middle; cursor: pointer;
            width: 45px; height: 45px; text-align: center; line-height: 45px;
            border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa;
            overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .thumbnail-container:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .fish-thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 0; border: none; }
        .no-photo-icon { font-size: 1.6rem; color: #adb5bd; vertical-align: middle; }

        /* --- Unified Modal Style --- */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; background-color: rgba(0, 0, 0, 0.6); }
        .modal-content {
            background: #ffffff;
            color: #212529;
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            background-color: #f8f9fa;
            color: #212529;
            border-bottom: 1px solid #dee2e6;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
            padding: 1rem 1.5rem;
        }
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;
            display: flex; justify-content: flex-end; flex-wrap: wrap;
            padding: 1rem 1.5rem;
        }
        .modal-footer .btn { margin: 0.25rem; } /* Ensure buttons have space */
        .modal-title { color: #0056b3; font-weight: 700; font-size: 1.2rem; }
        .modal-header .btn-close { filter: none; background-size: 0.8em; opacity: 0.7; transition: opacity 0.2s ease; }
        .modal-header .btn-close:hover { opacity: 1; }
        .modal-body {
            background-color: #ffffff;
            color: #212529;
            padding: 1.5rem 1.75rem;
            line-height: 1.7;
        }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body, #confirmPhotoModal .modal-body {
            color: #212529 !important;
        }


        /* --- Saved Scorecards Modal --- */
        #savedScorecardsList.card-section {
             background: transparent; border: none; box-shadow: none;
             padding: 0; margin: 0;
        }
        #savedScorecardsModal .modal-body { padding: 1rem 1.25rem; }
        #savedScorecardsModal .scorecard-entry {
            border: 1px solid #dee2e6; border-radius: 10px;
            margin-bottom: 1rem; background-color: #ffffff;
            overflow: hidden; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease;
        }
        #savedScorecardsModal .scorecard-entry:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12); }
        #savedScorecardsModal .scorecard-item { /* Clickable header */
            cursor: pointer; padding: 1rem 1.25rem; border-bottom: 1px solid #e9ecef;
            color: #212529; transition: background-color 0.2s;
            display: flex; align-items: center; gap: 0.75rem; /* Use gap for spacing */
        }
        #savedScorecardsModal .scorecard-item:hover { background-color: #f8f9fa; }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible {
            background-color: #eef5ff;
            border-bottom: 1px solid #cdddff; /* Stronger border when open */
        }
        #savedScorecardsModal .scorecard-item i.bi {
            transition: transform 0.2s ease-in-out; color: #6c757d;
            font-size: 1.1rem; flex-shrink: 0; /* Prevent icon shrinking */
            /* margin removed, using gap now */
        }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: #6c757d !important; font-size: 0.85rem; }
        #savedScorecardsModal .scorecard-item strong { font-weight: 600; }
        #savedScorecardsModal .scorecard-item > div { flex-grow: 1; } /* Allow text block to grow */
        #savedScorecardsModal .scorecard-item .badge { font-size: 0.75rem; padding: 0.3em 0.6em; vertical-align: middle; }

        #savedScorecardsModal .scorecard-details {
            display: none; padding: 1.25rem 1.5rem; background-color: #ffffff;
            border-top: none; margin-top: 0; border-radius: 0 0 10px 10px;
            color: #212529; line-height: 1.7;
        }
        #savedScorecardsModal .scorecard-details h6 {
            font-weight: 700; margin-top: 1.2rem; margin-bottom: 0.8rem;
            color: #0056b3; border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.4rem; font-size: 1.1rem;
        }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 0.6rem; color: #212529; font-size: 0.95rem; }
        #savedScorecardsModal .scorecard-details hr {
            margin-top: 1.2rem; margin-bottom: 1.2rem; border-top: 1px solid #dee2e6;
        }
        /* Fish list styling */
        .fish-list-item {
            padding: 0.5rem 0; border-bottom: 1px dashed #eee; font-size: 0.95rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .fish-list-item:last-child { border-bottom: none; }
        .fish-list-item .badge { font-weight: normal; }
        .fish-list-item small.text-muted { font-size: 0.8rem; margin-left: auto; /* Push verified text right */ }
        /* Session Photos */
        .session-photos {
             margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px;
        }
        .session-photo-thumbnail {
             width: 70px; height: 70px; object-fit: cover; border: 1px solid #ccc;
             border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
         }
         .session-photo-thumbnail:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .placeholder-photos { color: #6c757d; font-style: italic; font-size: 0.9rem; }

        /* Species Length Summary */
        #savedScorecardsModal .scorecard-details .species-length-summary p {
            margin-bottom: 0.4rem; padding-left: 0.5rem; font-size: 0.9rem;
        }
        #savedScorecardsModal .scorecard-details .species-length-summary h6 {
             margin-top: 0.5rem; margin-bottom: 0.6rem; font-size: 1rem;
             color: #495057; border-bottom: none; padding-bottom: 0;
        }
        /* Summary Block Styling */
        #savedScorecardsModal .scorecard-details .scorecard-summary-block {
            background-color: #e7f1ff; padding: 1rem 1.25rem; border-radius: 8px;
            margin-top: 1rem; border: 1px solid #b8d6fb;
        }
        #savedScorecardsModal .scorecard-details .scorecard-summary-block h6 {
            margin-top: 0; margin-bottom: 1rem; border-bottom: none; color: #0056b3;
        }
        /* Highlight Summary Lines */
        #savedScorecardsModal .scorecard-details .scorecard-summary-block .summary-highlight {
            background-color: #ddeaff;
             /* Removed negative margins/padding adjustments for simplicity */
             padding: 0.2em 0.5em; /* Inline padding */
             border-radius: 4px; /* Rounded highlight */
             font-weight: 600;
             display: inline-block; /* Make it wrap content */
        }
        /* Action Buttons */
        #savedScorecardsModal .scorecard-details .btn-actions-group {
            margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e9ecef;
            text-align: right;
        }
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-left: 5px; }
        #savedScorecardsModal .scorecard-details .btn-danger { color: white !important; }
        #savedScorecardsModal .scorecard-details .btn-info { color: black !important; }

        /* Latest Scorecard Styling */
        #savedScorecardsModal .latest-scorecard.scorecard-entry {
            border: 2px solid #007bff; box-shadow: 0 0 12px rgba(0, 123, 255, 0.3);
        }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item {
            border-bottom-color: rgba(0, 123, 255, 0.3); background-color: #e7f1ff;
            font-weight: 600;
        }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge {
            background-color: #007bff !important; color: white !important;
        }
        /* Older Scorecards Toggle */
        #olderScorecardsToggleContainer { padding-top: 1rem; text-align: center; }
        #olderScorecardsToggleContainer .btn { margin: 0.5rem; }


        /* --- Notes Modal --- */
        #notesModal .modal-body textarea { resize: vertical; min-height: 120px; font-size: 1rem; }


        /* --- Camera Modal Styles --- */
        #cameraModal .modal-dialog { max-width: 100%; margin: 0; height: 100%; }
        #cameraModal .modal-content { height: 100%; border-radius: 0; background-color: #000; }
        #cameraModal .modal-header {
            border-bottom: 0; background-color: rgba(0,0,0,0.6); position: absolute;
            top: 0; left: 0; right: 0; z-index: 10; padding: 0.8rem 1rem;
        }
        #cameraModal .modal-title { color: #fff; font-size: 1.1rem; }
        #cameraModal .btn-close { filter: brightness(0) invert(1); opacity: 0.8; }
        #cameraModal .modal-body { padding: 0; display: flex; justify-content: center; align-items: center; height: 100%; }
        #cameraVideo { display: block; width: 100%; height: 100%; object-fit: cover; }
        #cameraCanvas { display: none; }
        #cameraControls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background-color: rgba(0,0,0,0.6); padding: 25px 20px;
            text-align: center; z-index: 10;
        }
        #takePhotoButton { /* Uses ID for specific styling */
            border-radius: 50%; width: 75px; height: 75px;
            padding: 0; background-color: #fff; border: 6px solid rgba(255,255,255,0.5);
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            display: inline-block; /* Ensure it behaves like a block for centering */
            /* Reset base .btn styles that interfere */
            font-size: 1rem;
            font-weight: normal;
            line-height: initial;
            margin: 0;
            color: transparent; /* Hide any potential text */
        }
        #takePhotoButton:hover { background-color: #f0f0f0; border-color: rgba(255,255,255,0.8); transform: scale(1.05); }
        #takePhotoButton:active { transform: scale(0.95); }


        /* --- Image Viewer Modal Styles --- */
        #imageViewerModal .modal-dialog { max-width: 95%; margin: 1.75rem auto; }
        #imageViewerModal .modal-content { background-color: #f8f9fa; }
        #imageViewerModal .modal-body { text-align: center; padding: 1rem; }
        #fullImageView {
            max-width: 100%; max-height: 75vh;
            display: block; margin: 0 auto 1.5rem auto;
            border: 1px solid #ccc; border-radius: 8px; background-color: #fff;
        }
        #imageViewerModal .modal-footer { justify-content: space-between; }
        #imageViewerModal .btn { min-width: 100px; }


        /* --- Responsive Adjustments --- */
        @media (max-width: 767px) { /* Medium devices and down */
            .card-section { padding: 1.5rem 1rem; }
            .modal-body { padding: 1.25rem 1rem; }
            .modal-footer { padding: 0.75rem 1rem; }
            .modal-footer .btn { width: 100%; margin-left: 0; margin-right: 0; margin-bottom: 0.5rem; } /* Stack footer buttons */
            .modal-footer .btn:last-child { margin-bottom: 0; }
            #fishingPage .row .btn { width: 100%; } /* Stack add fish button */
        }
        @media (max-width: 575px) { /* Small devices and down */
             html { font-size: 15px; } /* Slightly smaller base font */
             .container { margin: 15px auto; padding: 1rem; }
             .card-section { padding: 1.25rem 0.8rem; }
             .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem; }
             .btn-lg { padding: 0.8rem 1.6rem; font-size: 1.05rem; }
             .splash-screen { padding: 2rem 1rem; }
             #fishingPage .row > div { padding-left: 5px; padding-right: 5px; } /* Reduce gutter */
             .fish-list-item { flex-wrap: wrap; } /* Allow wrapping on small screens */
             .fish-list-item small.text-muted { margin-left: 0; width: 100%; text-align: left; font-size: 0.75rem; padding-left: calc(1em + 0.5rem + 10px); /* Align under species/length */ }
        }

    </style>
</head>
<body>
    <!-- Container -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div class="mb-3">
                 <label for="zoneInput" class="form-label">Zone</label>
                 <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select>
            </div>
            <div class="mb-3">
                <label for="pegInput" class="form-label">Peg</label>
                <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> </select>
            </div>
            <div class="button-group-center"> <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button> </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>
             <!-- Form Row -->
            <div class="row g-2 align-items-end"> <!-- Use g-2 gutters, align-items-end -->
                <div class="col-md-6 col-lg-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select"> <option value="" selected disabled>Loading species...</option> </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-sm-6 col-md-3 col-lg-2 mb-3">
                     <label for="lengthInput" class="form-label">Length (cm)</label>
                     <input type="number" id="lengthInput" class="form-control" placeholder="Length" step="1" min="1" inputmode="numeric">
                </div>
                <div id="initialsInputGroup" class="col-sm-6 col-md-3 col-lg-2 mb-3" style="display: none;">
                    <label for="initialsInput" class="form-label">Verifier Initials</label>
                    <input type="text" id="initialsInput" class="form-control" placeholder="Initials" maxlength="3" style="text-transform:uppercase">
                </div>
                <!-- Add Fish Button -->
                <div class="col-md-12 col-lg-4 mb-3 text-lg-end text-center mt-3 mt-lg-0">
                     <button class="btn btn-primary" id="addFishBtn"> <i class="bi bi-plus-circle me-1"></i> Add Fish </button>
                </div>
            </div>
            <!-- Back Button -->
            <div class="text-center mb-4 mt-2"> <!-- Removed button-group-center -->
                 <button class="btn btn-secondary btn-sm" id="backFromFishingBtn"> <i class="bi bi-arrow-left-circle me-1"></i> Back to Registration </button>
             </div>

            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead> <tr> <th class="photo-col">Photo</th> <th class="species-col">Species</th> <th class="length-col">Length</th> <th id="verifiedByHeader" class="verified-col" style="display:none;">Verified</th> <th class="delete-col">Del</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>
             <!-- End Session Button Below Table -->
            <div class="button-group-center mt-4"> <button class="btn btn-success btn-lg" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button> </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details">
                <strong>Angler:</strong> <span id="summaryAngler"></span><br>
                <strong>Date:</strong> <span id="summaryDate"></span><br>
                <strong>Venue:</strong> <span id="summaryVenue"></span><br>
                <strong>Zone:</strong> <span id="summaryZone"></span><br>
                <strong>Peg:</strong> <span id="summaryPeg"></span><br>
                <span id="summaryVerifier"></span>
            </div>
            <div class="table-responsive">
                <table class="table">
                 <thead> <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr> </thead>
                 <tbody id="tallyTable"></tbody>
                 <tfoot>
                    <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                    <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                    <tr> <td colspan="3" class="text-end"><strong>Points Total</strong></td> <td><strong id="tallyPointsTotal">0</strong></td> </tr>
                 </tfoot>
                </table>
            </div>
            <div class="button-group-center"> <button class="btn btn-secondary" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back to Log</button> </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen page">
        <div class="button-group-center">
            <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
            <!-- Removed <br>, margin handles spacing now -->
            <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> An unsaved session was found. Would you like to restore it? <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p> <p><strong>Date:</strong> <span id="restoreDate"></span></p> <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p> </div> <div class="modal-footer button-group-center d-block"> <button type="button" class="btn btn-success btn-lg mb-2 w-100" id="restoreSessionBtn">Restore Session</button> <button type="button" class="btn btn-danger w-100" id="startNewSessionBtn">Start New Session</button> </div> </div> </div> </div>
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div id="savedScorecardsList" class="card-section"> <div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div> </div> <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p>Are you sure you want to end your session? This will save the scorecard.</p> <div id="verifierEndModalSection" class="mt-3" style="display: none;"> <hr> <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label> <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required> <small class="text-muted d-block mt-1">Required for competition scorecards.</small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button> <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button> </div> </div> </div> </div>
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="notesModalLabel">Session Notes</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" id="notesModalScorecardKey"> <div class="mb-3"> <label for="notesTextarea" class="form-label">Enter your notes below:</label> <textarea class="form-control" id="notesTextarea" rows="6"></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" onclick="saveNoteFromModal()">Save Notes</button> </div> </div> </div> </div>
    <div class="modal fade" id="mlsInfoModal" tabindex="-1" aria-labelledby="mlsInfoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="mlsInfoModalLabel"><i class="bi bi-info-circle-fill text-primary me-2"></i>Important MLS Information</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div> <div class="modal-body"> <p>Please ensure you are recording your catches in accordance with the minimum landing sizes (MLS) and any other fishing regulations that apply to your specific location or event.</p> <p><em>This app does not enforce MLS rules automatically.</em></p> </div> <div class="modal-footer"> <button type="button" class="btn btn-primary" id="mlsAgreeBtn" data-bs-dismiss="modal">OK, Understood</button> </div> </div> </div> </div>
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true"> <div class="modal-dialog modal-fullscreen"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cameraModalLabel">Take Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="cancelCameraButtonHeader"></button> </div> <div class="modal-body"> <video id="cameraVideo" playsinline autoplay muted></video> <canvas id="cameraCanvas"></canvas> </div> <div id="cameraControls"> <button type="button" id="takePhotoButton" aria-label="Take Photo"></button> <!-- Styling via ID --> </div> </div> </div> </div>
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="imageViewerModalLabel">Fish Photo</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <img id="fullImageView" src="#" alt="Full fish photo"> </div> <div class="modal-footer"> <button type="button" class="btn btn-info" id="shareImageBtn"><i class="bi bi-share-fill me-1"></i> Share</button> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <div class="modal fade" id="confirmPhotoModal" tabindex="-1" aria-labelledby="confirmPhotoModalLabel" aria-hidden="true"> <div class="modal-dialog modal-sm modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="confirmPhotoModalLabel">Add Photo?</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body text-center"> Add a photo for this fish now? </div> <div class="modal-footer justify-content-center"> <button type="button" class="btn btn-success mx-2" id="confirmPhotoYesBtn">Yes</button> <button type="button" class="btn btn-secondary mx-2" id="confirmPhotoNoBtn">No</button> </div> </div> </div> </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Application JS (No changes made to JS in this revision) -->
    <script>
        // --- Global Variables ---
        const fishCategories = {
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
             "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
             "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
             "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
             "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
         };
        let fishData = [];
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentPage = 'splashScreen';
        let isAppActive = false;
        let historyHijacked = false;
        let notesModalInstance = null;
        let cameraModalInstance = null;
        let imageViewerModalInstance = null;
        let confirmPhotoModalInstance = null;
        let db = null;
        let currentStream = null;
        let currentFishIdForPhoto = null;
        let currentImageBlobForViewer = null;
        let currentImageIdForViewer = null;
        let isDropdownPopulated = false;
        let pendingFishData = null;

        // --- Constants ---
        const DB_NAME = 'SeaCatchDB';
        const DB_VERSION = 1;
        const IMAGE_STORE_NAME = 'fishImages';
        const POINTS_PER_SPECIES = 10;

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function formatDateForInput(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function showPage(pageId) { console.log("Show page:", pageId); document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); const target = document.getElementById(pageId); if (target) { target.style.display = pageId === 'splashScreen' ? 'flex' : 'block'; currentPage = pageId; const container = document.querySelector('.container'); if(container) container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); } else if (pageId === 'splashScreen' && isAppActive) { deactivateAppMode(); } if (pageId !== 'splashScreen') { saveTempSession(); } } else { console.error("Page missing:", pageId, ". Defaulting splash."); const splash = document.getElementById('splashScreen'), container = document.querySelector('.container'); if(splash) splash.style.display = 'flex'; if(container) container.style.display = 'none'; currentPage = 'splashScreen'; deactivateAppMode(); } }
        function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16) ); }


        // --- IndexedDB Functions ---
        function initDb() { return new Promise((resolve, reject) => { if (db) { resolve(db); return; } console.log("Initializing IndexedDB..."); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("IndexedDB error: " + event.target.error); }; request.onsuccess = (event) => { db = event.target.result; console.log("IndexedDB initialized successfully."); resolve(db); }; request.onupgradeneeded = (event) => { console.log("Upgrading IndexedDB..."); db = event.target.result; if (!db.objectStoreNames.contains(IMAGE_STORE_NAME)) { console.log(`Creating object store: ${IMAGE_STORE_NAME}`); db.createObjectStore(IMAGE_STORE_NAME, { keyPath: 'id' }); } }; }); }
        function saveImageToDb(imageId, blob) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for saving image: " + dbErr); return; } } if (!blob || !imageId) { reject("Missing imageId or blob data."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); const imageData = { id: imageId, blob: blob }; console.log(`Attempting to save image with ID: ${imageId}`); const request = store.put(imageData); request.onsuccess = () => { console.log(`Image ${imageId} saved to IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error saving image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Save image transaction completed."); }; transaction.onerror = (event) => { console.error("Save image transaction error:", event.target.error); reject("Save image transaction failed."); }; }); }
        function getImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for getting image: " + dbErr); return; } } if (!imageId) { reject("Missing imageId."); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readonly'); const store = transaction.objectStore(IMAGE_STORE_NAME); const request = store.get(imageId); request.onsuccess = (event) => { if (event.target.result) { console.log(`Image ${imageId} retrieved from IndexedDB.`); resolve(event.target.result.blob); } else { console.log(`Image ${imageId} not found in IndexedDB.`); resolve(null); } }; request.onerror = (event) => { console.error(`Error retrieving image ${imageId}:`, event.target.error); reject(event.target.error); }; }); }
        function deleteImageFromDb(imageId) { return new Promise(async (resolve, reject) => { if (!db) { try { await initDb(); } catch(dbErr) { reject("Failed to init DB for deleting image: " + dbErr); return; } } if (!imageId) { resolve(); return; } const transaction = db.transaction([IMAGE_STORE_NAME], 'readwrite'); const store = transaction.objectStore(IMAGE_STORE_NAME); console.log(`Attempting to delete image with ID: ${imageId}`); const request = store.delete(imageId); request.onsuccess = () => { console.log(`Image ${imageId} deleted from IndexedDB.`); resolve(); }; request.onerror = (event) => { console.error(`Error deleting image ${imageId}:`, event.target.error); reject(event.target.error); }; transaction.oncomplete = () => { console.log("Delete image transaction completed."); }; transaction.onerror = (event) => { console.error("Delete image transaction error:", event.target.error); reject("Delete image transaction failed."); }; }); }


        // --- History/Navigation Control ---
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { try { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } catch (e) { console.error("Error pushing history state:", e); historyHijacked = false; } } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } }
        function handleBackButton(event) { if (isAppActive && historyHijacked) { console.log("Browser back button intercepted by app mode."); try { history.pushState({ appActive: true }, '', location.href); // Prevent going back
                // Optional: Implement in-app back navigation logic here based on `currentPage`
                // e.g., if (currentPage === 'fishingPage') { showPage('registrationPage'); }
                // else if (currentPage === 'tallyPage') { showPage('fishingPage'); }
                // else { /* Maybe show confirm exit dialog? */ }
            } catch (e) { console.error("Error pushing history state in back button handler:", e); } } else { console.log("Browser back button allowed (App not active or history not hijacked)."); } }
        function handleBeforeUnload(event) { if (isAppActive && fishData.length > 0) { // Only prompt if there's data
             console.log("beforeunload prompt triggered due to active session with data."); event.preventDefault(); event.returnValue = 'You have an unsaved fishing session. Are you sure you want to leave?'; return event.returnValue; } else { console.log("beforeunload allowed (No active session or no data)."); } }

        // --- Session Management ---
        function saveTempSession() { if (!isAppActive) return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); console.log("Temp session saved for page:", currentPage); } catch (e) { console.error("Save temp session error:", e); if(e.name === 'QuotaExceededError'){ alert("Warning: Could not save session progress, local storage might be full. Please clear old scorecards if possible.");}} }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temporary session cleared."); } catch (e) { console.error("Clear temp session error:", e); } }
        function checkRestoreSession() { let data; try { const temp = localStorage.getItem('temp_session'); if (!temp) { console.log("No temp session found."); setTodaysDate(); showPage('splashScreen'); return; } data = JSON.parse(temp); if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid temp session format."); } catch (e) { console.error("Error reading temp session:", e); clearTempSession(); setTodaysDate(); showPage('splashScreen'); return; } if (data.currentAngler || data.currentDate || data.currentVenue || data.fishData.length > 0) { console.log("Found restorable session, showing modal."); document.getElementById('restoreAngler').textContent=data.currentAngler||'N/A'; document.getElementById('restoreDate').textContent=data.currentDate?formatDate(data.currentDate):'N/A'; document.getElementById('restoreFishCount').textContent=data.fishData.length; const modalEl=document.getElementById('restoreSessionModal'); if(modalEl){ try { let mI=bootstrap.Modal.getInstance(modalEl); if(!mI) mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false}); mI.show(); } catch (modalError) { console.error("Error showing restore modal:", modalError); clearTempSession(); setTodaysDate(); showPage('splashScreen'); } } else { console.error("Restore modal element not found."); clearTempSession(); setTodaysDate(); showPage('splashScreen'); } } else { console.log("Temp session found but empty, clearing and showing splash."); clearTempSession(); setTodaysDate(); showPage('splashScreen'); } }
        function restoreSession() { console.log("Restore session initiated."); let temp; try { const sS=localStorage.getItem('temp_session'); if(!sS)throw new Error("No temp session data found in storage."); temp=JSON.parse(sS); if(!temp||!Array.isArray(temp.fishData))throw new Error("Invalid temp session data format."); } catch(e){ console.error("Error restoring session data:",e); alert("Failed to restore session data. Starting fresh."); startNewSession(); return; } fishData=temp.fishData||[]; currentAngler=temp.currentAngler||null; currentDate=temp.currentDate||null; currentVenue=temp.currentVenue||null; currentZone=temp.currentZone||null; currentPeg=temp.currentPeg||null; const page=temp.currentPage||'registrationPage'; isAppActive=temp.isAppActive||false; historyHijacked=temp.historyHijacked||false; const restoredIsCompetition = temp.isCompetition === true; console.log("Restoring state:",{currentAngler, currentDate, currentVenue, currentZone, currentPeg, page, isAppActive, historyHijacked, isCompetition: restoredIsCompetition}); try{ if(currentAngler)document.getElementById('anglerName').value=currentAngler; if(currentDate)document.getElementById('competitionDate').value=currentDate; if(currentVenue)document.getElementById('venueInput').value=currentVenue; document.getElementById('isCompetition').checked=restoredIsCompetition; toggleCompetitionFields(false); // Update fields based on checkbox, don't update log yet
            if(currentZone)document.getElementById('zoneInput').value=currentZone; if(currentPeg)document.getElementById('pegInput').value=currentPeg; } catch(e) { console.error("Error restoring registration fields:",e); } // Continue even if fields fail
        populateSpeciesDropdown(); // Ensure dropdown is ready
        if(page==='fishingPage'){ updateFishLog(); } // Update log if restoring to fishing page
        else if(page==='tallyPage'){ populateTallySummaryFields(); populateTallyTable(); } // Update tally if restoring there
        hideModal('restoreSessionModal'); showPage(page); if(isAppActive && !historyHijacked){ try { history.pushState({appActive:true},'',location.href); historyHijacked=true; console.log("Pushed history state after successful restore."); } catch (histErr) { console.error("Error pushing history after restore:", histErr); } } console.log("Session restoration complete."); }
        function startNewSession() { console.log("Start New Session confirmed."); clearTempSession(); resetApp(); hideModal('restoreSessionModal'); showPage('splashScreen'); }

        // --- UI Interaction ---
        function populateSpeciesDropdown() { if (isDropdownPopulated) { return; } console.log("Populating species dropdown..."); const input = document.getElementById('speciesInput'); if (!input) { console.error("Species dropdown (#speciesInput) missing!"); return; } try { const cats = Object.keys(fishCategories).sort(); input.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; if (Object.keys(fishCategories).length === 0) { console.warn("fishCategories object is empty!"); input.innerHTML = '<option value="" selected disabled>Error: No species loaded</option>'; return; } cats.forEach(cat => { const group = document.createElement('optgroup'); group.label = cat; const species = Array.isArray(fishCategories[cat]) ? [...fishCategories[cat]].sort() : []; if (species.length === 0) { console.warn(`No species array found for category: ${cat}`); } species.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; group.appendChild(opt); }); input.appendChild(group); }); isDropdownPopulated = true; console.log("Species dropdown populated successfully."); } catch (error) { console.error("Error during species dropdown population:", error); input.innerHTML = '<option value="" selected disabled>Error loading species</option>'; } }
        function toggleCustomSpeciesInput() { const sel=document.getElementById('speciesInput'), custom=document.getElementById('customSpeciesInput'); if(!sel||!custom)return; const showCustom = sel.value === 'Other'; custom.style.display = showCustom ? 'block' : 'none'; if(showCustom) { custom.focus(); } else { custom.value = ''; } }
        function toggleCompetitionFields(updateLog = true) { try{ const isChecked = document.getElementById('isCompetition').checked; const zone=document.getElementById('zoneInput'); const peg=document.getElementById('pegInput'); const initialsGroup = document.getElementById('initialsInputGroup'); const verifiedByHeader = document.getElementById('verifiedByHeader'); if (zone) zone.disabled=!isChecked; if (peg) peg.disabled=!isChecked; if (initialsGroup) initialsGroup.style.display = isChecked ? 'block' : 'none'; if (verifiedByHeader) verifiedByHeader.style.display = isChecked ? 'table-cell' : 'none'; if (!isChecked) { // Clear fields when disabling competition mode
                 if (zone) zone.value = ''; if (peg) peg.value = ''; const initialsInput = document.getElementById('initialsInput'); if (initialsInput) initialsInput.value = ''; // Clear initials input field
                 // Clear initials from existing fish data in current session
                 fishData.forEach(fish => fish.initials = null); currentZone = null; currentPeg = null; } if (updateLog) { updateFishLog(); } } catch(e){console.error("Toggle competition fields error:",e);} }
        function setTodaysDate() { try { const dateInput = document.getElementById('competitionDate'); if (dateInput && !dateInput.value) { const today = new Date(); const formattedDate = formatDateForInput(today); dateInput.value = formattedDate; console.log("Set date input to today:", formattedDate); } // Update currentDate global variable only if starting new session or explicitly changed
             // currentDate = dateInput.value; // Don't automatically set global here, let startRecording handle it.
         } catch (e) { console.error("Error setting today's date:", e); } }
        function startApp() { console.log("Start Fishing triggered."); setTodaysDate(); populateSpeciesDropdown(); showPage('registrationPage'); }
        function startRecording() { console.log("Record Catch triggered."); const nameEl=document.getElementById('anglerName'), dateEl=document.getElementById('competitionDate'), venueEl=document.getElementById('venueInput'), checkEl=document.getElementById('isCompetition'), zoneEl=document.getElementById('zoneInput'), pegEl=document.getElementById('pegInput'); let isValid = true; let errorMsg = ""; // Basic Validation
             if(!nameEl || !dateEl || !venueEl || !checkEl || !zoneEl || !pegEl){ alert("Critical error: Form elements are missing."); return; } const name=nameEl.value.trim(); const date=dateEl.value; const venue=venueEl.value.trim(); const isComp=checkEl.checked; const zone=zoneEl.value; const peg=pegEl.value; if(!name){ errorMsg += "Angler Name is required.\n"; isValid = false; nameEl.classList.add('is-invalid'); } else { nameEl.classList.remove('is-invalid'); } if(!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)){ errorMsg += "A valid Date is required.\n"; isValid = false; dateEl.classList.add('is-invalid'); } else { dateEl.classList.remove('is-invalid'); } if(!venue){ errorMsg += "Venue is required.\n"; isValid = false; venueEl.classList.add('is-invalid'); } else { venueEl.classList.remove('is-invalid'); } if(isComp){ if(!zone){ errorMsg += "Zone is required for competition.\n"; isValid = false; zoneEl.classList.add('is-invalid'); } else { zoneEl.classList.remove('is-invalid'); } if(!peg){ errorMsg += "Peg is required for competition.\n"; isValid = false; pegEl.classList.add('is-invalid'); } else { pegEl.classList.remove('is-invalid'); } } else { zoneEl.classList.remove('is-invalid'); pegEl.classList.remove('is-invalid'); } if (!isValid) { alert("Please fix the following errors:\n" + errorMsg); return; } // Set globals and proceed
             currentAngler=name; currentDate=date; currentVenue=venue; currentZone=isComp?zone:null; currentPeg=isComp?peg:null; const isActuallyCompetition = !!(currentZone && currentPeg); console.log("Starting recording session:",{currentAngler,currentDate,currentVenue,currentZone,currentPeg,isCompetition:isActuallyCompetition}); populateSpeciesDropdown(); // Ensure dropdown ready
             activateAppMode(); // Set app as active now
             saveTempSession(); updateFishLog(); showPage('fishingPage'); if (isActuallyCompetition) { showModal('mlsInfoModal'); } }
        function addFish() {
            console.log("Add Fish button clicked. Validating...");
            const spEl=document.getElementById('speciesInput'), custEl=document.getElementById('customSpeciesInput'), lenEl=document.getElementById('lengthInput'), initialsEl = document.getElementById('initialsInput');
            const isCompetition = document.getElementById('isCompetition').checked;
            let isValid = true; let errorMsg = "";

            // Clear previous validation states
            [spEl, custEl, lenEl, initialsEl].forEach(el => el?.classList.remove('is-invalid'));

            if(!spEl || !custEl || !lenEl){ alert("Critical error: Add fish form elements are missing."); return; }
            let species = spEl.value; const lenVal = lenEl.value.trim(); let length; let initials = null;

            if(!lenVal || isNaN(parseFloat(lenVal)) || parseFloat(lenVal) <= 0 || parseFloat(lenVal) > 500){ errorMsg += "Valid length (1-500cm) required.\n"; isValid = false; lenEl.classList.add('is-invalid'); } else { length = Math.round(parseFloat(lenVal)); }

            if(species === 'Other'){ species = custEl.value.trim(); if(!species){ errorMsg += "Custom species name required when 'Other' is selected.\n"; isValid = false; custEl.classList.add('is-invalid'); } else if(!/^[a-zA-Z0-9\s'-]+$/.test(species)){ // Allow numbers too, e.g., "Bass 30cm" might be entered
                 errorMsg += "Invalid characters in custom species name.\n"; isValid = false; custEl.classList.add('is-invalid'); } } else if(!species){ errorMsg += "Please select a species.\n"; isValid = false; spEl.classList.add('is-invalid'); }

            if (isCompetition && initialsEl) { initials = initialsEl.value.trim().toUpperCase(); if (!initials) { errorMsg += "Verifier initials are required for competition entries.\n"; isValid = false; initialsEl.classList.add('is-invalid'); } else if (initials.length < 2) { errorMsg += "Please enter at least 2 initials for the verifier.\n"; isValid = false; initialsEl.classList.add('is-invalid'); } }

            if (!isValid) { alert("Please fix the following errors:\n" + errorMsg); return; }

            // Validation passed, prepare data
            const fishId = generateUUID();
            pendingFishData = { id: fishId, species, length, initials: initials || null, imageId: null };
            console.log("Fish data validated. Stored pending:", pendingFishData);

            if (confirmPhotoModalInstance) { confirmPhotoModalInstance.show(); }
            else { console.error("Confirm photo modal instance not ready! Adding fish without photo prompt."); handleConfirmPhoto(false); }
        }
        function handleConfirmPhoto(shouldTakePhoto) {
            hideModal('confirmPhotoModal'); console.log(`Photo confirmation result: ${shouldTakePhoto}`);
            if (!pendingFishData) { console.error("Cannot confirm photo, pendingFishData is null!"); return; }
            fishData.push(pendingFishData); const addedFishId = pendingFishData.id;
            console.log("Added fish to main data:", pendingFishData); pendingFishData = null;
            try { // Reset form fields
                 document.getElementById('speciesInput').value = ''; document.getElementById('customSpeciesInput').value = ''; document.getElementById('customSpeciesInput').style.display = 'none'; document.getElementById('lengthInput').value = ''; const initialsInput = document.getElementById('initialsInput'); if(initialsInput) initialsInput.value = ''; // Clear initials after successful add
                 // Clear validation states
                 ['speciesInput', 'customSpeciesInput', 'lengthInput', 'initialsInput'].forEach(id => document.getElementById(id)?.classList.remove('is-invalid'));
                 document.getElementById('speciesInput').focus(); // Focus species for next entry
             } catch(e) { console.error("Error resetting form fields after add:", e); }
            updateFishLog(); saveTempSession();
            if (shouldTakePhoto) { openCamera(addedFishId); }
        }

        async function updateFishLog() {
            const logBody = document.getElementById('fishLog');
            const isCompetition = document.getElementById('isCompetition').checked;
            const verifiedByHeader = document.getElementById('verifiedByHeader');

            if (!logBody) { console.error("Fish log body (#fishLog) not found!"); return; }
            if (verifiedByHeader) { verifiedByHeader.style.display = isCompetition ? 'table-cell' : 'none'; }

            logBody.innerHTML = ''; // Clear existing log body

            const colCount = 3 + (isCompetition ? 1 : 0) + 1; // Photo, Species, Length, (Verified), Delete

            if (fishData.length === 0) {
                 const row = logBody.insertRow(); const cell = row.insertCell();
                 cell.colSpan = colCount; cell.className = 'text-center text-muted p-4';
                 cell.textContent = 'No fish added yet. Use the form above.'; return;
            }

            // Iterate newest first for display order
            for (let i = fishData.length - 1; i >= 0; i--) {
                 const f = fishData[i];
                 const row = logBody.insertRow(); // Appends row at the end, effectively reversing order visually

                 // Photo Cell
                 const photoCell = row.insertCell(); photoCell.className = 'photo-col';
                 const thumbContainer = document.createElement('span'); thumbContainer.className = 'thumbnail-container';
                 thumbContainer.id = `thumb-container-${f.id}`;
                 thumbContainer.innerHTML = '<i class="bi bi-camera no-photo-icon"></i>';
                 thumbContainer.title = f.imageId ? "Click to view photo" : "Click to add photo";
                 thumbContainer.onclick = () => { // Combined add/view logic
                     const currentFish = fishData.find(fish => fish.id === f.id); // Get current data
                     if (currentFish?.imageId) {
                         showFullscreenImage(currentFish.imageId);
                     } else {
                         openCamera(f.id);
                     }
                 };
                 photoCell.appendChild(thumbContainer);

                 // Species Cell
                 row.insertCell().textContent = f.species || '?';

                 // Length Cell
                 const lenCell = row.insertCell(); lenCell.className = 'length-col';
                 lenCell.textContent = f.length ? `${f.length} cm` : '?';

                 // Verified By Cell (Conditional)
                 if (isCompetition) {
                      const initialsCell = row.insertCell(); initialsCell.className = 'verified-col';
                      initialsCell.textContent = f.initials || '-';
                 }

                 // Delete Cell
                 const deleteCell = row.insertCell(); deleteCell.className = 'delete-col';
                 const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-icon-btn'; deleteBtn.title = 'Delete this fish';
                 deleteBtn.setAttribute('aria-label', `Delete ${f.species || 'fish'} (${f.length || '?'}cm)`);
                 deleteBtn.innerHTML = '<i class="bi bi-x-circle-fill" aria-hidden="true"></i>';
                 // Pass the correct index 'i' based on the current state of fishData array
                 deleteBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     // Find index dynamically in case array was modified elsewhere (safer)
                     const currentIndex = fishData.findIndex(fish => fish.id === f.id);
                     if (currentIndex !== -1) {
                         deleteFish(currentIndex);
                     } else {
                         console.error("Could not find fish to delete by ID:", f.id);
                         alert("Error: Could not delete fish, ID not found.");
                     }
                 });
                 deleteCell.appendChild(deleteBtn);

                 // Load thumbnail if imageId exists
                 if (f.imageId) {
                     loadThumbnail(f.id, f.imageId); // Existing function call is fine
                 }
            }
        }


        async function loadThumbnail(fishId, imageId) { const container = document.getElementById(`thumb-container-${fishId}`); if (!container || !imageId) return; container.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>'; container.onclick = null; // Temporarily disable click while loading
            try { const blob = await getImageFromDb(imageId); if (blob) { const url = URL.createObjectURL(blob); container.innerHTML = `<img src="${url}" alt="Fish thumbnail" class="fish-thumbnail">`; container.title = "Click to view full size"; container.onclick = () => { // Re-enable click to view full image
                    const currentFish = fishData.find(fish => fish.id === fishId); // Use find for safety
                    if (currentFish?.imageId) { showFullscreenImage(currentFish.imageId); } }; // Revoke URL when element is removed or image replaced (difficult to track reliably here)
                 // Simple approach: Revoke in showFullscreenImage when modal closes
                 } else { container.innerHTML = `<i class="bi bi-image-alt no-photo-icon" title="Image data missing"></i>`; container.title = "Click to add photo"; container.onclick = () => { openCamera(fishId); }; // Allow adding photo again if missing
                } } catch (error) { console.error(`Error loading thumbnail for ${imageId}:`, error); container.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger no-photo-icon" title="Error loading image"></i>`; container.title = "Error loading image"; container.onclick = null; // No action on error
            } }
        async function deleteFish(idx) { if (idx >= 0 && idx < fishData.length) { const fishToDelete = fishData[idx]; const { id, species, length, imageId } = fishToDelete; let confirmMessage = `Delete ${species || '?'} (${length || '?'}cm)?`; if (imageId) { confirmMessage += " The photo will also be permanently deleted."; } if (confirm(confirmMessage)) { console.log("Deleting fish index:", idx, "ID:", id, "ImageID:", imageId); try { if (imageId) { await deleteImageFromDb(imageId); } fishData.splice(idx, 1); updateFishLog(); saveTempSession(); } catch (error) { console.error("Error during fish/image deletion:", error); alert("An error occurred while deleting the fish or its photo. Please try again."); updateFishLog(); // Refresh log even on error } } else { console.log("Delete cancelled."); } } else { console.error("Invalid delete index:", idx); alert("Error: Cannot delete fish at invalid index."); } }
        function backFromFishing() { console.log("Back from Fishing requested."); stopCameraStream(); showPage('registrationPage'); }


        // --- Camera Functions ---
        async function openCamera(fishId) { console.log("Opening camera for fish ID:", fishId); currentFishIdForPhoto = fishId; const video = document.getElementById('cameraVideo'); if (!video || !cameraModalInstance) { console.error("Camera video element or modal instance missing!"); alert("Error: Could not initialize camera view."); return; } if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("Camera access is not supported by your browser or device."); return; } // Reset video source before requesting new stream
            if (video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); } video.srcObject = null; try { const constraints = { video: { facingMode: "environment" } }; // Prefer rear camera
            console.log("Requesting camera stream with constraints:", constraints); currentStream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = currentStream; await video.play(); // Ensure play() is awaited
            cameraModalInstance.show(); console.log("Rear camera stream started successfully."); } catch (err) { console.error("Error accessing rear camera:", err); if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") { alert("Camera permission denied. Please allow camera access in your browser settings."); } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError" || err.name === "OverconstrainedError") { console.log("Rear camera not found or constraints failed, trying front camera..."); try { const frontConstraints = { video: { facingMode: "user" } }; console.log("Requesting front camera stream with constraints:", frontConstraints); currentStream = await navigator.mediaDevices.getUserMedia(frontConstraints); video.srcObject = currentStream; await video.play(); cameraModalInstance.show(); console.log("Front camera stream started successfully."); } catch (fallbackErr) { console.error("Error accessing front camera:", fallbackErr); alert(`Could not access any camera. Please ensure it's not in use by another app. Error: ${fallbackErr.name}`); } } else { alert(`Could not access camera due to an unexpected error: ${err.name}`); } } }
        function stopCameraStream() { if (currentStream) { console.log("Stopping camera stream tracks."); currentStream.getTracks().forEach(track => track.stop()); } currentStream = null; const video = document.getElementById('cameraVideo'); if (video) video.srcObject = null; console.log("Camera stream stopped."); }
        async function takeSnapshot() { console.log("Taking snapshot..."); const video = document.getElementById('cameraVideo'); const canvas = document.getElementById('cameraCanvas'); const takePhotoButton = document.getElementById('takePhotoButton'); if (!video || !canvas || !currentFishIdForPhoto) { console.error("Snapshot failed: Missing video, canvas, or fish ID."); stopCameraStream(); hideModal('cameraModal'); return; } if (video.readyState < video.HAVE_METADATA) { console.error("Snapshot failed: Video not ready."); alert("Camera not ready, please wait a moment and try again."); return; } if (takePhotoButton) takePhotoButton.disabled = true; // Disable button during processing
             // --- Image Resizing ---
            const MAX_WIDTH = 1280; const MAX_HEIGHT = 1280; let width = video.videoWidth; let height = video.videoHeight;
            if (width <= 0 || height <= 0) { console.error("Snapshot failed: Invalid video dimensions."); alert("Error getting video dimensions. Cannot take photo."); stopCameraStream(); hideModal('cameraModal'); if (takePhotoButton) takePhotoButton.disabled = false; return; }
            if (width > height) { if (width > MAX_WIDTH) { height = Math.round(height * MAX_WIDTH / width); width = MAX_WIDTH; } }
            else { if (height > MAX_HEIGHT) { width = Math.round(width * MAX_HEIGHT / height); height = MAX_HEIGHT; } }
            canvas.width = width; canvas.height = height;
            const context = canvas.getContext('2d');
            console.log(`Drawing image to canvas. Original: ${video.videoWidth}x${video.videoHeight}, Resized: ${width}x${height}`);
            try { context.drawImage(video, 0, 0, width, height); // Draw resized image
            } catch (drawError) { console.error("Error drawing video to canvas:", drawError); alert("Failed to capture image from camera feed."); stopCameraStream(); hideModal('cameraModal'); if (takePhotoButton) takePhotoButton.disabled = false; return; }
            stopCameraStream(); // Stop stream after drawing
            canvas.toBlob(async (blob) => { if (blob) { const imageId = `img_${currentFishIdForPhoto}_${Date.now()}`; console.log(`Generated Blob (approx ${Math.round(blob.size / 1024)} KB). Saving with ID: ${imageId}`); try { const fishIndex = fishData.findIndex(f => f.id === currentFishIdForPhoto); let oldImageId = null; if (fishIndex !== -1) { oldImageId = fishData[fishIndex].imageId; } await saveImageToDb(imageId, blob); if (fishIndex !== -1) { fishData[fishIndex].imageId = imageId; console.log("Updated fishData with new imageId:", fishData[fishIndex]); saveTempSession(); updateFishLog(); // Update UI immediately
                 } else { console.error("Could not find fish with ID", currentFishIdForPhoto, "to update imageId after saving."); } if (oldImageId && oldImageId !== imageId) { console.log("Deleting old image:", oldImageId); await deleteImageFromDb(oldImageId); } } catch (error) { console.error("Error saving image blob to DB or deleting old one:", error); alert("Failed to save the photo due to a storage error."); } } else { console.error("Canvas toBlob failed to generate blob."); alert("Failed to process captured photo data."); } hideModal('cameraModal'); if (takePhotoButton) takePhotoButton.disabled = false; // Re-enable button
             currentFishIdForPhoto = null; }, 'image/jpeg', 0.85); /* Quality 0.85 */ }


        // --- End Session Modal ---
        function showEndSessionModal() { console.log("End Session button clicked."); if (fishData.length === 0) { if (!confirm("You haven't logged any fish. Do you still want to end and save this empty session?")) { return; } } const modalEl = document.getElementById('endSessionModal'); const verifierSection = document.getElementById('verifierEndModalSection'); const verifierInput = document.getElementById('verifierEndModalInput'); if (!modalEl || !verifierSection || !verifierInput) { console.error("End session modal elements missing!"); alert("Error preparing end session dialog."); return; } const isCompetition = !!(currentZone && currentPeg); verifierSection.style.display = isCompetition ? 'block' : 'none'; verifierInput.value = ''; verifierInput.classList.remove('is-invalid'); // Clear validation state
            bootstrap.Modal.getOrCreateInstance(modalEl, {backdrop: 'static', keyboard: false}).show(); }
        function confirmEndSession() { console.log("Confirm End button clicked."); if (!currentAngler || !currentDate || !currentVenue) { // Should be validated earlier, but double-check
             alert("Cannot save session: Missing critical Angler Name, Date, or Venue information."); hideModal('endSessionModal'); showPage('registrationPage'); return; } const isCompetition = !!(currentZone && currentPeg); let verifierName = null; const verifierInput = document.getElementById('verifierEndModalInput'); if (isCompetition) { if (!verifierInput) { console.error("Verifier input element missing!"); alert("Error: Verifier input field is missing."); return; } verifierName = verifierInput.value.trim(); if (!verifierName) { alert("Competition Scorecard: Please enter the verifier's name."); verifierInput.classList.add('is-invalid'); verifierInput.focus(); return; } verifierInput.classList.remove('is-invalid'); } hideModal('endSessionModal'); console.log("Session validated. Saving final scorecard data with verifier:", verifierName); const sessionData = { currentAngler, currentDate, currentVenue, currentZone: currentZone || null, // Ensure null if empty
                currentPeg: currentPeg || null, // Ensure null if empty
                verifier: verifierName, // Will be null if not competition
                notes: null, // Notes are saved separately per scorecard later
                fishData: fishData || [], isCompetition: isCompetition }; const id = `scorecard_${Date.now()}`; try { localStorage.setItem(id, JSON.stringify(sessionData)); console.log("Saved final scorecard metadata to localStorage with key:", id); alert("Scorecard saved successfully!"); clearTempSession(); resetApp(); showPage('splashScreen'); } catch(e) { console.error("Failed to save final scorecard metadata:", e); alert("Save failed. Local storage might be full or disabled."); if(e.name === 'QuotaExceededError') { alert("Local storage is full. Please delete older scorecards to free up space.");} // Don't reset, allow user to retry or manage data
             showPage('fishingPage'); // Stay on fishing page if save fails
            } }

        // --- Tally Page ---
        function populateTallySummaryFields() { try{ document.getElementById('summaryAngler').textContent=currentAngler||'?'; document.getElementById('summaryDate').textContent=currentDate?formatDate(currentDate):'?'; document.getElementById('summaryVenue').textContent=currentVenue||'?'; document.getElementById('summaryZone').textContent=currentZone||'N/A'; document.getElementById('summaryPeg').textContent=currentPeg||'N/A'; const verifierSpan = document.getElementById('summaryVerifier'); if (verifierSpan) { // Verifier info is only available on *saved* scorecards, not the live tally page
                verifierSpan.innerHTML = ''; // Clear it for the live tally view
            } }catch(e){console.error("Err populating tally summary:", e);} }
        function populateTallyTable() {
            const tableBody = document.getElementById('tallyTable');
            if (!tableBody) { console.error("Tally table body not found."); return; }

            const speciesSummary = {};
            let overallTotalLength = 0;
            let longestFish = null;

            fishData.forEach(fish => {
                const speciesKey = fish.species || "?";
                const length = fish.length || 0;
                speciesSummary[speciesKey] = speciesSummary[speciesKey] || { count: 0, totalLength: 0, lengths: [] };
                speciesSummary[speciesKey].count++;
                speciesSummary[speciesKey].totalLength += length;
                speciesSummary[speciesKey].lengths.push(length);
                overallTotalLength += length;
                if (!longestFish || length > (longestFish.length || 0)) {
                    longestFish = fish;
                }
            });

            Object.values(speciesSummary).forEach(details => details.lengths.sort((a, b) => a - b));
            const sortedSpeciesEntries = Object.entries(speciesSummary).sort(([a], [b]) => a.localeCompare(b));

            tableBody.innerHTML = sortedSpeciesEntries.map(([species, details]) =>
                `<tr>
                    <td>${species}</td>
                    <td>${details.count}</td>
                    <td>${details.lengths.length > 0 ? `(${details.lengths.join(', ')})` : '-'}</td>
                    <td>${details.totalLength}</td>
                 </tr>`
            ).join('') || '<tr><td colspan="4" class="text-center p-3 text-muted">No fish recorded for tally.</td></tr>';

            const speciesCount = Object.keys(speciesSummary).length;
            const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES);

            // Update footer elements
            try { document.getElementById('tallyTotalLength').textContent = `${overallTotalLength} cm`; document.getElementById('tallySpeciesCount').textContent = speciesCount; document.getElementById('longestFishSpecies').textContent = longestFish ? (longestFish.species || '?') : 'N/A'; document.getElementById('longestFishLength').textContent = longestFish ? `${longestFish.length || '?'} cm` : '0 cm'; document.getElementById('tallyPointsTotal').textContent = points; } catch(e) { console.error("Error updating tally footer:", e); }
        }
        function backFromTally() { console.log("Back from Tally requested."); showPage('fishingPage'); }

        // --- Saved Scorecards ---
        function showScorecardsModal() { console.log("View Saved Scorecards button clicked."); const modalEl=document.getElementById('savedScorecardsModal'), listEl=document.getElementById('savedScorecardsList'); if(modalEl&&listEl){listEl.innerHTML='<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading scorecards...</span></div></div>'; try { let mI=bootstrap.Modal.getInstance(modalEl); if(!mI) mI=new bootstrap.Modal(modalEl,{backdrop:'static',keyboard:false}); mI.show(); setTimeout(loadScorecards, 50); // Load async after modal starts showing
            } catch (modalError) { console.error("Error showing scorecards modal:", modalError); alert("Error opening saved scorecards viewer."); } } else { console.error("Scorecard modal or list element missing."); alert("Error: Cannot display saved scorecards."); } }
        async function loadScorecards() { console.log("Loading scorecards from localStorage..."); const savedScorecardsList = document.getElementById('savedScorecardsList'); const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer'); if (!savedScorecardsList || !olderScorecardsToggleContainer) { console.error("CRITICAL: Modal list or toggle container missing!"); return; } savedScorecardsList.innerHTML = ''; olderScorecardsToggleContainer.innerHTML = ''; const scorecards = []; let loadError = false; try { const keys = Object.keys(localStorage); for (const key of keys) { if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ try { const data=JSON.parse(dS); // Add more robust check for required fields
                            if(data && data.currentDate && data.currentVenue){ // Angler name optional maybe?
                                const tS=parseInt(key.split('_')[1],10); if(!isNaN(tS)){scorecards.push({key,data,timestamp:tS});} else { console.warn("Skipping scorecard with invalid timestamp in key:", key); } } else {console.warn("Skipping invalid/incomplete scorecard data:",key);}} catch(e){console.error("Error parsing scorecard JSON:",key,e);}}}}} catch (e) { console.error("Error reading scorecards from localStorage:",e); savedScorecardsList.innerHTML='<p class="text-danger p-3">Error loading scorecards from storage. Please check browser permissions.</p>'; loadError=true; } if(loadError) return; scorecards.sort((a,b)=>b.timestamp-a.timestamp); // Sort newest first
            if (scorecards.length===0){ savedScorecardsList.innerHTML='<p class="text-center text-muted p-4">No saved scorecards found.</p>'; return; } console.log(`Total scorecards loaded: ${scorecards.length}`); const displayLimit = 5; // Show 5 initially
            try { const initial = scorecards.slice(0, displayLimit); initial.forEach(({ key, data }, index) => { const el = createScorecardElement(key, data, index === 0); if (el) savedScorecardsList.appendChild(el); }); } catch(e) { console.error("Error creating initial scorecard elements:", e); savedScorecardsList.innerHTML += '<p class="text-danger p-3">Error displaying initial scorecards.</p>'; } if (scorecards.length > displayLimit) { const olderCount = scorecards.length - displayLimit; const showOlderBtn = document.createElement('button'); showOlderBtn.id = 'showOlderBtn'; showOlderBtn.className = 'btn btn-outline-secondary'; showOlderBtn.innerHTML = `<i class="bi bi-chevron-double-down me-1"></i> View ${olderCount} Older Scorecard${olderCount > 1 ? 's' : ''}`; showOlderBtn.onclick = function() { console.log("Show Older Scorecards clicked."); try { const older = scorecards.slice(displayLimit); older.forEach(({ key, data }) => { const el = createScorecardElement(key, data, false); if (el) savedScorecardsList.appendChild(el); }); olderScorecardsToggleContainer.innerHTML = ''; // Remove buttons after showing
                 } catch(e) { console.error("Error creating/appending older scorecard elements:", e); olderScorecardsToggleContainer.innerHTML = '<p class="text-danger">Error displaying older scorecards.</p>'; } }; olderScorecardsToggleContainer.appendChild(showOlderBtn); const deleteOlderBtn = document.createElement('button'); deleteOlderBtn.id = 'deleteOlderBtn'; deleteOlderBtn.className = 'btn btn-outline-danger'; deleteOlderBtn.innerHTML = '<i class="bi bi-trash me-1"></i> Delete Older'; deleteOlderBtn.title = `Delete ${olderCount} oldest scorecards`; deleteOlderBtn.onclick = confirmDeleteOlderScorecards; olderScorecardsToggleContainer.appendChild(deleteOlderBtn); } }
        function createScorecardElement (key, data, isLatest) {
            try {
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`;
                wrapperDiv.id = `entry-${key}`;

                // Calculate Summaries
                let overallTotalLength = 0, fishCount = 0, speciesSet = new Set(), longestFish = null, speciesTotals = {};
                const fishList = data.fishData || [];
                fishList.forEach(f => {
                    const length = f.length || 0; const speciesName = f.species || '?';
                    fishCount++; overallTotalLength += length; speciesSet.add(speciesName);
                    if (!longestFish || length > (longestFish.length || 0)) longestFish = f;
                    speciesTotals[speciesName] = (speciesTotals[speciesName] || 0) + length;
                });
                const speciesCount = speciesSet.size;
                const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES);
                const longestFishString = longestFish ? `${longestFish.species || '?'}(${longestFish.length || '?'}cm)` : 'N/A';
                const escapedKey = key.replace(/'/g, "\\'"); // Keep escaping for inline JS
                const hasNotes = data.notes && data.notes.trim() !== '';
                const viewNoteButtonHtml = hasNotes ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${escapedKey}', event)"><i class="bi bi-eye me-1"></i>View Note</button>` : '';
                const addEditNoteButtonHtml = `<button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${escapedKey}', event)"><i class="bi bi-pencil me-1"></i>${hasNotes ? 'Edit Note' : 'Add Note'}</button>`;

                // Generate Fish List HTML
                let fishListHtml = `<p class="ms-2 text-muted fst-italic">No fish recorded in this session.</p>`;
                if (fishList.length > 0) {
                    fishListHtml = fishList.map((f, i) => {
                        let verifiedText = ''; if (data.isCompetition && f.initials) verifiedText = ` <small class="text-muted fst-italic">(Verified: ${f.initials})</small>`;
                        return `<p class="fish-list-item">
                                    <span class="badge bg-secondary me-2">${i + 1}</span>
                                    <span>${f.species || '?'} - <strong>${f.length || '?'}cm</strong></span>
                                    ${verifiedText}
                                </p>`;
                    }).join('');
                }

                // Generate Species Length Summary HTML
                let speciesSummaryHtml = '';
                if (Object.keys(speciesTotals).length > 0) {
                    const sortedSpecies = Object.entries(speciesTotals).sort((a, b) => a[0].localeCompare(b[0]));
                    speciesSummaryHtml += '<div class="species-length-summary">';
                    speciesSummaryHtml += '<h6>Species Length Totals:</h6>';
                    sortedSpecies.forEach(([speciesName, totalLength]) => { speciesSummaryHtml += `<p><strong>${speciesName}:</strong> ${totalLength}cm</p>`; });
                    speciesSummaryHtml += '</div><hr>';
                }

                // Generate Photos Section HTML
                const photosPlaceholderId = `sessionPhotos-${key}`;
                const photosHtml = `<hr><h6>Session Photos</h6><div class="session-photos" id="${photosPlaceholderId}"><p class="text-muted placeholder-photos fst-italic">(No photos available)</p></div>`;

                // Assemble Full Scorecard Details HTML
                wrapperDiv.innerHTML = `
                    <div class="scorecard-item" onclick="toggleScorecardDetails('${escapedKey}',this)">
                        <i class="bi bi-chevron-right"></i>
                        <div>
                            <strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')}
                            <small class="text-muted d-block">
                                ${fishCount} fish  ${overallTotalLength}cm  ${points} pts  Angler: ${data.currentAngler || '?'}
                            </small>
                        </div>
                        ${isLatest ? '<span class="badge bg-primary ms-auto align-self-center">Latest</span>' : ''} <!-- Align badge center vertically -->
                    </div>
                    <div class="scorecard-details" id="details_${key}">
                        <h6>Session Details</h6>
                        <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p>
                        <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p>
                        <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p>
                        ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''}
                        ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''}
                        ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''}
                        <hr>
                        <h6>Catch List (${fishCount})</h6>
                        ${fishListHtml}
                        ${fishList.length > 0 ? `
                            <hr>
                            <div class="scorecard-summary-block">
                                <h6>Session Summary</h6>
                                ${speciesSummaryHtml}
                                <p><strong>Overall Total Length:</strong> <span class="summary-highlight">${overallTotalLength}cm</span></p>
                                <p><strong>Total Species Caught:</strong> ${speciesCount}</p>
                                <p><strong>Longest Fish Recorded:</strong> ${longestFishString}</p>
                                <p><strong>Points Total (Length + Species Bonus):</strong> <span class="summary-highlight">${points}</span></p>
                            </div>
                        ` : ''}
                        ${photosHtml}
                        <div class="btn-actions-group">
                            ${viewNoteButtonHtml}
                            ${addEditNoteButtonHtml}
                            <button class="btn btn-info btn-sm" onclick="emailScorecard('${escapedKey}', event)"><i class="bi bi-envelope me-1"></i>Email</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${escapedKey}', event)"><i class="bi bi-trash me-1"></i>Delete</button>
                        </div>
                    </div>`;

                // Asynchronously load photos for this specific scorecard
                setTimeout(() => loadSessionPhotos(key, fishList), 0);

                return wrapperDiv;
            } catch (elementError) { console.error(`Error creating scorecard element for ${key}:`, elementError); const errDiv = document.createElement('div'); errDiv.className = 'alert alert-warning p-2 my-2'; errDiv.textContent = `Error displaying scorecard ${key.slice(-6)}`; return errDiv; }
        }


        async function loadSessionPhotos(scorecardKey, fishList) {
            const photosContainerId = `sessionPhotos-${scorecardKey}`;
            const photosContainer = document.getElementById(photosContainerId);
            if (!photosContainer) { console.warn(`Photos container not found: ${photosContainerId}`); return; }
            const fishWithPhotos = fishList.filter(f => !!f.imageId);
            if (fishWithPhotos.length === 0) { photosContainer.innerHTML = '<p class="text-muted placeholder-photos fst-italic">(No photos saved for this session)</p>'; return; }
            console.log(`Loading ${fishWithPhotos.length} photos for scorecard ${scorecardKey}`);
            photosContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div><span class="text-muted small">Loading photos...</span>'; // Small text
            let imagesAdded = 0;
            const imagePromises = fishWithPhotos.map(async (fish) => {
                 try {
                      const blob = await getImageFromDb(fish.imageId);
                      if (blob) {
                           const url = URL.createObjectURL(blob);
                           const img = document.createElement('img'); img.src = url; img.alt = `Photo for ${fish.species || 'fish'}`; img.className = 'session-photo-thumbnail'; img.title = `Click to view full size - ${fish.species || 'fish'} (${fish.length || '?'}cm)`; // Add title
                           img.onclick = (e) => { e.stopPropagation(); showFullscreenImage(fish.imageId); };
                           img.addEventListener('load', () => URL.revokeObjectURL(url), { once: true }); // Revoke URL after load (might be too soon if modal opens later?)
                           img.addEventListener('error', () => console.error(`Error loading image URL: ${url.substring(url.length - 10)}`));
                           return img;
                      } else { console.warn(`Blob not found in DB for imageId: ${fish.imageId} (scorecard ${scorecardKey})`); return null; }
                 } catch (error) { console.error(`Error loading photo ${fish.imageId} for scorecard ${scorecardKey}:`, error); return null; }
            });
            const imageElements = await Promise.all(imagePromises);
            photosContainer.innerHTML = ''; // Clear loading indicator
            imageElements.forEach(img => { if (img) { photosContainer.appendChild(img); imagesAdded++; } });
            if (imagesAdded === 0 && fishWithPhotos.length > 0) { photosContainer.innerHTML = '<p class="text-danger placeholder-photos fst-italic">(Error loading session photos)</p>'; }
            else if (imagesAdded === 0) {
                photosContainer.innerHTML = '<p class="text-muted placeholder-photos fst-italic">(No photos found or loaded)</p>'; }
            console.log(`Finished loading photos for scorecard ${scorecardKey}. Added ${imagesAdded} images.`);
        }

        function toggleScorecardDetails(key, element){ console.log("Toggle details for:",key); const detailsDiv=document.getElementById(`details_${key}`), icon=element.querySelector('i.bi'); if(detailsDiv && icon){ const isVisible=detailsDiv.style.display==='block'; detailsDiv.style.display=isVisible?'none':'block'; icon.classList.toggle('bi-chevron-right',isVisible); icon.classList.toggle('bi-chevron-down',!isVisible); element.classList.toggle('details-visible',!isVisible); if (!isVisible) { setTimeout(() => { // Scroll after animation might start
                 detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } }else{console.error("Details div or icon missing for key:",key);} }
        async function deleteScorecard(key, event){ event.stopPropagation(); console.log("Attempting delete for scorecard key:", key); let data; try { data = JSON.parse(localStorage.getItem(key) || '{}'); } catch (e) { data = {}; } const fishList = data.fishData || []; const imageIdsToDelete = fishList.map(f => f.imageId).filter(id => !!id); let sN = `scorecard ${key.slice(-6)}`; try { sN = `scorecard for ${data.currentAngler || '?'} on ${formatDate(data.currentDate || '')}`; } catch (e) {} if (confirm(`Permanently delete ${sN}? \n\nThis will also delete ${imageIdsToDelete.length} associated photo(s).\nThis action cannot be undone.`)) { console.log("User confirmed deletion for:", key); try { if (imageIdsToDelete.length > 0) { console.log("Deleting images from DB:", imageIdsToDelete); const deletePromises = imageIdsToDelete.map(id => deleteImageFromDb(id)); await Promise.allSettled(deletePromises); console.log("Image deletion from DB attempted."); } localStorage.removeItem(key); console.log("Deleted scorecard metadata from localStorage:", key); const elementToRemove = document.getElementById(`entry-${key}`); if (elementToRemove) { elementToRemove.style.transition = 'opacity 0.3s ease-out, height 0.3s ease-out, margin 0.3s ease-out, padding 0.3s ease-out'; elementToRemove.style.opacity = '0'; elementToRemove.style.height = '0'; elementToRemove.style.margin = '0'; elementToRemove.style.padding = '0'; elementToRemove.style.border = 'none'; setTimeout(() => { elementToRemove.remove(); // Reload might still be needed if pagination/counts change loadScorecards(); // Refresh list to update counts/pagination if present
                 }, 300); } else { loadScorecards(); // Fallback to reload if element not found
                 } alert(`${sN} deleted successfully.`); } catch (e) { console.error("Delete scorecard/images error:", e); alert("Failed to delete scorecard or some associated images. Please try again."); loadScorecards(); // Refresh list even on error
                 } } else { console.log("Delete cancelled by user for key:", key); } }
        function emailScorecard(key, event) {
            event.stopPropagation(); console.log("Preparing email for scorecard:", key);
            alert("This will open your default email app. Note that photos and session notes are NOT included in the email body.");
            let data;
            try { const dS = localStorage.getItem(key); if (!dS) throw new Error("Scorecard data not found in storage."); data = JSON.parse(dS); if (!data?.currentAngler || !data.currentDate || !data.currentVenue || !Array.isArray(data.fishData)) throw new Error("Invalid scorecard data format."); } catch (error) { console.error("Error retrieving data for email:", error); alert(`Error preparing email data: ${error.message}`); return; }
            // --- Generate Email Body ---
            let body = " Sea Catch Scorecard Summary \r\n"; body += "=====================================\r\n\r\n"; body += "**SESSION DETAILS**\r\n"; // Use markdown hint
            body += `* Angler: ${data.currentAngler||'?'}\r\n`; body += `* Date: ${formatDate(data.currentDate||'')}\r\n`; body += `* Venue: ${data.currentVenue||'?'}\r\n`; if(data.currentZone)body+=`* Zone: ${data.currentZone}\r\n`; if(data.currentPeg)body+=`* Peg: ${data.currentPeg}\r\n`; if(data.verifier)body+=`* Verified By: ${data.verifier}\r\n`; body += "\r\n"; body += "**CATCH LIST**\r\n"; if(data.fishData?.length>0){ data.fishData.forEach((f,i)=>{ body+=`  ${i+1}. ${f.species||'?'} - **${f.length||'?'} cm**`; if(data.isCompetition && f.initials) { body += ` (Verified: ${f.initials || '-'})`; } body += `\r\n`; }); } else { body+="  *No fish recorded in this session.*\r\n"; } body+="\r\n";
            // --- Calculate Summary for Email ---
            let overallTotalLength=0, fishCount=0, speciesSet=new Set(), longestFish=null, speciesTotals={}; const fishList=data.fishData||[]; fishList.forEach(f=>{ const l=f.length||0; const sN=f.species||'?'; fishCount++; overallTotalLength+=l; speciesSet.add(sN); if(!longestFish||l>(longestFish.length||0)) longestFish=f; speciesTotals[sN]=(speciesTotals[sN]||0)+l; }); const speciesCount=speciesSet.size; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); const longestFishString=longestFish?`${longestFish.species||'?'}(${longestFish.length||'?'}cm)`:'N/A';
            // --- Add Summary to Body ---
            body += "**SESSION SUMMARY**\r\n"; if(Object.keys(speciesTotals).length > 0) { body += "  Species Length Totals:\r\n"; Object.entries(speciesTotals).sort((a,b) => a[0].localeCompare(b[0])).forEach(([name, len]) => { body += `    - ${name}: ${len}cm\r\n`; }); body += "\r\n"; } body += `* Overall Total Fish Caught: ${fishCount}\r\n`; body += `* Overall Total Length: **${overallTotalLength} cm**\r\n`; body += `* Unique Species Count: ${speciesCount}\r\n`; body += `* Longest Fish: ${longestFishString}\r\n`; body += `* Points Total: **${points}**\r\n`; body += "\r\n=====================================\r\n"; body += "_Generated by Sea Catch Scorer App_\r\n";
            // --- Create Mailto URL ---
            const subject = `Fishing Scorecard: ${data.currentVenue||'?'} - ${formatDate(data.currentDate||'')}`; const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; if(mailtoUrl.length > 2000){ /* Common limit */ console.warn(`Mailto URL length (${mailtoUrl.length}) exceeds 2000 chars, might be truncated by some email clients.`); alert("Warning: The generated email body is very long and might not work correctly in all email clients."); } console.log("Mailto URL length:", mailtoUrl.length); try{ const mailtoWin = window.open(mailtoUrl,'_blank'); if (!mailtoWin) { throw new Error("Popup blocked or window.open failed."); } console.log("Mailto link opened."); }catch(e){console.error("Mailto link error:",e);alert("Could not automatically open the email client. This might be due to browser settings (e.g., popup blocker) or no default email client configured. Please copy the details manually if needed.");}
        }


        // --- Notes Modal Functions ---
        function openNotesModal(key, event) { if(event) event.stopPropagation(); console.log('Opening notes modal for key:', key); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { console.error('Notes modal elements/instance missing!'); alert('Error opening notes editor.'); return; } try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; notesTextarea.value=data.notes||''; } catch(e){ console.error('Error loading notes for modal:',e); notesTextarea.value=''; alert('Could not load existing notes.'); } notesModalKeyInput.value = key; notesModalInstance.show(); }
        function saveNoteFromModal() { console.log('Save notes modal button clicked.'); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { alert('Error: Cannot save notes, required elements missing.'); return; } const key = notesModalKeyInput.value; const newNotes = notesTextarea.value; if (!key) { alert('Error: Scorecard key is missing, cannot save notes.'); return; } try { const dS = localStorage.getItem(key); if (!dS) throw new Error('Scorecard data not found in storage.'); let data = JSON.parse(dS); data.notes = newNotes; localStorage.setItem(key, JSON.stringify(data)); console.log('Notes saved successfully via modal for key:', key); notesModalInstance.hide(); // Update button text in the scorecard list without full reload
            const scorecardEntry = document.getElementById(`entry-${key}`); if (scorecardEntry) { const addEditButton = scorecardEntry.querySelector('.btn-actions-group button[onclick^="openNotesModal"]'); const viewButtonContainer = scorecardEntry.querySelector('.btn-actions-group'); let existingViewButton = scorecardEntry.querySelector('.btn-actions-group button[onclick^="viewNote"]'); const hasNotesNow = newNotes && newNotes.trim() !== ''; if (addEditButton) { addEditButton.innerHTML = `<i class="bi bi-pencil me-1"></i>${hasNotesNow ? 'Edit Note' : 'Add Note'}`; } if (viewButtonContainer) { if (hasNotesNow && !existingViewButton) { // Add View button if notes exist now and button doesn't
                    const viewBtn = document.createElement('button'); viewBtn.className = 'btn btn-secondary btn-sm'; viewBtn.onclick = (event) => viewNote(key, event); viewBtn.innerHTML = '<i class="bi bi-eye me-1"></i>View Note'; viewButtonContainer.insertBefore(viewBtn, addEditButton); // Add before add/edit button
                 } else if (!hasNotesNow && existingViewButton) { // Remove View button if notes were cleared
                    existingViewButton.remove(); } } } else { setTimeout(loadScorecards, 150); // Fallback to reload if entry not found
            } } catch (e) { console.error('Error saving notes from modal:', e); alert(`Failed to save notes: ${e.message}`); if(e.name === 'QuotaExceededError') { alert("Local storage is full. Could not save notes."); }} }
        function viewNote(key, event) { event.stopPropagation(); console.log('Viewing notes for key:', key); try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; const notes=data.notes||''; alert(`Notes for Scorecard:\n--------------------\n${notes.trim() || '(No notes have been saved yet)'}`); } catch (e) { console.error('Error retrieving notes for viewing:', e); alert('Could not retrieve notes.'); } }

        // --- Delete Older Scorecards Functions ---
        function confirmDeleteOlderScorecards() { const displayLimit = 5; // Match loadScorecards initial display
            const scorecards = []; try { const keys = Object.keys(localStorage); for (const key of keys) { if (key?.startsWith('scorecard_')) { const timestamp = parseInt(key.split('_')[1], 10); if (!isNaN(timestamp)) { scorecards.push({ key, timestamp }); } } } } catch (e) { alert('Error reading scorecards to determine deletion count.'); return; } scorecards.sort((a, b) => b.timestamp - a.timestamp); // Newest first
            if (scorecards.length > displayLimit) { const olderKeys = scorecards.slice(displayLimit).map(item => item.key); const olderCount = olderKeys.length; let imageCount = 0; olderKeys.forEach(key => { try { const data = JSON.parse(localStorage.getItem(key) || '{}'); imageCount += (data.fishData || []).filter(f => !!f.imageId).length; } catch (e) {} }); if (confirm(`Are you sure you want to permanently delete the ${olderCount} oldest scorecard${olderCount > 1 ? 's' : ''} (including approx. ${imageCount} photos)?\n\nThis action cannot be undone.`)) { deleteOlderScorecards(); } else { console.log("Delete older scorecards cancelled by user."); } } else { alert(`No older scorecards found to delete (fewer than ${displayLimit + 1} scorecards saved).`); } }
        async function deleteOlderScorecards() { console.log("Starting deletion of older scorecards..."); const displayLimit = 5; const scorecards = []; let errorOccurred = false; try { const keys = Object.keys(localStorage); for (const key of keys) { if (key?.startsWith('scorecard_')) { const timestamp = parseInt(key.split('_')[1], 10); if (!isNaN(timestamp)) { scorecards.push({ key, timestamp }); } } } scorecards.sort((a, b) => b.timestamp - a.timestamp); const keysToDelete = scorecards.slice(displayLimit).map(item => item.key); if (keysToDelete.length > 0) { console.log(`Attempting to delete ${keysToDelete.length} older scorecards:`, keysToDelete); let allImageIdsToDelete = []; keysToDelete.forEach(key => { try { const data = JSON.parse(localStorage.getItem(key) || '{}'); allImageIdsToDelete.push(...(data.fishData || []).map(f => f.imageId).filter(id => !!id)); } catch (e) { console.warn("Error parsing scorecard for image IDs during delete:", key); }}); allImageIdsToDelete = [...new Set(allImageIdsToDelete)]; // Unique IDs
                if (allImageIdsToDelete.length > 0) { console.log("Deleting associated older images from DB:", allImageIdsToDelete); const deleteImgPromises = allImageIdsToDelete.map(id => deleteImageFromDb(id)); const results = await Promise.allSettled(deleteImgPromises); results.forEach((result, index) => { if (result.status === 'rejected') { console.error(`Failed to delete image ${allImageIdsToDelete[index]}:`, result.reason); errorOccurred = true; }}); console.log("Older image deletion from DB finished."); } keysToDelete.forEach(key => { try { localStorage.removeItem(key); console.log(`Deleted scorecard metadata: ${key}`); } catch (removeError) { console.error(`Error removing metadata key ${key}:`, removeError); errorOccurred = true; } }); if (errorOccurred) { alert("Some older scorecards or their photos may not have been deleted due to an error. Please check storage or console for details."); } else { alert(`${keysToDelete.length} older scorecard${keysToDelete.length > 1 ? 's' : ''} and associated photos deleted successfully.`); } } else { console.log("No older scorecards found to delete after re-check."); } } catch (e) { console.error("Error during the delete older scorecards process:", e); alert("An error occurred while trying to delete older scorecards."); errorOccurred = true; } finally { loadScorecards(); // Refresh the list view
            } }

        // --- Image Viewer and Sharing ---
        async function showFullscreenImage(imageId) { console.log("Showing fullscreen image:", imageId); if (!imageId || !imageViewerModalInstance) { console.error("Cannot show image: Missing imageId or viewer instance."); return; } const imageView = document.getElementById('fullImageView'); const shareBtn = document.getElementById('shareImageBtn'); const modalLabel = document.getElementById('imageViewerModalLabel'); if (!imageView || !shareBtn || !modalLabel) { console.error("Image viewer modal elements missing"); return; } // Reset state
            imageView.src = '#'; // Placeholder or spinner could go here
            shareBtn.disabled = true; shareBtn.onclick = null; // Remove old listener
            modalLabel.textContent = 'Loading Photo...'; currentImageBlobForViewer = null; currentImageIdForViewer = null; imageViewerModalInstance.show(); try { const blob = await getImageFromDb(imageId); if (blob) { const url = URL.createObjectURL(blob); imageView.onload = () => { console.log("Fullscreen image loaded:", imageId); modalLabel.textContent = 'Fish Photo'; // Update title after load
                     // Revoke previous URL if one exists from a prior view in the same modal instance?
                     // This gets tricky. Rely on hidden.bs.modal for now.
                 }; imageView.onerror = () => { console.error("Error loading fullscreen image URL for:", imageId); modalLabel.textContent = 'Error Loading Photo'; alert("Error displaying the image."); }; imageView.src = url; currentImageBlobForViewer = blob; currentImageIdForViewer = imageId; // Check share capability and set button state/listener
                const canShare = 'share' in navigator && 'canShare' in navigator; shareBtn.disabled = !canShare; shareBtn.title = canShare ? "Share Image" : "Sharing not supported by browser"; if (canShare) { shareBtn.onclick = shareImage; // Add listener only if shareable
                 } const modalElement = document.getElementById('imageViewerModal'); // Define listener function to allow removal
                const revokeUrlOnHide = () => { console.log("Revoking fullscreen object URL:", url); URL.revokeObjectURL(url); imageView.src = '#'; // Clear image
                    currentImageBlobForViewer = null; currentImageIdForViewer = null; shareBtn.onclick = null; // Clean up listener
                    modalElement.removeEventListener('hidden.bs.modal', revokeUrlOnHide); // Remove self
                }; // Add listener for when modal is completely hidden
                modalElement.addEventListener('hidden.bs.modal', revokeUrlOnHide, { once: true }); } else { alert("Image data could not be found."); imageViewerModalInstance.hide(); } } catch (error) { console.error("Error loading image for viewer:", error); alert("Could not load image due to an error."); imageViewerModalInstance.hide(); } }
        async function shareImage() { console.log("Share button clicked for image:", currentImageIdForViewer); const shareBtn = document.getElementById('shareImageBtn'); if (shareBtn) shareBtn.disabled = true; if (!currentImageBlobForViewer || !currentImageIdForViewer) { alert("Image data is not available for sharing."); if (shareBtn) shareBtn.disabled = false; return; } if (!navigator.share) { /* Should have been caught by button state, but double check */ alert("Web Share API not supported on this browser/device."); if (shareBtn) shareBtn.disabled = false; return; } const fileName = `fish_photo_${currentImageIdForViewer}.jpg`; const file = new File([currentImageBlobForViewer], fileName, { type: currentImageBlobForViewer.type }); let fishInfoText = 'Check out this fish caught using the Sea Catch Scorer app!'; // Find fish details for context
            try { for (let i=0; i<localStorage.length; i++){ const key=localStorage.key(i); if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ const data=JSON.parse(dS); const fish = (data.fishData || []).find(f => f.imageId === currentImageIdForViewer); if (fish) { fishInfoText = `Check out this ${fish.species || 'fish'} (${fish.length || '?'}cm) caught on ${formatDate(data.currentDate)} at ${data.currentVenue}! (via Sea Catch Scorer)`; break; } } } } } catch (e) { console.log("Couldn't find fish details for sharing text."); } const shareData = { files: [file], title: 'Sea Catch Photo', text: fishInfoText }; try { if (navigator.canShare && navigator.canShare(shareData)) { console.log("Attempting to share file:", fileName); await navigator.share(shareData); console.log("Image shared successfully via Web Share API."); } else { console.warn("Browser indicates it cannot share this data (file)."); alert("Your browser may not support sharing this file type."); } } catch (error) { console.error("Error during Web Share API call:", error); if (error.name !== 'AbortError') { alert(`Sharing failed: ${error.message}`); } else { console.log("Sharing cancelled by user."); } } finally { if (shareBtn) shareBtn.disabled = false; // Re-enable button
            } }


        // --- General Modal Hiding/Showing ---
        function hideModal(modalId) { try { const mE=document.getElementById(modalId); if(mE){const m=bootstrap.Modal.getInstance(mE); if(m){m.hide();} else { /* Fallback for safety */ mE.classList.remove('show'); mE.style.display='none'; const b=document.querySelector('.modal-backdrop.show'); if(b) b.remove(); document.body.classList.remove('modal-open'); document.body.style.overflow=''; document.body.style.paddingRight=''; }} } catch(e) { console.error(`Error hiding modal ${modalId}:`, e); } }
        function showModal(modalId) { try { const modalElement = document.getElementById(modalId); if(modalElement) { const instance = bootstrap.Modal.getOrCreateInstance(modalElement, {backdrop: 'static', keyboard: false}); instance.show(); } else { console.error(`Modal element #${modalId} not found!`); } } catch (e) { console.error(`Error showing modal ${modalId}:`, e); } }

        // --- Application Reset ---
        function resetApp() {
            console.log("Resetting application state and UI...");
            fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null;
            currentPage='splashScreen'; stopCameraStream(); deactivateAppMode();
            isDropdownPopulated = false; pendingFishData = null;
            try {
                // Reset Registration Form & Fields
                const regFormIds = ['anglerName', 'competitionDate', 'venueInput', 'zoneInput', 'pegInput'];
                regFormIds.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; el.classList.remove('is-invalid'); } });
                const isCompCheck = document.getElementById('isCompetition'); if(isCompCheck) isCompCheck.checked = false;
                setTodaysDate(); // Set date to today after clearing
                toggleCompetitionFields(false); // Ensure dependent fields are disabled/hidden

                // Reset Fishing Page Form & Fields
                const fishFormIds = ['speciesInput', 'customSpeciesInput', 'lengthInput', 'initialsInput'];
                fishFormIds.forEach(id => { const el = document.getElementById(id); if(el) { el.value = ''; el.classList.remove('is-invalid'); } });
                const customSpeciesInput = document.getElementById('customSpeciesInput'); if (customSpeciesInput) customSpeciesInput.style.display = 'none';
                const speciesInput = document.getElementById('speciesInput'); if (speciesInput) { speciesInput.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; isDropdownPopulated = false; } // Reset dropdown content, force repopulate


                // Clear Logs/Tables
                const fishLog = document.getElementById('fishLog'); if (fishLog) fishLog.innerHTML='';
                const tallyTable = document.getElementById('tallyTable'); if (tallyTable) tallyTable.innerHTML='';

                // Reset Verifier Modal Input State
                const vI = document.getElementById('verifierEndModalInput'); if(vI) { vI.value=''; vI.classList.remove('is-invalid'); }
                const vS = document.getElementById('verifierEndModalSection'); if(vS) vS.style.display='none';

                // Reset Tally Page Footer Values
                populateTallySummaryFields(); // Update summary spans with null/empty data
                populateTallyTable(); // Update tally table and footer values (will show '0')

                 console.log("Application reset complete.");
            } catch(e) { console.error("Error occurred during application reset:", e); alert("An error occurred while resetting the application state."); }
        }


        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM fully loaded. Initializing Sea Catch Scorer application...");
            try {
                 await initDb(); // Initialize IndexedDB first
                 console.log("IndexedDB initialization attempted.");

                 // Register Service Worker
                 if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js') // Use relative path, ensure sw.js is in the same folder or adjust path
                        .then(reg => console.log('Service Worker registered successfully. Scope: ', reg.scope))
                        .catch(err => console.error('Service Worker registration failed: ', err)); }); } else { console.log('Service workers are not supported in this browser.'); }

                 // History/Unload Listeners
                 window.addEventListener('popstate', handleBackButton); window.addEventListener('beforeunload', handleBeforeUnload); console.log("Navigation state listeners attached.");

                 // Cache Element References
                 const refs = {
                     continueBtn: document.getElementById('continueBtn'),
                     viewScorecardsBtn: document.getElementById('viewScorecardsBtn'),
                     startRecordingBtn: document.getElementById('startRecordingBtn'),
                     isCompetitionCheck: document.getElementById('isCompetition'),
                     speciesSelect: document.getElementById('speciesInput'),
                     addFishBtn: document.getElementById('addFishBtn'),
                     backFromFishingBtn: document.getElementById('backFromFishingBtn'),
                     endSessionBtn: document.getElementById('endSessionBtn'),
                     confirmEndBtn: document.getElementById('confirmEndBtn'),
                     cancelEndSessionBtn: document.getElementById('cancelEndSessionBtn'),
                     backFromTallyBtn: document.getElementById('backFromTallyBtn'),
                     restoreSessionBtn: document.getElementById('restoreSessionBtn'),
                     startNewSessionBtn: document.getElementById('startNewSessionBtn'),
                     anglerNameInput: document.getElementById('anglerName'),
                     competitionDateInput: document.getElementById('competitionDate'),
                     venueInput: document.getElementById('venueInput'),
                     zoneSelect: document.getElementById('zoneInput'),
                     pegSelect: document.getElementById('pegInput'),
                     initialsInput: document.getElementById('initialsInput'),
                     lengthInput: document.getElementById('lengthInput'),
                     mlsAgreeBtn: document.getElementById('mlsAgreeBtn'),
                     takePhotoButton: document.getElementById('takePhotoButton'),
                     cancelCameraButtonHeader: document.getElementById('cancelCameraButtonHeader'),
                     shareImageBtn: document.getElementById('shareImageBtn'),
                     confirmPhotoYesBtn: document.getElementById('confirmPhotoYesBtn'),
                     confirmPhotoNoBtn: document.getElementById('confirmPhotoNoBtn'),
                     notesTextarea: document.getElementById('notesTextarea'),
                 };
                 console.log("Element references cached.");

                 // Initialize Bootstrap Modals Safely
                 try {
                     const notesModalElement = document.getElementById('notesModal'); if (notesModalElement) { notesModalInstance = new bootstrap.Modal(notesModalElement); } else { console.warn("#notesModal not found!"); }
                     const cameraModalElement = document.getElementById('cameraModal'); if (cameraModalElement) { cameraModalInstance = new bootstrap.Modal(cameraModalElement); cameraModalElement.addEventListener('hidden.bs.modal', stopCameraStream); } else { console.warn("#cameraModal not found!"); }
                     const imageViewerModalElement = document.getElementById('imageViewerModal'); if (imageViewerModalElement) { imageViewerModalInstance = new bootstrap.Modal(imageViewerModalElement); } else { console.warn("#imageViewerModal not found!"); }
                     const confirmPhotoModalElement = document.getElementById('confirmPhotoModal'); if (confirmPhotoModalElement) { confirmPhotoModalInstance = new bootstrap.Modal(confirmPhotoModalElement); } else { console.warn("#confirmPhotoModal not found!"); }
                     // Ensure other modals that might be shown programmatically are instantiated if needed
                     // bootstrap.Modal.getOrCreateInstance(document.getElementById('restoreSessionModal'));
                     // bootstrap.Modal.getOrCreateInstance(document.getElementById('endSessionModal'));
                     // bootstrap.Modal.getOrCreateInstance(document.getElementById('mlsInfoModal'));
                     // bootstrap.Modal.getOrCreateInstance(document.getElementById('savedScorecardsModal'));
                     console.log("Bootstrap modal instances initialized.");
                 } catch (modalInitError) {
                     console.error("Error initializing one or more Bootstrap modals:", modalInitError);
                     // App can likely continue, but modals might not work programmatically.
                 }


                 // Add Event Listeners Safely
                 const addClickListener = (ref, handler) => { if (ref) ref.addEventListener('click', handler); else console.warn(`Listener not added: Element ref is null for handler ${handler.name}`); };
                 const addInputListener = (ref, handler) => { if (ref) ref.addEventListener('input', handler); else console.warn(`Listener not added: Element ref is null for handler ${handler.name}`); };
                 const addChangeListener = (ref, handler) => { if (ref) ref.addEventListener('change', handler); else console.warn(`Listener not added: Element ref is null for handler ${handler.name}`); };

                 addClickListener(refs.continueBtn, startApp);
                 addClickListener(refs.viewScorecardsBtn, showScorecardsModal);
                 addClickListener(refs.startRecordingBtn, startRecording);
                 addChangeListener(refs.isCompetitionCheck, () => { toggleCompetitionFields(); saveTempSession(); });
                 addChangeListener(refs.speciesSelect, toggleCustomSpeciesInput);
                 addClickListener(refs.addFishBtn, addFish);
                 addClickListener(refs.backFromFishingBtn, backFromFishing);
                 addClickListener(refs.endSessionBtn, showEndSessionModal);
                 addClickListener(refs.confirmEndBtn, confirmEndSession);
                 addClickListener(refs.backFromTallyBtn, backFromTally);
                 addClickListener(refs.startNewSessionBtn, () => { if (confirm("Starting a new session will discard the currently unsaved session data. Are you sure?")) { startNewSession(); } });
                 addClickListener(refs.restoreSessionBtn, restoreSession);

                 // Input Listeners for saving temp session (Debounce might be good later)
                 addInputListener(refs.anglerNameInput, () => { currentAngler = refs.anglerNameInput.value.trim(); saveTempSession(); });
                 addChangeListener(refs.competitionDateInput, () => { currentDate = refs.competitionDateInput.value; saveTempSession(); });
                 addInputListener(refs.venueInput, () => { currentVenue = refs.venueInput.value.trim(); saveTempSession(); });
                 addChangeListener(refs.zoneSelect, () => { currentZone = refs.isCompetitionCheck?.checked ? refs.zoneSelect.value : null; saveTempSession(); });
                 addChangeListener(refs.pegSelect, () => { currentPeg = refs.isCompetitionCheck?.checked ? refs.pegSelect.value : null; saveTempSession(); });

                 // Modal Button Listeners
                 // MLS Agree button now uses data-bs-dismiss in HTML
                 addClickListener(refs.takePhotoButton, takeSnapshot);
                 addClickListener(refs.cancelCameraButtonHeader, stopCameraStream); // Explicit stop on close icon click
                 // Share button listener added dynamically in showFullscreenImage
                 addClickListener(refs.confirmPhotoYesBtn, () => handleConfirmPhoto(true));
                 addClickListener(refs.confirmPhotoNoBtn, () => handleConfirmPhoto(false));
                 console.log("Core event listeners attached.");

                 // Initial Setup Calls
                 setTodaysDate();
                 checkRestoreSession(); // Check for existing session and show splash or restore modal

                 console.log("Sea Catch Scorer initialization sequence complete.");
            } catch (error) { console.error("FATAL ERROR during application initialization:", error); document.body.innerHTML = `<div class="alert alert-danger m-5" role="alert"><strong>Application Initialization Failed!</strong><br> ${error.message}<br>Please check the browser's developer console for more details, ensure necessary permissions (camera, storage) are granted, and try refreshing the page.</div>`; }
        });
    </script>

</body>
</html>
