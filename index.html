<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for PWA Address Bar -->
    <meta name="theme-color" content="#007bff">
    <!-- Add Basic Icons for "Add to Home Screen" / PWA -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- Add other icon sizes if you have them -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed;
            color: #fff; /* Default text color (mostly for splash) */
            min-height: 100vh;
        }
        .container { /* Wrapper for main content cards */
            background: rgba(0, 0, 0, 0.7); /* Dark, semi-transparent wrapper */
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            z-index: 1;
            display: none; /* Hide initially, show based on page */
        }
        .page { display: none; } /* Hide pages by default */

        /* --- Splash Screen --- */
        .splash-screen {
            display: flex; /* Initially shown via JS */
            flex-direction: column; justify-content: flex-end; align-items: center;
            padding: 40px; height: 100vh; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 2;
        }

        /* --- Main Content Card Style (Registration, Fishing, Tally) --- */
        .card-section {
            background: rgba(255, 255, 255, 0.92); /* Slightly more opaque white */
            border-radius: 15px; padding: 25px; margin: 20px 0; /* Increased padding */
            border: 1px solid #dee2e6; /* Lighter border */
            color: #212529; /* Dark text for content */
            z-index: 3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card-section h2 { color: #0056b3; } /* Dark blue headings */
        .card-section h5 { color: #0056b3; }

        /* --- Buttons --- */
        .btn { padding: 12px 24px; font-size: 1.1rem; border-radius: 25px; border: none; margin: 10px; transition: transform 0.2s, background-color 0.2s, border-color 0.2s; cursor: pointer; font-weight: 600; }
        .btn:disabled { cursor: not-allowed; opacity: 0.65; }
        .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; transform: scale(1.05); }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; transform: scale(1.05); }
        .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; transform: scale(1.05); }
        .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; transform: scale(1.05); }
        .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; transform: scale(1.05); color: black;}
        .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; } .btn-outline-secondary:hover { background-color: #6c757d; color: white; }
        .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; } .btn-outline-light:hover { background-color: #f8f9fa; color: #000; }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; border-radius: 20px; font-weight: normal; }
        .btn-lg { padding: 14px 28px; font-size: 1.25rem; }


        /* --- Forms --- */
        .form-label { font-weight: 600; color: #495057; }
        .form-control, .form-select { border-radius: 8px; margin-bottom: 15px; border: 1px solid #ced4da; }
        .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-label { color: #212529; }
        /* Style for Verifier Field in Modal */
        #verifierEndModalSection { display: none; } /* Hide by default */

        /* --- Tables --- */
        .card-section .table { background: white; border-radius: 8px; color: #212529; border: 1px solid #dee2e6; margin-top: 15px; }
        .card-section .table thead { background-color: #f8f9fa; }
        .card-section .table th, .card-section .table td { border-color: #dee2e6; vertical-align: middle; }
        .card-section .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(0, 0, 0, 0.03); }
        .card-section .table-bordered { border: 1px solid #dee2e6; }
        .card-section .table-hover tbody tr:hover > * { background-color: rgba(0, 0, 0, 0.06); }

        /* --- Unified Modal Style --- */
        .modal { z-index: 1050; } .modal-backdrop { z-index: 1040; opacity: 0.5; }
        .modal-content { background: #f8f9fa; color: #212529; border: 1px solid #dee2e6; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-header { background-color: #e9ecef; color: #212529; border-bottom: 1px solid #dee2e6; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .modal-footer { background-color: #e9ecef; border-top: 1px solid #dee2e6; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; display: flex; justify-content: flex-end; flex-wrap: wrap; }
        .modal-title { color: #0056b3; font-weight: 700; }
        .modal-header .btn-close { filter: none; background-size: 0.75em; }
        .modal-body { background-color: #ffffff; color: #212529; padding: 20px; }
        #restoreSessionModal .modal-body, #endSessionModal .modal-body { color: #212529 !important; }

        /* --- Saved Scorecards Modal --- */
        #savedScorecardsList.card-section { background: transparent; border: none; padding: 0; margin: 0; }
        #savedScorecardsModal .scorecard-entry { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 15px; background-color: #ffffff; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        #savedScorecardsModal .scorecard-item { cursor: pointer; padding: 12px 15px; border-bottom: 1px solid #dee2e6; color: #212529; transition: background-color 0.2s; }
        #savedScorecardsModal .scorecard-item:hover { background-color: #f8f9fa; }
        #savedScorecardsModal .scorecard-entry .scorecard-item.details-visible { border-bottom: 1px solid #dee2e6; }
        #savedScorecardsModal .scorecard-item i.bi { transition: transform 0.2s ease-in-out; color: #6c757d; }
        #savedScorecardsModal .scorecard-item i.bi-chevron-down { transform: rotate(90deg); }
        #savedScorecardsModal .scorecard-item .text-muted { color: #6c757d !important; }
        #savedScorecardsModal .scorecard-details { display: none; padding: 15px; background-color: #ffffff; border-top: none; margin-top: 0; border-radius: 0 0 8px 8px; color: #212529; }
        #savedScorecardsModal .scorecard-details h6 { font-weight: 700; margin-top: 10px; margin-bottom: 8px; color: #0056b3; border-bottom: 1px solid #e9ecef; padding-bottom: 4px; }
        #savedScorecardsModal .scorecard-details h6:first-of-type { margin-top: 0; }
        #savedScorecardsModal .scorecard-details p { margin-bottom: 8px; color: #212529; }
        #savedScorecardsModal .scorecard-details hr { margin-top: 15px; margin-bottom: 15px; border-top: 1px solid #dee2e6; background-color: transparent; height: 1px; opacity: 1; }
        #savedScorecardsModal .scorecard-details .table { margin-bottom: 15px; background-color: #ffffff; color: #212529; border: 1px solid #dee2e6; }
        #savedScorecardsModal .scorecard-details .table thead { background-color: #f8f9fa; color: #495057; }
        #savedScorecardsModal .scorecard-details .table th, #savedScorecardsModal .scorecard-details .table td { border-color: #dee2e6; border-bottom-width: 1px; vertical-align: middle;}
        #savedScorecardsModal .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(0, 0, 0, 0.03); }
        #savedScorecardsModal .scorecard-details .btn-actions-group { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;}
        #savedScorecardsModal .scorecard-details .btn { margin-top: 5px; margin-right: 5px; }
        #savedScorecardsModal .scorecard-details .btn-danger { color: white !important; }
        #savedScorecardsModal .scorecard-details .btn-info { color: black !important; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry { border: 2px solid #007bff; box-shadow: 0 0 8px rgba(0, 123, 255, 0.3); }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item { border-bottom: 1px solid rgba(0, 123, 255, 0.3); background-color: #e7f1ff; }
        #savedScorecardsModal .latest-scorecard.scorecard-entry .scorecard-item .badge { background-color: #007bff !important; color: white !important; font-weight: 600; }
        #olderScorecardsToggleContainer { padding-top: 10px; text-align: center;}
        #olderScorecardsToggleContainer .btn { margin: 5px; } /* Add spacing between View Older and Delete Older */


        /* --- Notes Modal --- */
        #notesModal .modal-body textarea { resize: vertical; min-height: 100px; }

        #tallyPage.card-section .table { margin-top: 20px; }
        #tallyPage.card-section .catch-summary-details { margin-bottom: 20px; color: #495057; }
        #tallyPage.card-section tfoot td, #tallyPage.card-section tfoot strong { color: #212529; }
        .table-responsive { margin-bottom: 1rem; }

        /* --- Camera Styles --- */
        #cameraPreview { display: block; max-width: 100%; height: auto; margin-bottom: 10px; border-radius: 8px; }
        #captureCanvas { display: none; } /* Hidden canvas for capturing image frame */

    </style>
</head>
<body>
    <!-- Container only needed for card sections, not splash -->
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>
            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>
            <div class="mb-3">
                 <label for="zoneInput" class="form-label">Zone</label>
                 <select id="zoneInput" class="form-select" disabled>
                    <option value="" selected>Select a zone</option>
                    <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option>
                    <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="pegInput" class="form-label">Peg</label>
                <select id="pegInput" class="form-select" disabled>
                    <option value="" selected>Select a peg</option>
                    <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option>
                    <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option>
                    <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option>
                    <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option>
                    <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option>
                 </select>
            </div>
            <div class="text-center">
                <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button>
            </div>
        </div>

        <!-- Fishing Page -->
        <div id="fishingPage" class="card-section page">
            <h2>Record Your Catch</h2>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="speciesInput" class="form-label">Species</label>
                    <select id="speciesInput" class="form-select">
                         <option value="" selected disabled>Select a species</option>
                         <option value="Other">Other (specify)</option>
                    </select>
                    <input type="text" id="customSpeciesInput" class="form-control mt-2" placeholder="Enter custom species" style="display: none;">
                </div>
                <div class="col-md-4 mb-3">
                     <label for="lengthInput" class="form-label">Length (cm)</label>
                     <input type="number" id="lengthInput" class="form-control" placeholder="Enter length" step="1" min="1">
                </div>
                <div id="initialsInputGroup" class="col-md-4 mb-3" style="display: none;">  <!-- HIDDEN INITIALLY -->
                     <label for="initialsInput" class="form-label">Verifier Initials</label>
                     <input type="text" id="initialsInput" class="form-control" placeholder="Enter Initials (e.g., AB)" maxlength="3" style="text-transform:uppercase">
                </div>
            </div>

            <!-- Camera Preview and Capture Button -->
            <video id="cameraPreview" autoplay playsinline style="display:none; width: 100%; max-width: 400px; border-radius: 8px; margin-bottom: 10px;"></video>
            <canvas id="captureCanvas" style="display:none;"></canvas>
            <div class="text-center mb-3" id="photoCaptureControls" style="display:none;">
                <button class="btn btn-info mb-2" id="capturePhotoButton"><i class="bi bi-camera me-1"></i> Take Photo</button>
                <br> <button class="btn btn-outline-secondary btn-sm" id="retakePhotoButton">Retake</button>  <button class="btn btn-success btn-sm" id="usePhotoButton">Use Photo</button>  <button class="btn btn-danger btn-sm" id="cancelPhotoButton">Cancel</button>
            </div>
            <div id="photoPlaceholder" class="text-center mb-3" >
                <button class="btn btn-outline-secondary" id="addPhotoButton"><i class="bi bi-image me-1"></i> Add Photo</button>
            </div>
            <div id="fishPhotoPreviewArea" class="text-center mb-3" style="display:none;">
                <img id="fishPhotoPreview" src="#" alt="Fish Photo" style="max-width: 200px; border-radius: 8px; margin-bottom: 10px;">
                <button class="btn btn-sm btn-danger" id="removePhotoButton"><i class="bi bi-trash me-1"></i> Remove Photo</button>
            </div>


            <div class="text-center mb-3">
                <button class="btn btn-primary" id="addFishBtn"><i class="bi bi-plus-circle me-1"></i> Add Fish</button>
                <button class="btn btn-secondary" id="backFromFishingBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button>
            </div>

            <h2 class="mt-4">Fish Log</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead> <tr> <th>Species</th> <th>Length (cm)</th> <th id="verifiedByHeader" style="display:none;">Verified By</th> <th>Photo</th> <th class="text-end">Action</th> </tr> </thead>
                    <tbody id="fishLog"></tbody>
                </table>
            </div>


            <div class="text-center mt-3">
                <button class="btn btn-success" id="endSessionBtn"><i class="bi bi-check-circle me-1"></i> End & Save Session</button>
            </div>
        </div>

         <!-- Tally Page -->
         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details">
                 <strong>Angler:</strong> <span id="summaryAngler"></span><br>
                 <strong>Date:</strong> <span id="summaryDate"></span><br>
                 <strong>Venue:</strong> <span id="summaryVenue"></span><br>
                 <strong>Zone:</strong> <span id="summaryZone"></span><br>
                 <strong>Peg:</strong> <span id="summaryPeg"></span><br>
                 <span id="summaryVerifier"></span>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr> <th>Species</th> <th>Total Caught</th> <th>Lengths (cm)</th> <th>Total Length (cm)</th> </tr>
                    </thead>
                    <tbody id="tallyTable"></tbody>
                    <tfoot>
                        <tr> <td colspan="3" class="text-end"><strong>Total Length</strong></td> <td><strong id="tallyTotalLength">0 cm</strong></td> </tr>
                        <tr> <td colspan="3" class="text-end"><strong>Species Count</strong></td> <td><strong id="tallySpeciesCount">0</strong></td> </tr>
                        <tr> <td colspan="2" class="text-end"><strong>Longest Fish</strong></td> <td><strong id="longestFishSpecies">N/A</strong></td> <td><strong id="longestFishLength">0 cm</strong></td> </tr>
                    </tfoot>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-secondary mb-3" id="backFromTallyBtn"><i class="bi bi-arrow-left-circle me-1"></i> Back</button>
            </div>
        </div>
    </div> <!-- End of .container -->

    <!-- Splash Screen (Outside .container) -->
    <div id="splashScreen" class="splash-screen page">
        <div class="text-center">
             <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button>
             <br>
             <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Restore Session Modal -->
    <div class="modal fade" id="restoreSessionModal" tabindex="-1" aria-labelledby="restoreSessionModalLabel" aria-hidden="true">
         <div class="modal-dialog">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="restoreSessionModalLabel">Restore Previous Session?</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                 <div class="modal-body">
                     An unsaved session was found. Would you like to restore it?
                     <p class="mt-3"><strong>Angler:</strong> <span id="restoreAngler"></span></p>
                     <p><strong>Date:</strong> <span id="restoreDate"></span></p>
                     <p><strong>Fish Caught:</strong> <span id="restoreFishCount"></span></p>
                 </div>

                 <div class="modal-footer d-block text-center">
                     <button type="button" class="btn btn-success btn-lg mb-2" id="restoreSessionBtn">Restore Session</button>
                     <br>
                     <button type="button" class="btn btn-danger" id="startNewSessionBtn">Start New Session</button>
                 </div>
             </div>
         </div>
     </div>

    <!-- Saved Scorecards Modal -->
    <div class="modal fade" id="savedScorecardsModal" tabindex="-1" aria-labelledby="savedScorecardsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="savedScorecardsModalLabel">Saved Scorecards</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                <div class="modal-body">
                    <div id="savedScorecardsList" class="card-section">
                       <p class="placeholder-glow"><span class="placeholder col-12"></span></p> <!-- Placeholder while loading -->
                    </div>
                    <!-- DIV TO HOLD THE "VIEW OLDER" / "DELETE OLDER" BUTTONS -->
                    <div id="olderScorecardsToggleContainer" class="text-center mt-3"></div>
                </div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- End Session Confirmation Modal -->
    <div class="modal fade" id="endSessionModal" tabindex="-1" aria-labelledby="endSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="endSessionModalLabel">Confirm End Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to end your session? This will save the scorecard.</p>

                    <div id="verifierEndModalSection" class="mt-3" style="display: none;">
                        <hr>
                        <label for="verifierEndModalInput" class="form-label"><strong>Competition Verifier</strong> <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="verifierEndModalInput" placeholder="Enter name of verifier" required>
                        <small class="text-muted">Required for competition scorecards.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelEndSessionBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmEndBtn">Confirm & Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notesModalLabel">Session Notes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="notesModalScorecardKey">
            <div class="mb-3">
              <label for="notesTextarea" class="form-label">Enter your notes below:</label>
              <textarea class="form-control" id="notesTextarea" rows="5"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveNoteFromModal()">Save Notes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MLS Information Modal -->
    <div class="modal fade" id="mlsInfoModal" tabindex="-1" aria-labelledby="mlsInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mlsInfoModalLabel">Important MLS Information</h5>
                    <!-- No close button in header -->
                </div>
                <div class="modal-body">
                    <p>Please ensure you are recording your catches in accordance with the minimum landing sizes (MLS) and any other fishing regulations that apply to your specific location or event.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="mlsAgreeBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Application JS -->
    <script>
        // --- Global Variables ---
        const fishCategories = {
            "Flatfish": [ "Brill", "Dab", "Flounder", "Halibut", "Megrim", "Plaice", "Sole (Dover)", "Sole (Lemon)", "Turbot" ],
            "Round Fish": [ "Bass", "Bream (Black)", "Bream (Gilthead)", "Bream (Red)", "Bream (Sea)", "Bull Huss", "Coalfish", "Cod", "Conger Eel", "Dogfish", "Dogfish (Black Mouth)", "Gurnard (Red)", "Gurnard (Tub)", "Haddock", "Hake", "John Dory", "Ling", "Mackerel", "Monkfish", "Mullet (Grey)", "Mullet (Red)", "Pollack", "Poor Cod", "Pouting", "Saithe", "Triggerfish", "Whiting" ],
            "Rays and Skates": [ "Ray (Blonde)", "Ray (Small-eyed)", "Ray (Starry)", "Ray (Thornback)", "Skate" ],
            "Sharks": [ "Shark (Blue)", "Shark (Porbeagle)", "Shark (Thresher)", "Smoothhound", "Smoothhound (Starry)", "Spurdog", "Tope" ],
            "Wrasse": [ "Wrasse (Ballan)", "Wrasse (Cuckoo)" ]
        };
        let fishData = [];
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentPage = 'splashScreen';
        let isAppActive = false;
        let historyHijacked = false;
        let notesModalInstance = null;
        let cameraStream = null; // Track camera stream
        let currentFishPhoto = null; // Store DataURL of current fish photo

        // --- Utility Functions ---
        function formatDate(dateString) { if (!dateString) return 'N/A'; try { const d = new Date(dateString + 'T00:00:00Z'); return isNaN(d.getTime()) ? dateString : d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' }); } catch (e) { console.error("Date format err:", e); return dateString; } }
        function showPage(pageId) { console.log("Show page:", pageId); document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); const target = document.getElementById(pageId); if (target) { target.style.display = pageId === 'splashScreen' ? 'flex' : 'block'; currentPage = pageId; const container = document.querySelector('.container'); if(container) container.style.display = (pageId === 'splashScreen') ? 'none' : 'block'; if(pageId !== 'splashScreen' && !isAppActive) { activateAppMode(); } else if (pageId === 'splashScreen' && isAppActive) { deactivateAppMode(); } if (pageId !== 'splashScreen') { saveTempSession(); } } else { console.error("Page missing:", pageId, ". Defaulting splash."); const splash = document.getElementById('splashScreen'), container = document.querySelector('.container'); if(splash) splash.style.display = 'flex'; if(container) container.style.display = 'none'; currentPage = 'splashScreen'; deactivateAppMode(); } }

        // --- History/Navigation Control ---
        function activateAppMode() { if (!isAppActive) { console.log("Activating App Mode"); isAppActive = true; if (!historyHijacked) { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history state."); } } }
        function deactivateAppMode() { if (isAppActive) { console.log("Deactivating App Mode."); isAppActive = false; historyHijacked = false; } }
        function handleBackButton(event) { if (isAppActive) { console.log("popstate intercepted."); history.pushState({ appActive: true }, '', location.href); } else { console.log("popstate allowed."); } }
        function handleBeforeUnload(event) { if (isAppActive) { console.log("beforeunload prompt."); event.preventDefault(); event.returnValue = ''; return ''; } else { console.log("beforeunload allowed."); } }

        // --- Session Management ---
        function saveTempSession() { if (!currentAngler && !currentDate && !currentVenue && fishData.length === 0 && currentPage === 'registrationPage') return; const temp = { fishData: fishData||[], currentAngler, currentDate, currentVenue, currentZone, currentPeg, currentPage, isAppActive, historyHijacked, isCompetition: !!(currentZone && currentPeg) }; try { localStorage.setItem('temp_session', JSON.stringify(temp)); } catch (e) { console.error("Save temp err:", e); } }
        function clearTempSession() { try { localStorage.removeItem('temp_session'); console.log("Temp cleared."); } catch (e) { console.error("Clear temp err:", e); } }
        function checkRestoreSession() {
            console.log("Checking for restore session...");
            let data;
            try {
                const temp = localStorage.getItem('temp_session');
                if (!temp) {
                    console.log("No temp session found.");
                    showPage('splashScreen'); // Show splash if no temp session
                    return;
                }
                data = JSON.parse(temp);
                if (!data || !Array.isArray(data.fishData)) throw new Error("Invalid temp session format.");
            } catch (e) {
                console.error("Read temp session err:", e);
                clearTempSession();
                showPage('splashScreen');
                return;
            }
            if (data.currentAngler || data.currentDate || data.currentVenue || data.fishData.length > 0) {
                console.log("Found unsaved session, showing restore modal.");
                try {
                    document.getElementById('restoreAngler').textContent = data.currentAngler || 'N/A';
                    document.getElementById('restoreDate').textContent = data.currentDate ? formatDate(data.currentDate) : 'N/A';
                    document.getElementById('restoreFishCount').textContent = data.fishData.length;
                    const modalEl = document.getElementById('restoreSessionModal');
                    if (modalEl) {
                        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
                        modalInstance.show();
                    } else {
                        console.error("Restore modal element not found!");
                        clearTempSession();
                        showPage('splashScreen');
                    }
                } catch (uiError) {
                    console.error("Error updating restore modal UI:", uiError);
                    clearTempSession();
                    showPage('splashScreen');
                }
            } else {
                console.log("Temp session found but was empty, clearing.");
                clearTempSession();
                showPage('splashScreen'); // Show splash if temp session was empty
            }
        }
        function restoreSession() {
            console.log("Restore Session button clicked.");
            let temp;
            try {
                const sS = localStorage.getItem('temp_session');
                if (!sS) throw new Error("No temp session data found for restore.");
                temp = JSON.parse(sS);
                if (!temp || !Array.isArray(temp.fishData)) throw new Error("Invalid temp session format during restore.");
            } catch (e) {
                console.error("Restore err:", e);
                alert("Failed to restore session data. Starting new session.");
                startNewSessionConfirmed();
                return;
            }

            fishData = temp.fishData || [];
            currentAngler = temp.currentAngler || null;
            currentDate = temp.currentDate || null;
            currentVenue = temp.currentVenue || null;
            currentZone = temp.currentZone || null;
            currentPeg = temp.currentPeg || null;
            const page = temp.currentPage || 'registrationPage';
            isAppActive = temp.isAppActive || false;
            historyHijacked = temp.historyHijacked || false;
            const restoredIsCompetition = temp.isCompetition === true;

            console.log("Restoring data:", { currentAngler, currentDate, currentVenue, currentZone, currentPeg, page, isAppActive, restoredIsCompetition });

            try {
                const anglerNameEl = document.getElementById('anglerName');
                const competitionDateEl = document.getElementById('competitionDate');
                const venueInputEl = document.getElementById('venueInput');
                const isCompetitionEl = document.getElementById('isCompetition');
                const zoneInputEl = document.getElementById('zoneInput');
                const pegInputEl = document.getElementById('pegInput');

                if (anglerNameEl) anglerNameEl.value = currentAngler || '';
                if (competitionDateEl) competitionDateEl.value = currentDate || '';
                if (venueInputEl) venueInputEl.value = currentVenue || '';
                if (isCompetitionEl) isCompetitionEl.checked = restoredIsCompetition;

                toggleCompetitionFields(); // Update fields based on restored competition status BEFORE setting values

                if (zoneInputEl) zoneInputEl.value = currentZone || '';
                if (pegInputEl) pegInputEl.value = currentPeg || '';

            } catch (e) {
                console.error("Error restoring registration fields:", e);
            }

            // Repopulate UI elements based on restored page
            populateSpeciesDropdown(); // Always populate dropdown
            if (page === 'fishingPage') {
                updateFishLog();
            } else if (page === 'tallyPage') {
                populateTallySummaryFields();
                populateTallyTable();
            }

            hideModal('restoreSessionModal');
            showPage(page);

            if (isAppActive && !historyHijacked) {
                history.pushState({ appActive: true }, '', location.href);
                historyHijacked = true;
                console.log("Pushed history state after restore.");
            }
            console.log("Session restored successfully to page:", page);
        }
        function startNewSessionConfirmed() {
            console.log("Starting new session confirmed.");
            clearTempSession();
            resetApp();
            hideModal('restoreSessionModal');
            showPage('splashScreen');
        }


        // --- UI Interaction ---
        function populateSpeciesDropdown() { try { const input=document.getElementById('speciesInput'); if(!input) {console.error("Species dropdown missing!"); return;} const cats=Object.keys(fishCategories).sort(); input.innerHTML='<option value="" selected disabled>Select species</option><option value="Other">Other</option>'; cats.forEach(cat=>{const group=document.createElement('optgroup'); group.label=cat; const species=[...fishCategories[cat]].sort(); species.forEach(s=>{const opt=document.createElement('option'); opt.value=s; opt.textContent=s; group.appendChild(opt);}); input.appendChild(group);}); console.log("Species dropdown populated."); } catch (e) { console.error("Error populating species:", e); } }
        function toggleCustomSpeciesInput() { try { const sel=document.getElementById('speciesInput'), custom=document.getElementById('customSpeciesInput'); if(!sel||!custom)return; custom.style.display=sel.value==='Other'?'block':'none'; if(sel.value!=='Other')custom.value=''; } catch (e) { console.error("Error toggling custom species:", e); } }
        function toggleCompetitionFields() {
            try {
                const check = document.getElementById('isCompetition')?.checked || false;
                const zone = document.getElementById('zoneInput');
                const peg = document.getElementById('pegInput');
                const initialsGroup = document.getElementById('initialsInputGroup');
                const initialsInput = document.getElementById('initialsInput');
                const verifiedByHeader = document.getElementById('verifiedByHeader');

                if (zone) zone.disabled = !check;
                if (peg) peg.disabled = !check;
                if (initialsGroup) initialsGroup.style.display = check ? 'block' : 'none';
                if (verifiedByHeader) verifiedByHeader.style.display = check ? 'table-cell' : 'none';

                if (!check) {
                    if (zone) zone.value = '';
                    if (peg) peg.value = '';
                    currentZone = null; currentPeg = null;
                    if (initialsInput) initialsInput.value = '';
                }
                // Re-render fish log if it exists to show/hide "Verified By" column
                if (document.getElementById('fishLog')) updateFishLog();
            } catch (e) { console.error("Toggle comp fields err:", e); }
        }

        function startApp() { try { console.log("Start Fishing button clicked."); populateSpeciesDropdown(); showPage('registrationPage'); } catch (e) { console.error("Error in startApp:", e); } }
        function startRecording() {
            try {
                console.log("Record Catch button clicked.");
                const nameEl = document.getElementById('anglerName'), dateEl = document.getElementById('competitionDate'), venueEl = document.getElementById('venueInput'), checkEl = document.getElementById('isCompetition'), zoneEl = document.getElementById('zoneInput'), pegEl = document.getElementById('pegInput');
                if (!nameEl || !dateEl || !venueEl || !checkEl || !zoneEl || !pegEl) { alert("Required form elements are missing."); return; }
                const name = nameEl.value.trim(), date = dateEl.value, venue = venueEl.value.trim(), isComp = checkEl.checked, zone = zoneEl.value, peg = pegEl.value;
                if (!name || !date || !venue) { alert("Angler Name, Date, and Venue are required."); return; }
                if (isComp && (!zone || !peg)) { alert("Zone & Peg are required for competition entries."); return; }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { alert("Please enter a valid date in YYYY-MM-DD format."); return; }
                currentAngler = name; currentDate = date; currentVenue = venue; currentZone = isComp ? zone : null; currentPeg = isComp ? peg : null;
                const isActuallyCompetition = !!(currentZone && currentPeg);
                console.log("Start recording data:", { currentAngler, currentDate, currentVenue, currentZone, currentPeg, isCompetition: isActuallyCompetition });
                saveTempSession();
                updateFishLog(); // Update log before showing page
                showPage('fishingPage');

                if (isActuallyCompetition) {
                    console.log("Showing MLS modal for competition.");
                    showModal('mlsInfoModal');
                }
            } catch (e) { console.error("Error in startRecording:", e); alert("An error occurred starting the recording."); }
        }
        function addFish() {
            try {
                console.log("Add Fish button clicked.");
                const spEl = document.getElementById('speciesInput');
                const custEl = document.getElementById('customSpeciesInput');
                const lenEl = document.getElementById('lengthInput');
                const initialsEl = document.getElementById('initialsInput');
                const isCompetition = document.getElementById('isCompetition')?.checked;

                if (!spEl || !custEl || !lenEl) { alert("Form elements for adding fish are missing."); return; }
                let species = spEl.value;
                const lenVal = lenEl.value.trim();
                let length;
                let initials = null;

                if (!lenVal) { alert("Length is required."); return; }
                length = Math.round(parseFloat(lenVal));
                if (isNaN(length) || length <= 0 || length > 500) { alert("Please enter a valid length between 1 and 500 cm."); return; }
                if (species === 'Other') { species = custEl.value.trim(); if (!species) { alert("Please specify the species name when 'Other' is selected."); return; } if (!/^[a-zA-Z\s'-]+$/.test(species)) { alert("Species name contains invalid characters."); return; } } else if (!species) { alert("Please select a species."); return; }

                if (isCompetition && initialsEl) {
                    initials = initialsEl.value.trim().toUpperCase();
                }

                fishData.push({ species, length, initials: initials || null, photo: currentFishPhoto });
                console.log("Added fish:", { species, length, initials, photo: !!currentFishPhoto });
                updateFishLog();
                spEl.value = ''; custEl.value = ''; lenEl.value = ''; if (initialsEl) initialsEl.value = '';
                toggleCustomSpeciesInput();
                saveTempSession();
                clearFishPhoto(); // Clear the temporary photo variable
                clearFishPhotoPreview(); // Reset the photo UI
            } catch (e) { console.error("Error in addFish:", e); alert("An error occurred adding the fish."); }
        }


        function updateFishLog() {
            try {
                const log = document.getElementById('fishLog');
                const isCompetition = document.getElementById('isCompetition')?.checked;
                const verifiedByHeader = document.getElementById('verifiedByHeader');

                if (!log) return;
                if (verifiedByHeader) verifiedByHeader.style.display = isCompetition ? 'table-cell' : 'none';

                log.innerHTML = fishData.map((f, i) => {
                    let verifiedByCell = '';
                    if (isCompetition) {
                        verifiedByCell = `<td>${f.initials || '-'}</td>`;
                    }
                    const photoCell = f.photo ? '<td><i class="bi bi-image-fill text-success"></i></td>' : '<td></td>';
                    // Escape single quotes in species for the delete confirmation message
                    const safeSpecies = (f.species || '?').replace(/'/g, "\\'");
                    return `<tr><td>${f.species || '?'}</td><td>${f.length || '?'}</td>${verifiedByCell}${photoCell}<td class="text-end"><button class="btn btn-danger btn-sm" onclick="deleteFish(${i}, '${safeSpecies}')"><i class="bi bi-trash"></i></button></td></tr>`;
                }).join('');
            } catch (e) { console.error("Error updating fish log:", e); }
        }


        function deleteFish(idx, speciesName) { // Added speciesName for better confirm message
            try {
                if (idx >= 0 && idx < fishData.length) {
                    const fishToDelete = fishData[idx];
                    const isCompetition = document.getElementById('isCompetition')?.checked;
                    let confirmMessage = `Delete ${speciesName || '?'} (${fishToDelete.length || '?'}cm)?`;
                    if (isCompetition && fishToDelete.initials) {
                        confirmMessage = `Delete ${speciesName || '?'} (${fishToDelete.length || '?'}cm) verified by ${fishToDelete.initials}?`;
                    }
                    if (confirm(confirmMessage)) {
                        console.log("Deleting fish at index:", idx);
                        fishData.splice(idx, 1);
                        updateFishLog();
                        saveTempSession();
                    }
                } else { console.error("Invalid delete index:", idx); }
            } catch (e) { console.error("Error deleting fish:", e); }
        }
        function backFromFishing() {
            try {
                console.log("Back from Fishing button clicked.");
                stopCameraStream();
                clearFishPhotoPreview();
                showPage('registrationPage');
            } catch (e) { console.error("Error going back from fishing:", e); }
         }

        // --- End Session Modal Functions ---
        function showEndSessionModal() {
            try {
                console.log("End Session button clicked, showing confirmation modal.");
                const modalEl = document.getElementById('endSessionModal');
                const verifierSection = document.getElementById('verifierEndModalSection');
                const verifierInput = document.getElementById('verifierEndModalInput');

                if (!modalEl || !verifierSection || !verifierInput) {
                    console.error("End session modal or its verifier elements missing!");
                    alert("Error preparing end session dialog.");
                    return;
                }
                const isCompetition = !!(currentZone && currentPeg);
                if (isCompetition) {
                    console.log("Setting up modal for Competition save.");
                    verifierSection.style.display = 'block';
                    verifierInput.value = '';
                } else {
                    console.log("Setting up modal for Non-Competition save.");
                    verifierSection.style.display = 'none';
                    verifierInput.value = '';
                }
                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
                modalInstance.show();
            } catch (e) { console.error("Error showing end session modal:", e); }
        }

        function confirmEndSession() {
             console.log("Confirm End & Save button clicked.");
            try {
                if (!currentAngler || !currentDate || !currentVenue) {
                    alert("Cannot save session: Missing Angler Name, Date, or Venue information.");
                    hideModal('endSessionModal');
                    showPage('registrationPage');
                    return;
                }
                const isCompetition = !!(currentZone && currentPeg);
                let verifierName = null;
                if (isCompetition) {
                    const verifierInput = document.getElementById('verifierEndModalInput');
                    if (!verifierInput) {
                        console.error("Verifier input missing inside modal during save!");
                        alert("Error: Verifier field is missing. Cannot save competition scorecard.");
                        return;
                    }
                    verifierName = verifierInput.value.trim();
                    if (!verifierName) {
                        alert("Competition Scorecard: Please enter the verifier's name in the modal.");
                        verifierInput.focus();
                        return;
                    }
                }
                hideModal('endSessionModal');
                console.log("Validation passed. Preparing to save data...");
                const sessionData = {
                    currentAngler, currentDate, currentVenue, currentZone, currentPeg,
                    verifier: verifierName,
                    notes: null, // Notes are saved separately
                    fishData: fishData || [],
                    isCompetition: isCompetition
                };
                const id = `scorecard_${Date.now()}`;

                localStorage.setItem(id, JSON.stringify(sessionData));
                console.log("Saved scorecard:", id);
                alert("Scorecard saved successfully!");
                clearTempSession();
                resetApp();
                showPage('splashScreen');

            } catch (e) {
                console.error("Save scorecard error:", e);
                if (e.name === 'QuotaExceededError' || (e.message && e.message.toLowerCase().includes('storage') && e.message.toLowerCase().includes('exceeded'))) {
                    alert("Save failed: Storage limit exceeded. Photos can take up significant space. Consider deleting older scorecards or taking fewer photos.");
                } else {
                    alert(`Save failed. An unexpected error occurred. Error: ${e.message}`);
                }
                // Attempt to keep the user on the fishing page if save fails
                if (currentPage !== 'fishingPage') {
                     showPage('fishingPage');
                }
            }
        }


        // --- Tally Page Functions ---
        function populateTallySummaryFields() { try { const ids = ['summaryAngler', 'summaryDate', 'summaryVenue', 'summaryZone', 'summaryPeg', 'summaryVerifier']; ids.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = ''; }); document.getElementById('summaryAngler').textContent=currentAngler||'?'; document.getElementById('summaryDate').textContent=currentDate?formatDate(currentDate):'?'; document.getElementById('summaryVenue').textContent=currentVenue||'?'; document.getElementById('summaryZone').textContent=currentZone||'?'; document.getElementById('summaryPeg').textContent=currentPeg||'?'; } catch (e) { console.error("Error populating tally summary:", e); } }
        function populateTallyTable() { try { const table=document.getElementById('tallyTable'); if (!table)return; const sum={}; let tL=0, lF=null; fishData.forEach(f=>{const sK=f.species||"?";const l=f.length||0; sum[sK]=sum[sK]||{c:0,tL:0,l:[]}; sum[sK].c++;sum[sK].tL+=l;sum[sK].l.push(l); tL+=l; if(!lF||l>(lF.length||0))lF=f;}); Object.values(sum).forEach(d=>d.l.sort((a,b)=>a-b)); const sorted=Object.entries(sum).sort(([a],[b])=>a.localeCompare(b)); table.innerHTML=sorted.map(([s,d])=>`<tr><td>${s}</td><td>${d.c}</td><td>(${d.l.join(', ')})</td><td>${d.tL}</td></tr>`).join('')||'<tr><td colspan="4" class="text-center">No fish recorded.</td></tr>'; document.getElementById('tallyTotalLength').textContent=`${tL} cm`; document.getElementById('tallySpeciesCount').textContent=Object.keys(sum).length; document.getElementById('longestFishSpecies').textContent=lF?(lF.species||'?'):'N/A'; document.getElementById('longestFishLength').textContent=lF?`${lF.length||'?'} cm`:'0 cm'; } catch (e) { console.error("Error populating tally table:", e); } }
        function backFromTally() { try { console.log("Back from Tally button clicked."); showPage('fishingPage'); } catch (e) { console.error("Error going back from tally:", e); } }

        // --- Saved Scorecards ---
        function showScorecardsModal() { try { console.log("View Scorecards button clicked."); const modalEl=document.getElementById('savedScorecardsModal'), listEl=document.getElementById('savedScorecardsList'); if(modalEl&&listEl){listEl.innerHTML='<div class="text-center p-3"><div class="spinner-border text-primary"><span class="visually-hidden">Loading...</span></div></div>'; const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl); modalInstance.show();setTimeout(loadScorecards,50);}else{console.error("Scorecard modal/list missing.");alert("Error showing scorecards.");} } catch (e) { console.error("Error showing scorecards modal:", e); } }
        function loadScorecards() {
            try {
                console.log("Loading scorecards...");
                const savedScorecardsList = document.getElementById('savedScorecardsList');
                const olderScorecardsToggleContainer = document.getElementById('olderScorecardsToggleContainer');
                if (!savedScorecardsList || !olderScorecardsToggleContainer) { console.error("CRITICAL: Scorecard list or toggle container element not found!"); return; }

                savedScorecardsList.innerHTML = ''; olderScorecardsToggleContainer.innerHTML = '';
                const scorecards = [];

                for (let i=0; i<localStorage.length; i++){ const key=localStorage.key(i); if (key?.startsWith('scorecard_')){ const dS=localStorage.getItem(key); if(dS){ try { const data=JSON.parse(dS); if(data?.currentAngler && data.currentDate && data.currentVenue){ const tS=parseInt(key.split('_')[1],10); if(!isNaN(tS)){scorecards.push({key,data,timestamp:tS});}} else {console.warn("Skipping invalid scorecard data:",key);}} catch(e){console.error("Error parsing scorecard data:",key,e);}}}}

                scorecards.sort((a,b)=>b.timestamp-a.timestamp);
                if (scorecards.length===0){ savedScorecardsList.innerHTML='<p class="text-center p-3">No saved scorecards found.</p>'; return; }
                console.log(`Total scorecards found: ${scorecards.length}`);

                const displayLimit = 4;
                const createScorecardElement = (key, data, isLatest) => {
                    // ... (createScorecardElement function remains the same as the previous correct version)
                     try {
                         const w = document.createElement('div');
                         w.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`;
                         let tL = 0, fC = 0, sp = new Set(), lF = null;
                         const fish = data.fishData || [];
                         fish.forEach(f => { const l = f.length || 0; fC++; tL += l; if (f.species) sp.add(f.species); if (!lF || l > (lF.length || 0)) lF = f; });
                         const spC = sp.size;
                         const lFS = lF ? `${lF.species || '?'}(${lF.length || '?'}cm)` : 'N/A';
                         const eK = key.replace(/'/g, "\\'"); // Escape single quotes for JS function calls

                         const viewNoteButtonHtml = (data.notes && data.notes.trim() !== '')
                            ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${eK}', event)"><i class="bi bi-eye me-1"></i>View Note</button>`
                            : '';

                         let catchTableHTML = '<p>No fish recorded.</p>';
                         if (fish.length > 0) {
                             const verifiedHeader = data.isCompetition ? '<th>Verified</th>' : '';
                             const photoHeader = fish.some(f => f.photo) ? '<th>Photo</th>' : ''; // Show header only if photos exist
                             const fishRows = fish.map((f, i) => {
                                 const verifiedCell = data.isCompetition ? `<td>${f.initials || '-'}</td>` : '';
                                 // Escape quotes within the Data URL itself for the onclick attribute
                                 const safePhotoDataForSrc = f.photo ? f.photo.replace(/"/g, """) : null;
                                 const safePhotoDataForJs = f.photo ? f.photo.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/`/g, "\\`") : null; // Escape backslash, single quote, backtick for JS string literal
                                 const photoCell = photoHeader ? (safePhotoDataForJs ? `<td><img src="${safePhotoDataForSrc || '#'}" alt="${f.species||'Fish'} photo" style="max-width: 40px; height: auto; cursor:pointer; border-radius: 4px;" onclick="showFullImage('${safePhotoDataForJs}')"></td>` : '<td>-</td>') : '';
                                 return `<tr><td>${i + 1}</td><td>${f.species || '?'}</td><td>${f.length || '?'}</td>${verifiedCell}${photoCell}</tr>`;
                             }).join('');
                             catchTableHTML = `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>#</th><th>Species</th><th>Len(cm)</th>${verifiedHeader}${photoHeader}</tr></thead><tbody>${fishRows}</tbody></table></div>`;
                         }


                         w.innerHTML = `<div class="scorecard-item" onclick="toggleScorecardDetails('${eK}',this)"><i class="bi bi-chevron-right me-2"></i><strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')} <span class="text-muted ms-2">(${fC} fish, ${tL}cm)</span> ${isLatest ? '<span class="badge ms-2">Latest</span>' : ''}</div>
                            <div class="scorecard-details" id="details_${key}">
                                <h6>Session Details</h6>
                                <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p>
                                <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p>
                                <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p>
                                ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''}
                                ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''}
                                ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''}
                                <hr>
                                <h6>Catch (${fC})</h6>
                                ${catchTableHTML}
                                ${fish.length > 0 ? `<hr><h6>Summary</h6><p><strong>Total Len:</strong> ${tL}cm</p><p><strong>Species:</strong> ${spC}</p><p><strong>Longest:</strong> ${lFS}</p>` : ''}
                                ${data.notes ? `<hr><h6>Notes</h6><p>${data.notes.replace(/\n/g, '<br>')}</p>` : ''}

                                <div class="btn-actions-group">
                                    ${viewNoteButtonHtml}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${eK}', event)"><i class="bi bi-pencil me-1"></i>Add/Edit Note</button>
                                    <button class="btn btn-info btn-sm" onclick="emailScorecard('${eK}', event)"><i class="bi bi-envelope me-1"></i>Email</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${eK}', event)"><i class="bi bi-trash me-1"></i>Delete</button>
                                </div>
                            </div>`;
                         return w;
                     } catch (elementError) {
                         console.error(`Error creating scorecard element for ${key}:`, elementError);
                         const errDiv = document.createElement('div');
                         errDiv.className = 'alert alert-warning p-2 my-2';
                         errDiv.textContent = `Error displaying card ${key.slice(-4)}`;
                         return errDiv;
                     }
                }; // End of createScorecardElement


                console.log(`Displaying first ${Math.min(displayLimit, scorecards.length)} scorecards.`);
                scorecards.slice(0, displayLimit).forEach(({ key, data }, index) => {
                    const el = createScorecardElement(key, data, index === 0);
                    if (el) savedScorecardsList.appendChild(el);
                });

                if (scorecards.length > displayLimit) {
                    console.log("Adding 'Older Scorecards' buttons.");
                    const olderCount = scorecards.length - displayLimit;
                    const showOlderBtn = document.createElement('button');
                    showOlderBtn.id = 'showOlderBtn';
                    showOlderBtn.className = 'btn btn-outline-secondary';
                    showOlderBtn.textContent = `View ${olderCount} Older Scorecard${olderCount > 1 ? 's' : ''}`;
                    showOlderBtn.onclick = function() { console.log("'View Older' clicked."); try { scorecards.slice(displayLimit).forEach(({ key, data }) => { const el = createScorecardElement(key, data, false); if (el) savedScorecardsList.appendChild(el); }); olderScorecardsToggleContainer.innerHTML = ''; } catch(e) { console.error("Error displaying older scorecards:", e); olderScorecardsToggleContainer.innerHTML = '<p class="text-danger">Error displaying older.</p>'; } };
                    olderScorecardsToggleContainer.appendChild(showOlderBtn);

                    const deleteOlderBtn = document.createElement('button');
                    deleteOlderBtn.id = 'deleteOlderBtn';
                    deleteOlderBtn.className = 'btn btn-danger';
                    deleteOlderBtn.textContent = 'Delete Older Scorecards';
                    deleteOlderBtn.onclick = confirmDeleteOlderScorecards;
                    olderScorecardsToggleContainer.appendChild(deleteOlderBtn);
                } else {
                    console.log("No 'Older Scorecards' buttons needed.");
                }
            } catch (e) { console.error("Error loading scorecards:", e); }
        }
        function showFullImage(imageDataUrl) { try { if (!imageDataUrl) return; window.open(imageDataUrl, '_blank'); } catch (e) { console.error("Error opening image:", e); alert("Could not open image preview."); } }
        function toggleScorecardDetails(key, element){ try { console.log("Toggle details:",key); const d=document.getElementById(`details_${key}`), i=element.querySelector('i.bi'); if(d && i){const v=d.style.display==='block'; d.style.display=v?'none':'block'; i.classList.toggle('bi-chevron-right',v);i.classList.toggle('bi-chevron-down',!v); element.classList.toggle('details-visible',!v);}else{console.error("Details element or icon missing for:",key);} } catch (e) { console.error("Error toggling details:", e); } }
        function deleteScorecard(key, event){ try { event.stopPropagation(); console.log("Attempting to delete scorecard:",key); let sN=`card ${key.slice(-6)}`; try{const dS=localStorage.getItem(key); if(dS) {const d=JSON.parse(dS); sN=`card for ${d.currentAngler||'?'} on ${formatDate(d.currentDate||'')}`}}catch(e){} if(confirm(`Delete ${sN}? This cannot be undone.`)){localStorage.removeItem(key);console.log("Deleted scorecard:",key);loadScorecards();}else{console.log("Delete cancelled.");}} catch (e) { console.error("Error deleting scorecard:", e); alert("Failed to delete scorecard."); } }
        function emailScorecard(key, event) { try { event.stopPropagation(); console.log("Emailing scorecard:", key); alert("Photo images are NOT included in email export due to data size limitations. Only scorecard data will be sent."); let data; try { const dS = localStorage.getItem(key); if (!dS) throw new Error("Scorecard data not found."); data = JSON.parse(dS); if (!data?.currentAngler || !data.currentDate || !data.currentVenue || !Array.isArray(data.fishData)) throw new Error("Invalid scorecard data format."); } catch (error) { console.error("Email data error:", error); alert(`Error getting data for email: ${error.message}`); return; } let body = "Sea Catch Scorecard\r\n=====================\r\n\r\n"; body += "Session Details:\r\n"; body += `Angler: ${data.currentAngler||'?'}\r\n`; body += `Date: ${formatDate(data.currentDate||'')}\r\n`; body += `Venue: ${data.currentVenue||'?'}\r\n`; if(data.currentZone)body+=`Zone: ${data.currentZone}\r\n`; if(data.currentPeg)body+=`Peg: ${data.currentPeg}\r\n`; if(data.verifier)body+=`Verified By: ${data.verifier}\r\n`; body += "\r\n"; body += "Catch List:\r\n"; if(data.fishData?.length>0){data.fishData.forEach((f,i)=>{body+=`${i+1}. ${f.species||'?'} - ${f.length||'?'} cm`; if(data.isCompetition && f.initials) { body += ` - Verified by: ${f.initials}`;} body += `\r\n`;});}else{body+="No fish recorded.\r\n";} body+="\r\n"; let tL=0,fC=0,sp=new Set(),lF=null; const fish=data.fishData||[]; fish.forEach(f=>{const l=f.length||0;fC++;tL+=l;if(f.species)sp.add(f.species);if(!lF||l>(lF.length||0))lF=f;}); const spC=sp.size; const lFS=lF?`${lF.species||'?'}(${lF.length||'?'}cm)`:'N/A'; body += "Summary:\r\n"; body += `Total Fish: ${fC}\r\n`; body += `Total Length: ${tL} cm\r\n`; body += `Unique Species: ${spC}\r\n`; body += `Longest Fish: ${lFS}\r\n\r\n=====================\r\n`; const subject = `Fishing Scorecard: ${data.currentVenue||'?'} - ${formatDate(data.currentDate||'')}`; const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; if(mailtoUrl.length>1800){console.warn(`Mailto URL is long (${mailtoUrl.length}), might not work in all clients.`); alert("Warning: Scorecard data is very long, email might be truncated.");} window.open(mailtoUrl,'_self'); } catch (e) { console.error("Error emailing scorecard:",e);alert("Could not open email client.");} }

        // --- Notes Modal Functions ---
        function openNotesModal(key, event) { try { if(event) event.stopPropagation(); console.log('Opening notes modal for key:', key); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { console.error('Notes modal elements/instance missing!'); alert('Error opening notes editor.'); return; } try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; notesTextarea.value=data.notes||''; } catch(e){ console.error('Error loading notes for modal:',e); notesTextarea.value=''; alert('Could not load existing notes.'); } notesModalKeyInput.value = key; notesModalInstance.show(); } catch (e) { console.error("Error opening notes modal:", e); } }
        function saveNoteFromModal() { try { console.log('Save notes modal clicked.'); const notesTextarea = document.getElementById('notesTextarea'), notesModalKeyInput = document.getElementById('notesModalScorecardKey'); if (!notesTextarea || !notesModalKeyInput || !notesModalInstance) { alert('Error saving notes: Required elements missing.'); return; } const key = notesModalKeyInput.value; const newNotes = notesTextarea.value; if (!key) { alert('Error: Scorecard key missing.'); return; } try { const dS = localStorage.getItem(key); if (!dS) throw new Error('Scorecard data not found to save notes.'); let data = JSON.parse(dS); data.notes = newNotes; localStorage.setItem(key, JSON.stringify(data)); console.log('Notes saved via modal for key:', key); notesModalInstance.hide(); setTimeout(loadScorecards, 150); // Reload list to show note changes } catch (e) { console.error('Error saving notes from modal:', e); alert(`Failed to save notes: ${e.message}`); } } catch (e) { console.error("Error saving note from modal:", e); } }
        function viewNote(key, event) { try { event.stopPropagation(); console.log('Viewing notes for key:', key); try { const dS=localStorage.getItem(key); const data=dS?JSON.parse(dS):{}; const notes=data.notes||''; alert(`Notes for scorecard:\n--------------------\n${notes || '(No notes saved)'}`); } catch (e) { console.error('Error retrieving notes:', e); alert('Could not retrieve notes.'); } } catch (e) { console.error("Error viewing note:", e); } }
        // --- End Notes Functions ---

        // --- Delete Older Scorecards Functions ---
        function confirmDeleteOlderScorecards() { try { const displayLimit = 4; const scorecards = []; try { for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key?.startsWith('scorecard_')) scorecards.push(key); } } catch (e) { alert('Error reading scorecards for deletion count.'); return; } scorecards.sort((a, b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1])); if (scorecards.length > displayLimit) { const olderCount = scorecards.length - displayLimit; if (confirm(`Are you sure you want to delete the oldest ${olderCount} scorecard${olderCount > 1 ? 's' : ''}? This cannot be undone.`)) { deleteOlderScorecards(); } else { console.log("Delete older scorecards cancelled."); } } else { alert("No older scorecards found to delete (less than 5 total)."); } } catch (e) { console.error("Error confirming delete older:", e); } }
        function deleteOlderScorecards() { try { console.log("Deleting older scorecards..."); const displayLimit = 4; const scorecards = []; let errorOccurred = false; try { for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key?.startsWith('scorecard_')) { const timestamp = parseInt(key.split('_')[1], 10); if (!isNaN(timestamp)) { scorecards.push({ key, timestamp }); } } } scorecards.sort((a, b) => b.timestamp - a.timestamp); const keysToDelete = scorecards.slice(displayLimit).map(item => item.key); if (keysToDelete.length > 0) { console.log(`Attempting to delete ${keysToDelete.length} older scorecards:`, keysToDelete); keysToDelete.forEach(key => { try { localStorage.removeItem(key); console.log(`Deleted: ${key}`); } catch (removeError) { console.error(`Error removing key ${key}:`, removeError); errorOccurred = true; } }); if (errorOccurred) { alert("Some older scorecards may not have been deleted due to an error. Please check the list."); } else { alert(`${keysToDelete.length} older scorecard${keysToDelete.length > 1 ? 's' : ''} deleted successfully.`); } } else { console.log("No older scorecards found to delete after re-check."); } } catch (e) { console.error("Error during the delete older process:", e); alert("An error occurred while trying to delete older scorecards."); errorOccurred = true; } finally { loadScorecards(); } } catch (e) { console.error("Error deleting older scorecards:", e); } }
        // --- End Delete Older Scorecards ---

        // --- General Modal Hiding/Showing ---
        function hideModal(modalId) { try { const mE=document.getElementById(modalId); if(mE){ const m=bootstrap.Modal.getInstance(mE); if(m){m.hide();} else { console.warn(`No Bootstrap modal instance found for ${modalId} to hide automatically.`); /* Manual fallback if needed, but usually handled by Bootstrap if initialized */ mE.classList.remove('show'); mE.style.display='none'; const backdrop = document.querySelector('.modal-backdrop.fade.show'); if (backdrop) backdrop.remove(); document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = ''; } } } catch (e) { console.error(`Error hiding modal ${modalId}:`, e); } }
        function showModal(modalId) { try { const modalElement = document.getElementById(modalId); if(modalElement) { const instance = bootstrap.Modal.getOrCreateInstance(modalElement, {backdrop: 'static', keyboard: false}); instance.show(); } else { console.error(`Modal element #${modalId} not found!`); } } catch (e) { console.error(`Error showing modal ${modalId}:`, e); } }

        // --- Application Reset ---
        function resetApp() {
            console.log("Resetting application state...");
            fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null; currentPage='splashScreen';
            deactivateAppMode(); stopCameraStream(); clearFishPhoto();
            try {
               const fieldsToReset = ['anglerName', 'competitionDate', 'venueInput', 'zoneInput', 'pegInput', 'speciesInput', 'customSpeciesInput', 'lengthInput', 'initialsInput', 'verifierEndModalInput'];
               fieldsToReset.forEach(id => {
                   const el = document.getElementById(id);
                   if (el) {
                       if (el.tagName === 'SELECT') el.selectedIndex = 0;
                       else el.value = '';
                   }
               });
               const isCompCheck = document.getElementById('isCompetition'); if(isCompCheck) isCompCheck.checked = false;
               if(document.getElementById('customSpeciesInput')) document.getElementById('customSpeciesInput').style.display = 'none';
               if(document.getElementById('fishLog')) document.getElementById('fishLog').innerHTML='';
               if(document.getElementById('verifierEndModalSection')) document.getElementById('verifierEndModalSection').style.display='none';

               populateTallySummaryFields(); // Reset tally fields
                const tallyTable = document.getElementById('tallyTable'); if (tallyTable) tallyTable.innerHTML = '';
                const tallyFields = ['tallyTotalLength', 'tallySpeciesCount', 'longestFishLength'];
                tallyFields.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '0 cm'; });
                const longestFishSpeciesEl = document.getElementById('longestFishSpecies'); if (longestFishSpeciesEl) longestFishSpeciesEl.textContent = 'N/A';


               toggleCompetitionFields();
               clearFishPhotoPreview();
               console.log("App reset complete.");
            } catch(e) {
                console.error("Error during app reset:", e);
            }
        }

        // --- Camera Functions ---
        async function startCamera() {
            console.log("startCamera function called.");
            const previewElement = document.getElementById('cameraPreview');
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            const photoCaptureControls = document.getElementById('photoCaptureControls');
            const fishPhotoPreviewArea = document.getElementById('fishPhotoPreviewArea');

            if (!previewElement || !photoPlaceholder || !photoCaptureControls || !fishPhotoPreviewArea) { console.error("One or more camera UI elements are missing!"); alert("Error initializing camera UI."); return false; }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { console.error("getUserMedia is not supported by this browser."); alert("Camera access is not supported by your browser. Please use a modern browser and ensure you are using HTTPS."); return false; }

            try {
                stopCameraStream();
                fishPhotoPreviewArea.style.display = 'none';

                console.log("Requesting camera stream (environment facing)...");
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                console.log("Camera stream obtained.");
                previewElement.srcObject = cameraStream;
                // Ensure the video element is ready before trying to display it fully
                await previewElement.play(); // Start playing the stream
                previewElement.style.display = 'block';
                photoPlaceholder.style.display = 'none';
                photoCaptureControls.style.display = 'block';
                return true;
            } catch (error) {
                console.error("Camera access error:", error.name, error.message);
                alert(`Camera access failed: ${error.name}. Please check browser permissions and ensure you are using HTTPS (secure connection).`);
                photoPlaceholder.style.display = 'block';
                photoCaptureControls.style.display = 'none';
                return false;
            }
        }
        function stopCameraStream() { try { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; console.log("Camera stream stopped."); } const previewElement = document.getElementById('cameraPreview'); if(previewElement) previewElement.style.display = 'none'; } catch (e) { console.error("Error stopping camera stream:", e); } }
        function capturePhoto() {
            console.log("Capturing photo...");
            const previewElement = document.getElementById('cameraPreview');
            const canvasElement = document.getElementById('captureCanvas');
            const photoPreview = document.getElementById('fishPhotoPreview');
            const fishPhotoPreviewArea = document.getElementById('fishPhotoPreviewArea');
            const photoCaptureControls = document.getElementById('photoCaptureControls');

            if (!previewElement || !canvasElement || !photoPreview || !fishPhotoPreviewArea || !photoCaptureControls) { console.error("Camera, canvas, or preview elements missing for capture."); return; }
            if (!previewElement.srcObject || !previewElement.videoWidth || !previewElement.videoHeight || previewElement.readyState < previewElement.HAVE_METADATA) { console.error("Camera stream not active or video dimensions not ready for capture."); alert("Camera not ready. Please wait a moment and try again."); return; }

            try {
                const context = canvasElement.getContext('2d');
                canvasElement.width = previewElement.videoWidth;
                canvasElement.height = previewElement.videoHeight;
                context.drawImage(previewElement, 0, 0, canvasElement.width, canvasElement.height);
                currentFishPhoto = canvasElement.toDataURL('image/jpeg', 0.8); // Use JPEG with compression
                console.log("Photo captured, DataURL length:", currentFishPhoto ? currentFishPhoto.length : 0);

                stopCameraStream();
                photoPreview.src = currentFishPhoto;
                fishPhotoPreviewArea.style.display = 'block';
                photoCaptureControls.style.display = 'none';
            } catch (e) { console.error("Error capturing photo:", e); alert("An error occurred while capturing the photo."); stopCameraStream(); clearFishPhotoPreview(); }
        }
        function clearFishPhoto() { currentFishPhoto = null; console.log("Cleared currentFishPhoto variable."); }
        function clearFishPhotoPreview() {
            try {
                console.log("Clearing fish photo preview UI.");
                const photoPreview = document.getElementById('fishPhotoPreview');
                const fishPhotoPreviewArea = document.getElementById('fishPhotoPreviewArea');
                const photoPlaceholder = document.getElementById('photoPlaceholder');
                if(photoPreview) photoPreview.src = '#';
                if(fishPhotoPreviewArea) fishPhotoPreviewArea.style.display = 'none';
                if(photoPlaceholder) photoPlaceholder.style.display = 'block';
                const photoCaptureControls = document.getElementById('photoCaptureControls');
                if(photoCaptureControls) photoCaptureControls.style.display = 'none';
            } catch (e) { console.error("Error clearing photo preview:", e); }
        }


        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Initializing application...");
            try {
                 // --- Service Worker Registration ---
                 if ('serviceWorker' in navigator) {
                     window.addEventListener('load', () => {
                         navigator.serviceWorker.register('./sw.js') // Assuming sw.js is in the same folder as index.html
                             .then(reg => console.log('Service Worker registered successfully. Scope: ', reg.scope))
                             .catch(err => console.error('Service Worker registration failed: ', err));
                     });
                 } else { console.log('Service workers are not supported by this browser.'); }
                 // --- End Service Worker Registration ---

                 window.addEventListener('popstate', handleBackButton);
                 window.addEventListener('beforeunload', handleBeforeUnload);
                 console.log("Navigation event listeners attached.");

                 // Define refs for frequently accessed elements - Check if elements exist before adding listener
                 const refs = {};
                 const elementIds = [
                     'continueBtn', 'viewScorecardsBtn', 'startRecordingBtn', 'isCompetition',
                     'speciesInput', 'addFishBtn', 'backFromFishingBtn', 'endSessionBtn', 'confirmEndBtn',
                     'cancelEndSessionBtn', 'backFromTallyBtn', 'restoreSessionBtn', 'startNewSessionBtn',
                     'anglerName', 'competitionDate', 'venueInput', 'zoneInput', 'pegInput', 'initialsInput',
                     'mlsAgreeBtn', 'addPhotoButton', 'capturePhotoButton', 'usePhotoButton', 'retakePhotoButton',
                     'cancelPhotoButton', 'removePhotoButton', 'notesModal', 'customSpeciesInput', 'fishLog',
                     'verifiedByHeader', 'initialsInputGroup', 'verifierEndModalSection', 'verifierEndModalInput',
                     'tallyTable', 'tallyTotalLength', 'tallySpeciesCount', 'longestFishSpecies', 'longestFishLength',
                     'restoreAngler', 'restoreDate', 'restoreFishCount', 'restoreSessionModal',
                     'savedScorecardsModal', 'savedScorecardsList', 'olderScorecardsToggleContainer',
                     'notesTextarea', 'notesModalScorecardKey', 'mlsInfoModal',
                     'cameraPreview', 'captureCanvas', 'photoCaptureControls', 'photoPlaceholder', 'fishPhotoPreviewArea', 'fishPhotoPreview'
                 ];
                 elementIds.forEach(id => {
                     const el = document.getElementById(id);
                     if (el) {
                         refs[id] = el;
                     } else {
                         console.warn(`Initialization Warning: Element with ID "${id}" not found.`);
                     }
                 });

                 console.log("Refs defined (checked for existence).");

                 // --- Attach Event Listeners ---
                 console.log("Attaching event listeners...");

                 // Splash Screen Buttons
                 if (refs.continueBtn) { refs.continueBtn.addEventListener('click', startApp); console.log("Listener attached: continueBtn"); }
                 if (refs.viewScorecardsBtn) { refs.viewScorecardsBtn.addEventListener('click', showScorecardsModal); console.log("Listener attached: viewScorecardsBtn"); }

                 // Registration Page
                 if (refs.startRecordingBtn) { refs.startRecordingBtn.addEventListener('click', startRecording); console.log("Listener attached: startRecordingBtn"); }
                 if (refs.isCompetition) { refs.isCompetition.addEventListener('change', () => { toggleCompetitionFields(); saveTempSession(); }); console.log("Listener attached: isCompetition"); }
                 if (refs.anglerName) refs.anglerName.addEventListener('input', () => { currentAngler = refs.anglerName.value.trim(); saveTempSession(); });
                 if (refs.competitionDate) refs.competitionDate.addEventListener('change', () => { currentDate = refs.competitionDate.value; saveTempSession(); });
                 if (refs.venueInput) refs.venueInput.addEventListener('input', () => { currentVenue = refs.venueInput.value.trim(); saveTempSession(); });
                 if (refs.zoneInput) refs.zoneInput.addEventListener('change', () => { currentZone = refs.isCompetition?.checked ? refs.zoneInput.value : null; saveTempSession(); });
                 if (refs.pegInput) refs.pegInput.addEventListener('change', () => { currentPeg = refs.isCompetition?.checked ? refs.pegInput.value : null; saveTempSession(); });


                 // Fishing Page
                 if (refs.speciesInput) { refs.speciesInput.addEventListener('change', toggleCustomSpeciesInput); console.log("Listener attached: speciesInput"); }
                 if (refs.addFishBtn) { refs.addFishBtn.addEventListener('click', addFish); console.log("Listener attached: addFishBtn"); }
                 if (refs.backFromFishingBtn) { refs.backFromFishingBtn.addEventListener('click', backFromFishing); console.log("Listener attached: backFromFishingBtn"); }
                 if (refs.endSessionBtn) { refs.endSessionBtn.addEventListener('click', showEndSessionModal); console.log("Listener attached: endSessionBtn"); }
                 if (refs.initialsInput) refs.initialsInput.addEventListener('input', () => { saveTempSession(); }); // Save initials input for temp session

                 // Camera Buttons
                 if (refs.addPhotoButton) { refs.addPhotoButton.addEventListener('click', startCamera); console.log("Listener attached: addPhotoButton"); }
                 if (refs.capturePhotoButton) { refs.capturePhotoButton.addEventListener('click', capturePhoto); console.log("Listener attached: capturePhotoButton"); }
                 if (refs.usePhotoButton) { refs.usePhotoButton.addEventListener('click', () => { console.log("Using captured photo."); refs.photoCaptureControls.style.display = 'none'; refs.fishPhotoPreviewArea.style.display = 'block'; }); console.log("Listener attached: usePhotoButton"); }
                 if (refs.retakePhotoButton) { refs.retakePhotoButton.addEventListener('click', startCamera); console.log("Listener attached: retakePhotoButton"); }
                 if (refs.cancelPhotoButton) { refs.cancelPhotoButton.addEventListener('click', () => { stopCameraStream(); clearFishPhotoPreview(); }); console.log("Listener attached: cancelPhotoButton"); }
                 if (refs.removePhotoButton) { refs.removePhotoButton.addEventListener('click', () => { clearFishPhoto(); clearFishPhotoPreview(); }); console.log("Listener attached: removePhotoButton"); }

                 // Tally Page
                 if (refs.backFromTallyBtn) { refs.backFromTallyBtn.addEventListener('click', backFromTally); console.log("Listener attached: backFromTallyBtn"); }

                 // Modals
                 if (refs.confirmEndBtn) { refs.confirmEndBtn.addEventListener('click', confirmEndSession); console.log("Listener attached: confirmEndBtn"); }
                 if (refs.restoreSessionBtn) { refs.restoreSessionBtn.addEventListener('click', restoreSession); console.log("Listener attached: restoreSessionBtn"); }
                 if (refs.startNewSessionBtn) { refs.startNewSessionBtn.addEventListener('click', function() { if (confirm("Starting a new session will discard the currently unsaved session data. Are you sure?")) { startNewSessionConfirmed(); } else { console.log("User cancelled discarding session."); } }); console.log("Listener attached: startNewSessionBtn"); }
                 if (refs.mlsAgreeBtn) { refs.mlsAgreeBtn.addEventListener('click', () => { hideModal('mlsInfoModal'); }); console.log("Listener attached: mlsAgreeBtn"); }
                 // Note: Bootstrap handles default modal close buttons, no specific listener needed for cancelEndSessionBtn unless doing more than closing.


                 // Initialize Notes Modal instance
                 if (refs.notesModal) { notesModalInstance = new bootstrap.Modal(refs.notesModal); console.log("Notes modal instance created.");}
                 else { console.error("Notes Modal element (#notesModal) not found in HTML!"); }


                 console.log("All event listeners attached (if elements found).");

                 // Check for restore session last, after everything else is set up
                 checkRestoreSession();

             } catch (error) {
                console.error("FATAL ERROR during initialization:", error);
                document.body.innerHTML = `<div class="alert alert-danger m-5" role="alert">
                    <h4 class="alert-heading">Application Initialization Error!</h4>
                    <p>A critical error occurred while setting up the application:</p>
                    <hr>
                    <p class="mb-0"><b>Error:</b> ${error.message}</p>
                    <pre style="white-space: pre-wrap; word-wrap: break-word;"><code>Stack Trace:\n${error.stack || '(Not available)'}</code></pre>
                    <p class="mt-3">Please try the following:</p>
                    <ul>
                        <li>Clear your browser's cache and cookies completely.</li>
                        <li>Refresh the page using Ctrl+Shift+R (or Cmd+Shift+R on Mac).</li>
                        <li>If the problem persists, please report the error details above.</li>
                    </ul>
                </div>`;
             }
        });
    </script>

</body>
</html>
