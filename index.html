<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Catch Scorer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: url('https://i.postimg.cc/pLFtxQWs/seacatchscorecard.jpg') no-repeat center/cover fixed; color: #fff; min-height: 100vh; overscroll-behavior-y: contain; }
        .container { background: rgba(0, 0, 0, 0.75); border-radius: 15px; padding: 25px; margin: 20px auto; max-width: 960px; z-index: 1; display: none; }
        .page { display: none; }

        /* --- Splash Screen --- */
        .splash-screen { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 40px; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2; }

        /* --- Main Content Card Style --- */
        .card-section { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 30px 25px; margin: 20px 0; border: 1px solid #dee2e6; color: #212529; z-index: 3; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .card-section h2 { color: #0056b3; margin-bottom: 1.2rem; }
        .card-section h5 { color: #0056b3; margin-bottom: 1rem; }

        /* --- Buttons --- */
        /* ... styles unchanged from base ... */
        .btn { padding: 12px 24px; font-size: 1.1rem; border-radius: 25px; border: none; margin: 5px; transition: transform 0.2s, background-color 0.2s, border-color 0.2s; cursor: pointer; font-weight: 600; vertical-align: middle; } .btn:disabled { cursor: not-allowed; opacity: 0.65; } .btn-primary { background-color: #007bff; color: white; } .btn-primary:hover { background-color: #0056b3; transform: scale(1.05); } .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; transform: scale(1.05); } .btn-success { background-color: #198754; color: white; } .btn-success:hover { background-color: #157347; transform: scale(1.05); } .btn-danger { background-color: #dc3545; color: white; } .btn-danger:hover { background-color: #c82333; transform: scale(1.05); } .btn-info { background-color: #0dcaf0; color: black; } .btn-info:hover { background-color: #31d2f2; transform: scale(1.05); color: black;} .btn-outline-secondary { border: 2px solid #6c757d; color: #6c757d; background-color: transparent; } .btn-outline-secondary:hover { background-color: #6c757d; color: white; } .btn-outline-light { border: 2px solid #f8f9fa; color: #f8f9fa; background-color: transparent; } .btn-outline-light:hover { background-color: #f8f9fa; color: #000; } .btn-sm { padding: 5px 10px; font-size: 0.9rem; border-radius: 20px; font-weight: normal; margin: 2px; } .btn-lg { padding: 14px 28px; font-size: 1.25rem; margin: 10px; } .button-group-center { text-align: center; margin-top: 20px; } .button-group-center .btn { margin-left: 8px; margin-right: 8px; }

        /* --- Forms --- */
        .mb-3 { margin-bottom: 1.3rem !important; }
        .form-label { font-weight: 600; color: #495057; margin-bottom: 0.5rem; }
        .form-control, .form-select { border-radius: 8px; border: 1px solid #ced4da; }
        .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-label { color: #212529; }
        #verifierEndModalSection { display: none; }
        #competitionDetails { display: none; } /* ADDED: Hide competition section initially */


        /* --- Tables --- */
        /* ... styles unchanged ... */
        /* --- Specific Table Styles --- */
       /* ... styles unchanged ... */
        /* --- Fish Log Specific --- */
       /* ... styles unchanged ... */
        /* --- Unified Modal Style --- */
       /* ... styles unchanged ... */
        /* --- Saved Scorecards Modal --- */
       /* ... styles unchanged ... */
        /* --- Notes Modal --- */
       /* ... styles unchanged ... */
        /* --- Camera Modal Styles --- */
       /* ... styles unchanged ... */
        /* --- Image Viewer Modal Styles --- */
       /* ... styles unchanged ... */

    </style>
</head>
<body>
    <div class="container">
        <div id="registrationPage" class="card-section page">
            <h2>Angler Registration</h2>
            <div class="mb-3"> <label for="anglerName" class="form-label">Angler Name</label> <input type="text" id="anglerName" class="form-control" placeholder="Enter your name"> </div>
            <div class="mb-3"> <label for="competitionDate" class="form-label">Date</label> <input type="date" id="competitionDate" class="form-control"> </div>
            <div class="mb-3"> <label for="venueInput" class="form-label">Venue</label> <input type="text" id="venueInput" class="form-control" placeholder="Enter venue"> </div>

            <div class="mb-3 form-check"> <input type="checkbox" class="form-check-input" id="isCompetition"> <label class="form-check-label" for="isCompetition">Competition</label> </div>

             <div id="competitionDetails">
                 <div class="mb-3">
                     <label for="teamNameInput" class="form-label">Team Name</label>
                     <input type="text" id="teamNameInput" class="form-control" placeholder="Enter team name (optional)" disabled> </div>
                 <div class="mb-3">
                     <label for="zoneInput" class="form-label">Zone</label>
                     <select id="zoneInput" class="form-select" disabled> <option value="" selected>Select a zone</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> <option value="E">E</option> <option value="F">F</option> <option value="G">G</option> <option value="H">H</option> </select>
                 </div>
                 <div class="mb-3">
                     <label for="pegInput" class="form-label">Peg</label>
                     <select id="pegInput" class="form-select" disabled> <option value="" selected>Select a peg</option> <option value="1">1</option> <option value="25">25</option> </select>
                 </div>
             </div> <div class="button-group-center"> <button class="btn btn-primary" id="startRecordingBtn">Record Catch <i class="bi bi-arrow-right-circle ms-1"></i></button> </div>
        </div>

        <div id="fishingPage" class="card-section page">
             ...
        </div>

         <div id="tallyPage" class="card-section page">
            <h2>Catch Summary</h2>
            <div class="catch-summary-details">
                 <strong>Angler:</strong> <span id="summaryAngler">N/A</span><br>
                 <strong>Date:</strong> <span id="summaryDate">N/A</span><br>
                 <strong>Venue:</strong> <span id="summaryVenue">N/A</span><br>
                 <strong id="summaryTeamLabel" style="display: none;">Team:</strong> <span id="summaryTeam" style="display: none;">N/A</span><span id="summaryTeamBreak" style="display: none;"><br></span>
                 <strong>Zone:</strong> <span id="summaryZone">N/A</span><br>
                 <strong>Peg:</strong> <span id="summaryPeg">N/A</span><br>
                 <span id="summaryVerifier"></span>
             </div>
            ...
        </div>
    </div> <div id="splashScreen" class="splash-screen page">
         ...
         <div class="button-group-center"> <button class="btn btn-primary btn-lg" id="continueBtn">Start Fishing <i class="bi bi-water ms-1"></i></button> <br> <button class="btn btn-outline-light btn-lg" id="viewScorecardsBtn">View Saved Scorecards <i class="bi bi-journal-bookmark ms-1"></i></button> </div>
    </div>

    ...


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global Variables ---
        const fishCategories = { /* ... fish categories as provided ... */ };
        let fishData = [];
        let currentAngler = null;
        let currentDate = null;
        let currentVenue = null;
        let currentZone = null;
        let currentPeg = null;
        let currentTeamName = null; // ADDED Team Variable
        let currentPage = 'splashScreen';
        let isAppActive = false;
        let historyHijacked = false;
        let notesModalInstance = null;
        let cameraModalInstance = null;
        let imageViewerModalInstance = null;
        let confirmPhotoModalInstance = null;
        let db = null;
        let currentStream = null;
        let currentFishIdForPhoto = null;
        let currentImageBlobForViewer = null;
        let currentImageIdForViewer = null;
        let isDropdownPopulated = false;
        let pendingFishData = null;

        // --- Constants ---
        const DB_NAME = 'SeaCatchDB';
        const DB_VERSION = 1;
        const IMAGE_STORE_NAME = 'fishImages';
        const POINTS_PER_SPECIES = 10;

        // --- Utility Functions ---
        function formatDate(dateString) { /* ... (unchanged from base) ... */ }
        function formatDateForInput(date) { /* ... (unchanged from base) ... */ }
        function showPage(pageId) { /* ... (unchanged from base) ... */ }
        function generateUUID() { /* ... (unchanged from base) ... */ }


        // --- IndexedDB Functions ---
        function initDb() { /* ... (unchanged from base) ... */ }
        function saveImageToDb(imageId, blob) { /* ... (unchanged from base) ... */ }
        function getImageFromDb(imageId) { /* ... (unchanged from base) ... */ }
        function deleteImageFromDb(imageId) { /* ... (unchanged from base) ... */ }

        // --- History/Navigation Control ---
        function activateAppMode() { /* ... (unchanged from base) ... */ }
        function deactivateAppMode() { /* ... (unchanged from base) ... */ }
        function handleBackButton(event) { /* ... (unchanged from base) ... */ }
        function handleBeforeUnload(event) { /* ... (unchanged from base) ... */ }

        // --- Session Management ---
        // MODIFIED: saveTempSession includes team name
        function saveTempSession() {
             if (!isAppActive) return;
             const temp = {
                 fishData: fishData||[], currentAngler, currentDate, currentVenue,
                 currentZone, currentPeg, currentTeamName, // ADDED Team
                 currentPage, isAppActive, historyHijacked,
                 isCompetition: document.getElementById('isCompetition')?.checked
             };
             try { localStorage.setItem('temp_session', JSON.stringify(temp)); }
             catch (e) { console.error("Save temp err:", e); /* ... */ }
        }
        function clearTempSession() { /* ... (unchanged from base) ... */ }
        function checkRestoreSession() { /* ... (unchanged from base) ... */ }
        // MODIFIED: restoreSession handles team name
        function restoreSession() {
            console.log("Restore clicked.");
            let temp;
            try { /* ... (try block unchanged) ... */ }
            catch (e) { console.error("Restore err:", e); alert("Failed restore."); startNewSession(); return; }

            // ... restore fishData, angler, date, venue, zone, peg ...
             fishData = temp.fishData || []; currentAngler = temp.currentAngler || null; currentDate = temp.currentDate || null; currentVenue = temp.currentVenue || null; currentZone = temp.currentZone || null; currentPeg = temp.currentPeg || null;
             currentTeamName = temp.currentTeamName || null; // ADDED Team Restore
             const page = temp.currentPage || 'registrationPage'; isAppActive = temp.isAppActive || false; historyHijacked = temp.historyHijacked || false; const restoredIsCompetition = temp.isCompetition === true;

            console.log("Restoring to:", page, "App active:", isAppActive, "Is Competition:", restoredIsCompetition);

            try {
                 // ... restore angler, date, venue ...
                 if (currentAngler) document.getElementById('anglerName').value = currentAngler; if (currentDate) document.getElementById('competitionDate').value = currentDate; if (currentVenue) document.getElementById('venueInput').value = currentVenue;
                 const competitionCheck = document.getElementById('isCompetition'); if(competitionCheck) competitionCheck.checked = restoredIsCompetition;

                 // Set Team, Zone, Peg values BEFORE toggling fields
                 const teamInput = document.getElementById('teamNameInput'); if(teamInput && currentTeamName) teamInput.value = currentTeamName; // ADDED Team Restore
                 const zoneSelect = document.getElementById('zoneInput'); if(zoneSelect && currentZone) zoneSelect.value = currentZone;
                 const pegSelect = document.getElementById('pegInput'); if(pegSelect && currentPeg) pegSelect.value = currentPeg;

                 // Now toggle fields based on restored checkbox state
                 toggleCompetitionFields(false);

            } catch (e) { console.error("Restore reg fields err:", e); }

             // ... (rest of restore unchanged) ...
             if (page === 'fishingPage' || page === 'tallyPage') { populateSpeciesDropdown(); if (page === 'fishingPage') { updateFishLog(); } else if (page === 'tallyPage') { populateTallySummaryFields(); populateTallyTable(); } } hideModal('restoreSessionModal'); showPage(page); if (isAppActive && !historyHijacked) { history.pushState({ appActive: true }, '', location.href); historyHijacked = true; console.log("Pushed history after restore."); } console.log("Session restored.");
        }
        function startNewSession() { /* ... (unchanged from base) ... */ }

        // --- UI Interaction ---
        function populateSpeciesDropdown() { /* ... (unchanged from base) ... */ }
        function toggleCustomSpeciesInput() { /* ... (unchanged from base) ... */ }

        // MODIFIED: toggleCompetitionFields handles team wrapper and input
        function toggleCompetitionFields(updateLog = true) {
             try {
                 const check = document.getElementById('isCompetition').checked;
                 const competitionDetails = document.getElementById('competitionDetails'); // Get wrapper
                 const teamInput = document.getElementById('teamNameInput'); // Get team input
                 const zone = document.getElementById('zoneInput');
                 const peg = document.getElementById('pegInput');
                 const initialsGroup = document.getElementById('initialsInputGroup');
                 const verifiedByHeader = document.getElementById('verifiedByHeader');

                 // Toggle wrapper visibility
                 if(competitionDetails) competitionDetails.style.display = check ? 'block' : 'none';

                 // Enable/disable fields
                 if(teamInput) teamInput.disabled = !check; // Toggle team input
                 if(zone) zone.disabled = !check;
                 if(peg) peg.disabled = !check;
                 if(initialsGroup) initialsGroup.style.display = check ? 'block' : 'none';

                 // Clear values if disabling
                 if (!check) {
                     if(teamInput) teamInput.value = '';
                     if(zone) zone.value = '';
                     if(peg) peg.value = '';
                 }

                 if (verifiedByHeader) verifiedByHeader.style.display = check ? 'table-cell' : 'none';
                 if (updateLog) { updateFishLog(); }
                  console.log("Competition fields toggled. Competition Mode:", check);
             } catch (e) { console.error("Toggle comp fields err:", e); }
        }

        // UNCHANGED: setTodaysDate (uses actual current date from base)
        function setTodaysDate() { try { const dateInput = document.getElementById('competitionDate'); if (dateInput && !dateInput.value) { const today = new Date(); const formattedDate = formatDateForInput(today); dateInput.value = formattedDate; currentDate = formattedDate; console.log("Set date input to today:", formattedDate); } } catch (e) { console.error("Error setting today's date:", e); } }

        function startApp() { /* ... (unchanged from base) ... */ }

        // MODIFIED: startRecording reads and sets team name
        function startRecording() {
            console.log("Record Catch triggered.");
            const nameEl=document.getElementById('anglerName'), dateEl=document.getElementById('competitionDate'), venueEl=document.getElementById('venueInput'), checkEl=document.getElementById('isCompetition'), zoneEl=document.getElementById('zoneInput'), pegEl=document.getElementById('pegInput'), teamEl=document.getElementById('teamNameInput'); // ADDED teamEl ref

            if(!nameEl||!dateEl||!venueEl||!checkEl||!zoneEl||!pegEl||!teamEl){alert("Form elements missing.");return;} // Added teamEl check
            const name=nameEl.value.trim(), date=dateEl.value, venue=venueEl.value.trim(), isComp=checkEl.checked, zone=zoneEl.value, peg=pegEl.value;
            const team = teamEl.value.trim(); // ADDED reading team value

            if(!name||!date||!venue){alert("Name, Date, Venue required.");return;}
            if(isComp&&(!zone||!peg)){alert("Zone & Peg required for competition.");return;}
            if(!/^\d{4}-\d{2}-\d{2}$/.test(date)){alert("Valid date required.");return;}

            currentAngler=name; currentDate=date; currentVenue=venue;
            currentZone=isComp?zone:null; currentPeg=isComp?peg:null;
            currentTeamName = isComp ? team : null; // ADDED storing team name conditionally
            const isActuallyCompetition = !!(currentZone && currentPeg);

            console.log("Start recording data:",{currentAngler,currentDate,currentVenue,currentZone,currentPeg, currentTeamName, isCompetition:isActuallyCompetition}); // ADDED team name to log

            populateSpeciesDropdown();
            saveTempSession(); // Will now save team name if applicable
            updateFishLog();
            showPage('fishingPage');
            if (isActuallyCompetition) { showModal('mlsInfoModal'); }
        }

        function addFish() { /* ... (unchanged from base) ... */ }
        function handleConfirmPhoto(shouldTakePhoto) { /* ... (unchanged from base) ... */ }
        async function updateFishLog() { /* ... (unchanged from base) ... */ }
        async function loadThumbnail(fishId, imageId) { /* ... (unchanged from base) ... */ }
        async function deleteFish(idx) { /* ... (unchanged from base) ... */ }
        function backFromFishing() { /* ... (unchanged from base) ... */ }

        // --- Camera Functions ---
        async function openCamera(fishId) { /* ... (unchanged from base) ... */ }
        function stopCameraStream() { /* ... (unchanged from base) ... */ }
        async function takeSnapshot() { /* ... (unchanged from base) ... */ }


        // --- End Session Modal ---
        function showEndSessionModal() { /* ... (unchanged from base) ... */ }
        // MODIFIED: confirmEndSession includes team name in saved data
        function confirmEndSession() {
            console.log("Confirm End button clicked.");
             if (!currentAngler || !currentDate || !currentVenue) { /* ... validation ... */ }

            const isCompetition = !!(currentZone && currentPeg);
            let verifierName = null;
            if (isCompetition) { /* ... verifier validation ... */ }

            hideModal('endSessionModal');
            console.log("Validation passed. Saving data with verifier:", verifierName, "and team:", currentTeamName);

            // ADDED teamName to saved object
            const sessionData = {
                currentAngler, currentDate, currentVenue,
                currentZone, currentPeg,
                teamName: currentTeamName, // ADDED
                verifier: verifierName, notes: null,
                fishData: fishData || [], isCompetition: isCompetition
            };

            const id = `scorecard_${Date.now()}`;
            try {
                localStorage.setItem(id, JSON.stringify(sessionData)); // Save complete session data
                console.log("Saved scorecard metadata:", id);
                alert("Scorecard saved successfully!");
                clearTempSession();
                resetApp();
                showPage('splashScreen');
            } catch(e) { /* ... (error handling unchanged) ... */ }
        }

        // --- Tally Page ---
        // MODIFIED: populateTallySummaryFields displays team name
        function populateTallySummaryFields() {
             try{
                 document.getElementById('summaryAngler').textContent=currentAngler||'?';
                 document.getElementById('summaryDate').textContent=currentDate?formatDate(currentDate):'?';
                 document.getElementById('summaryVenue').textContent=currentVenue||'?';

                  // ADDED Team display logic
                 const teamLabel = document.getElementById('summaryTeamLabel');
                 const teamValue = document.getElementById('summaryTeam');
                 const teamBreak = document.getElementById('summaryTeamBreak');
                 if(currentTeamName && currentTeamName.trim() !== '') {
                     if(teamLabel) teamLabel.style.display = 'inline';
                     if(teamValue) { teamValue.textContent = currentTeamName; teamValue.style.display = 'inline'; }
                     if(teamBreak) teamBreak.style.display = 'block';
                 } else {
                      if(teamLabel) teamLabel.style.display = 'none';
                      if(teamValue) teamValue.style.display = 'none';
                      if(teamBreak) teamBreak.style.display = 'none';
                 }

                 document.getElementById('summaryZone').textContent=currentZone||'N/A';
                 document.getElementById('summaryPeg').textContent=currentPeg||'N/A';
                 document.getElementById('summaryVerifier').innerHTML = ''; // Verifier logic might need adding if required here
              }catch(e){ console.error("Error populating tally summary:", e); }
        }
        function populateTallyTable() { /* ... (unchanged from base) ... */ }
        function backFromTally() { /* ... (unchanged from base) ... */ }

        // --- Saved Scorecards ---
        function showScorecardsModal() { /* ... (unchanged from base - still uses modal) ... */ }
        async function loadScorecards() { /* ... (unchanged from base - loads from localStorage) ... */ }
        // MODIFIED: createScorecardElement displays team name
        function createScorecardElement (key, data, isLatest) {
             try {
                 const wrapperDiv = document.createElement('div');
                 wrapperDiv.className = `scorecard-entry${isLatest ? ' latest-scorecard' : ''}`;
                 wrapperDiv.id = `entry-${key}`;

                 // Calculate Summaries (unchanged)
                 /* ... */
                 const fishList = data.fishData || [];
                 let overallTotalLength = 0, fishCount = 0, speciesSet = new Set(), longestFish = null, speciesTotals = {};
                 fishList.forEach(f => {const length = f.length || 0; const speciesName = f.species || '?'; fishCount++; overallTotalLength += length; speciesSet.add(speciesName); if (!longestFish || length > (longestFish.length || 0)) longestFish = f; speciesTotals[speciesName] = (speciesTotals[speciesName] || 0) + length; });
                 const speciesCount = speciesSet.size; const points = overallTotalLength + (speciesCount * POINTS_PER_SPECIES); const longestFishString = longestFish ? `${longestFish.species || '?'}(${longestFish.length || '?'}cm)` : 'N/A'; const escapedKey = key.replace(/'/g, "\\'"); const viewNoteButtonHtml = (data.notes && data.notes.trim() !== '') ? `<button class="btn btn-secondary btn-sm" onclick="viewNote('${escapedKey}', event)"><i class="bi bi-eye me-1"></i>View Note</button>` : '';

                 // Generate Fish List HTML (unchanged)
                 let fishListHtml = /* ... */;

                 // Generate Species Length Summary HTML (unchanged)
                 let speciesSummaryHtml = /* ... */;

                 // Generate Photos Section HTML (unchanged)
                 const photosPlaceholderId = `sessionPhotos-${key}`; const photosHtml = /* ... */;

                 // Assemble Full Scorecard Details HTML (ADDED Team display)
                 wrapperDiv.innerHTML = `
                     <div class="scorecard-item" onclick="toggleScorecardDetails('${escapedKey}',this)">
                          <i class="bi bi-chevron-right me-2"></i><strong>${data.currentVenue || '?'}</strong> - ${formatDate(data.currentDate || '')} <span class="text-muted ms-2">(${fishCount} fish, ${overallTotalLength}cm, ${points} pts)</span> ${isLatest ? '<span class="badge bg-primary ms-2">Latest</span>' : ''}
                     </div>
                     <div class="scorecard-details" id="details_${key}">
                         <h6>Session Details</h6>
                         <p><strong>Angler:</strong> ${data.currentAngler || '?'}</p>
                         <p><strong>Venue:</strong> ${data.currentVenue || '?'}</p>
                         <p><strong>Date:</strong> ${formatDate(data.currentDate || '')}</p>
                         ${data.teamName ? `<p><strong>Team:</strong> ${data.teamName}</p>` : ''} ${data.currentZone ? `<p><strong>Zone:</strong> ${data.currentZone}</p>` : ''}
                         ${data.currentPeg ? `<p><strong>Peg:</strong> ${data.currentPeg}</p>` : ''}
                         ${data.verifier ? `<p><strong>Verified By:</strong> ${data.verifier}</p>` : ''}
                         <hr>
                         <h6>Catch (${fishCount})</h6>
                         ${fishListHtml}
                         ${fishList.length > 0 ? `
                             <hr>
                             <div class="scorecard-summary-block">
                                 <h6>Summary</h6>
                                 ${speciesSummaryHtml}
                                 <p class="summary-highlight"><strong>Overall Total Length:</strong> ${overallTotalLength}cm</p>
                                 <p><strong>Total Species:</strong> ${speciesCount}</p>
                                 <p><strong>Longest Fish:</strong> ${longestFishString}</p>
                                 <p class="summary-highlight"><strong>Points Total:</strong> ${points}</p>
                             </div>
                         ` : ''}
                         ${photosHtml}
                         <div class="btn-actions-group">
                             ${viewNoteButtonHtml}
                             <button class="btn btn-outline-secondary btn-sm" onclick="openNotesModal('${escapedKey}', event)"><i class="bi bi-pencil me-1"></i>Add/Edit Note</button>
                             <button class="btn btn-info btn-sm" onclick="emailScorecard('${escapedKey}', event)"><i class="bi bi-envelope me-1"></i>Email</button>
                             <button class="btn btn-danger btn-sm" onclick="deleteScorecard('${escapedKey}', event)"><i class="bi bi-trash me-1"></i>Delete</button>
                         </div>
                     </div>`;

                 setTimeout(() => loadSessionPhotos(key, fishList), 0);
                 return wrapperDiv;
             } catch (elementError) { /* ... error handling ... */ }
        } // End createScorecardElement

        async function loadSessionPhotos(scorecardKey, fishList) { /* ... (unchanged from base) ... */ }
        function toggleScorecardDetails(key, element){ /* ... (unchanged from base) ... */ }
        async function deleteScorecard(key, event){ /* ... (unchanged from base) ... */ }
        function emailScorecard(key, event) { /* ... (unchanged from base) ... */ }
        function openNotesModal(key, event) { /* ... (unchanged from base) ... */ }
        function saveNoteFromModal() { /* ... (unchanged from base) ... */ }
        function viewNote(key, event) { /* ... (unchanged from base) ... */ }
        function confirmDeleteOlderScorecards() { /* ... (unchanged from base) ... */ }
        async function deleteOlderScorecards() { /* ... (unchanged from base) ... */ }
        async function showFullscreenImage(imageId) { /* ... (unchanged from base) ... */ }
        async function shareImage() { /* ... (unchanged from base) ... */ }
        function hideModal(modalId) { /* ... (unchanged from base) ... */ }
        function showModal(modalId) { /* ... (unchanged from base) ... */ }

        // --- Application Reset ---
        // MODIFIED: resetApp clears team name and input
        function resetApp() {
            console.log("Resetting app.");
            fishData=[]; currentAngler=null; currentDate=null; currentVenue=null; currentZone=null; currentPeg=null; currentTeamName=null; // Clear team
            currentPage='splashScreen'; stopCameraStream(); deactivateAppMode();
            isDropdownPopulated = false; pendingFishData = null;
            try {
                document.getElementById('anglerName').value='';
                // setTodaysDate(); // Let init handle date setting
                document.getElementById('venueInput').value='';
                const competitionCheck = document.getElementById('isCompetition'); if(competitionCheck) competitionCheck.checked=false;
                const teamInput = document.getElementById('teamNameInput'); if(teamInput) teamInput.value=''; // Clear team input
                toggleCompetitionFields(false); // Reset competition fields visibility/state
                document.getElementById('zoneInput').value='';
                document.getElementById('pegInput').value='';
                // ... reset other fields ...
                const speciesInput = document.getElementById('speciesInput'); if (speciesInput) { speciesInput.innerHTML = '<option value="" selected disabled>Select a species</option><option value="Other">Other (specify)</option>'; }
                const customSpeciesInput = document.getElementById('customSpeciesInput'); if (customSpeciesInput) { customSpeciesInput.value = ''; customSpeciesInput.style.display = 'none'; }
                document.getElementById('lengthInput').value='';
                const initialsInput = document.getElementById('initialsInput'); if(initialsInput) initialsInput.value='';
                const fishLog = document.getElementById('fishLog'); if(fishLog) fishLog.innerHTML='';
                const vI = document.getElementById('verifierEndModalInput'); if(vI) vI.value='';
                const vS = document.getElementById('verifierEndModalSection'); if(vS) vS.style.display='none';
                populateTallySummaryFields(); // Reset tally summary
                 // ... reset tally table/footer ...
            } catch(e) { console.error("Error resetting forms:", e); }
             setTodaysDate(); // Ensure date is set correctly after reset
        }

        // --- Initialisation ---
        // DOMContentLoaded structure unchanged from base code
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM loaded. Initializing...");
            try {
                await initDb();
                 // ... SW registration ...
                 // ... History listeners ...
                 // ... Element References ...
                 const refs = { /* ... all refs from base code ... */ };
                 // ... Init Modals ...
                  const notesModalElement = document.getElementById('notesModal'); if (notesModalElement && typeof bootstrap !== 'undefined') { notesModalInstance = new bootstrap.Modal(notesModalElement); }
                  const cameraModalElement = document.getElementById('cameraModal'); if (cameraModalElement && typeof bootstrap !== 'undefined') { cameraModalInstance = new bootstrap.Modal(cameraModalElement); cameraModalElement.addEventListener('hidden.bs.modal', stopCameraStream); }
                  const imageViewerModalElement = document.getElementById('imageViewerModal'); if (imageViewerModalElement && typeof bootstrap !== 'undefined') { imageViewerModalInstance = new bootstrap.Modal(imageViewerModalElement); }
                  const confirmPhotoModalElement = document.getElementById('confirmPhotoModal'); if (confirmPhotoModalElement && typeof bootstrap !== 'undefined') { confirmPhotoModalInstance = new bootstrap.Modal(confirmPhotoModalElement); }

                 // ... Add Listeners ... (listeners automatically reference updated functions)
                 // Use optional chaining (?.) for safety
                refs.continueBtn?.addEventListener('click', startApp);
                refs.viewScorecardsBtn?.addEventListener('click', showScorecardsModal);
                refs.startRecordingBtn?.addEventListener('click', startRecording);
                refs.isCompetitionCheck?.addEventListener('change', () => { toggleCompetitionFields(); saveTempSession(); });
                refs.speciesSelect?.addEventListener('change', toggleCustomSpeciesInput);
                refs.addFishBtn?.addEventListener('click', addFish);
                refs.backFromFishingBtn?.addEventListener('click', backFromFishing);
                refs.endSessionBtn?.addEventListener('click', showEndSessionModal);
                refs.confirmEndBtn?.addEventListener('click', confirmEndSession);
                refs.backFromTallyBtn?.addEventListener('click', backFromTally);
                refs.startNewSessionBtn?.addEventListener('click', () => { if (confirm("Starting a new session will discard the currently unsaved session data. Are you sure?")) { startNewSession(); } });
                refs.restoreSessionBtn?.addEventListener('click', restoreSession);
                // Input Listeners including new Team Input Listener
                refs.anglerNameInput?.addEventListener('input', () => { currentAngler = refs.anglerNameInput?.value.trim(); saveTempSession(); });
                refs.competitionDateInput?.addEventListener('change', () => { currentDate = refs.competitionDateInput?.value; saveTempSession(); });
                refs.venueInput?.addEventListener('input', () => { currentVenue = refs.venueInput?.value.trim(); saveTempSession(); });
                document.getElementById('teamNameInput')?.addEventListener('input', () => { currentTeamName = document.getElementById('isCompetition')?.checked ? document.getElementById('teamNameInput')?.value.trim() : null; saveTempSession(); }); // ADDED Listener
                refs.zoneSelect?.addEventListener('change', () => { currentZone = refs.isCompetitionCheck?.checked ? refs.zoneSelect.value : null; saveTempSession(); });
                refs.pegSelect?.addEventListener('change', () => { currentPeg = refs.isCompetitionCheck?.checked ? refs.pegSelect.value : null; saveTempSession(); });
                refs.initialsInput?.addEventListener('input', saveTempSession);
                // Modal Buttons
                refs.mlsAgreeBtn?.addEventListener('click', () => hideModal('mlsInfoModal'));
                refs.takePhotoButton?.addEventListener('click', takeSnapshot);
                refs.cancelCameraButtonHeader?.addEventListener('click', stopCameraStream);
                refs.shareImageBtn?.addEventListener('click', shareImage);
                refs.confirmPhotoYesBtn?.addEventListener('click', () => handleConfirmPhoto(true));
                refs.confirmPhotoNoBtn?.addEventListener('click', () => handleConfirmPhoto(false));

                // Initial setup calls
                toggleCompetitionFields(false); // Set initial state based on default unchecked box
                setTodaysDate(); // Set date (will use actual today's date from base code)
                checkRestoreSession(); // Check restore last, as it might show a page/modal

                console.log("Initialization complete.");
            } catch (error) { console.error("Fatal init error:", error); document.body.innerHTML = `<div class="alert alert-danger m-5">App Error: ${error.message}. Please check console, allow permissions, and refresh.</div>`; }
        });
    </script>

</body>
</html>
